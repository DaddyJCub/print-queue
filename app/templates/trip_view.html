{% extends "pwa_base.html" %}

{% block title %}{{ trip.title }} | Printellect{% endblock %}

{% block header_title %}{{ trip.title }}{% endblock %}

{% block header_left %}
<a href="/trips" class="flex items-center gap-2 tap-highlight text-zinc-400 hover:text-white">
  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
  </svg>
  <span class="hidden sm:inline">Trips</span>
</a>
{% endblock %}

{% block header_right %}
{% if can_edit %}
<a href="/trips/{{ trip.id }}/events/new" class="p-2 rounded-lg hover:bg-zinc-800 transition tap-highlight" title="Add Event">
  <svg class="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
  </svg>
</a>
{% endif %}
<button onclick="toggleTripMenu()" class="p-2 rounded-lg hover:bg-zinc-800 transition tap-highlight">
  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
  </svg>
</button>
<!-- Trip Menu Dropdown -->
<div id="trip-menu" class="hidden absolute top-full right-4 mt-2 w-56 bg-zinc-900 border border-zinc-700 rounded-xl shadow-xl z-50 overflow-hidden">
  <a href="/trips/{{ trip.id }}/members" class="flex items-center gap-3 px-4 py-3 hover:bg-zinc-800 transition">
    <svg class="w-5 h-5 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
    </svg>
    <span>Members ({{ members|length }})</span>
  </a>
  <a href="/trips/{{ trip.id }}/pdf" class="flex items-center gap-3 px-4 py-3 hover:bg-zinc-800 transition">
    <svg class="w-5 h-5 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
    </svg>
    <span>PDF Itinerary</span>
  </a>
  {% if can_edit %}
  <a href="/trips/{{ trip.id }}/import/ics" class="flex items-center gap-3 px-4 py-3 hover:bg-zinc-800 transition">
    <svg class="w-5 h-5 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9M4 4l16 16"/>
    </svg>
    <span>Import ICS</span>
  </a>
  {% endif %}
  {% if can_manage %}
  <a href="/trips/{{ trip.id }}/share" class="flex items-center gap-3 px-4 py-3 hover:bg-zinc-800 transition">
    <svg class="w-5 h-5 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h6a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
    </svg>
    <span>Share & Calendar</span>
  </a>
  {% endif %}
  {% if can_edit %}
  <a href="/trips/{{ trip.id }}/edit" class="flex items-center gap-3 px-4 py-3 hover:bg-zinc-800 transition">
    <svg class="w-5 h-5 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
    </svg>
    <span>Edit Trip</span>
  </a>
  {% endif %}
</div>
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto -mt-2">
  
  <!-- Offline Banner (hidden by default, shown via JS when offline) -->
  <div id="offline-banner" class="hidden mb-4 p-3 bg-amber-600/20 border border-amber-500/30 rounded-xl text-amber-300 text-sm text-center">
    <span class="flex items-center justify-center gap-2">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414"/>
      </svg>
      You're offline â€” viewing cached trip data
    </span>
  </div>
  
  <!-- Trip Header Card -->
  <div class="bg-gradient-to-br from-indigo-600/20 to-purple-600/10 border border-indigo-500/30 rounded-2xl p-5 mb-6">
    <div class="flex items-start justify-between">
      <div>
        <div class="flex items-center gap-2 mb-1">
          <span class="text-2xl">
            {% if 'vegas' in trip.destination|lower or 'las vegas' in trip.destination|lower %}ğŸ°
            {% elif 'beach' in trip.destination|lower or 'hawaii' in trip.destination|lower %}ğŸ–ï¸
            {% else %}âœˆï¸{% endif %}
          </span>
          <h1 class="text-xl font-bold">{{ trip.title }}</h1>
        </div>
        <p class="text-zinc-400">{{ trip.destination }}</p>
        <div class="flex items-center gap-4 mt-3 text-sm text-zinc-400">
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            {{ trip.start_date }} â€” {{ trip.end_date }}
          </span>
          {% if trip.budget_cents %}
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-12v2m0 10v2m-7-6h14"/>
            </svg>
            Budget: ${{ '%.2f' % (trip.budget_cents/100) }} Â· Spent ${{ '%.2f' % (total_cost_cents/100) }}{% if remaining_budget_cents is not none %} Â· Left ${{ '%.2f' % (remaining_budget_cents/100) }}{% endif %}
          </span>
          {% endif %}
          {% if share_mode %}
          <span class="px-2 py-0.5 bg-emerald-600/20 text-emerald-300 text-xs rounded-full">Shared View</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  
  <!-- "What's Next" Card (Sticky on mobile) -->
  {% if next_event %}
  <div class="sticky top-14 z-30 -mx-4 px-4 py-3 bg-zinc-950/95 backdrop-blur-lg border-b border-zinc-800/50 mb-4" style="margin-top: -1rem;">
    <div class="bg-gradient-to-r from-emerald-600/20 to-teal-600/10 border border-emerald-500/30 rounded-xl p-4">
      <div class="flex items-center gap-2 text-emerald-400 text-xs font-medium mb-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        WHAT'S NEXT
      </div>
      <a href="/trips/{{ trip.id }}/events/{{ next_event.id }}" class="block">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl flex items-center justify-center text-lg
            {% if next_event.category.value == 'flight' %}bg-blue-600/30 text-blue-300
            {% elif next_event.category.value == 'hotel' %}bg-purple-600/30 text-purple-300
            {% elif next_event.category.value == 'activity' %}bg-amber-600/30 text-amber-300
            {% elif next_event.category.value == 'meal' %}bg-orange-600/30 text-orange-300
            {% elif next_event.category.value == 'transport' %}bg-cyan-600/30 text-cyan-300
            {% else %}bg-zinc-700/50 text-zinc-300{% endif %}">
            {% if next_event.category.value == 'flight' %}âœˆï¸
            {% elif next_event.category.value == 'hotel' %}ğŸ¨
            {% elif next_event.category.value == 'activity' %}ğŸ¯
            {% elif next_event.category.value == 'meal' %}ğŸ½ï¸
            {% elif next_event.category.value == 'transport' %}ğŸš—
            {% else %}ğŸ“{% endif %}
          </div>
          <div class="flex-1 min-w-0">
            <h3 class="font-semibold truncate">{{ next_event.title }}</h3>
            <p class="text-sm text-zinc-400">
              {% if next_event.is_all_day %}All day{% else %}{{ next_event.start_datetime[11:16] }}{% endif %}
              {% if next_event.location_name %} Â· {{ next_event.location_name }}{% endif %}
            </p>
          </div>
          <svg class="w-5 h-5 text-zinc-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </div>
      </a>
    </div>
  </div>
  {% endif %}
  
  <!-- Coming Up List -->
  {% if coming_up %}
  <div class="mb-6">
    <h2 class="text-sm font-semibold text-zinc-400 uppercase tracking-wider mb-3">Coming Up</h2>
    <div class="space-y-2">
      {% for event in coming_up %}
      <a href="/trips/{{ trip.id }}/events/{{ event.id }}" class="flex items-center gap-3 p-3 bg-zinc-900/60 border border-zinc-800 rounded-xl hover:border-zinc-700 transition tap-highlight">
        <div class="w-8 h-8 rounded-lg flex items-center justify-center text-sm
          {% if event.category.value == 'flight' %}bg-blue-600/20 text-blue-300
          {% elif event.category.value == 'hotel' %}bg-purple-600/20 text-purple-300
          {% elif event.category.value == 'activity' %}bg-amber-600/20 text-amber-300
          {% elif event.category.value == 'meal' %}bg-orange-600/20 text-orange-300
          {% elif event.category.value == 'transport' %}bg-cyan-600/20 text-cyan-300
          {% else %}bg-zinc-700/30 text-zinc-400{% endif %}">
          {% if event.category.value == 'flight' %}âœˆï¸
          {% elif event.category.value == 'hotel' %}ğŸ¨
          {% elif event.category.value == 'activity' %}ğŸ¯
          {% elif event.category.value == 'meal' %}ğŸ½ï¸
          {% elif event.category.value == 'transport' %}ğŸš—
          {% else %}ğŸ“{% endif %}
        </div>
        <div class="flex-1 min-w-0">
          <p class="font-medium truncate">{{ event.title }}</p>
          <p class="text-xs text-zinc-500">
            {{ event.start_datetime[:10] }}
            {% if not event.is_all_day %} Â· {{ event.start_datetime[11:16] }}{% endif %}
          </p>
        </div>
        <svg class="w-4 h-4 text-zinc-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </a>
      {% endfor %}
    </div>
  </div>
  {% endif %}
  
  <!-- Day-by-Day Timeline -->
  <div class="mb-6">
    <h2 class="text-sm font-semibold text-zinc-400 uppercase tracking-wider mb-3">Day by Day</h2>
    
    <!-- Day Chips (Horizontal Scroll) -->
    <div class="flex gap-2 overflow-x-auto pb-3 hide-scrollbar -mx-4 px-4 mb-4">
      {% for day in trip_dates %}
      <button onclick="scrollToDay('{{ day.date }}')" 
              class="day-chip flex-shrink-0 flex flex-col items-center px-3 py-2 rounded-xl border transition
                     {% if day.is_today %}bg-indigo-600/30 border-indigo-500 text-white{% else %}bg-zinc-900/60 border-zinc-800 text-zinc-400 hover:border-zinc-700{% endif %}"
              data-date="{{ day.date }}">
        <span class="text-xs">{{ day.day_name }}</span>
        <span class="text-lg font-bold">{{ day.day_num }}</span>
        {% if day.events|length > 0 %}
        <span class="w-1.5 h-1.5 rounded-full bg-indigo-400 mt-1"></span>
        {% endif %}
      </button>
      {% endfor %}
    </div>
    
    <!-- Day Sections -->
    <div class="space-y-6" id="timeline">
      {% for day in trip_dates %}
      <div id="day-{{ day.date }}" class="day-section scroll-mt-40">
        <div class="flex items-center gap-3 mb-3">
          <div class="flex items-center gap-2">
            <span class="text-2xl font-bold {% if day.is_today %}text-indigo-400{% else %}text-white{% endif %}">{{ day.day_num }}</span>
            <div>
              <p class="text-sm font-medium {% if day.is_today %}text-indigo-400{% endif %}">{{ day.day_name }}</p>
              <p class="text-xs text-zinc-500">{{ day.month }}</p>
            </div>
          </div>
          {% if day.is_today %}
          <span class="px-2 py-0.5 bg-indigo-600/20 text-indigo-300 text-xs rounded-full">Today</span>
          {% endif %}
          {% if can_edit %}
          <a href="/trips/{{ trip.id }}/events/new?date={{ day.date }}" class="ml-auto p-2 rounded-lg hover:bg-zinc-800 transition tap-highlight" title="Add event">
            <svg class="w-5 h-5 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
          </a>
          {% endif %}
        </div>
        
        {% if day.events %}
        <div class="space-y-2 pl-1 border-l-2 border-zinc-800 ml-4">
          {% for event in day.events %}
          <a href="/trips/{{ trip.id }}/events/{{ event.id }}" class="block ml-4 -translate-x-[1.125rem]">
            <div class="flex items-start gap-3 p-3 bg-zinc-900/60 border border-zinc-800 rounded-xl hover:border-zinc-700 transition tap-highlight">
              <!-- Timeline dot -->
              <div class="w-2 h-2 rounded-full mt-2 flex-shrink-0
                {% if event.category.value == 'flight' %}bg-blue-400
                {% elif event.category.value == 'hotel' %}bg-purple-400
                {% elif event.category.value == 'activity' %}bg-amber-400
                {% elif event.category.value == 'meal' %}bg-orange-400
                {% elif event.category.value == 'transport' %}bg-cyan-400
                {% else %}bg-zinc-500{% endif %}"></div>
              
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-xs px-2 py-0.5 rounded-full
                    {% if event.category.value == 'flight' %}bg-blue-600/20 text-blue-300
                    {% elif event.category.value == 'hotel' %}bg-purple-600/20 text-purple-300
                    {% elif event.category.value == 'activity' %}bg-amber-600/20 text-amber-300
                    {% elif event.category.value == 'meal' %}bg-orange-600/20 text-orange-300
                    {% elif event.category.value == 'transport' %}bg-cyan-600/20 text-cyan-300
                    {% else %}bg-zinc-700/50 text-zinc-400{% endif %}">
                    {{ event.category.value|capitalize }}
                  </span>
                  <span class="text-xs text-zinc-500">
                    {% if event.is_all_day %}All day{% else %}{{ event.start_datetime[11:16] }}{% if event.end_datetime %} - {{ event.end_datetime[11:16] }}{% endif %}{% endif %}
                  </span>
                </div>
                <h3 class="font-medium">{{ event.title }}</h3>
                {% if event.location_name %}
                <p class="text-sm text-zinc-400 flex items-center gap-1 mt-1">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                  </svg>
                  {{ event.location_name }}
                </p>
                {% endif %}
                {% if event.flight_number %}
                <p class="text-sm text-zinc-400 mt-1">Flight: {{ event.flight_number }}</p>
                {% endif %}
              </div>
              <svg class="w-4 h-4 text-zinc-600 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </div>
          </a>
          {% endfor %}
        </div>
        {% else %}
        <p class="text-zinc-600 text-sm pl-10">No events scheduled</p>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </div>
  
  <!-- Add Event FAB (Mobile) -->
  {% if can_edit %}
  <a href="/trips/{{ trip.id }}/events/new" 
     class="fixed bottom-24 right-4 w-14 h-14 bg-indigo-600 hover:bg-indigo-700 rounded-full shadow-lg flex items-center justify-center transition tap-highlight sm:hidden z-40">
    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
    </svg>
  </a>
  {% endif %}
  
</div>

<script>
  // Toggle trip menu
  function toggleTripMenu() {
    document.getElementById('trip-menu').classList.toggle('hidden');
  }
  window.toggleTripMenu = toggleTripMenu;
  
  // Close menu when clicking outside
  document.addEventListener('click', (e) => {
    const menu = document.getElementById('trip-menu');
    if (menu && !e.target.closest('#trip-menu') && !e.target.closest('button[onclick="toggleTripMenu()"]')) {
      menu.classList.add('hidden');
    }
  });
  
  // Scroll to day
  function scrollToDay(date) {
    const el = document.getElementById('day-' + date);
    if (el) {
      el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      
      // Update active chip
      document.querySelectorAll('.day-chip').forEach(chip => {
        if (chip.dataset.date === date) {
          chip.classList.add('bg-indigo-600/30', 'border-indigo-500', 'text-white');
          chip.classList.remove('bg-zinc-900/60', 'border-zinc-800', 'text-zinc-400');
        } else {
          chip.classList.remove('bg-indigo-600/30', 'border-indigo-500', 'text-white');
          chip.classList.add('bg-zinc-900/60', 'border-zinc-800', 'text-zinc-400');
        }
      });
    }
  }
  window.scrollToDay = scrollToDay;
  
  // Scroll to today on load, or to specific event if coming from notification
  document.addEventListener('DOMContentLoaded', () => {
    // Inform service worker which user owns this trip cache for isolation
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.ready.then((reg) => {
        reg.active?.postMessage({ type: 'SET_ACTIVE_USER', userId: '{{ user.id }}' });
      }).catch(() => {});
    }
    
    // Check for event query param (from notification click-through)
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('event');
    
    if (eventId) {
      // Find and highlight the event, or redirect to event detail page
      const eventEl = document.querySelector(`a[href*="/events/${eventId}"]`);
      if (eventEl) {
        // Scroll to event and highlight it
        setTimeout(() => {
          eventEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          eventEl.classList.add('ring-2', 'ring-indigo-500', 'ring-offset-2', 'ring-offset-zinc-950');
          // Remove highlight after a few seconds
          setTimeout(() => {
            eventEl.classList.remove('ring-2', 'ring-indigo-500', 'ring-offset-2', 'ring-offset-zinc-950');
          }, 3000);
        }, 300);
      } else {
        // Event not visible on this page, go to event detail
        window.location.href = `/trips/{{ trip.id }}/events/${eventId}`;
      }
    } else {
      // Default behavior: scroll to today chip
      const todayChip = document.querySelector('.day-chip.bg-indigo-600\\/30');
      if (todayChip) {
        todayChip.scrollIntoView({ behavior: 'auto', block: 'nearest', inline: 'center' });
      }
    }
  });
  
  // Offline detection - show banner when offline
  function updateOfflineStatus() {
    const banner = document.getElementById('offline-banner');
    if (banner) {
      if (!navigator.onLine) {
        banner.classList.remove('hidden');
      } else {
        banner.classList.add('hidden');
      }
    }
  }
  
  window.addEventListener('online', updateOfflineStatus);
  window.addEventListener('offline', updateOfflineStatus);
  updateOfflineStatus(); // Check on load
  
  // Warm the service worker cache for this trip after binding the user
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.ready.then(() => {
      fetch(window.location.pathname, { credentials: 'include', cache: 'reload' }).catch(() => {});
    });
  }
</script>
{% endblock %}
