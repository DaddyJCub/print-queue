<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ item.name }} - Store Item</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-zinc-950 text-zinc-100 min-h-screen">
  <div class="max-w-4xl mx-auto p-6">
    {% set active_page = 'store' %}
    {% include 'admin_nav.html' %}
    
    <div class="flex items-center justify-between mb-6">
      <div>
        <a href="/admin/store" class="text-zinc-400 hover:text-zinc-200 text-sm mb-2 inline-block">‚Üê Back to Store</a>
        <h1 class="text-2xl font-bold">{{ item.name }}</h1>
        {% if not item.is_active %}
          <span class="inline-block mt-1 px-2 py-0.5 rounded text-xs bg-zinc-700 text-zinc-400">Hidden from public store</span>
        {% endif %}
      </div>
      <div class="flex gap-2">
        <a href="/store/item/{{ item.id }}" target="_blank" class="rounded-xl bg-zinc-700 hover:bg-zinc-600 transition px-4 py-2 text-sm font-semibold">
          üëÅ View Public Page
        </a>
        <button onclick="confirmDelete()" class="rounded-xl bg-red-600/20 border border-red-500/50 hover:bg-red-600/30 transition px-4 py-2 text-sm font-semibold text-red-300">
          üóë Delete
        </button>
      </div>
    </div>
    
    {% if request.query_params.get('created') %}
      <div class="mb-6 p-4 rounded-xl bg-emerald-600/20 border border-emerald-500/50 text-emerald-200">
        ‚úì Store item created from request! You can edit details below.
      </div>
    {% endif %}
    
    {% if request.query_params.get('saved') %}
      <div class="mb-6 p-4 rounded-xl bg-emerald-600/20 border border-emerald-500/50 text-emerald-200">
        ‚úì Changes saved successfully
      </div>
    {% endif %}
    
    {% if request.query_params.get('uploaded') %}
      <div class="mb-6 p-4 rounded-xl bg-emerald-600/20 border border-emerald-500/50 text-emerald-200">
        ‚úì Files uploaded successfully
      </div>
    {% endif %}
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Main Edit Form -->
      <div class="lg:col-span-2 space-y-6">
        <form method="POST" action="/admin/store/item/{{ item.id }}/update" enctype="multipart/form-data" 
              class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5">
          <h2 class="font-semibold mb-4">Edit Item Details</h2>
          
          <div class="space-y-4">
            <div>
              <label class="text-sm text-zinc-400">Name *</label>
              <input type="text" name="name" value="{{ item.name }}" required
                     class="w-full mt-1 rounded-xl bg-zinc-950 border border-zinc-800 p-3 text-sm focus:border-indigo-500 focus:outline-none" />
            </div>
            
            <div>
              <label class="text-sm text-zinc-400">Description</label>
              <textarea name="description" rows="3"
                        class="w-full mt-1 rounded-xl bg-zinc-950 border border-zinc-800 p-3 text-sm resize-none focus:border-indigo-500 focus:outline-none">{{ item.description or '' }}</textarea>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="text-sm text-zinc-400">Category</label>
                <input type="text" name="category" value="{{ item.category or '' }}" placeholder="e.g. Toys, Tools"
                       class="w-full mt-1 rounded-xl bg-zinc-950 border border-zinc-800 p-3 text-sm focus:border-indigo-500 focus:outline-none" />
              </div>
              <div>
                <label class="text-sm text-zinc-400">Material</label>
                <select name="material" class="w-full mt-1 rounded-xl bg-zinc-950 border border-zinc-800 p-3 text-sm focus:border-indigo-500 focus:outline-none">
                  <option value="PLA" {% if item.material == 'PLA' %}selected{% endif %}>PLA</option>
                  <option value="PETG" {% if item.material == 'PETG' %}selected{% endif %}>PETG</option>
                  <option value="ABS" {% if item.material == 'ABS' %}selected{% endif %}>ABS</option>
                  <option value="TPU" {% if item.material == 'TPU' %}selected{% endif %}>TPU</option>
                  <option value="RESIN" {% if item.material == 'RESIN' %}selected{% endif %}>Resin</option>
                  <option value="ANY" {% if item.material == 'ANY' %}selected{% endif %}>Any</option>
                </select>
              </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="text-sm text-zinc-400">Colors</label>
                <input type="text" name="colors" value="{{ item.colors or '' }}" placeholder="e.g. Black, White"
                       class="w-full mt-1 rounded-xl bg-zinc-950 border border-zinc-800 p-3 text-sm focus:border-indigo-500 focus:outline-none" />
              </div>
              <div>
                <label class="text-sm text-zinc-400">Est. Print Time (min)</label>
                <input type="number" name="estimated_time_minutes" value="{{ item.estimated_time_minutes or '' }}" min="0"
                       class="w-full mt-1 rounded-xl bg-zinc-950 border border-zinc-800 p-3 text-sm focus:border-indigo-500 focus:outline-none" />
              </div>
            </div>
            
            <div>
              <label class="text-sm text-zinc-400">Model Link (optional)</label>
              <input type="url" name="link_url" value="{{ item.link_url or '' }}" placeholder="https://..."
                     class="w-full mt-1 rounded-xl bg-zinc-950 border border-zinc-800 p-3 text-sm focus:border-indigo-500 focus:outline-none" />
            </div>
            
            <div>
              <label class="text-sm text-zinc-400">Update Thumbnail Image</label>
              <input type="file" name="image" accept="image/*"
                     class="w-full mt-1 rounded-xl bg-zinc-950 border border-zinc-800 p-3 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-indigo-600 file:text-white file:font-semibold file:cursor-pointer" />
              <p class="text-xs text-zinc-500 mt-1">Leave empty to keep current image</p>
            </div>
            
            <div>
              <label class="text-sm text-zinc-400">Internal Notes (admin only)</label>
              <textarea name="notes" rows="2"
                        class="w-full mt-1 rounded-xl bg-zinc-950 border border-zinc-800 p-3 text-sm resize-none focus:border-indigo-500 focus:outline-none">{{ item.notes or '' }}</textarea>
            </div>
            
            <div class="flex items-center gap-3 pt-2">
              <input type="checkbox" name="is_active" id="is_active" value="1" {% if item.is_active %}checked{% endif %}
                     class="rounded bg-zinc-950 border-zinc-700 text-indigo-600 focus:ring-indigo-500" />
              <label for="is_active" class="text-sm">Active (visible in public store)</label>
            </div>
            
            <button type="submit" class="w-full rounded-xl bg-indigo-600 hover:bg-indigo-500 transition px-4 py-3 text-sm font-semibold mt-4">
              Save Changes
            </button>
          </div>
        </form>
        
        <!-- Files Section -->
        <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5">
          <h2 class="font-semibold mb-4">Print Files</h2>
          
          {% if files %}
            <div class="space-y-2 mb-4">
              {% for f in files %}
                <div class="flex items-center justify-between bg-zinc-950/60 border border-zinc-800 rounded-xl p-3">
                  <div class="flex items-center gap-3">
                    <span class="text-emerald-400">üìÅ</span>
                    <div>
                      <span class="text-sm">{{ f.original_filename }}</span>
                      <span class="text-xs text-zinc-500 ml-2">{{ (f.size_bytes / 1024)|round(1) }} KB</span>
                    </div>
                  </div>
                  <form method="POST" action="/admin/store/item/{{ item.id }}/file/{{ f.id }}/delete" class="inline">
                    <button type="submit" class="text-red-400 hover:text-red-300 text-sm" onclick="return confirm('Delete this file?')">
                      üóë
                    </button>
                  </form>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-zinc-500 text-sm mb-4">No files uploaded yet</p>
          {% endif %}
          
          <form method="POST" action="/admin/store/item/{{ item.id }}/upload" enctype="multipart/form-data" class="pt-4 border-t border-zinc-800">
            <input type="file" name="files" multiple accept=".stl,.obj,.3mf,.gcode,.step,.stp,.fpp,.zip"
                   class="w-full rounded-xl bg-zinc-950 border border-zinc-800 p-3 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-emerald-600 file:text-white file:font-semibold file:cursor-pointer" />
            <p class="text-xs text-zinc-500 mt-1">STL, OBJ, 3MF, GCODE, STEP, FPP</p>
            <button type="submit" class="mt-3 rounded-xl bg-emerald-600 hover:bg-emerald-500 transition px-4 py-2 text-sm font-semibold">
              Upload Files
            </button>
          </form>
        </div>
      </div>
      
      <!-- Sidebar Preview -->
      <div class="space-y-6">
        <!-- Image Preview -->
        <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5">
          <h2 class="font-semibold mb-4">Thumbnail Preview</h2>
          <div class="aspect-square bg-zinc-800 rounded-xl flex items-center justify-center overflow-hidden">
            {% if item.image_data %}
              <img src="data:image/jpeg;base64,{{ item.image_data }}" 
                   alt="{{ item.name }}" 
                   class="w-full h-full object-cover" />
            {% else %}
              <span class="text-6xl text-zinc-600">üé®</span>
            {% endif %}
          </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5">
          <h2 class="font-semibold mb-4">Info</h2>
          <div class="space-y-3 text-sm">
            <div class="flex justify-between">
              <span class="text-zinc-500">ID</span>
              <span class="font-mono text-xs">{{ item.id[:8] }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-zinc-500">Created</span>
              <span>{{ item.created_at[:10] }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-zinc-500">Updated</span>
              <span>{{ item.updated_at[:10] }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-zinc-500">Files</span>
              <span>{{ files|length }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="mt-8 pt-4 border-t border-zinc-800 text-center text-xs text-zinc-500">
      <a href="/changelog" class="hover:text-indigo-400 transition">3D Print Queue v{{ version }}</a>
    </div>
  </div>
  
  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-zinc-900 border border-zinc-700 rounded-2xl p-6 max-w-sm mx-4">
      <h3 class="text-lg font-semibold mb-3">Delete Store Item?</h3>
      <p class="text-sm text-zinc-400 mb-6">This will permanently delete "{{ item.name }}" and all associated files. This cannot be undone.</p>
      <div class="flex gap-3">
        <button onclick="hideDeleteModal()" class="flex-1 rounded-xl bg-zinc-700 hover:bg-zinc-600 transition px-4 py-2 text-sm font-semibold">
          Cancel
        </button>
        <form method="POST" action="/admin/store/item/{{ item.id }}/delete" class="flex-1">
          <button type="submit" class="w-full rounded-xl bg-red-600 hover:bg-red-500 transition px-4 py-2 text-sm font-semibold">
            Delete
          </button>
        </form>
      </div>
    </div>
  </div>
  
  <script>
    function confirmDelete() {
      const modal = document.getElementById('delete-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    
    function hideDeleteModal() {
      const modal = document.getElementById('delete-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
    
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') hideDeleteModal();
    });
  </script>
</body>
</html>
