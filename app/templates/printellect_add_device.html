<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Add Device | Printellect</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-zinc-950 text-zinc-100">
  <main class="max-w-3xl mx-auto p-6 space-y-6">
    <h1 class="text-2xl font-bold">Add Device Wizard</h1>
    <ol class="space-y-4 text-sm text-zinc-200 list-decimal list-inside">
      <li>Power on the Printellect base.</li>
      <li>Join phone Wi-Fi network <code>PRINTELLECT-SETUP-xxxx</code>.</li>
      <li>Open <a class="text-indigo-300 underline" href="http://192.168.4.1/">http://192.168.4.1/</a> and save SSID/password + claim code.</li>
      <li>Return here and claim by scanning QR or entering device ID + claim code.</li>
      <li>Wait for online confirmation.</li>
    </ol>

    <div class="grid md:grid-cols-2 gap-4">
      <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-4 space-y-2">
        <h2 class="font-semibold text-sm">Scan QR (optional)</h2>
        <button id="startScan" class="bg-zinc-800 hover:bg-zinc-700 rounded px-3 py-2 text-sm">Start camera scan</button>
        <video id="preview" class="w-full rounded border border-zinc-800 hidden" muted playsinline></video>
        <p id="scanResult" class="text-xs text-zinc-400"></p>
      </div>
      <form id="claimForm" class="space-y-3 bg-zinc-900 border border-zinc-800 rounded-xl p-4">
      <div>
        <label class="text-xs text-zinc-400">Device ID</label>
        <input name="device_id" class="w-full mt-1 rounded bg-zinc-950 border border-zinc-700 p-2" required />
      </div>
      <div>
        <label class="text-xs text-zinc-400">Claim Code</label>
        <input name="claim_code" class="w-full mt-1 rounded bg-zinc-950 border border-zinc-700 p-2" required />
      </div>
      <button class="bg-indigo-600 hover:bg-indigo-500 rounded px-4 py-2 font-medium">Claim Device</button>
      <p id="result" class="text-xs text-zinc-400"></p>
      </form>
    </div>

    <a href="/printellect/devices" class="inline-block text-indigo-300 underline">View my devices</a>
  </main>

  <script>
    document.getElementById('claimForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = Object.fromEntries(fd.entries());
      const resp = await fetch('/api/printellect/pairing/claim', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload),
      });
      const text = await resp.text();
      let data = {};
      try { data = JSON.parse(text); } catch (_) {}
      document.getElementById('result').textContent = resp.ok
        ? `Claimed ${data.device_id || payload.device_id}. Device will come online after provisioning.`
        : (data.detail || data.error || 'Claim failed');
    });

    const scanBtn = document.getElementById('startScan');
    const preview = document.getElementById('preview');
    const scanResult = document.getElementById('scanResult');

    async function tryBarcodeDetector(stream) {
      if (!('BarcodeDetector' in window)) {
        scanResult.textContent = 'BarcodeDetector not supported on this browser. Enter details manually.';
        return;
      }
      const detector = new BarcodeDetector({formats: ['qr_code']});
      preview.srcObject = stream;
      preview.classList.remove('hidden');
      await preview.play();
      const loop = async () => {
        if (preview.readyState < 2) {
          requestAnimationFrame(loop);
          return;
        }
        const codes = await detector.detect(preview);
        if (codes && codes.length) {
          const raw = codes[0].rawValue || '';
          scanResult.textContent = `Scanned: ${raw}`;
          const url = new URL(raw.replace('printellect://pair', 'https://print.jcubhub.com/pair'));
          const deviceId = url.searchParams.get('device_id');
          const claim = url.searchParams.get('claim');
          if (deviceId && claim) {
            document.querySelector('input[name="device_id"]').value = deviceId;
            document.querySelector('input[name="claim_code"]').value = claim;
            preview.pause();
            preview.classList.add('hidden');
            stream.getTracks().forEach(t => t.stop());
            return;
          }
        }
        requestAnimationFrame(loop);
      };
      requestAnimationFrame(loop);
    }

    scanBtn.addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: 'environment'}});
        await tryBarcodeDetector(stream);
      } catch (err) {
        scanResult.textContent = 'Camera permission denied or unavailable. Enter details manually.';
      }
    });
  </script>
</body>
</html>
