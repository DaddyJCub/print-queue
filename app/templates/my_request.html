<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Request - {{ req.print_name or req.id[:8] }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-zinc-950 text-zinc-100">
  <div class="max-w-2xl mx-auto p-6">
    
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold">{{ req.print_name or 'My Request' }}</h1>
        <p class="text-zinc-400 text-sm">Request #{{ req.id[:8] }}</p>
      </div>
      <div class="flex gap-2 text-sm">
        <a id="my-requests-link" href="/my-requests" class="text-zinc-400 hover:text-zinc-200">‚Üê My Requests</a>
        <span class="text-zinc-600">|</span>
        <a href="/queue" class="text-indigo-400 hover:underline">View Queue</a>
      </div>
    </div>
    
    <script>
      // Check for saved token to link back to my requests
      const savedToken = sessionStorage.getItem('my_requests_token');
      if (savedToken) {
        const link = document.getElementById('my-requests-link');
        if (link) {
          link.href = '/my-requests/view?token=' + savedToken;
        }
      }
    </script>
    
    <!-- Status Banner -->
    {% set status_colors = {
      'NEW': 'bg-blue-600/20 border-blue-500/50 text-blue-300',
      'NEEDS_INFO': 'bg-orange-600/20 border-orange-500/50 text-orange-300',
      'APPROVED': 'bg-emerald-600/20 border-emerald-500/50 text-emerald-300',
      'PRINTING': 'bg-indigo-600/20 border-indigo-500/50 text-indigo-300',
      'DONE': 'bg-green-600/20 border-green-500/50 text-green-300',
      'PICKED_UP': 'bg-zinc-600/20 border-zinc-500/50 text-zinc-300',
      'REJECTED': 'bg-red-600/20 border-red-500/50 text-red-300',
      'CANCELLED': 'bg-zinc-600/20 border-zinc-500/50 text-zinc-300'
    } %}
    {% set status_messages = {
      'NEW': 'üìã Your request is awaiting review',
      'NEEDS_INFO': '‚ö†Ô∏è We need more information from you - please respond below',
      'APPROVED': '‚úì Approved and in queue',
      'PRINTING': 'üñ®Ô∏è Currently printing!',
      'DONE': '‚úÖ Print complete - ready for pickup',
      'PICKED_UP': 'üì¶ Picked up',
      'REJECTED': '‚ùå Request was rejected',
      'CANCELLED': 'üö´ Request was cancelled'
    } %}
    
    <div class="rounded-2xl border p-4 mb-6 {{ status_colors.get(req.status, 'bg-zinc-800 border-zinc-700') }}">
      <div class="font-semibold text-lg">{{ status_messages.get(req.status, req.status) }}</div>
      {% if req.status == 'NEEDS_INFO' %}
        <p class="text-sm mt-2 opacity-80">Please scroll down to send a reply or upload additional files.</p>
      {% endif %}
    </div>
    
    <!-- Live Printer View (when PRINTING) -->
    {% if req.status == 'PRINTING' and printer_status %}
      <div class="bg-gradient-to-br from-indigo-900/30 to-purple-900/20 border border-indigo-500/30 rounded-2xl p-5 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-semibold flex items-center gap-2">
            <span class="inline-block w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
            Live Print Progress
          </h2>
          <span class="text-xs text-zinc-400">{{ req.printer }}</span>
        </div>
        
        <!-- Camera Preview -->
        <div class="mb-4">
          <button onclick="toggleCamera()" id="camera-toggle" class="text-xs text-indigo-400 hover:text-indigo-300 flex items-center gap-1 mb-2">
            üì∑ Show Live View
          </button>
          <div id="camera-preview" class="hidden">
            <img id="camera-img" src="" alt="Camera preview" 
                 class="w-full rounded-lg border border-zinc-700 bg-zinc-800" 
                 onerror="this.src=''; this.alt='Camera unavailable'"/>
            <div class="text-xs text-zinc-500 mt-1">Updates every 10 seconds</div>
          </div>
        </div>
        
        <!-- Progress Bar -->
        {% if printer_status.progress is not none %}
          <div class="mb-4">
            <div class="flex justify-between text-sm mb-1">
              <span class="text-zinc-400">Progress</span>
              <span class="font-semibold text-indigo-300">{{ printer_status.progress }}%</span>
            </div>
            <div class="h-3 bg-zinc-800 rounded-full overflow-hidden">
              <div class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-500" 
                   style="width: {{ printer_status.progress }}%"></div>
            </div>
          </div>
        {% endif %}
        
        <!-- Stats Grid -->
        <div class="grid grid-cols-2 gap-3 text-sm">
          {% if printer_status.current_layer and printer_status.total_layers %}
            <div class="bg-zinc-900/50 rounded-xl p-3">
              <span class="text-zinc-500 text-xs">Layer</span>
              <p class="font-semibold">{{ printer_status.current_layer }} / {{ printer_status.total_layers }}</p>
            </div>
          {% endif %}
          {% if smart_eta_display %}
            <div class="bg-zinc-900/50 rounded-xl p-3">
              <span class="text-zinc-500 text-xs">Est. Completion</span>
              <p class="font-semibold text-emerald-300">{{ smart_eta_display }}</p>
            </div>
          {% endif %}
          {% if printer_status.temp %}
            <div class="bg-zinc-900/50 rounded-xl p-3">
              <span class="text-zinc-500 text-xs">Temperature</span>
              <p class="font-semibold">{{ printer_status.temp }}¬∞C</p>
            </div>
          {% endif %}
          <div class="bg-zinc-900/50 rounded-xl p-3">
            <span class="text-zinc-500 text-xs">Status</span>
            <p class="font-semibold">{{ printer_status.status }}</p>
          </div>
        </div>
      </div>
      
      <script>
        let cameraInterval = null;
        const printerCode = "{{ req.printer }}";
        
        function toggleCamera() {
          const preview = document.getElementById('camera-preview');
          const toggle = document.getElementById('camera-toggle');
          
          if (preview.classList.contains('hidden')) {
            preview.classList.remove('hidden');
            toggle.innerHTML = 'üì∑ Hide Live View';
            refreshCamera();
            cameraInterval = setInterval(refreshCamera, 10000);
          } else {
            preview.classList.add('hidden');
            toggle.innerHTML = 'üì∑ Show Live View';
            if (cameraInterval) {
              clearInterval(cameraInterval);
              cameraInterval = null;
            }
          }
        }
        
        function refreshCamera() {
          const img = document.getElementById('camera-img');
          if (img) {
            img.src = `/api/camera/${printerCode}/snapshot?t=${Date.now()}`;
          }
        }
      </script>
    {% endif %}
    
    <!-- Completion Snapshot (for DONE status) -->
    {% if req.status == 'DONE' and req.completion_snapshot %}
      <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5 mb-6">
        <h2 class="font-semibold mb-4">üì∏ Completion Snapshot</h2>
        <img src="data:image/jpeg;base64,{{ req.completion_snapshot }}" 
             alt="Print completion snapshot"
             class="w-full rounded-xl border border-zinc-700 cursor-pointer hover:opacity-90 transition"
             onclick="showSnapshot(this.src)" />
      </div>
    {% endif %}
    
    <!-- Request Details -->
    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5 mb-6">
      <h2 class="font-semibold mb-4">Request Details</h2>
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div>
          <span class="text-zinc-500">Printer</span>
          <p class="font-medium">{{ req.printer or 'ANY' }}</p>
        </div>
        <div>
          <span class="text-zinc-500">Material</span>
          <p class="font-medium">{{ req.material }}</p>
        </div>
        <div>
          <span class="text-zinc-500">Colors</span>
          <p class="font-medium">{{ req.colors }}</p>
        </div>
        <div>
          <span class="text-zinc-500">Submitted</span>
          <p class="font-medium">{{ req.created_at|localtime }}</p>
        </div>
      </div>
      
      {% if req.link_url %}
        <div class="mt-4 pt-4 border-t border-zinc-800">
          <span class="text-zinc-500 text-sm">Model Link</span>
          <a href="{{ req.link_url }}" target="_blank" class="block text-indigo-400 hover:underline truncate">{{ req.link_url }}</a>
        </div>
      {% endif %}
      
      {% if req.notes %}
        <div class="mt-4 pt-4 border-t border-zinc-800">
          <span class="text-zinc-500 text-sm">Your Notes</span>
          <p class="mt-1 text-sm">{{ req.notes }}</p>
        </div>
      {% endif %}
    </div>
    
    <!-- Files -->
    {% if files %}
      <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5 mb-6">
        <h2 class="font-semibold mb-4">üìÅ Files</h2>
        <p class="text-xs text-zinc-500 mb-3">.3mf, .fpp, .gcode, .obj, .step, .stl, .stp, .zip ‚Ä¢ 200MB max</p>
        <div class="space-y-2">
          {% for f in files %}
            <div class="bg-zinc-950/60 border border-zinc-800 rounded-xl p-3">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3 min-w-0 flex-1">
                  <span class="text-emerald-400 flex-shrink-0">üìÑ</span>
                  <span class="text-sm truncate">{{ f.original_filename }}</span>
                </div>
                <span class="text-xs text-zinc-500 flex-shrink-0 ml-2">{{ (f.size_bytes / 1024)|round(1) }} KB</span>
              </div>
              <div class="text-xs text-zinc-500 mt-1 ml-7">Uploaded {{ f.created_at|localtime('%b %d, %Y at %I:%M %p') }}</div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
    
    <!-- Messages / Communication -->
    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5 mb-6">
      <h2 class="font-semibold mb-4">üí¨ Messages</h2>
      
      {% if messages %}
        <div class="space-y-3 mb-6 max-h-80 overflow-y-auto">
          {% for msg in messages %}
            {% if msg.sender_type == 'admin' %}
              <div class="flex justify-start">
                <div class="bg-indigo-600/20 border border-indigo-500/30 rounded-2xl rounded-bl-md px-4 py-2 max-w-[85%]">
                  <p class="text-sm">{{ msg.message }}</p>
                  <span class="text-xs text-zinc-500 mt-1 block">Admin ‚Ä¢ {{ msg.created_at|localtime }}</span>
                </div>
              </div>
            {% else %}
              <div class="flex justify-end">
                <div class="bg-emerald-600/20 border border-emerald-500/30 rounded-2xl rounded-br-md px-4 py-2 max-w-[85%]">
                  <p class="text-sm">{{ msg.message }}</p>
                  <span class="text-xs text-zinc-500 mt-1 block">You ‚Ä¢ {{ msg.created_at|localtime }}</span>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      {% else %}
        <p class="text-sm text-zinc-500 mb-4">No messages yet. If the admin has questions, they'll appear here.</p>
      {% endif %}
      
      <!-- Reply Form (always show for active requests) -->
      {% if req.status not in ['PICKED_UP', 'REJECTED', 'CANCELLED'] %}
        <form method="POST" action="/my/{{ req.id }}/reply?token={{ token }}" class="space-y-3">
          <textarea name="message" rows="3" 
                    placeholder="Type your message here..."
                    class="w-full rounded-xl bg-zinc-950 border border-zinc-800 p-3 text-sm resize-none focus:border-indigo-500 focus:outline-none"
                    required></textarea>
          <button type="submit" class="rounded-xl bg-indigo-600 hover:bg-indigo-500 transition px-4 py-2 text-sm font-semibold">
            Send Reply
          </button>
        </form>
      {% endif %}
    </div>
    
    <!-- Add Files Section (for NEEDS_INFO or NEW status) -->
    {% if req.status in ['NEW', 'NEEDS_INFO'] %}
      <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5 mb-6">
        <h2 class="font-semibold mb-4">üìé Add More Files</h2>
        <form method="POST" action="/my/{{ req.id }}/upload?token={{ token }}" enctype="multipart/form-data" class="space-y-3">
          <input type="file" name="files" multiple accept=".stl,.obj,.3mf,.gcode,.step,.stp,.fpp,.zip"
                 class="w-full rounded-xl bg-zinc-950 border border-zinc-800 p-3 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-indigo-600 file:text-white file:font-semibold file:cursor-pointer" />
          <p class="text-xs text-zinc-500">Accepted formats: STL, OBJ, 3MF, GCODE, STEP, FPP, ZIP</p>
          <button type="submit" class="rounded-xl bg-emerald-600 hover:bg-emerald-500 transition px-4 py-2 text-sm font-semibold">
            Upload Files
          </button>
        </form>
      </div>
    {% endif %}
    
    <!-- Edit Request -->
    {% if req.status in ['NEW', 'NEEDS_INFO'] %}
      <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5 mb-6">
        <h2 class="font-semibold mb-4">‚úèÔ∏è Edit Request</h2>
        <form method="POST" action="/my/{{ req.id }}/edit?token={{ token }}" class="space-y-4">
          <div>
            <label class="text-sm text-zinc-400">Print Name</label>
            <input type="text" name="print_name" value="{{ req.print_name or '' }}"
                   class="w-full mt-1 rounded-xl bg-zinc-950 border border-zinc-800 p-3 text-sm focus:border-indigo-500 focus:outline-none" />
          </div>
          <div>
            <label class="text-sm text-zinc-400">Model Link (optional)</label>
            <input type="url" name="link_url" value="{{ req.link_url or '' }}"
                   placeholder="https://www.thingiverse.com/thing:..."
                   class="w-full mt-1 rounded-xl bg-zinc-950 border border-zinc-800 p-3 text-sm focus:border-indigo-500 focus:outline-none" />
          </div>
          <div>
            <label class="text-sm text-zinc-400">Additional Notes</label>
            <textarea name="notes" rows="3"
                      class="w-full mt-1 rounded-xl bg-zinc-950 border border-zinc-800 p-3 text-sm resize-none focus:border-indigo-500 focus:outline-none">{{ req.notes or '' }}</textarea>
          </div>
          <button type="submit" class="rounded-xl bg-amber-600 hover:bg-amber-500 transition px-4 py-2 text-sm font-semibold">
            Save Changes
          </button>
        </form>
      </div>
    {% elif req.status in ['APPROVED', 'PRINTING', 'DONE'] %}
      <!-- Read-only details for in-progress requests -->
      <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-semibold">‚úèÔ∏è Request Details</h2>
          <span class="text-xs text-zinc-500">Editing disabled while {{ req.status|lower }}</span>
        </div>
        <div class="space-y-3 text-sm">
          <div>
            <span class="text-zinc-500">Print Name</span>
            <p class="mt-1">{{ req.print_name or '‚Äî' }}</p>
          </div>
          {% if req.link_url %}
          <div>
            <span class="text-zinc-500">Model Link</span>
            <a href="{{ req.link_url }}" target="_blank" class="block mt-1 text-indigo-400 hover:underline truncate">{{ req.link_url }}</a>
          </div>
          {% endif %}
          {% if req.notes %}
          <div>
            <span class="text-zinc-500">Notes</span>
            <p class="mt-1 text-zinc-300">{{ req.notes }}</p>
          </div>
          {% endif %}
        </div>
      </div>
    {% endif %}
    
    <!-- Status History -->
    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5">
      <h2 class="font-semibold mb-4">üìú Status History</h2>
      <div class="space-y-2">
        {% for evt in history %}
          <div class="flex items-start gap-3 text-sm">
            <div class="w-2 h-2 mt-2 rounded-full bg-indigo-500"></div>
            <div class="flex-1">
              <div class="font-medium">{{ evt.to_status }}</div>
              {% if evt.comment %}
                <p class="text-zinc-400 text-xs mt-1">{{ evt.comment }}</p>
              {% endif %}
              <span class="text-xs text-zinc-500">{{ evt.created_at|localtime }}</span>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
    
    <!-- Actions Section -->
    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5 mt-6">
      <h2 class="font-semibold mb-4">‚ö° Actions</h2>
      <div class="flex flex-wrap gap-3">
        <!-- Cancel (for active requests not yet printing) -->
        {% if req.status in ['NEW', 'NEEDS_INFO', 'APPROVED'] %}
          <button onclick="confirmCancel()" class="rounded-xl bg-red-600/20 border border-red-500/50 hover:bg-red-600/30 transition px-4 py-2 text-sm font-semibold text-red-300">
            üö´ Cancel Request
          </button>
        {% endif %}
        
        <!-- Resubmit (for closed requests) -->
        {% if req.status in ['CANCELLED', 'REJECTED', 'PICKED_UP'] %}
          <form method="POST" action="/my/{{ req.id }}/resubmit?token={{ token }}" class="inline">
            <button type="submit" class="rounded-xl bg-emerald-600/20 border border-emerald-500/50 hover:bg-emerald-600/30 transition px-4 py-2 text-sm font-semibold text-emerald-300">
              üîÑ Request Again
            </button>
          </form>
        {% endif %}
        
        <!-- View in Queue -->
        <a href="/queue?mine={{ req.id[:8] }}" class="rounded-xl bg-indigo-600/20 border border-indigo-500/50 hover:bg-indigo-600/30 transition px-4 py-2 text-sm font-semibold text-indigo-300">
          üìã View in Queue
        </a>
        
        <!-- Submit New Request -->
        <a href="/" class="rounded-xl bg-zinc-700/50 border border-zinc-600/50 hover:bg-zinc-700 transition px-4 py-2 text-sm font-semibold text-zinc-300">
          ‚ûï New Request
        </a>
      </div>
    </div>
    
    <div class="mt-6 pt-4 border-t border-zinc-800 text-center text-xs text-zinc-500">
      <div class="flex items-center gap-3">
        <a href="/feedback?type=bug" class="hover:text-red-400 transition" title="Report a Bug">üêõ</a>
        <a href="/feedback?type=suggestion" class="hover:text-yellow-400 transition" title="Submit a Suggestion">üí°</a>
        <a href="/changelog" class="hover:text-indigo-400 transition">v{{ version }}</a>
      </div>
    </div>
  </div>
  
  <!-- Cancel Confirmation Modal -->
  <div id="cancel-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-zinc-900 border border-zinc-700 rounded-2xl p-6 max-w-sm mx-4">
      <h3 class="text-lg font-semibold mb-3">Cancel Request?</h3>
      <p class="text-sm text-zinc-400 mb-6">Are you sure you want to cancel this print request? This action cannot be undone, but you can always submit a new request.</p>
      <div class="flex gap-3">
        <button onclick="hideCancelModal()" class="flex-1 rounded-xl bg-zinc-700 hover:bg-zinc-600 transition px-4 py-2 text-sm font-semibold">
          Keep Request
        </button>
        <form method="POST" action="/my/{{ req.id }}/cancel?token={{ token }}" class="flex-1">
          <button type="submit" class="w-full rounded-xl bg-red-600 hover:bg-red-500 transition px-4 py-2 text-sm font-semibold">
            Yes, Cancel
          </button>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Snapshot Modal -->
  <div id="snapshot-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50 p-4" onclick="hideSnapshot()">
    <img id="snapshot-img" src="" class="max-w-full max-h-full rounded-xl border border-zinc-700" />
  </div>
  
  <script>
    function confirmCancel() {
      const modal = document.getElementById('cancel-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    
    function hideCancelModal() {
      const modal = document.getElementById('cancel-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
    
    function showSnapshot(src) {
      const modal = document.getElementById('snapshot-modal');
      const img = document.getElementById('snapshot-img');
      img.src = src;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    
    function hideSnapshot() {
      const modal = document.getElementById('snapshot-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
    
    // Close modals on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        hideCancelModal();
        hideSnapshot();
      }
    });
  </script>
</body>
</html>