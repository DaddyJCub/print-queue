<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Request - {{ req.print_name or req.id[:8] }}</title>
  <!-- PWA Support -->
  <link rel="manifest" href="/static/manifest.json" />
  <meta name="theme-color" content="#6366f1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <link rel="apple-touch-icon" href="/static/icons/icon-192.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
        // --- Service Worker Diagnostics Helpers ---
        
        /**
         * Get detailed SW status for diagnostics
         */
        function getSWStatus() {
          const status = {
            supported: 'serviceWorker' in navigator,
            isSecureContext: window.isSecureContext,
            origin: location.origin,
            controller: null,
            registration: null,
            timestamp: new Date().toISOString()
          };
          
          if (status.supported) {
            const ctrl = navigator.serviceWorker.controller;
            status.controller = ctrl ? {
              scriptURL: ctrl.scriptURL,
              state: ctrl.state
            } : null;
          }
          return status;
        }
        
        /**
         * Log SW diagnostic info to console
         */
        function logSWDiagnostics(context, extra = {}) {
          const status = getSWStatus();
          console.log(`[SW Diagnostics] ${context}:`, { ...status, ...extra });
          return status;
        }
        
        /**
         * Ensure SW is registered and get a ready registration.
         * Handles first-install case by waiting for activation.
         * @param {number} timeout - Max wait time in ms
         * @returns {Promise<ServiceWorkerRegistration>}
         */
        async function getServiceWorkerRegistrationOrThrow(timeout = 15000) {
          logSWDiagnostics('getServiceWorkerRegistrationOrThrow called');
          
          if (!('serviceWorker' in navigator)) {
            throw new Error('Service Workers are not supported in this browser.');
          }
          
          if (!window.isSecureContext) {
            throw new Error(`Service Workers require HTTPS. Current origin: ${location.origin}`);
          }
          
          const start = performance.now();
          
          // Step 1: Ensure SW is registered
          let registration;
          try {
            registration = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
            logSWDiagnostics('SW registered', { 
              scope: registration.scope,
              installing: !!registration.installing,
              waiting: !!registration.waiting,
              active: !!registration.active
            });
          } catch (regErr) {
            throw new Error(`SW registration failed: ${regErr.message}. Check if /sw.js is accessible.`);
          }
          
          // Step 2: Wait for SW to be active
          if (!registration.active) {
            const sw = registration.installing || registration.waiting;
            if (sw) {
              logSWDiagnostics('SW not active yet, waiting for activation', { state: sw.state });
              await new Promise((resolve, reject) => {
                const timeoutId = setTimeout(() => {
                  reject(new Error(`SW activation timeout after ${timeout}ms`));
                }, timeout);
                
                sw.addEventListener('statechange', () => {
                  logSWDiagnostics('SW state changed', { newState: sw.state });
                  if (sw.state === 'activated') {
                    clearTimeout(timeoutId);
                    resolve();
                  } else if (sw.state === 'redundant') {
                    clearTimeout(timeoutId);
                    reject(new Error('SW became redundant (replaced or error during install)'));
                  }
                });
                
                // Also resolve if already activated
                if (sw.state === 'activated') {
                  clearTimeout(timeoutId);
                  resolve();
                }
              });
            } else {
              throw new Error('No SW found (installing, waiting, or active)');
            }
          }
          
          // Step 3: Wait for navigator.serviceWorker.ready (guarantees active SW)
          try {
            const readyReg = await Promise.race([
              navigator.serviceWorker.ready,
              new Promise((_, rej) => setTimeout(() => rej(new Error('SW ready timeout')), timeout))
            ]);
            logSWDiagnostics('SW ready', { 
              elapsed: Math.round(performance.now() - start),
              activeScriptURL: readyReg.active?.scriptURL 
            });
            return readyReg;
          } catch (e) {
            throw new Error(`SW not ready: ${e.message}`);
          }
        }
        
        /**
         * Wait for this page to be controlled by the SW (optional, for postMessage etc)
         */
        async function ensureController(timeout = 5000) {
          if (navigator.serviceWorker.controller) {
            return navigator.serviceWorker.controller;
          }
          
          logSWDiagnostics('No controller yet, waiting for controllerchange');
          return new Promise((resolve, reject) => {
            const timeoutId = setTimeout(() => {
              // Controller not strictly required for push subscription
              logSWDiagnostics('Controller wait timeout - proceeding anyway');
              resolve(null);
            }, timeout);
            
            navigator.serviceWorker.addEventListener('controllerchange', () => {
              clearTimeout(timeoutId);
              logSWDiagnostics('Controller changed', { controller: navigator.serviceWorker.controller?.scriptURL });
              resolve(navigator.serviceWorker.controller);
            }, { once: true });
          });
        }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js', {scope: '/'})
          .then(reg => console.log('[SW] Registered:', reg.scope))
          .catch(err => console.error('[SW] Registration failed:', err));
      });
    }
  </script>
</head>
<body class="bg-zinc-950 text-zinc-100">
  <div class="max-w-2xl mx-auto p-6">
    
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold">{{ req.print_name or 'My Request' }}</h1>
        <p class="text-zinc-400 text-sm">Request #{{ req.id[:8] }}</p>
      </div>
      <div class="flex gap-2 text-sm">
        <a id="my-requests-link" href="/my-requests" class="text-zinc-400 hover:text-zinc-200">‚Üê My Requests</a>
        <span class="text-zinc-600">|</span>
        <a href="/queue" class="text-indigo-400 hover:underline">View Queue</a>
      </div>
    </div>
    
    <script>
      // Check for saved token to link back to my requests (use localStorage for persistence)
      const savedToken = localStorage.getItem('my_requests_token');
      if (savedToken) {
        const link = document.getElementById('my-requests-link');
        if (link) {
          link.href = '/my-requests/view?token=' + savedToken;
        }
      }
    </script>
    
    <!-- Open in App Banner (shown when viewing in browser but PWA may be installed) -->
    <div id="open-in-app-banner" class="hidden bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-4 mb-6 shadow-lg">
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <span class="text-2xl">üì±</span>
          <div>
            <h3 class="font-medium">Open in App</h3>
            <p class="text-xs text-indigo-200">For the best experience with push notifications</p>
          </div>
        </div>
        <div class="flex gap-2">
          <button onclick="openInApp()" class="px-4 py-2 bg-white text-indigo-700 rounded-lg text-sm font-semibold hover:bg-indigo-50 transition">
            Open App
          </button>
          <button onclick="dismissOpenInApp()" class="px-3 py-2 bg-indigo-700/50 rounded-lg text-sm hover:bg-indigo-700 transition">
            ‚úï
          </button>
        </div>
      </div>
    </div>
    <script>
      // Show "Open in App" banner if viewing in browser but likely has PWA installed
      (function() {
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
        const hasDismissed = localStorage.getItem('open_in_app_dismissed');
        const hasUsedPWA = localStorage.getItem('pwa_used'); // Set when running as PWA
        
        // If we're in the PWA, mark it as used
        if (isStandalone) {
          localStorage.setItem('pwa_used', 'true');
        }
        
        // Show banner if: not in PWA, has used PWA before, hasn't dismissed
        if (!isStandalone && hasUsedPWA && !hasDismissed) {
          document.getElementById('open-in-app-banner').classList.remove('hidden');
        }
      })();
      
      function openInApp() {
        // Try to open the current URL - on Android this may open the PWA if installed
        // On iOS, we can only suggest manual action
        const currentUrl = window.location.href;
        
        // For Android, we can try an intent-like approach
        // But mainly this serves as a reminder to manually switch
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        
        if (isIOS) {
          alert('To open in the app:\\n\\n1. Open your home screen\\n2. Tap the Printellect app icon\\n3. Navigate to this request');
        } else {
          // On Android, closing browser and opening app is the only reliable way
          // We can try copying the URL to clipboard
          if (navigator.clipboard) {
            navigator.clipboard.writeText(currentUrl).then(() => {
              alert('URL copied!\\n\\nOpen the Printellect app from your home screen and paste the link, or navigate to your request.');
            }).catch(() => {
              alert('To view in the app:\\n\\nOpen the Printellect app from your home screen and navigate to your request.');
            });
          } else {
            alert('To view in the app:\\n\\nOpen the Printellect app from your home screen and navigate to your request.');
          }
        }
      }
      
      function dismissOpenInApp() {
        localStorage.setItem('open_in_app_dismissed', 'true');
        document.getElementById('open-in-app-banner').classList.add('hidden');
      }
    </script>

    <!-- Status Banner -->
    {% set status_colors = {
      'NEW': 'bg-blue-600/20 border-blue-500/50 text-blue-300',
      'NEEDS_INFO': 'bg-orange-600/20 border-orange-500/50 text-orange-300',
      'APPROVED': 'bg-emerald-600/20 border-emerald-500/50 text-emerald-300',
      'PRINTING': 'bg-indigo-600/20 border-indigo-500/50 text-indigo-300',
      'DONE': 'bg-green-600/20 border-green-500/50 text-green-300',
      'PICKED_UP': 'bg-zinc-600/20 border-zinc-500/50 text-zinc-300',
      'REJECTED': 'bg-red-600/20 border-red-500/50 text-red-300',
      'CANCELLED': 'bg-zinc-600/20 border-zinc-500/50 text-zinc-300'
    } %}
    {% set status_messages = {
      'NEW': 'üìã Your request is awaiting review',
      'NEEDS_INFO': '‚ö†Ô∏è We need more information from you - please respond below',
      'APPROVED': '‚úì Approved and in queue',
      'PRINTING': 'üñ®Ô∏è Currently printing!',
      'DONE': '‚úÖ Print complete - ready for pickup',
      'PICKED_UP': 'üì¶ Picked up',
      'REJECTED': '‚ùå Request was rejected',
      'CANCELLED': 'üö´ Request was cancelled'
    } %}
    
    <div class="rounded-2xl border p-4 mb-6 {{ status_colors.get(req.status, 'bg-zinc-800 border-zinc-700') }}">
      <div class="font-semibold text-lg">{{ status_messages.get(req.status, req.status) }}</div>
      {% if req.status == 'NEEDS_INFO' %}
        <p class="text-sm mt-2 opacity-80">Please scroll down to send a reply or upload additional files.</p>
      {% endif %}
    </div>
    
    <!-- PWA Install Tip (shown if not installed) -->
    <div id="pwa-install-tip" class="hidden bg-gradient-to-r from-indigo-900/40 to-purple-900/30 border border-indigo-500/30 rounded-2xl p-4 mb-6">
      <div class="flex items-start gap-3">
        <span class="text-2xl">üì≤</span>
        <div class="flex-1">
          <h3 class="font-medium text-indigo-200">Install this App</h3>
          <p class="text-xs text-zinc-400 mt-1">Add to your home screen for quick access, push notifications, and to stay logged in automatically.</p>
          <div id="pwa-install-instructions" class="text-xs text-zinc-500 mt-2"></div>
          <div class="flex gap-2 mt-3">
            <button id="pwa-install-btn" onclick="installPWA()" class="hidden px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-xs font-medium transition">
              Install Now
            </button>
            <button onclick="dismissPWATip()" class="px-3 py-1.5 bg-zinc-700 hover:bg-zinc-600 rounded-lg text-xs text-zinc-300 transition">
              Maybe Later
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Notification Settings -->
    <div id="notification-section" class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-4 mb-6">
      <h3 class="font-medium mb-3 flex items-center gap-2">
        üîî Notification Settings
      </h3>

      <!-- Push Notification Status Banner (shown if not enabled) -->
      <div id="push-status-banner" class="hidden mb-3 p-3 rounded-xl border border-yellow-500/40 bg-yellow-900/20 text-yellow-200 flex items-center gap-2">
        <span class="text-xl">‚ö†Ô∏è</span>
        <span id="push-status-message">Push notifications are not enabled. Enable them below for instant updates.</span>
      </div>

      <!-- Email Notifications Toggle -->
      <div class="flex items-center justify-between py-2">
        <div>
          <span class="text-sm">Email Notifications</span>
          <p class="text-xs text-zinc-500">Receive status updates via email</p>
        </div>
        <button id="email-toggle" onclick="toggleEmailNotifications()" 
                class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none bg-indigo-600">
          <span id="email-toggle-dot" class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-6"></span>
        </button>
      </div>

      <!-- Push Notifications Toggle + Status -->
      <div class="flex items-center justify-between py-2 border-t border-zinc-800 mt-2 pt-3">
        <div>
          <span class="text-sm" id="push-label">Push Notifications</span>
          <p class="text-xs text-zinc-500" id="push-desc">Get instant alerts on your device</p>
          <div class="mt-1">
            <span id="push-status-indicator" class="inline-flex items-center text-xs font-medium"></span>
          </div>
        </div>
        <button id="push-toggle" onclick="togglePushNotifications()" 
                class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none bg-zinc-700">
          <span id="push-toggle-dot" class="inline-block h-4 w-4 transform rounded-full bg-zinc-400 transition-transform translate-x-1"></span>
        </button>
      </div>

      <!-- Push Diagnostics & Test -->
      <div class="mt-3 flex flex-col gap-2">
        <div class="flex items-center gap-2">
          <button id="test-push-btn" onclick="testPushNotification()" class="px-3 py-1.5 bg-indigo-700 hover:bg-indigo-600 rounded-lg text-xs font-medium text-white transition">Test Notification</button>
          <button onclick="showSWDebugPanel()" class="px-3 py-1.5 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-xs font-medium text-zinc-300 transition">üîß Debug</button>
        </div>
        <div id="push-diagnostics" class="text-xs text-zinc-400 whitespace-pre-wrap"></div>
      </div>
      
      <!-- SW Debug Panel (hidden by default) -->
      <div id="sw-debug-panel" class="hidden mt-3 p-3 bg-zinc-900 border border-zinc-700 rounded-xl text-xs font-mono">
        <div class="flex items-center justify-between mb-2">
          <span class="font-semibold text-zinc-300">Service Worker Debug</span>
          <button onclick="document.getElementById('sw-debug-panel').classList.add('hidden')" class="text-zinc-500 hover:text-zinc-300">‚úï</button>
        </div>
        <div id="sw-debug-content" class="text-zinc-400 whitespace-pre-wrap"></div>
        <div class="mt-2 flex gap-2">
          <button onclick="refreshSWDebug()" class="px-2 py-1 bg-zinc-800 hover:bg-zinc-700 rounded text-zinc-300">Refresh</button>
          <button onclick="unregisterAllSW()" class="px-2 py-1 bg-red-900/50 hover:bg-red-800 rounded text-red-300">Unregister SW</button>
        </div>
      </div>

      <!-- iOS Install Instructions (shown when needed) -->
      <div id="ios-install-hint" class="hidden mt-3 p-3 bg-blue-900/30 border border-blue-500/30 rounded-xl">
        <p class="text-xs text-blue-300">
          <strong>üì± iPhone/iPad:</strong> To get push notifications, first install this app: 
          tap <span class="inline-block px-1 bg-zinc-700 rounded">Share</span> ‚Üí 
          <span class="inline-block px-1 bg-zinc-700 rounded">Add to Home Screen</span>, 
          then open from your home screen.
        </p>
      </div>

      <p class="text-xs text-zinc-600 mt-3 pt-2 border-t border-zinc-800">
        üí° Tip: Enable push and disable email for instant notifications without inbox clutter.
      </p>
    </div>
    
    <script>
      // Notification Preferences Management
      const requestId = '{{ req.id }}';
      const requestEmail = '{{ req.requester_email }}';
      const token = new URLSearchParams(window.location.search).get('token');
      
      // State
      let emailEnabled = true;
      let pushEnabled = false;
      let deferredPrompt = null;
      
      // Check if running as installed PWA
      function isInstalledPWA() {
        return window.matchMedia('(display-mode: standalone)').matches || 
               window.navigator.standalone === true;
      }
      
      // Detect device type
      function getDeviceType() {
        const ua = navigator.userAgent;
        if (/iPad|iPhone|iPod/.test(ua)) return 'ios';
        if (/Android/.test(ua)) return 'android';
        return 'desktop';
      }
      
      // Initialize everything
      async function initNotifications() {
        // Load saved preferences from server
        await loadPreferences();
        // Setup PWA install tip
        setupPWAInstallTip();
        // Setup push notifications section
        setupPushSection();
        // Show push status banner if not enabled
        updatePushStatusBanner();
      }
            // Update push status indicator and banner
            function updatePushStatusBanner() {
              const banner = document.getElementById('push-status-banner');
              const indicator = document.getElementById('push-status-indicator');
              let message = '';
              let status = '';
              if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                message = 'Push notifications are not supported on this device/browser.';
                status = '<span class="inline-flex items-center gap-1 text-red-400">‚ùå Not Supported</span>';
                banner.classList.remove('hidden');
              } else if (Notification.permission === 'denied') {
                message = 'Push notifications are blocked in your browser settings.';
                status = '<span class="inline-flex items-center gap-1 text-red-400">üö´ Blocked</span>';
                banner.classList.remove('hidden');
              } else if (!pushEnabled) {
                message = 'Push notifications are not enabled. Enable them below for instant updates.';
                status = '<span class="inline-flex items-center gap-1 text-yellow-400">‚ö†Ô∏è Disabled</span>';
                banner.classList.remove('hidden');
              } else {
                message = '';
                status = '<span class="inline-flex items-center gap-1 text-emerald-400">‚úÖ Enabled</span>';
                banner.classList.add('hidden');
              }
              document.getElementById('push-status-message').innerHTML = message;
              indicator.innerHTML = status;
            }

            // Diagnostics and test notification
            async function testPushNotification() {
              const diag = document.getElementById('push-diagnostics');
              diag.innerHTML = '<span class="text-zinc-500">‚è≥ Sending test notification...</span>';
              try {
                const resp = await fetch(`/api/push/test`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ email: requestEmail })
                });
                const result = await resp.json();
                console.log('[PUSH TEST] Result:', result);
                
                if (result.status === 'sent') {
                  diag.innerHTML = `<span class="text-emerald-400">‚úÖ Test notification sent!</span> Check your device.` +
                    `<br><small class="text-zinc-500">Sent to ${result.details?.sent || 0} subscription(s)</small>`;
                } else if (result.status === 'no_subscriptions') {
                  diag.innerHTML = `<span class="text-amber-400">‚ö†Ô∏è No subscriptions found for ${requestEmail}</span>` +
                    `<br><small class="text-zinc-500">Try disabling and re-enabling push notifications.</small>`;
                } else if (result.status === 'error') {
                  const errors = result.details?.errors?.join('<br>') || 'Unknown error';
                  diag.innerHTML = `<span class="text-red-400">‚ùå Failed to send:</span>` +
                    `<br><small class="text-zinc-500">${errors}</small>`;
                } else {
                  diag.innerHTML = `<span class="text-red-400">‚ùå Error: ${result.error || 'Unknown'}</span>`;
                }
              } catch (err) {
                diag.innerHTML = `<span class="text-red-400">‚ùå Network error: ${err.message}</span>`;
                console.error('[PUSH TEST] Error:', err);
              }
            }
      
      async function loadPreferences() {
        try {
          const resp = await fetch(`/api/notification-prefs/${requestId}?token=${token}`);
          if (resp.ok) {
            const prefs = await resp.json();
            emailEnabled = prefs.email !== false;
            pushEnabled = prefs.push === true;
            updateEmailToggleUI();
            updatePushToggleUI();
          }
        } catch (err) {
          console.error('Failed to load notification prefs:', err);
        }
      }
      
      async function savePreferences() {
        try {
          await fetch(`/api/notification-prefs/${requestId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: token, email: emailEnabled, push: pushEnabled })
          });
        } catch (err) {
          console.error('Failed to save notification prefs:', err);
        }
      }
      
      // PWA Install Tip
      function setupPWAInstallTip() {
        const tip = document.getElementById('pwa-install-tip');
        const installBtn = document.getElementById('pwa-install-btn');
        const iosHint = document.getElementById('ios-install-hint');
        
        // Don't show if already installed or dismissed
        if (isInstalledPWA() || localStorage.getItem('pwa_tip_dismissed')) {
          tip.style.display = 'none';
          return;
        }
        
        // Show the tip
        tip.classList.remove('hidden');
        
        const device = getDeviceType();
        if (device === 'ios') {
          // Show iOS instructions, hide install button
          iosHint.classList.remove('hidden');
          installBtn.style.display = 'none';
        } else {
          // Chrome/Edge: capture install prompt
          window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.classList.remove('hidden');
          });
        }
      }
      
      async function installPWA() {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const result = await deferredPrompt.userChoice;
        if (result.outcome === 'accepted') {
          document.getElementById('pwa-install-tip').style.display = 'none';
        }
        deferredPrompt = null;
      }
      
      function dismissPWATip() {
        localStorage.setItem('pwa_tip_dismissed', 'true');
        document.getElementById('pwa-install-tip').style.display = 'none';
      }
      
      // Email Toggle
      async function toggleEmailNotifications() {
        emailEnabled = !emailEnabled;
        updateEmailToggleUI();
        await savePreferences();
      }
      
      function updateEmailToggleUI() {
        const toggle = document.getElementById('email-toggle');
        const dot = document.getElementById('email-toggle-dot');
        
        if (emailEnabled) {
          toggle.classList.remove('bg-zinc-700');
          toggle.classList.add('bg-indigo-600');
          dot.classList.remove('translate-x-1', 'bg-zinc-400');
          dot.classList.add('translate-x-6', 'bg-white');
        } else {
          toggle.classList.add('bg-zinc-700');
          toggle.classList.remove('bg-indigo-600');
          dot.classList.add('translate-x-1', 'bg-zinc-400');
          dot.classList.remove('translate-x-6', 'bg-white');
        }
      }
      
      // Push Notifications
      function setupPushSection() {
        const iosHint = document.getElementById('ios-install-hint');
        const device = getDeviceType();
        // iOS-specific: Only allow push if installed as PWA
        if (device === 'ios') {
          if (!isInstalledPWA()) {
            iosHint.classList.remove('hidden');
            const toggle = document.getElementById('push-toggle');
            toggle.classList.add('opacity-50', 'cursor-not-allowed');
            toggle.onclick = null;
            const desc = document.getElementById('push-desc');
            desc.textContent = 'On iPhone/iPad, push notifications only work after installing this app to your home screen.';
            return;
          } else {
            iosHint.classList.add('hidden');
          }
        }
        // Check if push is supported
        if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
          // Disable the push toggle
          const toggle = document.getElementById('push-toggle');
          toggle.classList.add('opacity-50', 'cursor-not-allowed');
          toggle.onclick = null;
          return;
        }
        // If permission denied, disable toggle
        if (Notification.permission === 'denied') {
          const toggle = document.getElementById('push-toggle');
          toggle.classList.add('opacity-50', 'cursor-not-allowed');
          toggle.title = 'Notifications blocked in browser settings';
          toggle.onclick = null;
        }
        // Check if we have an existing subscription
        checkPushSubscription();
      }
      
      async function checkPushSubscription() {
        try {
          const registration = await navigator.serviceWorker.ready;
          const subscription = await registration.pushManager.getSubscription();
          if (subscription) {
            pushEnabled = true;
            updatePushToggleUI();
            // Also update server preference
            await savePreferences();
          }
        } catch (err) {
          console.log('Could not check push subscription:', err);
        }
      }
      
      async function togglePushNotifications() {
        if (pushEnabled) {
          await unsubscribeFromPush();
        } else {
          await subscribeToPush();
        }
      }
      
      async function subscribeToPush() {
        const toggle = document.getElementById('push-toggle');
        const diag = document.getElementById('push-diagnostics');
        const startTime = performance.now();
        
        const updateDiag = (msg, isError = false) => {
          const elapsed = Math.round(performance.now() - startTime);
          const prefix = isError ? '‚ùå ' : '‚è≥ ';
          diag.textContent = prefix + msg + ` [${elapsed}ms]`;
          console.log(`[Push Subscribe] ${msg}`, { elapsed });
        };
        
        try {
          toggle.classList.add('opacity-50');
          diag.textContent = '';
          
          // Step 1: Log initial diagnostics
          logSWDiagnostics('Starting push subscription');
          updateDiag('Requesting notification permission...');
          
          // Step 2: Request permission (must be from user gesture)
          const permission = await Notification.requestPermission();
          if (permission !== 'granted') {
            updateDiag(`Permission ${permission}. You must allow notifications.`, true);
            toggle.classList.remove('opacity-50');
            return;
          }
          updateDiag('Permission granted, fetching VAPID key...');
          
          // Step 3: Get VAPID key from server
          const resp = await fetch('/api/push/vapid-public-key');
          const data = await resp.json();
          if (!data.publicKey) {
            updateDiag('Push not configured on server (no VAPID key).', true);
            toggle.classList.remove('opacity-50');
            return;
          }
          updateDiag('Got VAPID key, getting SW registration...');
          
          // Step 4: Get service worker registration
          let registration;
          try {
            registration = await getServiceWorkerRegistrationOrThrow();
          } catch (err) {
            const status = getSWStatus();
            diag.innerHTML = `‚ùå ${err.message}<br><small style="color:#888">` +
              `origin: ${status.origin}<br>` +
              `secure: ${status.isSecureContext}<br>` +
              `controller: ${status.controller ? 'yes' : 'no'}</small>`;
            console.error('[Push Subscribe] SW error:', err, status);
            toggle.classList.remove('opacity-50');
            return;
          }
          updateDiag('SW ready, subscribing to push...');
          
          // Step 5: Subscribe to push
          let subscription;
          try {
            subscription = await registration.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: urlBase64ToUint8Array(data.publicKey)
            });
          } catch (subErr) {
            updateDiag(`Push subscribe failed: ${subErr.message}`, true);
            console.error('[Push Subscribe] PushManager.subscribe error:', subErr);
            toggle.classList.remove('opacity-50');
            return;
          }
          updateDiag('Subscribed locally, saving to server...');
          
          // Step 6: Send subscription to server
          const serverResp = await fetch('/api/push/subscribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: requestEmail,
              subscription: subscription.toJSON()
            })
          });
          if (!serverResp.ok) {
            const errText = await serverResp.text();
            updateDiag(`Server error: ${serverResp.status} ${errText}`, true);
            toggle.classList.remove('opacity-50');
            return;
          }
          
          // Success!
          pushEnabled = true;
          updatePushToggleUI();
          await savePreferences();
          const elapsed = Math.round(performance.now() - startTime);
          diag.textContent = `‚úÖ Push notifications enabled! [${elapsed}ms]`;
          console.log('[Push Subscribe] Success', { elapsed, endpoint: subscription.endpoint });
          toggle.classList.remove('opacity-50');
        } catch (err) {
          diag.textContent = `‚ùå Unexpected error: ${err.message}`;
          console.error('[Push Subscribe] Unexpected error:', err);
          toggle.classList.remove('opacity-50');
        }
      }
      
      async function unsubscribeFromPush() {
        const diag = document.getElementById('push-diagnostics');
        try {
          const registration = await navigator.serviceWorker.ready;
          const subscription = await registration.pushManager.getSubscription();
          if (subscription) {
            await subscription.unsubscribe();
            const resp = await fetch('/api/push/unsubscribe', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                email: requestEmail,
                endpoint: subscription.endpoint
              })
            });
            if (!resp.ok) {
              diag.textContent = '‚ùå Server error unsubscribing from push.';
            } else {
              diag.textContent = 'Push notifications disabled.';
            }
          }
          pushEnabled = false;
          updatePushToggleUI();
          await savePreferences();
        } catch (err) {
          diag.textContent = '‚ùå Error unsubscribing from push notifications.';
          console.error('Push unsubscribe error:', err);
        }
      }
      
      function updatePushToggleUI() {
        const toggle = document.getElementById('push-toggle');
        const dot = document.getElementById('push-toggle-dot');
        if (pushEnabled) {
          toggle.classList.remove('bg-zinc-700');
          toggle.classList.add('bg-indigo-600');
          dot.classList.remove('translate-x-1', 'bg-zinc-400');
          dot.classList.add('translate-x-6', 'bg-white');
        } else {
          toggle.classList.add('bg-zinc-700');
          toggle.classList.remove('bg-indigo-600');
          dot.classList.add('translate-x-1', 'bg-zinc-400');
          dot.classList.remove('translate-x-6', 'bg-white');
        }
        updatePushStatusBanner();
      }
      
      // Convert VAPID key
      function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      }
      
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SW DEBUG PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function showSWDebugPanel() {
        const panel = document.getElementById('sw-debug-panel');
        panel.classList.remove('hidden');
        await refreshSWDebug();
      }
      
      async function refreshSWDebug() {
        const content = document.getElementById('sw-debug-content');
        content.textContent = 'Loading...';
        
        const lines = [];
        
        // Client-side info
        lines.push('‚îÄ‚îÄ Client Info ‚îÄ‚îÄ');
        lines.push(`origin: ${location.origin}`);
        lines.push(`isSecureContext: ${window.isSecureContext}`);
        lines.push(`protocol: ${location.protocol}`);
        lines.push(`SW supported: ${'serviceWorker' in navigator}`);
        lines.push(`Push supported: ${'PushManager' in window}`);
        lines.push(`Notification permission: ${Notification.permission}`);
        
        // SW Registration
        lines.push('\n‚îÄ‚îÄ Service Worker ‚îÄ‚îÄ');
        if ('serviceWorker' in navigator) {
          try {
            const regs = await navigator.serviceWorker.getRegistrations();
            lines.push(`Registrations: ${regs.length}`);
            for (const reg of regs) {
              lines.push(`  scope: ${reg.scope}`);
              lines.push(`  active: ${reg.active?.scriptURL || 'none'} (${reg.active?.state || '-'})`);
              lines.push(`  installing: ${reg.installing?.scriptURL || 'none'} (${reg.installing?.state || '-'})`);
              lines.push(`  waiting: ${reg.waiting?.scriptURL || 'none'} (${reg.waiting?.state || '-'})`);
            }
            lines.push(`controller: ${navigator.serviceWorker.controller?.scriptURL || 'none'}`);
            
            // Try to get SW status via message
            if (navigator.serviceWorker.controller) {
              try {
                const swStatus = await new Promise((resolve, reject) => {
                  const mc = new MessageChannel();
                  mc.port1.onmessage = (e) => resolve(e.data);
                  setTimeout(() => reject(new Error('timeout')), 2000);
                  navigator.serviceWorker.controller.postMessage({ type: 'GET_SW_STATUS' }, [mc.port2]);
                });
                lines.push(`SW version: ${swStatus.version || 'unknown'}`);
              } catch (e) {
                lines.push(`SW message: ${e.message}`);
              }
            }
          } catch (e) {
            lines.push(`Error: ${e.message}`);
          }
        } else {
          lines.push('Not supported');
        }
        
        // Push subscription
        lines.push('\n‚îÄ‚îÄ Push Subscription ‚îÄ‚îÄ');
        try {
          const reg = await navigator.serviceWorker.ready;
          const sub = await reg.pushManager.getSubscription();
          if (sub) {
            lines.push(`endpoint: ${sub.endpoint.substring(0, 60)}...`);
            lines.push(`expirationTime: ${sub.expirationTime || 'none'}`);
          } else {
            lines.push('No active subscription');
          }
        } catch (e) {
          lines.push(`Error: ${e.message}`);
        }
        
        // Server-side info
        lines.push('\n‚îÄ‚îÄ Server Config ‚îÄ‚îÄ');
        try {
          const resp = await fetch('/api/sw/debug');
          const data = await resp.json();
          lines.push(`sw_file_exists: ${data.sw_file_exists}`);
          lines.push(`vapid_configured: ${data.vapid_configured}`);
          lines.push(`vapid_key_length: ${data.vapid_public_key_length}`);
          lines.push(`base_url: ${data.base_url}`);
        } catch (e) {
          lines.push(`Error: ${e.message}`);
        }
        
        // Server-side subscriptions for this email
        lines.push('\n‚îÄ‚îÄ Server Subscriptions ‚îÄ‚îÄ');
        lines.push(`email: ${requestEmail}`);
        try {
          const resp = await fetch(`/api/push/diagnostics/${encodeURIComponent(requestEmail)}`);
          const data = await resp.json();
          if (data.subscriptions && data.subscriptions.length > 0) {
            lines.push(`count: ${data.subscriptions.length}`);
            for (const sub of data.subscriptions) {
              lines.push(`  endpoint: ${sub.endpoint.substring(0, 50)}...`);
              lines.push(`  created: ${sub.created_at}`);
            }
          } else {
            lines.push('‚ö†Ô∏è NO SUBSCRIPTIONS FOUND ON SERVER');
            lines.push('The subscription may not have been saved correctly.');
          }
        } catch (e) {
          lines.push(`Error: ${e.message}`);
        }
        
        content.textContent = lines.join('\n');
      }
      
      async function unregisterAllSW() {
        if (!confirm('Unregister all service workers? You will need to reload the page.')) return;
        try {
          const regs = await navigator.serviceWorker.getRegistrations();
          for (const reg of regs) {
            await reg.unregister();
            console.log('[SW] Unregistered:', reg.scope);
          }
          alert('Service workers unregistered. Reloading page...');
          location.reload();
        } catch (e) {
          alert('Error: ' + e.message);
        }
      }
      
      // Initialize on page load
      document.addEventListener('DOMContentLoaded', initNotifications);
    </script>

    <!-- Live Printer View (when PRINTING) -->
    {% if req.status == 'PRINTING' and printer_status %}
      <div class="bg-gradient-to-br from-indigo-900/30 to-purple-900/20 border border-indigo-500/30 rounded-2xl p-5 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-semibold flex items-center gap-2">
            <span class="inline-block w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
            Live Print Progress
          </h2>
          <span class="text-xs text-zinc-400">{{ req.printer }}</span>
        </div>
        
        <!-- Camera Preview -->
        <div class="mb-4">
          <button onclick="toggleCamera()" id="camera-toggle" class="text-xs text-indigo-400 hover:text-indigo-300 flex items-center gap-1 mb-2">
            üì∑ Show Live View
          </button>
          <div id="camera-preview" class="hidden">
            <img id="camera-img" src="" alt="Camera preview" 
                 class="w-full rounded-lg border border-zinc-700 bg-zinc-800" 
                 onerror="this.src=''; this.alt='Camera unavailable'"/>
            <div class="text-xs text-zinc-500 mt-1">Updates every 10 seconds</div>
          </div>
        </div>
        
        <!-- Progress Bar -->
        {% if printer_status.progress is not none %}
          <div class="mb-4">
            <div class="flex justify-between text-sm mb-1">
              <span class="text-zinc-400">Progress</span>
              <span class="font-semibold text-indigo-300">{{ printer_status.progress }}%</span>
            </div>
            <div class="h-3 bg-zinc-800 rounded-full overflow-hidden">
                  <div class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-500"
                    style="width: {{ printer_status.progress|float|round(1) }}%;"></div>
            </div>
          </div>
        {% endif %}
        
        <!-- Stats Grid -->
        <div class="grid grid-cols-2 gap-3 text-sm">
          {% if printer_status.current_layer and printer_status.total_layers %}
            <div class="bg-zinc-900/50 rounded-xl p-3">
              <span class="text-zinc-500 text-xs">Layer</span>
              <p class="font-semibold">{{ printer_status.current_layer }} / {{ printer_status.total_layers }}</p>
            </div>
          {% endif %}
          {% if smart_eta_display %}
            <div class="bg-zinc-900/50 rounded-xl p-3">
              <span class="text-zinc-500 text-xs">Est. Completion</span>
              <p class="font-semibold text-emerald-300">{{ smart_eta_display }}</p>
            </div>
          {% endif %}
          {% if printer_status.temp %}
            <div class="bg-zinc-900/50 rounded-xl p-3">
              <span class="text-zinc-500 text-xs">Temperature</span>
              <p class="font-semibold">{{ printer_status.temp }}¬∞C</p>
            </div>
          {% endif %}
          <div class="bg-zinc-900/50 rounded-xl p-3">
            <span class="text-zinc-500 text-xs">Status</span>
            <p class="font-semibold">{{ printer_status.status }}</p>
          </div>
        </div>
      </div>
      
      <script>
        let cameraInterval = null;
        const printerCode = "{{ req.printer }}";
        
        function toggleCamera() {
          const preview = document.getElementById('camera-preview');
          const toggle = document.getElementById('camera-toggle');
          
          if (preview.classList.contains('hidden')) {
            preview.classList.remove('hidden');
            toggle.innerHTML = 'üì∑ Hide Live View';
            refreshCamera();
            cameraInterval = setInterval(refreshCamera, 10000);
          } else {
            preview.classList.add('hidden');
            toggle.innerHTML = 'üì∑ Show Live View';
            if (cameraInterval) {
              clearInterval(cameraInterval);
              cameraInterval = null;
            }
          }
        }
        
        function refreshCamera() {
          const img = document.getElementById('camera-img');
          if (img) {
            img.src = `/api/camera/${printerCode}/snapshot?t=${Date.now()}`;
          }
        }
      </script>
    {% endif %}
    
    <!-- Completion Snapshot (for DONE status) -->
    {% if req.status == 'DONE' and req.completion_snapshot %}
      <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5 mb-6">
        <h2 class="font-semibold mb-4">üì∏ Completion Snapshot</h2>
        <img src="data:image/jpeg;base64,{{ req.completion_snapshot }}" 
             alt="Print completion snapshot"
             class="w-full rounded-xl border border-zinc-700 cursor-pointer hover:opacity-90 transition"
             onclick="showSnapshot(this.src)" />
      </div>
    {% endif %}
    
    <!-- Request Details -->
    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5 mb-6">
      <h2 class="font-semibold mb-4">Request Details</h2>
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div>
          <span class="text-zinc-500">Printer</span>
          <p class="font-medium">{{ req.printer or 'ANY' }}</p>
        </div>
        <div>
          <span class="text-zinc-500">Material</span>
          <p class="font-medium">{{ req.material }}</p>
        </div>
        <div>
          <span class="text-zinc-500">Colors</span>
          <p class="font-medium">{{ req.colors }}</p>
        </div>
        <div>
          <span class="text-zinc-500">Submitted</span>
          <p class="font-medium">{{ req.created_at|localtime }}</p>
        </div>
      </div>
      
      {% if req.link_url %}
        <div class="mt-4 pt-4 border-t border-zinc-800">
          <span class="text-zinc-500 text-sm">Model Link</span>
          <a href="{{ req.link_url }}" target="_blank" class="block text-indigo-400 hover:underline truncate">{{ req.link_url }}</a>
        </div>
      {% endif %}
      
      {% if req.notes %}
        <div class="mt-4 pt-4 border-t border-zinc-800">
          <span class="text-zinc-500 text-sm">Your Notes</span>
          <p class="mt-1 text-sm">{{ req.notes }}</p>
        </div>
      {% endif %}
    </div>
    
    <!-- Files -->
    {% if files %}
      <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5 mb-6">
        <h2 class="font-semibold mb-4">üìÅ Files</h2>
        <p class="text-xs text-zinc-500 mb-3">.3mf, .fpp, .gcode, .obj, .step, .stl, .stp, .zip ‚Ä¢ 200MB max</p>
        <div class="space-y-2">
          {% for f in files %}
            <div class="bg-zinc-950/60 border border-zinc-800 rounded-xl p-3">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3 min-w-0 flex-1">
                  <span class="text-emerald-400 flex-shrink-0">üìÑ</span>
                  <span class="text-sm truncate">{{ f.original_filename }}</span>
                </div>
                <span class="text-xs text-zinc-500 flex-shrink-0 ml-2">{{ (f.size_bytes / 1024)|round(1) }} KB</span>
              </div>
              <div class="text-xs text-zinc-500 mt-1 ml-7">Uploaded {{ f.created_at|localtime('%b %d, %Y at %I:%M %p') }}</div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
    
    <!-- Messages / Communication -->
    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5 mb-6">
      <h2 class="font-semibold mb-4">üí¨ Messages</h2>
      
      {% if messages %}
        <div class="space-y-3 mb-6 max-h-80 overflow-y-auto">
          {% for msg in messages %}
            {% if msg.sender_type == 'admin' %}
              <div class="flex justify-start">
                <div class="bg-indigo-600/20 border border-indigo-500/30 rounded-2xl rounded-bl-md px-4 py-2 max-w-[85%]">
                  <p class="text-sm">{{ msg.message }}</p>
                  <span class="text-xs text-zinc-500 mt-1 block">Admin ‚Ä¢ {{ msg.created_at|localtime }}</span>
                </div>
              </div>
            {% else %}
              <div class="flex justify-end">
                <div class="bg-emerald-600/20 border border-emerald-500/30 rounded-2xl rounded-br-md px-4 py-2 max-w-[85%]">
                  <p class="text-sm">{{ msg.message }}</p>
                  <span class="text-xs text-zinc-500 mt-1 block">You ‚Ä¢ {{ msg.created_at|localtime }}</span>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      {% else %}
        <p class="text-sm text-zinc-500 mb-4">No messages yet. If the admin has questions, they'll appear here.</p>
      {% endif %}
      
      <!-- Reply Form (always show for active requests) -->
      {% if req.status not in ['PICKED_UP', 'REJECTED', 'CANCELLED'] %}
        <form method="POST" action="/my/{{ req.id }}/reply?token={{ token }}" class="space-y-3">
          <textarea name="message" rows="3" 
                    placeholder="Type your message here..."
                    class="w-full rounded-xl bg-zinc-950 border border-zinc-800 p-3 text-sm resize-none focus:border-indigo-500 focus:outline-none"
                    required></textarea>
          <button type="submit" class="rounded-xl bg-indigo-600 hover:bg-indigo-500 transition px-4 py-2 text-sm font-semibold">
            Send Reply
          </button>
        </form>
      {% endif %}
    </div>
    
    <!-- Add Files Section (for NEEDS_INFO or NEW status) -->
    {% if req.status in ['NEW', 'NEEDS_INFO'] %}
      <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5 mb-6">
        <h2 class="font-semibold mb-4">üìé Add More Files</h2>
        <form method="POST" action="/my/{{ req.id }}/upload?token={{ token }}" enctype="multipart/form-data" class="space-y-3" id="multi-upload-form">
          <div id="multi-drop-zone" 
               class="w-full border-2 border-dashed border-zinc-700 hover:border-emerald-500 rounded-xl p-6 text-center cursor-pointer transition-colors"
               ondrop="handleMultiDrop(event)" 
               ondragover="handleMultiDragOver(event)" 
               ondragleave="handleMultiDragLeave(event)"
               onclick="document.getElementById('multi-file-input').click()">
            <div id="multi-drop-content">
              <div class="text-3xl mb-2">üìÅ</div>
              <p class="text-zinc-400 text-sm">Drag & drop files here, or <span class="text-emerald-400">click to browse</span></p>
              <p class="text-xs text-zinc-500 mt-1">Multiple files allowed ‚Ä¢ STL, 3MF, OBJ, GCODE, STEP, ZIP</p>
            </div>
            <div id="multi-file-list" class="hidden space-y-2 text-left"></div>
          </div>
          <input id="multi-file-input" type="file" name="files" multiple accept=".stl,.obj,.3mf,.gcode,.step,.stp,.fpp,.zip" class="hidden" onchange="handleMultiSelect(this)" />
          <button type="submit" id="multi-upload-btn" class="hidden rounded-xl bg-emerald-600 hover:bg-emerald-500 transition px-4 py-2 text-sm font-semibold">
            Upload <span id="file-count">0</span> File(s)
          </button>
        </form>
        
        <script>
          let selectedFiles = [];
          function handleMultiDragOver(e) {
            e.preventDefault();
            document.getElementById('multi-drop-zone').classList.add('border-emerald-500', 'bg-emerald-500/10');
          }
          function handleMultiDragLeave(e) {
            e.preventDefault();
            document.getElementById('multi-drop-zone').classList.remove('border-emerald-500', 'bg-emerald-500/10');
          }
          function handleMultiDrop(e) {
            e.preventDefault();
            handleMultiDragLeave(e);
            addFiles(e.dataTransfer.files);
          }
          function handleMultiSelect(input) {
            addFiles(input.files);
          }
          function addFiles(files) {
            for (let f of files) {
              selectedFiles.push(f);
            }
            updateFileList();
          }
          function removeFile(idx) {
            selectedFiles.splice(idx, 1);
            updateFileList();
          }
          function updateFileList() {
            const listEl = document.getElementById('multi-file-list');
            const contentEl = document.getElementById('multi-drop-content');
            const btnEl = document.getElementById('multi-upload-btn');
            const countEl = document.getElementById('file-count');
            
            if (selectedFiles.length === 0) {
              listEl.classList.add('hidden');
              contentEl.classList.remove('hidden');
              btnEl.classList.add('hidden');
              return;
            }
            
            contentEl.classList.add('hidden');
            listEl.classList.remove('hidden');
            btnEl.classList.remove('hidden');
            countEl.textContent = selectedFiles.length;
            
            listEl.innerHTML = selectedFiles.map((f, i) => `
              <div class="flex items-center justify-between bg-zinc-950/50 rounded-lg px-3 py-2">
                <div class="flex items-center gap-2">
                  <span class="text-lg">üìÑ</span>
                  <span class="text-sm text-zinc-200">${f.name}</span>
                  <span class="text-xs text-zinc-500">${(f.size/1024/1024).toFixed(2)} MB</span>
                </div>
                <button type="button" onclick="removeFile(${i})" class="text-red-400 hover:text-red-300 text-sm">‚úï</button>
              </div>
            `).join('');
            
            // Update the actual input with selected files
            const dt = new DataTransfer();
            selectedFiles.forEach(f => dt.items.add(f));
            document.getElementById('multi-file-input').files = dt.files;
          }
        </script>
      </div>
    {% endif %}
    
    <!-- Edit Request -->
    {% if req.status in ['NEW', 'NEEDS_INFO'] %}
      <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5 mb-6">
        <h2 class="font-semibold mb-4">‚úèÔ∏è Edit Request</h2>
        <form method="POST" action="/my/{{ req.id }}/edit?token={{ token }}" class="space-y-4">
          <div>
            <label class="text-sm text-zinc-400">Print Name</label>
            <input type="text" name="print_name" value="{{ req.print_name or '' }}"
                   class="w-full mt-1 rounded-xl bg-zinc-950 border border-zinc-800 p-3 text-sm focus:border-indigo-500 focus:outline-none" />
          </div>
          <div>
            <label class="text-sm text-zinc-400">Model Link (optional)</label>
            <input type="url" name="link_url" value="{{ req.link_url or '' }}"
                   placeholder="https://www.thingiverse.com/thing:..."
                   class="w-full mt-1 rounded-xl bg-zinc-950 border border-zinc-800 p-3 text-sm focus:border-indigo-500 focus:outline-none" />
          </div>
          <div>
            <label class="text-sm text-zinc-400">Additional Notes</label>
            <textarea name="notes" rows="3"
                      class="w-full mt-1 rounded-xl bg-zinc-950 border border-zinc-800 p-3 text-sm resize-none focus:border-indigo-500 focus:outline-none">{{ req.notes or '' }}</textarea>
          </div>
          <button type="submit" class="rounded-xl bg-amber-600 hover:bg-amber-500 transition px-4 py-2 text-sm font-semibold">
            Save Changes
          </button>
        </form>
      </div>
    {% elif req.status in ['APPROVED', 'PRINTING', 'DONE'] %}
      <!-- Read-only details for in-progress requests -->
      <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-semibold">‚úèÔ∏è Request Details</h2>
          <span class="text-xs text-zinc-500">Editing disabled while {{ req.status|lower }}</span>
        </div>
        <div class="space-y-3 text-sm">
          <div>
            <span class="text-zinc-500">Print Name</span>
            <p class="mt-1">{{ req.print_name or '‚Äî' }}</p>
          </div>
          {% if req.link_url %}
          <div>
            <span class="text-zinc-500">Model Link</span>
            <a href="{{ req.link_url }}" target="_blank" class="block mt-1 text-indigo-400 hover:underline truncate">{{ req.link_url }}</a>
          </div>
          {% endif %}
          {% if req.notes %}
          <div>
            <span class="text-zinc-500">Notes</span>
            <p class="mt-1 text-zinc-300">{{ req.notes }}</p>
          </div>
          {% endif %}
        </div>
      </div>
    {% endif %}
    
    <!-- Status History -->
    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5">
      <h2 class="font-semibold mb-4">üìú Status History</h2>
      <div class="space-y-2">
        {% for evt in history %}
          <div class="flex items-start gap-3 text-sm">
            <div class="w-2 h-2 mt-2 rounded-full bg-indigo-500"></div>
            <div class="flex-1">
              <div class="font-medium">{{ evt.to_status }}</div>
              {% if evt.comment %}
                <p class="text-zinc-400 text-xs mt-1">{{ evt.comment }}</p>
              {% endif %}
              <span class="text-xs text-zinc-500">{{ evt.created_at|localtime }}</span>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
    
    <!-- Actions Section -->
    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5 mt-6">
      <h2 class="font-semibold mb-4">‚ö° Actions</h2>
      <div class="flex flex-wrap gap-3">
        <!-- Cancel (for active requests not yet printing) -->
        {% if req.status in ['NEW', 'NEEDS_INFO', 'APPROVED'] %}
          <button onclick="confirmCancel()" class="rounded-xl bg-red-600/20 border border-red-500/50 hover:bg-red-600/30 transition px-4 py-2 text-sm font-semibold text-red-300">
            üö´ Cancel Request
          </button>
        {% endif %}
        
        <!-- Resubmit (for closed requests) -->
        {% if req.status in ['CANCELLED', 'REJECTED', 'PICKED_UP'] %}
          <form method="POST" action="/my/{{ req.id }}/resubmit?token={{ token }}" class="inline">
            <button type="submit" class="rounded-xl bg-emerald-600/20 border border-emerald-500/50 hover:bg-emerald-600/30 transition px-4 py-2 text-sm font-semibold text-emerald-300">
              üîÑ Request Again
            </button>
          </form>
        {% endif %}
        
        <!-- View in Queue -->
        <a href="/queue?mine={{ req.id[:8] }}" class="rounded-xl bg-indigo-600/20 border border-indigo-500/50 hover:bg-indigo-600/30 transition px-4 py-2 text-sm font-semibold text-indigo-300">
          üìã View in Queue
        </a>
        
        <!-- Submit New Request -->
        <a href="/" class="rounded-xl bg-zinc-700/50 border border-zinc-600/50 hover:bg-zinc-700 transition px-4 py-2 text-sm font-semibold text-zinc-300">
          ‚ûï New Request
        </a>
      </div>
    </div>
    
    <div class="mt-6 pt-4 border-t border-zinc-800 text-center text-xs text-zinc-500">
      <div class="flex items-center gap-3">
        <a href="/feedback?type=bug" class="hover:text-red-400 transition" title="Report a Bug">üêõ</a>
        <a href="/feedback?type=suggestion" class="hover:text-yellow-400 transition" title="Submit a Suggestion">üí°</a>
        <a href="/changelog" class="hover:text-indigo-400 transition">v{{ version }}</a>
      </div>
    </div>
  </div>
  
  <!-- Cancel Confirmation Modal -->
  <div id="cancel-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-zinc-900 border border-zinc-700 rounded-2xl p-6 max-w-sm mx-4">
      <h3 class="text-lg font-semibold mb-3">Cancel Request?</h3>
      <p class="text-sm text-zinc-400 mb-6">Are you sure you want to cancel this print request? This action cannot be undone, but you can always submit a new request.</p>
      <div class="flex gap-3">
        <button onclick="hideCancelModal()" class="flex-1 rounded-xl bg-zinc-700 hover:bg-zinc-600 transition px-4 py-2 text-sm font-semibold">
          Keep Request
        </button>
        <form method="POST" action="/my/{{ req.id }}/cancel?token={{ token }}" class="flex-1">
          <button type="submit" class="w-full rounded-xl bg-red-600 hover:bg-red-500 transition px-4 py-2 text-sm font-semibold">
            Yes, Cancel
          </button>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Snapshot Modal -->
  <div id="snapshot-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50 p-4" onclick="hideSnapshot()">
    <img id="snapshot-img" src="" class="max-w-full max-h-full rounded-xl border border-zinc-700" />
  </div>
  
  <script>
    function confirmCancel() {
      const modal = document.getElementById('cancel-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    
    function hideCancelModal() {
      const modal = document.getElementById('cancel-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
    
    function showSnapshot(src) {
      const modal = document.getElementById('snapshot-modal');
      const img = document.getElementById('snapshot-img');
      img.src = src;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    
    function hideSnapshot() {
      const modal = document.getElementById('snapshot-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
    
    // Close modals on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        hideCancelModal();
        hideSnapshot();
      }
    });
  </script>
</body>
</html>