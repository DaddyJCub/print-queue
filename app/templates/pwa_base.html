<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>{% block title %}Printellect{% endblock %}</title>
  
  <!-- PWA Support -->
  <link rel="manifest" href="/static/manifest.json" />
  <meta name="theme-color" content="#18181b" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Printellect" />
  <link rel="apple-touch-icon" href="/static/icons/icon-192.png" />
  
  <script src="https://cdn.tailwindcss.com"></script>
  {% block head_extra %}{% endblock %}
  
  <style>
    /* PWA Safe Areas */
    :root {
      --safe-area-top: env(safe-area-inset-top, 0px);
      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
      --nav-height: 64px;
    }
    
    /* Smooth page transitions */
    .page-content {
      animation: fadeIn 0.2s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Staggered animation for lists */
    .stagger-item {
      opacity: 0;
      animation: staggerIn 0.3s ease-out forwards;
    }
    .stagger-item:nth-child(1) { animation-delay: 0.05s; }
    .stagger-item:nth-child(2) { animation-delay: 0.1s; }
    .stagger-item:nth-child(3) { animation-delay: 0.15s; }
    .stagger-item:nth-child(4) { animation-delay: 0.2s; }
    .stagger-item:nth-child(5) { animation-delay: 0.25s; }
    .stagger-item:nth-child(n+6) { animation-delay: 0.3s; }
    @keyframes staggerIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Skeleton loading animation */
    .skeleton {
      background: linear-gradient(90deg, #27272a 25%, #3f3f46 50%, #27272a 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 0.5rem;
    }
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    /* Reduced motion: respect user preferences */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
      .page-content, .stagger-item {
        animation: none;
        opacity: 1;
      }
      .skeleton {
        animation: none;
        background: #3f3f46;
      }
    }
    
    /* Bottom nav styling */
    .bottom-nav {
      padding-bottom: calc(var(--safe-area-bottom) + 8px);
    }
    
    /* Main content padding when bottom nav visible */
    .has-bottom-nav {
      padding-bottom: calc(var(--nav-height) + var(--safe-area-bottom) + 16px);
    }
    
    /* Active nav indicator */
    .nav-item.active {
      color: #818cf8;
    }
    .nav-item.active .nav-icon {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      transform: scale(1.05);
    }
    
    /* Tap highlight */
    .tap-highlight {
      -webkit-tap-highlight-color: transparent;
    }
    .tap-highlight:active {
      transform: scale(0.97);
    }
    
    /* Pull to refresh indicator area */
    body {
      overscroll-behavior-y: contain;
    }
    
    /* Card press effect - enhanced */
    .card-interactive {
      transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), 
                  box-shadow 0.2s ease,
                  border-color 0.2s ease;
    }
    .card-interactive:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.3);
    }
    .card-interactive:active {
      transform: scale(0.98) translateY(0);
      box-shadow: 0 2px 10px -3px rgba(0, 0, 0, 0.2);
    }
    
    /* Smooth link transitions */
    .link-smooth {
      transition: color 0.15s ease, opacity 0.15s ease;
    }
    
    /* Button hover glow effect */
    .btn-glow {
      position: relative;
      overflow: hidden;
    }
    .btn-glow::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s ease;
    }
    .btn-glow:hover::before {
      left: 100%;
    }
    
    /* Ripple effect for buttons */
    .btn-ripple {
      position: relative;
      overflow: hidden;
    }
    .btn-ripple::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      background: radial-gradient(circle, rgba(255,255,255,0.3) 10%, transparent 10%);
      transform: scale(10);
      opacity: 0;
      transition: transform 0.5s, opacity 0.5s;
    }
    .btn-ripple:active::after {
      transform: scale(0);
      opacity: 1;
      transition: 0s;
    }
    
    /* Skip link - visible on focus */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: #6366f1;
      color: white;
      padding: 8px 16px;
      z-index: 10000;
      text-decoration: none;
      font-weight: 500;
      border-radius: 0 0 8px 0;
      transition: top 0.2s ease;
    }
    .skip-link:focus {
      top: 0;
    }
    
    /* Screen reader only - visually hidden but accessible */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    
    /* Enhanced focus indicators for accessibility */
    :focus-visible {
      outline: 2px solid #818cf8;
      outline-offset: 2px;
    }
    
    /* Remove default focus outline when using mouse */
    :focus:not(:focus-visible) {
      outline: none;
    }
    
    /* High contrast focus for buttons and links */
    button:focus-visible,
    a:focus-visible,
    [role="button"]:focus-visible {
      outline: 2px solid #818cf8;
      outline-offset: 2px;
      box-shadow: 0 0 0 4px rgba(129, 140, 248, 0.3);
    }
    
    /* Focus indicators for form inputs */
    input:focus-visible,
    textarea:focus-visible,
    select:focus-visible {
      outline: none;
      ring: 2px;
      ring-color: #818cf8;
      border-color: #818cf8;
    }
    
    /* Hide scrollbar but keep functionality */
    .hide-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .hide-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    
    /* Update banner animations */
    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes slideDown {
      from { transform: translateY(0); opacity: 1; }
      to { transform: translateY(100%); opacity: 0; }
    }
    .animate-slide-up {
      animation: slideUp 0.3s ease-out forwards;
    }
    .animate-slide-down {
      animation: slideDown 0.3s ease-out forwards;
    }
  </style>
  
  <script>
    // Register service worker with logging and update notifications
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const reg = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
          console.log('[SW] Registered successfully:', {
            scope: reg.scope,
            active: reg.active?.scriptURL,
            installing: reg.installing?.state,
            waiting: reg.waiting?.state
          });
          
          // Check if there's already a waiting SW (update ready)
          if (reg.waiting) {
            showUpdateNotification(reg.waiting);
          }
          
          // Listen for updates
          reg.addEventListener('updatefound', () => {
            const newSW = reg.installing;
            console.log('[SW] Update found, new SW installing:', newSW?.state);
            newSW?.addEventListener('statechange', () => {
              console.log('[SW] New SW state:', newSW.state);
              // When the new SW is installed and waiting, show update notification
              if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
                showUpdateNotification(newSW);
              }
            });
          });
          
          // Handle controller change (when new SW takes over)
          navigator.serviceWorker.addEventListener('controllerchange', () => {
            console.log('[SW] Controller changed, reloading page');
            window.location.reload();
          });
        } catch (err) {
          console.error('[SW] Registration failed:', err);
        }
      });
    }
    
    // Show update available notification
    function showUpdateNotification(waitingSW) {
      // Don't show if already shown
      if (document.getElementById('sw-update-banner')) return;
      
      const banner = document.createElement('div');
      banner.id = 'sw-update-banner';
      banner.className = 'fixed bottom-20 md:bottom-4 left-4 right-4 md:left-auto md:right-4 md:max-w-sm z-[9998] animate-slide-up';
      banner.innerHTML = `
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl shadow-2xl p-4 text-white">
          <div class="flex items-start gap-3">
            <div class="flex-shrink-0 w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
              </svg>
            </div>
            <div class="flex-1 min-w-0">
              <p class="font-semibold">Update Available</p>
              <p class="text-sm text-white/80 mt-0.5">A new version is ready to install</p>
            </div>
            <button id="sw-update-dismiss" class="text-white/60 hover:text-white transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <div class="flex gap-2 mt-3">
            <button id="sw-update-later" class="flex-1 px-3 py-2 text-sm font-medium rounded-lg bg-white/10 hover:bg-white/20 transition-colors">
              Later
            </button>
            <button id="sw-update-now" class="flex-1 px-3 py-2 text-sm font-medium rounded-lg bg-white hover:bg-white/90 text-blue-600 transition-colors">
              Update Now
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(banner);
      
      // Handle dismiss/later
      const dismissBanner = () => {
        banner.classList.add('animate-slide-down');
        setTimeout(() => banner.remove(), 300);
      };
      
      document.getElementById('sw-update-dismiss').addEventListener('click', dismissBanner);
      document.getElementById('sw-update-later').addEventListener('click', dismissBanner);
      
      // Handle update now
      document.getElementById('sw-update-now').addEventListener('click', () => {
        waitingSW.postMessage({ type: 'SKIP_WAITING' });
      });
    }
    
    // Check if running as PWA
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    document.documentElement.classList.toggle('pwa-mode', isStandalone);
    
    // PWA Install prompt handling
    let deferredInstallPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredInstallPrompt = e;
      // Show install prompts
      document.querySelectorAll('.pwa-install-trigger').forEach(el => el.classList.remove('hidden'));
    });
    
    function installPWA() {
      if (deferredInstallPrompt) {
        deferredInstallPrompt.prompt();
        deferredInstallPrompt.userChoice.then((choice) => {
          if (choice.outcome === 'accepted') {
            document.querySelectorAll('.pwa-install-trigger').forEach(el => el.classList.add('hidden'));
          }
          deferredInstallPrompt = null;
        });
      }
    }
  </script>
</head>
<body class="bg-zinc-950 text-zinc-100 min-h-screen">
  <!-- Offline Banner - auto shows/hides based on connectivity -->
  <div id="offline-banner" 
       class="fixed top-0 left-0 right-0 z-[9998] transform transition-transform duration-300 -translate-y-full"
       role="alert" aria-live="assertive"
       style="padding-top: var(--safe-area-top);">
    <div class="bg-amber-500/95 backdrop-blur-sm text-amber-950 px-4 py-2.5 text-center">
      <div class="flex items-center justify-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414"/>
        </svg>
        <span class="text-sm font-medium">You're offline ‚Äî some features may be limited</span>
      </div>
    </div>
  </div>

  <!-- Back Online Banner -->
  <div id="online-banner" 
       class="fixed top-0 left-0 right-0 z-[9998] transform transition-transform duration-300 -translate-y-full"
       role="status" aria-live="polite"
       style="padding-top: var(--safe-area-top);">
    <div class="bg-emerald-500/95 backdrop-blur-sm text-emerald-950 px-4 py-2.5 text-center">
      <div class="flex items-center justify-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"/>
        </svg>
        <span class="text-sm font-medium">You're back online!</span>
      </div>
    </div>
  </div>

  <!-- Skip to main content link for keyboard/screen reader users -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Toast Container - with safe area for iOS Dynamic Island -->
  <div id="toast-container" class="fixed left-1/2 -translate-x-1/2 z-[9999] flex flex-col gap-2 pointer-events-none" style="top: max(1rem, calc(var(--safe-area-top) + 0.5rem));" role="region" aria-label="Notifications" aria-live="polite"></div>

  <!-- Top Header Bar (fixed on PWA) -->
  <header role="banner" class="sticky top-0 z-40 bg-zinc-950/95 backdrop-blur-lg border-b border-zinc-800/50" style="padding-top: var(--safe-area-top);">
    <div class="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
      <!-- Left: Logo/Back -->
      <div class="flex items-center gap-3">
        {% block header_left %}
        <a href="/" class="flex items-center gap-2 tap-highlight">
          <img src="/static/icons/logo.png" alt="Printellect" class="h-8 w-8 rounded-lg">
          <span class="font-bold text-lg hidden sm:block">Printellect</span>
        </a>
        {% endblock %}
      </div>
      
      <!-- Center: Page Title (mobile) -->
      <div class="flex-1 text-center sm:hidden">
        <h1 class="font-semibold text-sm truncate px-2">{% block header_title %}{% endblock %}</h1>
      </div>
      
      <!-- Right: Actions -->
      <div class="flex items-center gap-2">
        {% block header_right %}
        <!-- Desktop nav links -->
        <nav aria-label="Main navigation" class="hidden sm:flex items-center gap-1">
          <a href="/" class="px-3 py-2 rounded-lg text-sm font-medium text-zinc-400 hover:text-white hover:bg-zinc-800 transition {% block nav_home %}{% endblock %}">Submit</a>
          <a href="/queue" class="px-3 py-2 rounded-lg text-sm font-medium text-zinc-400 hover:text-white hover:bg-zinc-800 transition {% block nav_queue %}{% endblock %}">Queue</a>
          <a href="/store" class="px-3 py-2 rounded-lg text-sm font-medium text-zinc-400 hover:text-white hover:bg-zinc-800 transition {% block nav_store %}{% endblock %}">Store</a>
          <a href="/my-requests" id="desktop-my-requests-link" class="px-3 py-2 rounded-lg text-sm font-medium text-zinc-400 hover:text-white hover:bg-zinc-800 transition flex items-center gap-1.5 {% block nav_myrequests %}{% endblock %}">
            <span id="user-indicator" class="hidden w-2 h-2 rounded-full bg-indigo-500"></span>
            My Prints
          </a>
          <!-- Admin link - shown via JS if user is admin -->
          <a href="/admin" id="desktop-admin-link" class="hidden px-3 py-2 rounded-lg text-sm font-medium text-amber-400 hover:text-amber-300 hover:bg-amber-900/20 transition flex items-center gap-1.5">
            <span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span>
            Admin
          </a>
        </nav>
        
        <!-- User Account Menu (shown when logged in) -->
        <div id="global-account-menu-container" class="hidden relative">
          <div class="w-px h-5 bg-zinc-700 mx-1 hidden sm:block"></div>
          <button id="global-account-btn" onclick="toggleGlobalAccountMenu()" aria-haspopup="true" aria-expanded="false" aria-controls="global-account-dropdown" class="flex items-center gap-2 px-2 py-1.5 hover:bg-zinc-800 rounded-lg transition tap-highlight">
            <div id="global-account-avatar" class="w-7 h-7 rounded-full bg-indigo-600 flex items-center justify-center text-xs font-bold overflow-hidden">
              <img id="global-account-avatar-img" src="" alt="" class="hidden w-full h-full object-cover">
              <span id="global-account-avatar-initial" aria-hidden="true">?</span>
            </div>
            <span class="sr-only">Account menu</span>
            <svg class="w-4 h-4 text-zinc-400 hidden sm:block" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>
          
          <!-- Account Dropdown -->
          <div id="global-account-dropdown" role="menu" aria-label="Account options" class="hidden absolute top-full right-0 mt-2 w-72 bg-zinc-900 border border-zinc-700 rounded-2xl shadow-2xl z-50 overflow-hidden">
            <!-- Account Header -->
            <div class="p-4 border-b border-zinc-800 bg-zinc-950/50">
              <div class="flex items-center gap-3">
                <div id="global-account-avatar-lg" class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-lg font-bold overflow-hidden">
                  <img id="global-account-avatar-lg-img" src="" alt="Avatar" class="hidden w-full h-full object-cover">
                  <span id="global-account-avatar-lg-initial">?</span>
                </div>
                <div class="flex-1 min-w-0">
                  <p id="global-account-email" class="text-sm font-medium text-white truncate">Loading...</p>
                  <p class="text-xs text-zinc-500">Printellect Account</p>
                </div>
              </div>
            </div>
            
            <!-- Menu Items -->
            <div class="p-2">
              <a id="global-profile-link" href="/user/profile" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-zinc-800 transition">
                <span class="text-lg">üë§</span>
                <div>
                  <p class="text-sm font-medium">My Account</p>
                  <p class="text-xs text-zinc-500">Profile & preferences</p>
                </div>
              </a>
              <a id="global-my-prints-link" href="/my-requests" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-zinc-800 transition">
                <span class="text-lg">üñ®Ô∏è</span>
                <div>
                  <p class="text-sm font-medium">My Prints</p>
                  <p class="text-xs text-zinc-500">Track your requests</p>
                </div>
              </a>
              <a href="/feedback?type=suggestion" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-zinc-800 transition">
                <span class="text-lg">üí°</span>
                <div>
                  <p class="text-sm font-medium">Send Feedback</p>
                  <p class="text-xs text-zinc-500">Suggestions & bug reports</p>
                </div>
              </a>
            </div>
            
            <!-- Admin Section (shown if admin) -->
            <div id="global-admin-section" class="hidden p-2 border-t border-zinc-800">
              <a href="/admin" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-amber-900/30 text-amber-400 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <div>
                  <p class="text-sm font-medium">Admin Dashboard</p>
                  <p class="text-xs text-amber-500/70">Manage print queue</p>
                </div>
              </a>
            </div>
            
            <!-- Sign Out -->
            <div class="p-2 border-t border-zinc-800">
              <button onclick="signOutUser()" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-red-900/30 text-red-400 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
                <span class="text-sm font-medium">Sign Out</span>
              </button>
            </div>
          </div>
        </div>
        {% endblock %}
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main id="main-content" role="main" class="page-content has-bottom-nav sm:pb-6" tabindex="-1">
    <div class="max-w-6xl mx-auto px-4 py-4">
      {% block content %}{% endblock %}
    </div>
  </main>

  <!-- Bottom Navigation (Mobile PWA Style) -->
  <nav role="navigation" aria-label="Mobile navigation" class="fixed bottom-0 left-0 right-0 z-50 bg-zinc-900/95 backdrop-blur-lg border-t border-zinc-800 sm:hidden bottom-nav">
    <div id="bottom-nav-grid" class="grid grid-cols-4 gap-1 px-2 pt-2">
      <a href="/" class="nav-item flex flex-col items-center py-2 tap-highlight {% block bnav_home %}{% endblock %}">
        <div class="nav-icon w-10 h-10 rounded-xl flex items-center justify-center transition-all">
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
          </svg>
        </div>
        <span class="text-xs mt-1">Submit</span>
      </a>
      <a href="/queue" class="nav-item flex flex-col items-center py-2 tap-highlight {% block bnav_queue %}{% endblock %}">
        <div class="nav-icon w-10 h-10 rounded-xl flex items-center justify-center transition-all">
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
          </svg>
        </div>
        <span class="text-xs mt-1">Queue</span>
      </a>
      <a href="/store" class="nav-item flex flex-col items-center py-2 tap-highlight {% block bnav_store %}{% endblock %}">
        <div class="nav-icon w-10 h-10 rounded-xl flex items-center justify-center transition-all">
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
          </svg>
        </div>
        <span class="text-xs mt-1">Store</span>
      </a>
      <a href="/my-requests" id="my-requests-nav" class="nav-item flex flex-col items-center py-2 tap-highlight {% block bnav_myrequests %}{% endblock %}">
        <div class="nav-icon w-10 h-10 rounded-xl flex items-center justify-center transition-all">
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </div>
        <span class="text-xs mt-1">My Prints</span>
      </a>
      <!-- Admin tab - hidden by default, shown via JS if admin -->
      <a href="/admin" id="admin-nav" class="hidden nav-item flex flex-col items-center py-2 tap-highlight {% block bnav_admin %}{% endblock %}">
        <div class="nav-icon w-10 h-10 rounded-xl flex items-center justify-center transition-all">
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </div>
        <span class="text-xs mt-1">Admin</span>
      </a>
    </div>
  </nav>
  
  <script>
    // Check if user is admin (via API check) and show admin tab
    async function checkAdminStatus() {
      try {
        const resp = await fetch('/api/admin/check', { credentials: 'include' });
        if (resp.ok) {
          const data = await resp.json();
          if (data.is_admin) {
            // Show admin tab (mobile bottom nav)
            const adminNav = document.getElementById('admin-nav');
            if (adminNav) {
              adminNav.classList.remove('hidden');
              // Change grid to 5 columns
              const grid = document.getElementById('bottom-nav-grid');
              if (grid) grid.classList.replace('grid-cols-4', 'grid-cols-5');
            }
            // Show admin link in desktop nav
            const desktopAdminLink = document.getElementById('desktop-admin-link');
            if (desktopAdminLink) {
              desktopAdminLink.classList.remove('hidden');
            }
            // Show admin section in global account dropdown
            const globalAdminSection = document.getElementById('global-admin-section');
            if (globalAdminSection) {
              globalAdminSection.classList.remove('hidden');
            }
          }
        }
      } catch (e) {
        // Silently fail - user is not admin
      }
    }
    checkAdminStatus();
    
    // Check for user session and show account menu
    async function checkUserSession() {
      try {
        const resp = await fetch('/api/user/me', { credentials: 'include' });
        if (resp.ok) {
          const data = await resp.json();
          if (data.user && data.user.email) {
            // User is logged in - show account menu
            const container = document.getElementById('global-account-menu-container');
            if (container) {
              container.classList.remove('hidden');
              container.classList.add('flex');
            }
            
            // Update avatar and email
            const displayName = data.user.display_name || data.user.email;
            const initial = displayName[0].toUpperCase();
            const avatar = document.getElementById('global-account-avatar');
            const avatarImg = document.getElementById('global-account-avatar-img');
            const avatarInitial = document.getElementById('global-account-avatar-initial');
            const avatarLg = document.getElementById('global-account-avatar-lg');
            const avatarLgImg = document.getElementById('global-account-avatar-lg-img');
            const avatarLgInitial = document.getElementById('global-account-avatar-lg-initial');
            const emailEl = document.getElementById('global-account-email');
            
            if (avatarInitial) avatarInitial.textContent = initial;
            if (avatarLgInitial) avatarLgInitial.textContent = initial;
            if (data.user.avatar_url) {
              const avatarUrl = data.user.avatar_url;
              if (avatarImg) {
                avatarImg.src = avatarUrl;
                avatarImg.classList.remove('hidden');
              }
              if (avatarLgImg) {
                avatarLgImg.src = avatarUrl;
                avatarLgImg.classList.remove('hidden');
              }
              if (avatarInitial) avatarInitial.classList.add('hidden');
              if (avatarLgInitial) avatarLgInitial.classList.add('hidden');
            } else {
              if (avatarImg) avatarImg.classList.add('hidden');
              if (avatarLgImg) avatarLgImg.classList.add('hidden');
              if (avatarInitial) avatarInitial.classList.remove('hidden');
              if (avatarLgInitial) avatarLgInitial.classList.remove('hidden');
            }
            if (emailEl) emailEl.textContent = data.user.email;
            
            // Update profile link with token if available
            const token = localStorage.getItem('my_requests_token') || data.user.token;
            if (token) {
              const profileLink = document.getElementById('global-profile-link');
              const myPrintsLink = document.getElementById('global-my-prints-link');
              if (profileLink) profileLink.href = '/user/profile?token=' + token;
              if (myPrintsLink) myPrintsLink.href = '/my-requests/view?token=' + token;
            }
          }
        }
      } catch (e) {
        // User not logged in - keep menu hidden
      }
    }
    checkUserSession();
    
    // Global account menu toggle with accessibility
    function toggleGlobalAccountMenu() {
      const menu = document.getElementById('global-account-dropdown');
      const btn = document.getElementById('global-account-btn');
      if (menu && btn) {
        const isHidden = menu.classList.toggle('hidden');
        btn.setAttribute('aria-expanded', !isHidden);
        
        // Focus first menu item when opening
        if (!isHidden) {
          const firstItem = menu.querySelector('a, button');
          if (firstItem) setTimeout(() => firstItem.focus(), 10);
        }
      }
    }
    window.toggleGlobalAccountMenu = toggleGlobalAccountMenu;
    
    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      const menu = document.getElementById('global-account-dropdown');
      const btn = document.getElementById('global-account-btn');
      if (menu && btn && !btn.contains(e.target) && !menu.contains(e.target)) {
        menu.classList.add('hidden');
        btn.setAttribute('aria-expanded', 'false');
      }
    });
    
    // Keyboard navigation for account menu
    document.addEventListener('keydown', (e) => {
      const menu = document.getElementById('global-account-dropdown');
      const btn = document.getElementById('global-account-btn');
      if (!menu || menu.classList.contains('hidden')) return;
      
      const items = Array.from(menu.querySelectorAll('a, button'));
      const currentIndex = items.indexOf(document.activeElement);
      
      switch (e.key) {
        case 'Escape':
          menu.classList.add('hidden');
          btn?.setAttribute('aria-expanded', 'false');
          btn?.focus();
          e.preventDefault();
          break;
        case 'ArrowDown':
          if (currentIndex < items.length - 1) {
            items[currentIndex + 1]?.focus();
          } else {
            items[0]?.focus();
          }
          e.preventDefault();
          break;
        case 'ArrowUp':
          if (currentIndex > 0) {
            items[currentIndex - 1]?.focus();
          } else {
            items[items.length - 1]?.focus();
          }
          e.preventDefault();
          break;
        case 'Tab':
          // Close menu on tab out
          if (!e.shiftKey && currentIndex === items.length - 1) {
            menu.classList.add('hidden');
            btn?.setAttribute('aria-expanded', 'false');
          }
          break;
      }
    });
    
    // Sign out function
    function signOutUser() {
      // Clear local storage
      localStorage.removeItem('my_requests_token');
      localStorage.removeItem('user_session');
      localStorage.removeItem('user_email');
      // Clear any trip caches and user binding
      if ('serviceWorker' in navigator && 'caches' in window) {
        navigator.serviceWorker.ready.then((reg) => {
          reg.active?.postMessage({ type: 'CLEAR_ACTIVE_USER' });
          return caches.keys().then(keys => {
            return Promise.all(keys.filter(k => k.startsWith('trip-cache-')).map(k => caches.delete(k)));
          });
        }).catch(() => {});
      }
      // Redirect to logout endpoint
      window.location.href = '/auth/logout';
    }
    window.signOutUser = signOutUser;
    
    // Update My Requests nav link if user has token
    const savedToken = localStorage.getItem('my_requests_token');
    if (savedToken) {
      // Update mobile bottom nav
      const navLink = document.getElementById('my-requests-nav');
      if (navLink) navLink.href = '/my-requests/view?token=' + savedToken;
      
      // Update desktop nav link
      const desktopLink = document.getElementById('desktop-my-requests-link');
      if (desktopLink) desktopLink.href = '/my-requests/view?token=' + savedToken;
      
      // Show user indicator dot on desktop
      const userIndicator = document.getElementById('user-indicator');
      if (userIndicator) userIndicator.classList.remove('hidden');
    }
  </script>

  <!-- Offline Detection System -->
  <script>
  (function() {
    const offlineBanner = document.getElementById('offline-banner');
    const onlineBanner = document.getElementById('online-banner');
    let onlineTimeout;
    
    function showBanner(banner) {
      banner.classList.remove('-translate-y-full');
      banner.classList.add('translate-y-0');
    }
    
    function hideBanner(banner) {
      banner.classList.remove('translate-y-0');
      banner.classList.add('-translate-y-full');
    }
    
    function updateOnlineStatus() {
      if (!navigator.onLine) {
        hideBanner(onlineBanner);
        showBanner(offlineBanner);
        document.body.classList.add('is-offline');
        // Disable submit buttons when offline
        document.querySelectorAll('form button[type="submit"], form input[type="submit"]')
          .forEach(btn => {
            if (!btn.dataset.allowOffline) {
              btn.dataset.wasDisabled = btn.disabled;
              btn.disabled = true;
            }
          });
      } else {
        hideBanner(offlineBanner);
        document.body.classList.remove('is-offline');
        // Re-enable buttons
        document.querySelectorAll('form button[type="submit"], form input[type="submit"]')
          .forEach(btn => {
            if (btn.dataset.wasDisabled !== undefined) {
              btn.disabled = btn.dataset.wasDisabled === 'true';
              delete btn.dataset.wasDisabled;
            }
          });
        showBanner(onlineBanner);
        clearTimeout(onlineTimeout);
        onlineTimeout = setTimeout(() => hideBanner(onlineBanner), 3000);
      }
    }
    
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    if (!navigator.onLine) updateOnlineStatus();
  })();
  </script>

  <!-- Toast Notification System -->
  <style>
    .toast-item { 
      pointer-events: auto; 
      transform: translateX(100%) scale(0.9); 
      opacity: 0; 
      transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .toast-item.toast-visible { 
      transform: translateX(0) scale(1); 
      opacity: 1; 
    }
    .toast-item.toast-exit {
      transform: translateX(100%) scale(0.9);
      opacity: 0;
    }
    .toast-success > div { 
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1)); 
      border-color: rgba(16, 185, 129, 0.4);
      box-shadow: 0 10px 40px -10px rgba(16, 185, 129, 0.3);
    }
    .toast-success .toast-icon { color: #10b981; }
    .toast-error > div { 
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1)); 
      border-color: rgba(239, 68, 68, 0.4);
      box-shadow: 0 10px 40px -10px rgba(239, 68, 68, 0.3);
    }
    .toast-error .toast-icon { color: #ef4444; }
    .toast-warning > div { 
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1)); 
      border-color: rgba(245, 158, 11, 0.4);
      box-shadow: 0 10px 40px -10px rgba(245, 158, 11, 0.3);
    }
    .toast-warning .toast-icon { color: #f59e0b; }
    .toast-info > div { 
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1)); 
      border-color: rgba(59, 130, 246, 0.4);
      box-shadow: 0 10px 40px -10px rgba(59, 130, 246, 0.3);
    }
    .toast-info .toast-icon { color: #3b82f6; }
    .toast-loading > div { 
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(139, 92, 246, 0.1)); 
      border-color: rgba(139, 92, 246, 0.4);
      box-shadow: 0 10px 40px -10px rgba(139, 92, 246, 0.3);
    }
    .toast-loading .toast-icon { color: #8b5cf6; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Toast progress bar */
    .toast-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: currentColor;
      opacity: 0.3;
      border-radius: 0 0 12px 12px;
    }
    body.is-offline .requires-online { opacity: 0.5; pointer-events: none; }
  </style>
  <script>
  const toastIcons = {
    success: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>',
    error: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>',
    warning: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>',
    info: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
    loading: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>'
  };
  
  function showToast(message, type = 'info', duration = 4000) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast-item toast-${type}`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'polite');
    
    const showProgress = type !== 'loading' && duration > 0;
    toast.innerHTML = `
      <div class="relative flex items-center gap-3 px-4 py-3 rounded-xl shadow-2xl backdrop-blur-md border min-w-[280px] max-w-[90vw] overflow-hidden">
        <span class="toast-icon flex-shrink-0">${toastIcons[type] || toastIcons.info}</span>
        <span class="text-sm font-medium text-white flex-1">${message}</span>
        <button class="toast-close flex-shrink-0 text-white/50 hover:text-white transition-colors" onclick="this.closest('.toast-item').remove()" aria-label="Dismiss">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
        ${showProgress ? `<div class="toast-progress" style="width: 100%; animation: toastProgress ${duration}ms linear forwards;"></div>` : ''}
      </div>
    `;
    
    // Add progress bar animation
    if (showProgress) {
      const style = document.createElement('style');
      style.textContent = `@keyframes toastProgress { from { width: 100%; } to { width: 0%; } }`;
      if (!document.querySelector('style[data-toast-progress]')) {
        style.setAttribute('data-toast-progress', 'true');
        document.head.appendChild(style);
      }
    }
    
    container.appendChild(toast);
    requestAnimationFrame(() => {
      requestAnimationFrame(() => toast.classList.add('toast-visible'));
    });
    
    if (type !== 'loading' && duration > 0) {
      setTimeout(() => { 
        toast.classList.add('toast-exit');
        toast.classList.remove('toast-visible'); 
        setTimeout(() => toast.remove(), 350); 
      }, duration);
    }
    return toast;
  }
  
  function dismissToast(toast) { toast.classList.remove('toast-visible'); setTimeout(() => toast.remove(), 300); }
  window.showToast = showToast;
  window.dismissToast = dismissToast;
  
  // Button loading state helpers
  const loadingSpinnerSVG = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
  
  function setButtonLoading(button, loadingText = 'Loading...') {
    if (!button || button.dataset.loading === 'true') return;
    button.dataset.originalContent = button.innerHTML;
    button.dataset.originalDisabled = button.disabled;
    button.dataset.loading = 'true';
    button.disabled = true;
    button.innerHTML = `<span class="flex items-center justify-center gap-2">${loadingSpinnerSVG}<span>${loadingText}</span></span>`;
    button.classList.add('opacity-75', 'cursor-wait');
  }
  
  function resetButton(button) {
    if (!button || button.dataset.loading !== 'true') return;
    button.innerHTML = button.dataset.originalContent;
    button.disabled = button.dataset.originalDisabled === 'true';
    button.classList.remove('opacity-75', 'cursor-wait');
    delete button.dataset.loading;
    delete button.dataset.originalContent;
    delete button.dataset.originalDisabled;
  }
  
  // Auto-loading for forms with data-loading attribute
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('form[data-loading]').forEach(form => {
      form.addEventListener('submit', (e) => {
        const submitBtn = form.querySelector('button[type="submit"], input[type="submit"]');
        if (submitBtn && !submitBtn.disabled) {
          setButtonLoading(submitBtn, form.dataset.loading || 'Submitting...');
        }
      });
    });
    
    // Real-time validation feedback for inputs with data-validate attribute
    document.querySelectorAll('input[data-validate], textarea[data-validate]').forEach(input => {
      const validateType = input.dataset.validate;
      
      input.addEventListener('blur', () => validateInput(input, validateType));
      input.addEventListener('input', () => {
        // Clear error styling on input if currently in error state
        if (input.classList.contains('border-red-500/70')) {
          clearInputError(input);
        }
      });
    });
  });
  
  // Input validation helpers
  function validateInput(input, type) {
    const value = input.value.trim();
    let isValid = true;
    let errorMsg = '';
    
    switch(type) {
      case 'email':
        if (value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
          isValid = false;
          errorMsg = 'Please enter a valid email address';
        }
        break;
      case 'required':
        if (!value) {
          isValid = false;
          errorMsg = 'This field is required';
        }
        break;
      case 'min':
        const minLen = parseInt(input.dataset.minLength || input.minLength || 0);
        if (value && value.length < minLen) {
          isValid = false;
          errorMsg = `Must be at least ${minLen} characters`;
        }
        break;
      case 'url':
        if (value && !/^https?:\/\/.+/.test(value)) {
          isValid = false;
          errorMsg = 'Please enter a valid URL (starting with http:// or https://)';
        }
        break;
    }
    
    if (!isValid) {
      showInputError(input, errorMsg);
    } else if (value) {
      showInputSuccess(input);
    }
    
    return isValid;
  }
  
  function showInputError(input, message) {
    input.classList.remove('border-zinc-700', 'border-emerald-500/70');
    input.classList.add('border-red-500/70');
    
    // Add or update error message
    let errorEl = input.parentElement.querySelector('.input-error');
    if (!errorEl) {
      errorEl = document.createElement('p');
      errorEl.className = 'input-error mt-1.5 text-sm text-red-400 flex items-center gap-1';
      errorEl.innerHTML = `<svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><span></span>`;
      input.parentElement.appendChild(errorEl);
    }
    errorEl.querySelector('span').textContent = message;
    input.setAttribute('aria-invalid', 'true');
  }
  
  function showInputSuccess(input) {
    clearInputError(input);
    input.classList.add('border-emerald-500/70');
    setTimeout(() => {
      if (!input.classList.contains('border-red-500/70')) {
        input.classList.remove('border-emerald-500/70');
        input.classList.add('border-zinc-700');
      }
    }, 1500);
  }
  
  function clearInputError(input) {
    input.classList.remove('border-red-500/70', 'border-emerald-500/70');
    input.classList.add('border-zinc-700');
    input.removeAttribute('aria-invalid');
    const errorEl = input.parentElement.querySelector('.input-error');
    if (errorEl) errorEl.remove();
  }
  
  window.setButtonLoading = setButtonLoading;
  window.resetButton = resetButton;
  window.validateInput = validateInput;
  window.showInputError = showInputError;
  window.clearInputError = clearInputError;
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>
