<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Broadcast Notifications | Printellect</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-zinc-950 text-zinc-100">
  <div class="max-w-7xl mx-auto p-6">
    <!-- Navigation -->
    {% set active_page = 'settings' %}
    {% include 'admin_nav.html' %}
    
    <!-- Settings Tabs -->
    {% set active_settings_tab = 'broadcast' %}
    {% include '_components/settings_tabs.html' %}

    <!-- Success/Error Messages -->
    {% if request.query_params.get('sent') == '1' %}
      <div class="mb-6 bg-emerald-900/20 border border-emerald-800 text-emerald-200 rounded-2xl p-4">
        <div class="flex items-center gap-2">
          <span class="text-xl">âœ…</span>
          <div>
            <p class="font-semibold">Broadcast sent!</p>
            <p class="text-sm text-emerald-300/80">
              ğŸ“² Sent to {{ request.query_params.get('total', 0) }} push subscriber(s)
              {% if request.query_params.get('failed', '0') != '0' %}
                ({{ request.query_params.get('failed') }} failed)
              {% endif %}
              {% if request.query_params.get('emails', '0') != '0' %}
                <br>ğŸ“§ Sent {{ request.query_params.get('emails') }} email(s)
              {% endif %}
            </p>
          </div>
        </div>
      </div>
    {% endif %}

    <!-- Subscriber Stats -->
    <div class="mb-6 bg-zinc-900/60 border border-zinc-800 rounded-2xl p-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="text-3xl">ğŸ‘¥</span>
          <div>
            <p class="text-2xl font-bold text-indigo-400">{{ subscriber_count }}</p>
            <p class="text-sm text-zinc-400">Unique email subscribers</p>
            <p class="text-xs text-zinc-500">{{ total_subscriptions }} total device subscriptions</p>
          </div>
        </div>
        <button onclick="toggleSubscriberDetails()" 
                class="px-3 py-1.5 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-sm transition">
          ğŸ‘ï¸ View Details
        </button>
      </div>
      
      <!-- Subscriber Details (collapsed by default) -->
      <div id="subscriber-details" class="hidden mt-4 pt-4 border-t border-zinc-800">
        <h3 class="text-sm font-semibold text-zinc-300 mb-3">ğŸ“‹ Subscription Breakdown</h3>
        {% if subscribers %}
          <div class="space-y-2 max-h-64 overflow-y-auto">
            {% for sub in subscribers %}
              <div class="flex items-center justify-between bg-zinc-950 rounded-lg px-3 py-2 text-sm">
                <div class="flex items-center gap-2 min-w-0 flex-1">
                  <span class="text-zinc-400">ğŸ“§</span>
                  <span class="truncate">{{ sub.email }}</span>
                </div>
                <div class="flex items-center gap-2 shrink-0">
                  <span class="text-xs px-2 py-0.5 rounded-full 
                    {% if sub.device_count > 1 %}bg-amber-900/40 text-amber-300{% else %}bg-zinc-700 text-zinc-400{% endif %}">
                    {{ sub.device_count }} device{% if sub.device_count != 1 %}s{% endif %}
                  </span>
                  <button onclick="cleanupSubscriptions('{{ sub.email }}')" 
                          class="text-xs text-zinc-500 hover:text-red-400 transition"
                          title="Remove invalid subscriptions">
                    ğŸ—‘ï¸
                  </button>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-zinc-500 text-sm">No subscribers yet</p>
        {% endif %}
        
        <div class="mt-3 flex gap-2">
          <button onclick="testAllSubscriptions()" 
                  class="px-3 py-1.5 bg-indigo-700 hover:bg-indigo-600 rounded-lg text-xs transition">
            ğŸ§ª Test All Subscriptions
          </button>
          <button onclick="cleanupAllStale()" 
                  class="px-3 py-1.5 bg-amber-700 hover:bg-amber-600 rounded-lg text-xs transition">
            ğŸ§¹ Cleanup Stale
          </button>
        </div>
      </div>
    </div>

    <!-- Send Custom Broadcast -->
    <section class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-6 mb-6">
      <h2 class="text-lg font-semibold mb-4">âœï¸ Send Custom Broadcast</h2>

      <div class="mb-4 p-3 bg-zinc-900 border border-zinc-800 rounded-xl">
        <label class="flex items-center justify-between text-sm text-zinc-200">
          <div>
            <div class="font-semibold">Admin Progress Push Alerts</div>
            <div class="text-xs text-zinc-500">Send 25% & 75% build checkpoints (with snapshots) to admin push subscribers.</div>
          </div>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="admin-progress-toggle" class="sr-only">
            <div class="w-11 h-6 bg-zinc-700 rounded-full peer-focus:outline-none peer-checked:bg-emerald-500 transition"></div>
            <span class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition peer-checked:translate-x-5"></span>
          </label>
        </label>
        <p id="admin-progress-status" class="text-xs text-zinc-500 mt-1">Loading settingâ€¦</p>
      </div>
      
      <form method="POST" action="/admin/broadcast/send" class="space-y-4" onsubmit="return confirmBroadcast(this)">
        <div>
          <label class="block text-sm text-zinc-300 mb-1">Title</label>
          <input type="text" name="title" required
                 class="w-full rounded-xl bg-zinc-950 border border-zinc-800 p-3"
                 placeholder="ğŸ‰ Exciting News!" />
        </div>
        
        <div>
          <label class="block text-sm text-zinc-300 mb-1">Message</label>
          <textarea name="body" required rows="3"
                    class="w-full rounded-xl bg-zinc-950 border border-zinc-800 p-3"
                    placeholder="We have some exciting updates to share..."></textarea>
        </div>
        
        <div>
          <label class="block text-sm text-zinc-300 mb-1">Click URL (optional)</label>
          <input type="text" name="url"
                 class="w-full rounded-xl bg-zinc-950 border border-zinc-800 p-3"
                 placeholder="/changelog or https://example.com" />
          <p class="text-xs text-zinc-500 mt-1">Where users go when they tap the notification. Leave blank for homepage.</p>
        </div>
        
        <div>
          <label class="block text-sm text-zinc-300 mb-1">Type</label>
          <select name="broadcast_type" 
                  class="w-full rounded-xl bg-zinc-950 border border-zinc-800 p-3">
            <option value="custom">ğŸ“ Custom Announcement</option>
            <option value="announcement">ğŸ“£ General Announcement</option>
            <option value="maintenance">ğŸ”§ Maintenance Notice</option>
            <option value="app_update">ğŸš€ App Update</option>
          </select>
        </div>
        
        <!-- Target Audience -->
        <div class="bg-zinc-950 border border-zinc-800 rounded-xl p-4">
          <p class="text-sm text-zinc-300 font-medium mb-3">ğŸ¯ Target Audience</p>
          <div class="space-y-2">
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="radio" name="target" value="all" checked class="scale-110" onchange="toggleTargetEmails()">
              <span class="text-sm">ğŸ‘¥ All Subscribers <span class="text-zinc-500">({{ subscriber_count }} users)</span></span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="radio" name="target" value="specific" class="scale-110" onchange="toggleTargetEmails()">
              <span class="text-sm">ğŸ“§ Specific Users</span>
            </label>
          </div>
          
          <!-- Specific Emails Input (hidden by default) -->
          <div id="target-emails-container" class="hidden mt-3">
            <label class="block text-xs text-zinc-400 mb-1">Email addresses (one per line or comma-separated)</label>
            <textarea name="target_emails" id="target-emails" rows="3"
                      class="w-full rounded-lg bg-zinc-900 border border-zinc-700 p-2 text-sm"
                      placeholder="user1@example.com&#10;user2@example.com"></textarea>
            <p class="text-xs text-zinc-600 mt-1">Only subscribed users will receive notifications</p>
          </div>
        </div>
        
        <!-- Delivery Options -->
        <div class="bg-zinc-950 border border-zinc-800 rounded-xl p-4">
          <p class="text-sm text-zinc-300 font-medium mb-3">ğŸ“¬ Delivery Methods</p>
          <div class="space-y-2">
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" checked disabled class="scale-110 rounded">
              <span class="text-sm">ğŸ“² Push Notifications <span class="text-zinc-500">(always sent)</span></span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" name="send_email" value="1" class="scale-110 rounded">
              <span class="text-sm">ğŸ“§ Email <span class="text-zinc-500">(optional)</span></span>
            </label>
          </div>
        </div>
        
        <button type="submit" 
                class="w-full rounded-xl bg-indigo-600 hover:bg-indigo-500 transition px-4 py-3 font-semibold">
          ğŸ“¤ Send Broadcast
        </button>
      </form>
    </section>

    <!-- Quick App Update Notification -->
    <section class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-6 mb-6">
      <h2 class="text-lg font-semibold mb-4">ğŸš€ App Update Notification</h2>
      <p class="text-sm text-zinc-400 mb-4">
        Quickly notify all subscribers about a new app version. Links directly to that version in the changelog.
      </p>
      
      <div id="update-preview" class="bg-zinc-950 border border-zinc-800 rounded-xl p-4 mb-4">
        <p class="text-sm text-zinc-500 mb-1">Preview:</p>
        <p class="font-semibold">ğŸ‰ New Update Available!</p>
        <p class="text-zinc-300">Printellect v<span id="preview-version">{{ version }}</span> is here with new features and improvements. Tap to see what's new!</p>
        <p class="text-xs text-zinc-500 mt-2">â†’ Links to: <code class="bg-zinc-800 px-1 rounded">/changelog#v<span id="preview-anchor">{{ version }}</span></code></p>
      </div>
      
      <form method="POST" action="/api/admin/broadcast/app-update" class="space-y-3">
        <div>
          <label class="block text-sm text-zinc-400 mb-1">Version Number</label>
          <input type="text" name="version" id="version-input" value="{{ version }}" 
                 oninput="updateVersionPreview(this.value)"
                 class="w-full rounded-xl bg-zinc-950 border border-zinc-800 p-3"
                 placeholder="e.g., 1.8.14" />
        </div>
        
        <!-- Delivery Options -->
        <div class="bg-zinc-950 border border-zinc-800 rounded-xl p-4">
          <p class="text-sm text-zinc-300 font-medium mb-3">ğŸ“¬ Delivery Methods</p>
          <div class="space-y-2">
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" checked disabled class="scale-110 rounded">
              <span class="text-sm">ğŸ“² Push Notifications <span class="text-zinc-500">(always sent)</span></span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" name="send_email" value="1" class="scale-110 rounded">
              <span class="text-sm">ğŸ“§ Email <span class="text-zinc-500">(optional)</span></span>
            </label>
          </div>
        </div>
        
        <button type="submit" 
                class="w-full rounded-xl bg-emerald-600 hover:bg-emerald-500 transition px-6 py-3 font-semibold"
                onclick="return confirm('Send app update notification to all {{ subscriber_count }} subscribers?')">
          ğŸš€ Send Update Alert
        </button>
      </form>
      
      <script>
        function updateVersionPreview(version) {
          document.getElementById('preview-version').textContent = version || '{{ version }}';
          document.getElementById('preview-anchor').textContent = version || '{{ version }}';
        }
      </script>
    </section>

    <!-- Broadcast History -->
    <section class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-6">
      <h2 class="text-lg font-semibold mb-4">ğŸ“œ Recent Broadcasts</h2>
      
      {% if history %}
        <div class="space-y-3">
          {% for item in history %}
            <div class="bg-zinc-950 border border-zinc-800 rounded-xl p-4">
              <div class="flex justify-between items-start gap-3">
                <div class="flex-1 min-w-0">
                  <p class="font-semibold truncate">{{ item.title }}</p>
                  <p class="text-sm text-zinc-400 truncate">{{ item.body }}</p>
                </div>
                <div class="text-right text-sm shrink-0">
                  <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs
                    {% if item.broadcast_type == 'app_update' %}bg-emerald-900/40 text-emerald-300
                    {% elif item.broadcast_type == 'maintenance' %}bg-amber-900/40 text-amber-300
                    {% else %}bg-indigo-900/40 text-indigo-300{% endif %}">
                    {{ item.broadcast_type }}
                  </span>
                </div>
              </div>
              <div class="mt-2 flex justify-between text-xs text-zinc-500">
                <span>{{ item.sent_at[:16].replace('T', ' ') }}</span>
                <span>âœ… {{ item.total_sent }} sent {% if item.total_failed > 0 %}Â· âŒ {{ item.total_failed }} failed{% endif %}</span>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-center py-8 text-zinc-500">
          <p class="text-4xl mb-2">ğŸ“­</p>
          <p>No broadcasts sent yet</p>
        </div>
      {% endif %}
    </section>
    
    <!-- Footer with version -->
    <div class="mt-8 pt-4 border-t border-zinc-800 text-center text-xs text-zinc-500">
      <a href="/changelog" class="hover:text-indigo-400 transition">Printellect v{{ version }}</a>
    </div>
  </div>
  
  <!-- Toast notification -->
  <div id="toast" class="hidden fixed bottom-4 right-4 px-4 py-3 rounded-xl shadow-lg z-50"></div>
  
  <script>
    function toggleSubscriberDetails() {
      const details = document.getElementById('subscriber-details');
      details.classList.toggle('hidden');
    }
    
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'fixed bottom-4 right-4 px-4 py-3 rounded-xl shadow-lg z-50 ' + 
        (type === 'error' ? 'bg-red-900 text-red-200 border border-red-700' : 'bg-emerald-900 text-emerald-200 border border-emerald-700');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }
    
    async function cleanupSubscriptions(email) {
      if (!confirm(`Remove invalid subscriptions for ${email}?`)) return;
      try {
        const resp = await fetch('/api/admin/push/cleanup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const data = await resp.json();
        if (data.ok) {
          showToast(`Cleaned up ${data.removed} invalid subscriptions`);
          setTimeout(() => location.reload(), 1000);
        } else {
          showToast(data.error || 'Cleanup failed', 'error');
        }
      } catch (e) {
        showToast('Network error', 'error');
      }
    }
    
    async function cleanupAllStale() {
      if (!confirm('Test all subscriptions and remove invalid ones?')) return;
      showToast('Testing subscriptions...');
      try {
        const resp = await fetch('/api/admin/push/cleanup-all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        const data = await resp.json();
        if (data.ok) {
          showToast(`Removed ${data.removed} stale subscriptions`);
          setTimeout(() => location.reload(), 1000);
        } else {
          showToast(data.error || 'Cleanup failed', 'error');
        }
      } catch (e) {
        showToast('Network error', 'error');
      }
    }
    
    async function testAllSubscriptions() {
      if (!confirm('Send a silent test to all subscriptions to check validity?')) return;
      showToast('Testing...');
      try {
        const resp = await fetch('/api/admin/push/test-all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        const data = await resp.json();
        if (data.ok) {
          showToast(`${data.valid} valid, ${data.invalid} invalid (${data.removed} removed)`);
          setTimeout(() => location.reload(), 2000);
        } else {
          showToast(data.error || 'Test failed', 'error');
        }
      } catch (e) {
        showToast('Network error', 'error');
      }
    }
    
    function toggleTargetEmails() {
      const container = document.getElementById('target-emails-container');
      const isSpecific = document.querySelector('input[name="target"][value="specific"]').checked;
      container.classList.toggle('hidden', !isSpecific);
    }
    
    function confirmBroadcast(form) {
      const target = form.querySelector('input[name="target"]:checked').value;
      if (target === 'all') {
        return confirm('Send this notification to all {{ subscriber_count }} subscribers?');
      } else {
        const emails = form.querySelector('#target-emails').value.trim();
        if (!emails) {
          alert('Please enter at least one email address');
          return false;
        }
        const count = emails.split(/[\n,]/).filter(e => e.trim()).length;
        return confirm(`Send this notification to ${count} specified user(s)?`);
      }
    }
    
  function updateVersionPreview(version) {
    document.getElementById('preview-version').textContent = version;
    document.getElementById('preview-anchor').textContent = version;
  }

  // Admin progress toggle
  async function loadAdminProgressToggle() {
    try {
      const resp = await fetch('/api/settings/admin_progress_notifications', { credentials: 'include' });
      if (!resp.ok) throw new Error('Failed to load setting');
      const data = await resp.json();
      const toggle = document.getElementById('admin-progress-toggle');
      const status = document.getElementById('admin-progress-status');
      toggle.checked = data.enabled;
      status.textContent = data.enabled ? 'Enabled for admin push subscribers' : 'Disabled';
    } catch (e) {
      document.getElementById('admin-progress-status').textContent = 'Could not load setting';
    }
  }

  async function saveAdminProgressToggle() {
    const toggle = document.getElementById('admin-progress-toggle');
    const status = document.getElementById('admin-progress-status');
    status.textContent = 'Saving...';
    try {
      const resp = await fetch('/api/settings/admin_progress_notifications', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ enabled: toggle.checked })
      });
      if (!resp.ok) throw new Error('Save failed');
      status.textContent = toggle.checked ? 'Enabled for admin push subscribers' : 'Disabled';
      showToast('Saved admin progress alerts');
    } catch (e) {
      status.textContent = 'Save failed';
      toggle.checked = !toggle.checked;
      showToast('Failed to save', 'error');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadAdminProgressToggle();
    document.getElementById('admin-progress-toggle').addEventListener('change', saveAdminProgressToggle);
  });
  </script>
</body>
</html>
