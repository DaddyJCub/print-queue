<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Submit Request | Printellect</title>
  <!-- PWA Support -->
  <link rel="manifest" href="/static/manifest.json" />
  <meta name="theme-color" content="#6366f1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Printellect" />
  <link rel="apple-touch-icon" href="/static/icons/icon-192.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <script>
    // Register service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/static/sw.js').catch(err => console.log('SW registration failed:', err));
      });
    }
  </script>
</head>
<body class="bg-zinc-950 text-zinc-100">
  <div class="max-w-2xl mx-auto p-6">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6">
      <div class="flex items-center gap-4">
        <img src="/static/icons/logo.png" alt="Printellect" class="h-14 w-14 rounded-xl">
        <div>
          <h1 class="text-3xl font-bold">Printellect</h1>
          <p class="text-zinc-400">Submit your print job ‚Äî we'll take it from here.</p>
        </div>
      </div>
      <div class="flex gap-3">
        <a href="/store"
           class="rounded-xl bg-emerald-600 hover:bg-emerald-500 transition px-4 py-2 font-medium text-center whitespace-nowrap">
          üè™ Store
        </a>
        <a href="/my-requests"
           class="rounded-xl bg-zinc-800 hover:bg-zinc-700 transition px-4 py-2 font-medium text-center whitespace-nowrap">
          üìã My Requests
        </a>
        <a href="/queue"
           class="rounded-xl bg-indigo-600 hover:bg-indigo-500 transition px-4 py-2 font-semibold text-center whitespace-nowrap">
          View Queue
        </a>
      </div>
    </div>

    <!-- PWA Install Banner -->
    <div id="pwa-install-banner" class="hidden mb-6">
      <div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 rounded-2xl p-4 shadow-lg relative overflow-hidden">
        <div class="absolute inset-0 bg-[url('data:image/svg+xml,%3Csvg width=\"30\" height=\"30\" viewBox=\"0 0 30 30\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\"%3E%3Ccircle cx=\"15\" cy=\"15\" r=\"2\" fill=\"white\" fill-opacity=\"0.1\"/%3E%3C/svg%3E')]"></div>
        <div class="relative flex items-center gap-4">
          <div class="flex-shrink-0">
            <img src="/static/icons/logo.png" alt="Printellect" class="h-16 w-16 rounded-xl shadow-lg border-2 border-white/20">
          </div>
          <div class="flex-1 min-w-0">
            <h3 class="font-bold text-lg">Get the Printellect App</h3>
            <p class="text-sm text-indigo-100 mt-0.5">Install for instant notifications, quick access & offline support</p>
          </div>
          <div class="flex-shrink-0 flex flex-col gap-2">
            <button id="pwa-install-btn" onclick="installPWA()" class="px-5 py-2.5 bg-white text-indigo-700 rounded-xl font-semibold hover:bg-indigo-50 transition shadow-lg">
              Install
            </button>
            <button onclick="dismissPWABanner()" class="text-xs text-indigo-200 hover:text-white transition">
              Maybe later
            </button>
          </div>
        </div>
        <!-- iOS Instructions (shown when needed) -->
        <div id="ios-install-hint" class="hidden mt-3 pt-3 border-t border-white/20">
          <p class="text-sm text-indigo-100">
            <strong>iPhone/iPad:</strong> Tap 
            <span class="inline-flex items-center px-1.5 py-0.5 bg-white/20 rounded">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M15 8a1 1 0 00-1-1h-1V6a1 1 0 00-2 0v1H9a1 1 0 000 2h2v6H9a1 1 0 000 2h4a1 1 0 000-2h-1V9h2a1 1 0 001-1z"/><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 0h8v12H6V4z" clip-rule="evenodd"/></svg>
              Share
            </span>
            ‚Üí <span class="inline-block px-1.5 py-0.5 bg-white/20 rounded">Add to Home Screen</span>
          </p>
        </div>
      </div>
    </div>
    
    <script>
      let deferredInstallPrompt = null;
      
      // Check if should show PWA banner
      (function() {
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
        const dismissed = localStorage.getItem('pwa_banner_dismissed');
        const dismissedTime = localStorage.getItem('pwa_banner_dismissed_time');
        
        // Show again after 7 days if dismissed
        const shouldShowAgain = dismissedTime && (Date.now() - parseInt(dismissedTime)) > 7 * 24 * 60 * 60 * 1000;
        
        if (!isStandalone && (!dismissed || shouldShowAgain)) {
          document.getElementById('pwa-install-banner').classList.remove('hidden');
          
          // Detect iOS
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          if (isIOS) {
            document.getElementById('ios-install-hint').classList.remove('hidden');
            document.getElementById('pwa-install-btn').style.display = 'none';
          }
        }
        
        // Mark PWA as used if in standalone
        if (isStandalone) {
          localStorage.setItem('pwa_used', 'true');
        }
      })();
      
      // Capture Chrome/Edge install prompt
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredInstallPrompt = e;
        document.getElementById('pwa-install-btn').style.display = 'block';
      });
      
      async function installPWA() {
        if (deferredInstallPrompt) {
          deferredInstallPrompt.prompt();
          const result = await deferredInstallPrompt.userChoice;
          if (result.outcome === 'accepted') {
            document.getElementById('pwa-install-banner').style.display = 'none';
            localStorage.setItem('pwa_banner_dismissed', 'true');
          }
          deferredInstallPrompt = null;
        }
      }
      
      function dismissPWABanner() {
        document.getElementById('pwa-install-banner').style.display = 'none';
        localStorage.setItem('pwa_banner_dismissed', 'true');
        localStorage.setItem('pwa_banner_dismissed_time', Date.now().toString());
      }
    </script>

    {% if error %}
      <div class="mt-4 bg-red-900/30 border border-red-800 text-red-200 p-3 rounded-xl text-sm">
        {{ error }}
      </div>
    {% endif %}

    <!-- Saved Templates Section -->
    {% if saved_templates and saved_templates|length > 0 %}
    <div class="mt-6 bg-zinc-900/40 border border-zinc-800 rounded-xl p-4">
      <div class="flex items-center justify-between mb-3">
        <div class="text-sm font-semibold text-zinc-300">üìÅ Saved Templates</div>
        <button type="button" onclick="toggleTemplatesPanel()" class="text-xs text-zinc-500 hover:text-zinc-300">
          <span id="templates-toggle-text">Hide</span>
        </button>
      </div>
      <div id="templates-panel" class="flex flex-wrap gap-2">
        {% for tpl in saved_templates %}
        <button type="button" onclick="loadTemplate('{{ tpl.id }}')"
                class="group flex items-center gap-2 px-3 py-1.5 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 rounded-lg text-sm transition">
          <span>{{ tpl.name }}</span>
          <span onclick="event.stopPropagation(); deleteTemplate('{{ tpl.id }}', '{{ tpl.name }}')" 
                class="text-zinc-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition">√ó</span>
        </button>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <form class="mt-6 space-y-4 bg-zinc-900/60 p-6 rounded-2xl border border-zinc-800" id="request-form"
          action="/submit" method="POST" enctype="multipart/form-data">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="text-sm text-zinc-300">Name</label>
          <input name="requester_name" id="requester-name" required
                 value="{{ (form.requester_name if form is defined else '') }}"
                 onchange="updateRushPricing()"
                 onkeyup="debounceUpdatePricing()"
                 class="mt-1 w-full rounded-xl bg-zinc-950 border border-zinc-800 p-3" />
        </div>
        <div>
          <label class="text-sm text-zinc-300">Email</label>
          <input name="requester_email" type="email" required
                 value="{{ (form.requester_email if form is defined else '') }}"
                 class="mt-1 w-full rounded-xl bg-zinc-950 border border-zinc-800 p-3" />
        </div>
      </div>

      <div>
        <label class="text-sm text-zinc-300">Print Name <span class="text-zinc-500">(What are you printing?)</span></label>
        <input name="print_name" required placeholder="e.g., Dragon Statue, Phone Holder, Benchy..."
               value="{{ (form.print_name if form is defined else '') }}"
               class="mt-1 w-full rounded-xl bg-zinc-950 border border-zinc-800 p-3" />
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="text-sm text-zinc-300">Printer</label>
          <select name="printer" id="printer-select" required class="mt-1 w-full rounded-xl bg-zinc-950 border border-zinc-800 p-3">
            {% set selected_printer = (form.printer if form is defined and form.printer else 'ANY') %}
            {% for val, label in printers %}
              <option value="{{val}}" {% if val == selected_printer %}selected{% endif %}>{{label}}</option>
            {% endfor %}
          </select>
          {% if printer_suggestions %}
            <div class="mt-2 text-xs">
              {% if printer_suggestions.suggested %}
                <div class="inline-flex items-center gap-2 px-2 py-1 rounded-lg bg-emerald-900/30 border border-emerald-800/50 text-emerald-300">
                  üí° <span>{{ printer_suggestions.reason }}</span>
                  <button type="button" onclick="document.getElementById('printer-select').value='{{ printer_suggestions.suggested }}'" 
                          class="text-emerald-200 hover:text-white underline">Use it</button>
                </div>
              {% else %}
                <div class="inline-flex items-center gap-2 px-2 py-1 rounded-lg bg-zinc-800/50 border border-zinc-700/50 text-zinc-400">
                  ‚ÑπÔ∏è {{ printer_suggestions.reason }}
                </div>
              {% endif %}
            </div>
          {% endif %}
        </div>
        <div>
          <label class="text-sm text-zinc-300">Material</label>
          <select name="material" required class="mt-1 w-full rounded-xl bg-zinc-950 border border-zinc-800 p-3">
            {% set selected_material = (form.material if form is defined and form.material else 'ANY') %}
            {% for val, label in materials %}
              <option value="{{val}}" {% if val == selected_material %}selected{% endif %}>{{label}}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div>
        <label class="text-sm text-zinc-300">Colors</label>
        <input name="colors" placeholder="Black / White / Red (comma-separated)" required
               value="{{ (form.colors if form is defined else '') }}"
               class="mt-1 w-full rounded-xl bg-zinc-950 border border-zinc-800 p-3" />
      </div>

      <div>
        <label class="text-sm text-zinc-300">Link (optional)</label>
        <input name="link_url" placeholder="https://printables.com/..."
               value="{{ (form.link_url if form is defined else '') }}"
               class="mt-1 w-full rounded-xl bg-zinc-950 border border-zinc-800 p-3" />
        <p class="text-xs text-zinc-400 mt-1">Note: you must provide either a link or a file upload.</p>
      </div>

      <div>
        <label class="text-sm text-zinc-300">Upload file (optional)</label>
        <div id="file-drop-zone" 
             class="mt-1 w-full border-2 border-dashed border-zinc-700 hover:border-indigo-500 rounded-xl p-6 text-center cursor-pointer transition-colors"
             ondrop="handleDrop(event)" 
             ondragover="handleDragOver(event)" 
             ondragleave="handleDragLeave(event)"
             onclick="document.getElementById('file-input').click()">
          <div id="drop-zone-content">
            <div class="text-3xl mb-2">üìÅ</div>
            <p class="text-zinc-400 text-sm">Drag & drop your file here, or <span class="text-indigo-400">click to browse</span></p>
            <p class="text-xs text-zinc-500 mt-1">STL, 3MF, OBJ, GCODE, STEP, ZIP ‚Ä¢ Max 200MB</p>
          </div>
          <div id="file-preview" class="hidden">
            <div class="flex items-center justify-center gap-3">
              <span class="text-2xl">üìÑ</span>
              <div class="text-left">
                <p id="file-name" class="text-zinc-200 font-medium"></p>
                <p id="file-size" class="text-xs text-zinc-500"></p>
              </div>
              <button type="button" onclick="clearFile(event)" class="ml-2 text-red-400 hover:text-red-300 text-sm">‚úï Remove</button>
            </div>
          </div>
        </div>
        <input id="file-input" name="upload" type="file" accept=".stl,.3mf,.obj,.gcode,.step,.stp,.fpp,.zip" class="hidden" onchange="handleFileSelect(this)" />
        <p class="text-xs text-zinc-400 mt-1">Note: you must provide either a link or a file upload.</p>
      </div>

      <script>
        function handleDragOver(e) {
          e.preventDefault();
          document.getElementById('file-drop-zone').classList.add('border-indigo-500', 'bg-indigo-500/10');
        }
        function handleDragLeave(e) {
          e.preventDefault();
          document.getElementById('file-drop-zone').classList.remove('border-indigo-500', 'bg-indigo-500/10');
        }
        function handleDrop(e) {
          e.preventDefault();
          handleDragLeave(e);
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            document.getElementById('file-input').files = files;
            showFilePreview(files[0]);
          }
        }
        function handleFileSelect(input) {
          if (input.files.length > 0) {
            showFilePreview(input.files[0]);
          }
        }
        function showFilePreview(file) {
          document.getElementById('drop-zone-content').classList.add('hidden');
          document.getElementById('file-preview').classList.remove('hidden');
          document.getElementById('file-name').textContent = file.name;
          document.getElementById('file-size').textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
        }
        function clearFile(e) {
          e.stopPropagation();
          document.getElementById('file-input').value = '';
          document.getElementById('drop-zone-content').classList.remove('hidden');
          document.getElementById('file-preview').classList.add('hidden');
        }
      </script>

      <div>
        <label class="text-sm text-zinc-300">Notes (optional)</label>
        <textarea
          name="notes"
          rows="4"
          placeholder="Helpful details (optional):&#10;‚Ä¢ Which color for which part?&#10;‚Ä¢ Size/scale changes?&#10;‚Ä¢ Infill/strength needs?&#10;‚Ä¢ Supports okay? (yes/no)&#10;‚Ä¢ Any deadlines?"
          class="mt-1 w-full rounded-xl bg-zinc-950 border border-zinc-800 p-3">{{ (form.notes if form is defined else '') }}</textarea>
      </div>

      <!-- Priority Rush Option -->
      {% if rush_settings and rush_settings.enabled %}
      <div class="bg-gradient-to-r from-amber-900/30 to-orange-900/20 border border-amber-700/50 rounded-xl p-4">
        <label class="flex items-start gap-3 cursor-pointer">
          <input type="checkbox" name="rush_request" id="rush-checkbox" value="1" 
                 {% if form is defined and form.rush_request %}checked{% endif %}
                 onchange="toggleRushPayment()"
                 class="mt-1 w-5 h-5 rounded border-amber-600 text-amber-500 focus:ring-amber-500" />
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <span class="font-semibold text-amber-200">üöÄ Priority Rush</span>
              <span id="rush-price-badge" class="px-2 py-0.5 bg-amber-600/30 border border-amber-500/50 text-amber-200 text-xs rounded-lg">${{ rush_settings.fee }}</span>

            </div>
            <p class="text-xs text-zinc-400 mt-1">
              Skip the queue! Rush requests are processed first.
              <span id="rush-queue-reason" class="text-amber-400/70">({{ rush_settings.queue_reason }}{% if rush_settings.queue_addon > 0 %} +${{ rush_settings.queue_addon }}{% endif %})</span>
            </p>
          </div>
        </label>
        
        <!-- Payment Instructions (shown when rush is checked) -->
        <div id="rush-payment-section" class="mt-4 pt-4 border-t border-amber-800/50 hidden">
          <div class="bg-zinc-950/60 rounded-lg p-4">
            <div class="text-sm font-semibold text-amber-200 mb-2">üí≥ Payment Required</div>
            <div class="text-sm text-zinc-300 space-y-2">
              <p>Send <span id="rush-price-amount" class="font-bold text-amber-300">${{ rush_settings.fee }}</span> via Venmo to:</p>
              <div class="flex items-center gap-3 bg-zinc-900 rounded-lg px-4 py-3">
                <span class="text-2xl">üì±</span>
                <div>
                  <div class="font-mono text-lg text-amber-300">{{ rush_settings.venmo_handle }}</div>
                  <div class="text-xs text-zinc-500">Include your email in the note</div>
                </div>
              </div>
            </div>
            
            <label class="flex items-center gap-2 mt-4 cursor-pointer">
              <input type="checkbox" name="rush_payment_confirmed" id="rush-payment-confirm" value="1"
                     {% if form is defined and form.rush_payment_confirmed %}checked{% endif %}
                     class="w-4 h-4 rounded border-amber-600 text-amber-500 focus:ring-amber-500" />
              <span class="text-sm text-amber-200">I have sent payment via Venmo</span>
            </label>
          </div>
          <p class="text-xs text-zinc-500 mt-2">
            ‚ö†Ô∏è Rush requests without confirmed payment will be processed as regular priority.
          </p>
        </div>
      </div>
      {% endif %}
      
      <script>
        let pricingDebounceTimer = null;
        
        function toggleRushPayment() {
          const checkbox = document.getElementById('rush-checkbox');
          const paymentSection = document.getElementById('rush-payment-section');
          const confirmCheckbox = document.getElementById('rush-payment-confirm');
          
          if (checkbox && checkbox.checked) {
            paymentSection.classList.remove('hidden');
          } else if (paymentSection) {
            paymentSection.classList.add('hidden');
            if (confirmCheckbox) confirmCheckbox.checked = false;
          }
        }
        
        function debounceUpdatePricing() {
          clearTimeout(pricingDebounceTimer);
          pricingDebounceTimer = setTimeout(updateRushPricing, 300);
        }
        
        async function updateRushPricing() {
          const nameInput = document.getElementById('requester-name');
          const name = nameInput ? nameInput.value : '';
          
          try {
            const response = await fetch(`/api/rush-pricing?name=${encodeURIComponent(name)}`);
            const data = await response.json();
            
            // Update price displays
            const priceBadge = document.getElementById('rush-price-badge');
            const priceAmount = document.getElementById('rush-price-amount');
            const queueReason = document.getElementById('rush-queue-reason');
            const specialBadge = document.getElementById('rush-special-badge');
            
            if (priceBadge) priceBadge.textContent = `$${data.price}`;
            if (priceAmount) priceAmount.textContent = `$${data.price}`;
            
            if (queueReason) {
              let reasonText = `(${data.queue_reason}`;
              if (data.queue_addon > 0) reasonText += ` +$${data.queue_addon}`;
              reasonText += ')';
              queueReason.textContent = reasonText;
            }
          } catch (error) {
            console.error('Failed to fetch pricing:', error);
          }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
          toggleRushPayment();
          // Initial pricing update if name is pre-filled
          const nameInput = document.getElementById('requester-name');
          if (nameInput && nameInput.value) {
            updateRushPricing();
          }
        });
      </script>

      {% if turnstile_site_key %}
        <div class="cf-turnstile" data-sitekey="{{turnstile_site_key}}" data-theme="dark"></div>
      {% else %}
        <div class="text-xs text-amber-300">
          Turnstile keys not set ‚Äî submissions allowed (LAN testing).
        </div>
      {% endif %}

      <div class="flex gap-3">
        <button type="submit" class="flex-1 rounded-2xl bg-indigo-600 hover:bg-indigo-500 transition p-3 font-semibold">
          Submit Request
        </button>
        <button type="button" onclick="showSaveTemplateModal()" 
                class="rounded-2xl bg-zinc-700 hover:bg-zinc-600 transition px-4 py-3 font-semibold text-sm"
                title="Save current form as template">
          üíæ Save
        </button>
      </div>
    </form>

    <!-- Save Template Modal -->
    <div id="save-template-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
      <div class="bg-zinc-900 border border-zinc-700 rounded-2xl p-6 w-full max-w-md mx-4">
        <h3 class="text-lg font-bold mb-4">üíæ Save as Template</h3>
        <p class="text-sm text-zinc-400 mb-4">Save your current form settings for quick reuse later.</p>
        <input type="text" id="template-name-input" placeholder="Template name (e.g., 'My Default Settings')"
               class="w-full rounded-xl bg-zinc-950 border border-zinc-700 p-3 mb-4" />
        <div class="flex gap-3">
          <button onclick="saveTemplate()" class="flex-1 rounded-xl bg-indigo-600 hover:bg-indigo-500 p-2 font-semibold">
            Save Template
          </button>
          <button onclick="hideSaveTemplateModal()" class="rounded-xl bg-zinc-700 hover:bg-zinc-600 px-4 py-2">
            Cancel
          </button>
        </div>
      </div>
    </div>

    <div class="mt-6 pt-4 border-t border-zinc-800 flex items-center justify-between text-xs text-zinc-500">
      <a class="text-indigo-400 hover:underline" href="/admin/login">Admin Login</a>
      <div class="flex items-center gap-3">
        <a href="/feedback?type=bug" class="hover:text-red-400 transition" title="Report a Bug">üêõ</a>
        <a href="/feedback?type=suggestion" class="hover:text-yellow-400 transition" title="Submit a Suggestion">üí°</a>
        <a href="/changelog" class="hover:text-indigo-400 transition">v{{ version }}</a>
      </div>
    </div>
  </div>

  <script>
    // Template functions
    function toggleTemplatesPanel() {
      const panel = document.getElementById('templates-panel');
      const toggleText = document.getElementById('templates-toggle-text');
      if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        toggleText.textContent = 'Hide';
      } else {
        panel.classList.add('hidden');
        toggleText.textContent = 'Show';
      }
    }

    async function loadTemplate(templateId) {
      try {
        const response = await fetch(`/api/templates/${templateId}`);
        const tpl = await response.json();
        
        // Fill form fields
        const form = document.getElementById('request-form');
        if (tpl.requester_name) form.querySelector('[name="requester_name"]').value = tpl.requester_name;
        if (tpl.requester_email) form.querySelector('[name="requester_email"]').value = tpl.requester_email;
        if (tpl.printer) form.querySelector('[name="printer"]').value = tpl.printer;
        if (tpl.material) form.querySelector('[name="material"]').value = tpl.material;
        if (tpl.colors) form.querySelector('[name="colors"]').value = tpl.colors;
        if (tpl.notes) form.querySelector('[name="notes"]').value = tpl.notes;
        
        // Update rush pricing with new name
        updateRushPricing();
        
        // Visual feedback
        showToast(`Loaded template: ${tpl.name}`);
      } catch (error) {
        console.error('Failed to load template:', error);
        showToast('Failed to load template', true);
      }
    }

    async function deleteTemplate(templateId, templateName) {
      if (!confirm(`Delete template "${templateName}"?`)) return;
      
      try {
        await fetch(`/api/templates/${templateId}`, { method: 'DELETE' });
        location.reload();
      } catch (error) {
        console.error('Failed to delete template:', error);
        showToast('Failed to delete template', true);
      }
    }

    function showSaveTemplateModal() {
      document.getElementById('save-template-modal').classList.remove('hidden');
      document.getElementById('template-name-input').focus();
    }

    function hideSaveTemplateModal() {
      document.getElementById('save-template-modal').classList.add('hidden');
    }

    async function saveTemplate() {
      const name = document.getElementById('template-name-input').value.trim();
      if (!name) {
        showToast('Please enter a template name', true);
        return;
      }
      
      const form = document.getElementById('request-form');
      const formData = new FormData();
      formData.append('name', name);
      formData.append('requester_name', form.querySelector('[name="requester_name"]').value);
      formData.append('requester_email', form.querySelector('[name="requester_email"]').value);
      formData.append('printer', form.querySelector('[name="printer"]').value);
      formData.append('material', form.querySelector('[name="material"]').value);
      formData.append('colors', form.querySelector('[name="colors"]').value);
      formData.append('notes', form.querySelector('[name="notes"]').value);
      
      try {
        const response = await fetch('/api/templates', {
          method: 'POST',
          body: formData
        });
        const result = await response.json();
        
        if (result.success) {
          hideSaveTemplateModal();
          showToast(`Template "${name}" saved!`);
          setTimeout(() => location.reload(), 1000);
        }
      } catch (error) {
        console.error('Failed to save template:', error);
        showToast('Failed to save template', true);
      }
    }

    function showToast(message, isError = false) {
      const toast = document.createElement('div');
      toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-xl text-sm font-semibold z-50 transition-opacity duration-300 ${isError ? 'bg-red-600' : 'bg-emerald-600'}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 2000);
    }

    // Handle Enter key in template name input
    document.addEventListener('DOMContentLoaded', function() {
      const templateInput = document.getElementById('template-name-input');
      if (templateInput) {
        templateInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            saveTemplate();
          }
        });
      }
    });
  </script>
</body>
</html>
