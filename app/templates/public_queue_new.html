{% extends "pwa_base.html" %}

{% block title %}Print Queue | Printellect{% endblock %}

{% block nav_queue %}text-white bg-zinc-800{% endblock %}
{% block bnav_queue %}active{% endblock %}

{% block header_title %}Queue{% endblock %}

{% block content %}
<!-- Quick Stats -->
<div id="queue-stats" class="grid grid-cols-4 gap-2 mb-4">
  <div class="bg-zinc-900/60 border border-zinc-800 rounded-xl p-3 text-center">
    <div class="text-xl font-bold text-zinc-200">{{ counts["NEW"] }}</div>
    <div class="text-xs text-zinc-500">New</div>
  </div>
  <div class="bg-indigo-900/30 border border-indigo-700/50 rounded-xl p-3 text-center">
    <div class="text-xl font-bold text-indigo-300">{{ counts["APPROVED"] }}</div>
    <div class="text-xs text-indigo-400">Queued</div>
  </div>
  <div class="bg-emerald-900/30 border border-emerald-700/50 rounded-xl p-3 text-center">
    <div class="text-xl font-bold text-emerald-300">{{ counts["PRINTING_BUILDS"] or ((counts["PRINTING"] or 0) + (counts["IN_PROGRESS"] or 0)) }}</div>
    <div class="text-xs text-emerald-400">Printing</div>
  </div>
  <div class="bg-amber-900/30 border border-amber-700/50 rounded-xl p-3 text-center">
    <div class="text-xl font-bold text-amber-300">{{ counts["DONE"] }}</div>
    <div class="text-xs text-amber-400">Done</div>
  </div>
</div>

<!-- Your Position (if tracking a request) -->
{% if mine and my_pos %}
<div id="my-position" class="mb-4 bg-gradient-to-r from-indigo-600/20 to-purple-600/10 border border-indigo-500/40 rounded-2xl p-4">
  <div class="flex items-center justify-between">
    <div>
      <p class="text-sm text-zinc-400">Your Request</p>
      <p class="font-mono font-semibold text-indigo-200">{{ mine }}</p>
    </div>
    <div class="text-right">
      <p class="text-sm text-zinc-400">Position</p>
      <p class="text-3xl font-bold text-indigo-300 position-number">#{{ my_pos }}</p>
    </div>
  </div>
</div>
{% endif %}

<!-- PWA Install (collapsed, non-intrusive) -->
<div id="pwa-promo" class="hidden mb-4">
  <button onclick="installPWA()" class="w-full flex items-center justify-between bg-zinc-900/60 border border-zinc-700 rounded-xl px-4 py-3 tap-highlight">
    <div class="flex items-center gap-3">
      <span class="text-xl">üì≤</span>
      <span class="text-sm">Install app for notifications</span>
    </div>
    <span class="text-xs text-indigo-400">Install ‚Üí</span>
  </button>
</div>
<script>
  (function() {
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    if (!isStandalone && !localStorage.getItem('pwa_promo_dismissed')) {
      document.getElementById('pwa-promo')?.classList.remove('hidden');
    }
  })();
</script>

<!-- Printer Status Cards -->
<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
  <!-- Adventurer 4 -->
  <div class="bg-zinc-900/60 border {% if printer_status.ADVENTURER_4.is_offline and printer_status.ADVENTURER_4.is_cached %}border-amber-700/50{% else %}border-zinc-800{% endif %} rounded-xl p-4">
    <div class="flex items-center justify-between mb-3">
      <span class="font-semibold text-sm">üñ® Adventurer 4</span>
      <span id="printer-status-ADVENTURER_4">
      {% if printer_status.ADVENTURER_4.status %}
        <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-lg text-xs font-medium
          {% if printer_status.ADVENTURER_4.is_offline %}bg-amber-600/20 text-amber-300 border border-amber-500/50
          {% elif printer_status.ADVENTURER_4.is_printing %}bg-emerald-500/20 text-emerald-300 border border-emerald-500/50
          {% elif printer_status.ADVENTURER_4.status == 'READY' %}bg-green-500/20 text-green-300 border border-green-500/50
          {% else %}bg-amber-500/20 text-amber-300 border border-amber-500/50{% endif %}">
          {% if printer_status.ADVENTURER_4.is_offline %}
          <span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span>
          {% else %}
          <span class="w-1.5 h-1.5 rounded-full animate-pulse {% if printer_status.ADVENTURER_4.is_printing %}bg-emerald-400{% elif printer_status.ADVENTURER_4.status == 'READY' %}bg-green-400{% else %}bg-amber-400{% endif %}"></span>
          {% endif %}
          {% if printer_status.ADVENTURER_4.is_offline %}Offline{% else %}{{ printer_status.ADVENTURER_4.status }}{% endif %}
        </span>
      {% else %}
        <span class="px-2 py-1 rounded-lg text-xs bg-zinc-800 text-zinc-500">Offline</span>
      {% endif %}
      </span>
    </div>
    
    <!-- Last seen indicator for offline printers with cached data -->
    {% if printer_status.ADVENTURER_4.is_offline and printer_status.ADVENTURER_4.is_cached %}
    <div class="mb-2 px-2 py-1.5 bg-amber-900/20 border border-amber-700/30 rounded-lg text-xs text-amber-300">
      <span class="font-medium">üì° Connection lost</span>
      <span class="text-amber-400/80">‚Ä¢ Last status: {{ printer_status.ADVENTURER_4.status or 'Unknown' }}</span>
      {% if printer_status.ADVENTURER_4.last_seen %}
      <span class="text-amber-400/60">‚Ä¢ Last seen: {{ printer_status.ADVENTURER_4.last_seen[:19].replace('T', ' ') }}</span>
      {% endif %}
    </div>
    {% endif %}
    
    <!-- Printing info - container with ID for JavaScript updates -->
    <div id="printing-info-ADVENTURER_4" class="{% if not printer_status.ADVENTURER_4.is_printing %}hidden{% endif %}">
    {% if printer_status.ADVENTURER_4.is_printing %}
    <div class="space-y-3 mb-3">
      <!-- Current print job details - PROMINENT -->
      {% if printing_by_printer.ADVENTURER_4 %}
      {% set pit = printing_by_printer.ADVENTURER_4 %}
      {% set is_likely = pit.get('_likely_printing', False) %}
      <div class="{% if is_likely %}bg-amber-900/30 border border-amber-600/40{% else %}bg-emerald-900/30 border border-emerald-600/40{% endif %} rounded-lg p-3">
        {% if is_likely %}
        <p class="text-[10px] text-amber-400 font-semibold mb-1 uppercase tracking-wide">üìã Likely Printing</p>
        {% endif %}
        <div class="flex items-start justify-between gap-2 mb-2">
          <div class="min-w-0 flex-1">
            <p class="font-bold {% if is_likely %}text-amber-100{% else %}text-emerald-100{% endif %} text-base truncate">{{ pit.print_name or pit.short_id }}</p>
            <p class="text-sm {% if is_likely %}text-amber-200/80{% else %}text-emerald-200/80{% endif %}">By: {{ pit.requester_first }}</p>
          </div>
          <span class="flex-shrink-0 px-2 py-1 rounded-lg text-xs font-bold {% if is_likely %}bg-amber-500/30 border border-amber-400/50 text-amber-200{% else %}bg-emerald-500/30 border border-emerald-400/50 text-emerald-200{% endif %}">#{{ pit.queue_pos }}</span>
        </div>
        <div class="flex flex-wrap items-center gap-2 text-xs">
          <span class="px-2 py-0.5 rounded bg-zinc-800/80 text-zinc-300">{{ pit.material }}</span>
          {% if pit.total_builds > 1 %}
          <span class="px-2 py-0.5 rounded bg-amber-700/50 border border-amber-500/50 text-amber-200 font-semibold" title="Currently printing build {{ pit.build_number or (pit.completed_builds + 1) }} of {{ pit.total_builds }}">Build {{ pit.build_number or (pit.completed_builds + 1) }}/{{ pit.total_builds }}</span>
          {% endif %}
          {% if pit.smart_eta_display %}
          <span class="ml-auto {% if is_likely %}text-amber-300{% else %}text-emerald-300{% endif %} font-medium">ETA: {{ pit.smart_eta_display }}</span>
          {% endif %}
        </div>
        {% if pit.total_builds > 1 %}
        <!-- Mini build progress bar -->
        <div class="flex gap-0.5 mt-2" title="Build {{ pit.build_number or (pit.completed_builds + 1) }} of {{ pit.total_builds }} printing">
          {% for i in range(pit.total_builds) %}
            {% set current_build = pit.build_number or (pit.completed_builds + 1) %}
            <div class="flex-1 h-1 rounded-full {% if i + 1 == current_build %}bg-amber-500 animate-pulse{% elif i + 1 < current_build %}bg-emerald-500{% else %}bg-zinc-700{% endif %}"></div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% endif %}
      
      <!-- File and progress -->
      <div class="text-xs text-zinc-400 space-y-2">
        {% if printer_status.ADVENTURER_4.current_file %}
        <p class="truncate text-zinc-500">üìÑ {{ printer_status.ADVENTURER_4.current_file }}</p>
        {% endif %}
        {% if printer_status.ADVENTURER_4.progress is not none %}
        <div class="flex items-center gap-2">
          <div class="flex-1 h-2 bg-zinc-800 rounded-full overflow-hidden">
            <div class="h-full bg-gradient-to-r from-emerald-500 to-emerald-400 transition-all" style="width: {{ printer_status.ADVENTURER_4.progress }}%"></div>
          </div>
          <span class="text-emerald-300 font-semibold min-w-[3rem] text-right">{{ printer_status.ADVENTURER_4.progress }}%</span>
        </div>
        {% endif %}
        {% if printer_status.ADVENTURER_4.current_layer is not none %}
        <p>Layer: <span class="text-blue-300 font-medium">{{ printer_status.ADVENTURER_4.current_layer }}/{{ printer_status.ADVENTURER_4.total_layers }}</span></p>
        {% endif %}
      </div>
    </div>
    {% endif %}
    </div><!-- Close printing-info-ADVENTURER_4 -->
    
    <!-- Temperature and Camera row -->
    <div class="flex items-center justify-between text-xs pt-2 border-t border-zinc-700/50">
      <span class="text-zinc-400">
        {% if printer_status.ADVENTURER_4.temp %}
        üå° <span class="text-zinc-200">{{ printer_status.ADVENTURER_4.temp }}¬∞C</span>
        {% if printer_status.ADVENTURER_4.target_temp %}
        <span class="text-zinc-500">/ {{ printer_status.ADVENTURER_4.target_temp }}¬∞C</span>
        {% endif %}
        {% else %}
        <span class="text-zinc-600">‚Äî</span>
        {% endif %}
      </span>
      {% if printer_status.ADVENTURER_4.camera_url %}
      <button type="button" onclick="toggleCamera('ADVENTURER_4')" id="cam-btn-ADVENTURER_4" 
              class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 rounded-lg text-xs font-medium text-zinc-300 transition">
        <span>üì∑</span> <span class="btn-text">Show Camera</span>
      </button>
      {% endif %}
    </div>
    
    <!-- Camera preview (hidden by default) -->
    <div id="cam-ADVENTURER_4" class="hidden mt-3">
      <img id="cam-img-ADVENTURER_4" class="w-full rounded-lg bg-zinc-800 border border-zinc-700" alt="Camera" />
      <div class="text-xs text-zinc-500 mt-1 text-center">Updates every 10 seconds</div>
    </div>
  </div>

  <!-- AD5X -->
  <div class="bg-zinc-900/60 border {% if printer_status.AD5X.is_offline and printer_status.AD5X.is_cached %}border-amber-700/50{% else %}border-zinc-800{% endif %} rounded-xl p-4">
    <div class="flex items-center justify-between mb-3">
      <span class="font-semibold text-sm">üñ® AD5X</span>
      <span id="printer-status-AD5X">
      {% if printer_status.AD5X.status %}
        <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-lg text-xs font-medium
          {% if printer_status.AD5X.is_offline %}bg-amber-600/20 text-amber-300 border border-amber-500/50
          {% elif printer_status.AD5X.is_printing %}bg-emerald-500/20 text-emerald-300 border border-emerald-500/50
          {% elif printer_status.AD5X.status == 'READY' %}bg-green-500/20 text-green-300 border border-green-500/50
          {% else %}bg-amber-500/20 text-amber-300 border border-amber-500/50{% endif %}">
          {% if printer_status.AD5X.is_offline %}
          <span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span>
          {% else %}
          <span class="w-1.5 h-1.5 rounded-full animate-pulse {% if printer_status.AD5X.is_printing %}bg-emerald-400{% elif printer_status.AD5X.status == 'READY' %}bg-green-400{% else %}bg-amber-400{% endif %}"></span>
          {% endif %}
          {% if printer_status.AD5X.is_offline %}Offline{% else %}{{ printer_status.AD5X.status }}{% endif %}
        </span>
      {% else %}
        <span class="px-2 py-1 rounded-lg text-xs bg-zinc-800 text-zinc-500">Offline</span>
      {% endif %}
      </span>
    </div>
    
    <!-- Last seen indicator for offline printers with cached data -->
    {% if printer_status.AD5X.is_offline and printer_status.AD5X.is_cached %}
    <div class="mb-2 px-2 py-1.5 bg-amber-900/20 border border-amber-700/30 rounded-lg text-xs text-amber-300">
      <span class="font-medium">üì° Connection lost</span>
      <span class="text-amber-400/80">‚Ä¢ Last status: {{ printer_status.AD5X.status or 'Unknown' }}</span>
      {% if printer_status.AD5X.last_seen %}
      <span class="text-amber-400/60">‚Ä¢ Last seen: {{ printer_status.AD5X.last_seen[:19].replace('T', ' ') }}</span>
      {% endif %}
    </div>
    {% endif %}
    
    <!-- Printing info - container with ID for JavaScript updates -->
    <div id="printing-info-AD5X" class="{% if not printer_status.AD5X.is_printing %}hidden{% endif %}">
    {% if printer_status.AD5X.is_printing %}
    <div class="space-y-3 mb-3">
      <!-- Current print job details - PROMINENT -->
      {% if printing_by_printer.AD5X %}
      {% set pit = printing_by_printer.AD5X %}
      {% set is_likely = pit.get('_likely_printing', False) %}
      <div class="{% if is_likely %}bg-amber-900/30 border border-amber-600/40{% else %}bg-emerald-900/30 border border-emerald-600/40{% endif %} rounded-lg p-3">
        {% if is_likely %}
        <p class="text-[10px] text-amber-400 font-semibold mb-1 uppercase tracking-wide">üìã Likely Printing</p>
        {% endif %}
        <div class="flex items-start justify-between gap-2 mb-2">
          <div class="min-w-0 flex-1">
            <p class="font-bold {% if is_likely %}text-amber-100{% else %}text-emerald-100{% endif %} text-base truncate">{{ pit.print_name or pit.short_id }}</p>
            <p class="text-sm {% if is_likely %}text-amber-200/80{% else %}text-emerald-200/80{% endif %}">By: {{ pit.requester_first }}</p>
          </div>
          <span class="flex-shrink-0 px-2 py-1 rounded-lg text-xs font-bold {% if is_likely %}bg-amber-500/30 border border-amber-400/50 text-amber-200{% else %}bg-emerald-500/30 border border-emerald-400/50 text-emerald-200{% endif %}">#{{ pit.queue_pos }}</span>
        </div>
        <div class="flex flex-wrap items-center gap-2 text-xs">
          <span class="px-2 py-0.5 rounded bg-zinc-800/80 text-zinc-300">{{ pit.material }}</span>
          {% if pit.total_builds > 1 %}
          <span class="px-2 py-0.5 rounded bg-amber-700/50 border border-amber-500/50 text-amber-200 font-semibold" title="Currently printing build {{ pit.build_number or (pit.completed_builds + 1) }} of {{ pit.total_builds }}">Build {{ pit.build_number or (pit.completed_builds + 1) }}/{{ pit.total_builds }}</span>
          {% endif %}
          {% if pit.smart_eta_display %}
          <span class="ml-auto {% if is_likely %}text-amber-300{% else %}text-emerald-300{% endif %} font-medium">ETA: {{ pit.smart_eta_display }}</span>
          {% endif %}
        </div>
        {% if pit.total_builds > 1 %}
        <!-- Mini build progress bar -->
        <div class="flex gap-0.5 mt-2" title="Build {{ pit.build_number or (pit.completed_builds + 1) }} of {{ pit.total_builds }} printing">
          {% for i in range(pit.total_builds) %}
            {% set current_build = pit.build_number or (pit.completed_builds + 1) %}
            <div class="flex-1 h-1 rounded-full {% if i + 1 == current_build %}bg-amber-500 animate-pulse{% elif i + 1 < current_build %}bg-emerald-500{% else %}bg-zinc-700{% endif %}"></div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% endif %}
      
      <!-- File and progress -->
      <div class="text-xs text-zinc-400 space-y-2">
        {% if printer_status.AD5X.current_file %}
        <p class="truncate text-zinc-500">üìÑ {{ printer_status.AD5X.current_file }}</p>
        {% endif %}
        {% if printer_status.AD5X.progress is not none %}
        <div class="flex items-center gap-2">
          <div class="flex-1 h-2 bg-zinc-800 rounded-full overflow-hidden">
            <div class="h-full bg-gradient-to-r from-emerald-500 to-emerald-400 transition-all" style="width: {{ printer_status.AD5X.progress }}%"></div>
          </div>
          <span class="text-emerald-300 font-semibold min-w-[3rem] text-right">{{ printer_status.AD5X.progress }}%</span>
        </div>
        {% endif %}
        {% if printer_status.AD5X.current_layer is not none %}
        <p>Layer: <span class="text-blue-300 font-medium">{{ printer_status.AD5X.current_layer }}/{{ printer_status.AD5X.total_layers }}</span></p>
        {% endif %}
      </div>
    </div>
    {% endif %}
    </div><!-- Close printing-info-AD5X -->
    
    <!-- Temperature and Camera row -->
    <div class="flex items-center justify-between text-xs pt-2 border-t border-zinc-700/50">
      <span class="text-zinc-400">
        {% if printer_status.AD5X.temp %}
        üå° <span class="text-zinc-200">{{ printer_status.AD5X.temp }}¬∞C</span>
        {% if printer_status.AD5X.target_temp %}
        <span class="text-zinc-500">/ {{ printer_status.AD5X.target_temp }}¬∞C</span>
        {% endif %}
        {% else %}
        <span class="text-zinc-600">‚Äî</span>
        {% endif %}
      </span>
      {% if printer_status.AD5X.camera_url %}
      <button type="button" onclick="toggleCamera('AD5X')" id="cam-btn-AD5X" 
              class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 rounded-lg text-xs font-medium text-zinc-300 transition">
        <span>üì∑</span> <span class="btn-text">Show Camera</span>
      </button>
      {% endif %}
    </div>
    
    <!-- Camera preview (hidden by default) -->
    <div id="cam-AD5X" class="hidden mt-3">
      <img id="cam-img-AD5X" class="w-full rounded-lg bg-zinc-800 border border-zinc-700" alt="Camera" />
      <div class="text-xs text-zinc-500 mt-1 text-center">Updates every 10 seconds</div>
    </div>
  </div>
</div>

<!-- Active Queue -->
<div class="mb-4">
  <div class="flex items-center justify-between mb-3">
    <h2 class="font-semibold">Active Queue</h2>
    <div class="flex items-center gap-2 text-xs">
      <span id="refresh-indicator" class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-emerald-900/30 border border-emerald-800/50 text-emerald-300">
        <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
        Live
      </span>
      <button onclick="toggleAutoRefresh()" id="refresh-toggle" class="px-2 py-1 rounded-lg bg-zinc-800 hover:bg-zinc-700 text-zinc-400 tap-highlight">‚è∏</button>
    </div>
  </div>
  
  <!-- Mobile Cards View -->
  <div id="queue-mobile" class="sm:hidden space-y-3">
  {% if active_queue %}
    {% for r in active_queue %}
    <div class="bg-zinc-900/60 border {% if r.is_mine %}border-indigo-500/50 bg-indigo-900/20{% elif r.status in ['PRINTING', 'IN_PROGRESS'] %}border-emerald-500/50 bg-emerald-900/10{% else %}border-zinc-800{% endif %} rounded-xl p-4 card-interactive">
      <div class="flex items-start justify-between mb-2">
        <div class="flex items-center gap-2">
          <span class="text-lg font-bold text-zinc-500">#{{ r.queue_pos }}</span>
          <div>
            <p class="font-semibold text-zinc-200">{{ r.print_name or r.short_id }}</p>
            <p class="text-xs text-zinc-500">{{ r.requester_first }}{% if r.total_builds > 1 %} ‚Ä¢ Build {{ r.build_number or (r.completed_builds + 1) }}/{{ r.total_builds }}{% endif %}</p>
          </div>
        </div>
        <span class="px-2 py-1 rounded-lg text-xs font-medium
          {% if r.status in ['PRINTING', 'IN_PROGRESS'] %}bg-amber-500/20 border border-amber-500/50 text-amber-300
          {% elif r.status == 'APPROVED' %}bg-emerald-500/20 border border-emerald-500/50 text-emerald-300
          {% elif r.status == 'NEEDS_INFO' %}bg-orange-500/20 border border-orange-500/50 text-orange-300
          {% else %}bg-zinc-800 text-zinc-400{% endif %}">
          {% if r.status == 'NEEDS_INFO' %}WAITING{% elif r.status == 'IN_PROGRESS' %}PRINTING{% else %}{{ r.status }}{% endif %}
        </span>
      </div>
      <div class="flex items-center gap-3 text-xs text-zinc-400">
        <span>{{ r.printer }}</span>
        <span>‚Ä¢</span>
        <span>{{ r.material }}</span>
        <span>‚Ä¢</span>
        <span>{{ r.colors }}</span>
      </div>
      {% if r.status in ['PRINTING', 'IN_PROGRESS'] and r.printer_progress is not none %}
      <div class="mt-2 flex items-center gap-2">
        <div class="flex-1 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
          <div class="h-full bg-emerald-500" style="width: {{ r.printer_progress }}%"></div>
        </div>
        <span class="text-xs text-emerald-300">{{ r.printer_progress }}%</span>
      </div>
      {% elif r.estimated_wait_minutes %}
      <p class="mt-2 text-xs text-zinc-400">Est. wait: {{ r.estimated_wait_minutes // 60 }}h {{ r.estimated_wait_minutes % 60 }}m</p>
      {% endif %}
    </div>
    {% endfor %}
  {% else %}
    <!-- Empty State for Mobile -->
    <div class="text-center py-12 bg-zinc-900/30 rounded-2xl border border-zinc-800">
      <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-zinc-800/50 flex items-center justify-center">
        <svg class="w-8 h-8 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
        </svg>
      </div>
      <h3 class="text-lg font-semibold text-zinc-300">Queue is empty!</h3>
      <p class="text-sm text-zinc-500 mt-1 max-w-xs mx-auto">No prints waiting. Be the first to submit a request!</p>
      <a href="/" class="inline-flex items-center gap-2 mt-4 px-6 py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-semibold rounded-xl transition tap-highlight">
        Submit Request
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
        </svg>
      </a>
    </div>
  {% endif %}
  </div>
  
  <!-- Desktop Table View -->
  <div id="queue-desktop" class="hidden sm:block overflow-x-auto bg-zinc-900/60 rounded-2xl border border-zinc-800">
    <table class="w-full text-sm">
      <thead class="text-zinc-400 bg-zinc-950/40 text-xs">
        <tr class="border-b border-zinc-800">
          <th class="text-left p-3">#</th>
          <th class="text-left p-3">Print</th>
          <th class="text-left p-3">Requester</th>
          <th class="text-left p-3">Printer</th>
          <th class="text-left p-3">Material</th>
          <th class="text-left p-3">Status</th>
          <th class="text-left p-3">Progress</th>
        </tr>
      </thead>
      <tbody>
      {% if active_queue %}
        {% for r in active_queue %}
        <tr class="border-b border-zinc-800 {% if r.is_mine %}bg-indigo-900/20{% elif r.status in ['PRINTING', 'IN_PROGRESS'] %}bg-emerald-900/10{% else %}hover:bg-zinc-950/40{% endif %} transition">
          <td class="p-3 text-zinc-500 font-semibold">{{ r.queue_pos }}</td>
          <td class="p-3">
            <span class="font-medium text-zinc-200">{{ r.print_name or r.short_id }}</span>
            {% if r.print_name %}<span class="block text-xs text-zinc-500 font-mono">{{ r.short_id }}</span>{% endif %}
            {% if r.total_builds > 1 %}<span class="block text-xs text-amber-400">Build {{ r.build_number or (r.completed_builds + 1) }}/{{ r.total_builds }}</span>{% endif %}
          </td>
          <td class="p-3 text-zinc-400">{{ r.requester_first }}</td>
          <td class="p-3 text-zinc-400">{{ r.printer }}</td>
          <td class="p-3 text-zinc-400">{{ r.material }}</td>
          <td class="p-3">
            <span class="px-2 py-1 rounded-lg text-xs font-medium
              {% if r.status in ['PRINTING', 'IN_PROGRESS'] %}bg-amber-500/20 border border-amber-500/50 text-amber-300
              {% elif r.status == 'APPROVED' %}bg-emerald-500/20 border border-emerald-500/50 text-emerald-300
              {% elif r.status == 'NEEDS_INFO' %}bg-orange-500/20 border border-orange-500/50 text-orange-300
              {% else %}bg-zinc-800 text-zinc-400{% endif %}">
              {% if r.status == 'NEEDS_INFO' %}WAITING{% elif r.status == 'IN_PROGRESS' %}PRINTING{% else %}{{ r.status }}{% endif %}
            </span>
          </td>
          <td class="p-3">
            {% if r.status in ['PRINTING', 'IN_PROGRESS'] and r.printer_progress is not none %}
            <div class="flex items-center gap-2">
              <div class="w-16 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                <div class="h-full bg-emerald-500" style="width: {{ r.printer_progress }}%"></div>
              </div>
              <span class="text-xs text-emerald-300">{{ r.printer_progress }}%</span>
            </div>
            {% elif r.estimated_wait_minutes %}
            <span class="text-xs text-zinc-400">~{{ r.estimated_wait_minutes // 60 }}h {{ r.estimated_wait_minutes % 60 }}m</span>
            {% else %}
            <span class="text-xs text-emerald-300">Up next!</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Done Items -->
<div id="done-items" class="mb-4 {% if not done_items %}hidden{% endif %}">
  <h2 class="font-semibold mb-3 text-amber-300">‚úÖ Ready for Pickup</h2>
  <div class="done-list space-y-2">
  {% if done_items %}
    {% for r in done_items %}
    <div class="flex items-center justify-between bg-amber-900/20 border border-amber-700/30 rounded-xl px-4 py-3 {% if r.is_mine %}ring-1 ring-amber-500/50{% endif %}">
      <div class="flex items-center gap-3">
        <span class="text-lg">üì¶</span>
        <div>
          <p class="font-medium text-zinc-200">{{ r.print_name or r.short_id }}</p>
          <p class="text-xs text-zinc-500">{{ r.requester_first }} ‚Ä¢ {{ r.printer }}</p>
        </div>
      </div>
      <span class="text-xs text-amber-300">Ready!</span>
    </div>
    {% endfor %}
  {% endif %}
  </div>
</div>

<!-- Footer -->
<div class="mt-6 pt-4 border-t border-zinc-800 flex items-center justify-between text-xs text-zinc-500">
  <span id="last-update">Updated just now</span>
  <div class="flex items-center gap-4">
    <a href="/feedback?type=bug" class="hover:text-red-400 transition">üêõ</a>
    <a href="/feedback?type=suggestion" class="hover:text-yellow-400 transition">üí°</a>
    <a href="/changelog" class="hover:text-indigo-400 transition">v{{ version }}</a>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Camera toggle
  const camIntervals = {};
  
  function toggleCamera(printer) {
    const div = document.getElementById(`cam-${printer}`);
    const btn = document.getElementById(`cam-btn-${printer}`);
    const img = document.getElementById(`cam-img-${printer}`);
    
    console.log('[Camera] toggleCamera called for:', printer, { div: !!div, btn: !!btn, img: !!img });
    
    if (!div || !btn || !img) {
      console.warn('[Camera] Missing elements for', printer);
      if (btn) {
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
        btn.title = 'Camera unavailable';
      }
      return;
    }
    
    const btnText = btn.querySelector('.btn-text');
    
    if (div.classList.contains('hidden')) {
      // Show camera
      div.classList.remove('hidden');
      if (btnText) btnText.textContent = 'Hide Camera';
      
      // Show loading state
      img.alt = 'Loading camera...';
      img.src = `/api/camera/${printer}/snapshot?t=${Date.now()}`;
      console.log('[Camera] Loading:', img.src);
      
      // Handle image load error
      img.onerror = function() {
        console.error('[Camera] Load error for', printer);
        img.alt = 'Camera unavailable';
        if (btnText) btnText.textContent = 'Camera Error';
        clearInterval(camIntervals[printer]);
      };
      img.onload = function() {
        console.log('[Camera] Loaded successfully for', printer);
        img.alt = 'Camera feed';
      };
      
      // Auto-refresh every 10 seconds
      camIntervals[printer] = setInterval(() => {
        const newImg = new Image();
        newImg.onload = function() {
          img.src = this.src;
        };
        newImg.src = `/api/camera/${printer}/snapshot?t=${Date.now()}`;
      }, 10000);
    } else {
      // Hide camera
      div.classList.add('hidden');
      if (btnText) btnText.textContent = 'Show Camera';
      clearInterval(camIntervals[printer]);
      console.log('[Camera] Hidden for', printer);
    }
  }
  
  // AJAX-based auto-refresh (no full page reload)
  let autoRefresh = true;
  let refreshInterval = null;
  const mine = '{{ mine or "" }}';
  
  function startAutoRefresh() {
    refreshInterval = setInterval(refreshQueueData, 30000);
  }
  
  function toggleAutoRefresh() {
    autoRefresh = !autoRefresh;
    const btn = document.getElementById('refresh-toggle');
    const ind = document.getElementById('refresh-indicator');
    btn.textContent = autoRefresh ? '‚è∏' : '‚ñ∂';
    ind.style.opacity = autoRefresh ? '1' : '0.5';
    
    if (autoRefresh) {
      refreshQueueData(); // Immediate refresh when re-enabled
      startAutoRefresh();
    } else {
      clearInterval(refreshInterval);
    }
  }
  
  async function refreshQueueData() {
    if (!autoRefresh) return;
    
    try {
      const url = mine ? `/api/queue?mine=${mine}` : '/api/queue';
      const response = await fetch(url);
      const data = await response.json();
      
      // Update stats - use PRINTING_BUILDS if available (counts actual builds printing)
      // Otherwise fall back to combining PRINTING and IN_PROGRESS request counts
      const printingCount = data.counts.PRINTING_BUILDS ?? ((data.counts.PRINTING || 0) + (data.counts.IN_PROGRESS || 0));
      const adjustedCounts = {...data.counts, PRINTING: printingCount};
      updateStats(adjustedCounts);
      
      // Update my position if tracking
      updateMyPosition(data.my_pos);
      
      // Update printer status cards with printing_by_printer data
      updatePrinterStatus(data.printer_status, data.printing_by_printer || {});
      
      // Update queue list
      updateQueueList(data.active_queue, data.done_items);
      
      // Update timestamp
      document.getElementById('last-update').textContent = 'Updated just now';
      
    } catch (e) {
      console.error('Refresh failed:', e);
    }
  }
  
  function updateStats(counts) {
    const statsEl = document.getElementById('queue-stats');
    if (statsEl) {
      statsEl.innerHTML = `
        <div class="bg-zinc-900/60 border border-zinc-800 rounded-xl p-3 text-center">
          <div class="text-xl font-bold text-zinc-200">${counts.NEW || 0}</div>
          <div class="text-xs text-zinc-500">New</div>
        </div>
        <div class="bg-indigo-900/30 border border-indigo-700/50 rounded-xl p-3 text-center">
          <div class="text-xl font-bold text-indigo-300">${counts.APPROVED || 0}</div>
          <div class="text-xs text-indigo-400">Queued</div>
        </div>
        <div class="bg-emerald-900/30 border border-emerald-700/50 rounded-xl p-3 text-center">
          <div class="text-xl font-bold text-emerald-300">${counts.PRINTING || 0}</div>
          <div class="text-xs text-emerald-400">Printing</div>
        </div>
        <div class="bg-amber-900/30 border border-amber-700/50 rounded-xl p-3 text-center">
          <div class="text-xl font-bold text-amber-300">${counts.DONE || 0}</div>
          <div class="text-xs text-amber-400">Done</div>
        </div>
      `;
    }
  }
  
  function updateMyPosition(pos) {
    const el = document.getElementById('my-position');
    if (el && pos) {
      el.querySelector('.position-number').textContent = '#' + pos;
    }
  }
  
  function updatePrinterStatus(printerStatus, printingByPrinter) {
    // Update Adventurer 4 status
    updateSinglePrinter('ADVENTURER_4', printerStatus.ADVENTURER_4 || {}, printingByPrinter.ADVENTURER_4);
    updateSinglePrinter('AD5X', printerStatus.AD5X || {}, printingByPrinter.AD5X);
  }
  
  function updateSinglePrinter(code, status, printingItem) {
    const statusEl = document.getElementById(`printer-status-${code}`);
    if (!statusEl) return;
    
    if (status.status) {
      let badgeClass = 'bg-amber-500/20 text-amber-300 border-amber-500/50';
      let dotClass = 'bg-amber-400';
      
      if (status.is_printing) {
        badgeClass = 'bg-emerald-500/20 text-emerald-300 border-emerald-500/50';
        dotClass = 'bg-emerald-400';
      } else if (status.status === 'READY') {
        badgeClass = 'bg-green-500/20 text-green-300 border-green-500/50';
        dotClass = 'bg-green-400';
      }
      
      statusEl.innerHTML = `
        <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-lg text-xs font-medium ${badgeClass} border">
          <span class="w-1.5 h-1.5 rounded-full animate-pulse ${dotClass}"></span>
          ${status.status}
        </span>
      `;
    } else {
      statusEl.innerHTML = `<span class="px-2 py-1 rounded-lg text-xs bg-zinc-800 text-zinc-500">Offline</span>`;
    }
    
    // Update the "Currently Printing" job card
    const printingInfoEl = document.getElementById(`printing-info-${code}`);
    if (printingInfoEl) {
      if (status.is_printing && printingItem) {
        // Build the printing info card HTML
        const isLikely = printingItem._likely_printing || false;
        const bgClass = isLikely ? 'bg-amber-900/30 border border-amber-600/40' : 'bg-emerald-900/30 border border-emerald-600/40';
        const textClass = isLikely ? 'text-amber-' : 'text-emerald-';
        
        let buildsHtml = '';
        const currentBuildNum = printingItem.build_number || (printingItem.completed_builds + 1);
        if (printingItem.total_builds > 1) {
          buildsHtml = `<span class="px-2 py-0.5 rounded bg-amber-700/50 border border-amber-500/50 text-amber-200 font-semibold" title="Currently printing build ${currentBuildNum} of ${printingItem.total_builds}">Build ${currentBuildNum}/${printingItem.total_builds}</span>`;
          
          // Mini build progress bar - check current build first, then position
          let progressBars = '';
          for (let i = 0; i < printingItem.total_builds; i++) {
            const barClass = (i + 1 === currentBuildNum) ? 'bg-amber-500 animate-pulse' : 
                            (i + 1 < currentBuildNum ? 'bg-emerald-500' : 'bg-zinc-700');
            progressBars += `<div class="flex-1 h-1 rounded-full ${barClass}"></div>`;
          }
          buildsHtml += `<div class="flex gap-0.5 mt-2 w-full" title="Build ${currentBuildNum} of ${printingItem.total_builds} printing">${progressBars}</div>`;
        }
        
        printingInfoEl.innerHTML = `
          <div class="space-y-3 mb-3">
            <div class="${bgClass} rounded-lg p-3">
              ${isLikely ? '<p class="text-[10px] text-amber-400 font-semibold mb-1 uppercase tracking-wide">üìã Likely Printing</p>' : ''}
              <div class="flex items-start justify-between gap-2 mb-2">
                <div class="min-w-0 flex-1">
                  <p class="font-bold ${isLikely ? 'text-amber-100' : 'text-emerald-100'} text-base truncate">${printingItem.print_name || printingItem.short_id}</p>
                  <p class="text-sm ${isLikely ? 'text-amber-200/80' : 'text-emerald-200/80'}">By: ${printingItem.requester_first}</p>
                </div>
                <span class="flex-shrink-0 px-2 py-1 rounded-lg text-xs font-bold ${isLikely ? 'bg-amber-500/30 border border-amber-400/50 text-amber-200' : 'bg-emerald-500/30 border border-emerald-400/50 text-emerald-200'}">#${printingItem.queue_pos}</span>
              </div>
              <div class="flex flex-wrap items-center gap-2 text-xs">
                <span class="px-2 py-0.5 rounded bg-zinc-800/80 text-zinc-300">${printingItem.material}</span>
                ${buildsHtml}
                ${printingItem.smart_eta_display ? `<span class="ml-auto ${isLikely ? 'text-amber-300' : 'text-emerald-300'} font-medium">ETA: ${printingItem.smart_eta_display}</span>` : ''}
              </div>
            </div>
            
            <!-- File and progress -->
            <div class="text-xs text-zinc-400 space-y-2">
              ${status.current_file ? `<p class="truncate text-zinc-500">üìÑ ${status.current_file}</p>` : ''}
              ${status.progress !== null && status.progress !== undefined ? `
              <div class="flex items-center gap-2">
                <div class="flex-1 h-2 bg-zinc-800 rounded-full overflow-hidden">
                  <div class="h-full bg-gradient-to-r from-emerald-500 to-emerald-400 transition-all" style="width: ${status.progress}%"></div>
                </div>
                <span class="text-emerald-300 font-semibold min-w-[3rem] text-right">${status.progress}%</span>
              </div>
              ` : ''}
              ${status.current_layer !== null && status.current_layer !== undefined ? `<p>Layer: <span class="text-blue-300 font-medium">${status.current_layer}/${status.total_layers || '?'}</span></p>` : ''}
            </div>
          </div>
        `;
        printingInfoEl.classList.remove('hidden');
      } else {
        printingInfoEl.innerHTML = '';
        printingInfoEl.classList.add('hidden');
      }
    }
  }
  
  function updateQueueList(activeQueue, doneItems) {
    const mobileEl = document.getElementById('queue-mobile');
    const desktopEl = document.getElementById('queue-desktop');
    
    if (!mobileEl || !desktopEl) return;
    
    if (activeQueue.length === 0) {
      mobileEl.innerHTML = `
        <div class="text-center py-12 bg-zinc-900/30 rounded-2xl border border-zinc-800">
          <div class="text-5xl mb-4">üéâ</div>
          <h3 class="text-lg font-semibold text-zinc-300">Queue is empty!</h3>
          <p class="text-sm text-zinc-500 mt-1 max-w-xs mx-auto">No prints waiting. Be the first to submit a request!</p>
          <a href="/" class="inline-flex items-center gap-2 mt-4 px-6 py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-semibold rounded-xl transition tap-highlight">
            Submit Request ‚Üí
          </a>
        </div>
      `;
      desktopEl.innerHTML = mobileEl.innerHTML;
      return;
    }
    
    // Mobile cards - treat IN_PROGRESS same as PRINTING
    mobileEl.innerHTML = activeQueue.map(r => {
      const isPrinting = r.status === 'PRINTING' || r.status === 'IN_PROGRESS';
      return `
      <div class="bg-zinc-900/60 border ${r.is_mine ? 'border-indigo-500/50 bg-indigo-900/20' : isPrinting ? 'border-emerald-500/50 bg-emerald-900/10' : 'border-zinc-800'} rounded-xl p-4 card-interactive">
        <div class="flex items-start justify-between mb-2">
          <div class="flex items-center gap-2">
            <span class="text-lg font-bold text-zinc-500">#${r.queue_pos}</span>
            <div>
              <p class="font-semibold text-zinc-200">${r.print_name || r.short_id}</p>
              <p class="text-xs text-zinc-500">${r.requester_first}</p>
            </div>
          </div>
          <span class="px-2 py-1 rounded-lg text-xs font-medium ${getStatusClass(r.status)}">
            ${r.status === 'NEEDS_INFO' ? 'WAITING' : (r.status === 'IN_PROGRESS' ? 'PRINTING' : r.status)}
          </span>
        </div>
        <div class="flex items-center gap-3 text-xs text-zinc-400">
          <span>${r.printer}</span>
          <span>‚Ä¢</span>
          <span>${r.material}</span>
          <span>‚Ä¢</span>
          <span>${r.colors}</span>
        </div>
        ${isPrinting && r.printer_progress !== null ? `
        <div class="mt-2 flex items-center gap-2">
          <div class="flex-1 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
            <div class="h-full bg-emerald-500" style="width: ${r.printer_progress}%"></div>
          </div>
          <span class="text-xs text-emerald-300">${r.printer_progress}%</span>
        </div>
        ` : ''}
        ${r.total_builds > 1 ? `
        <div class="mt-2 flex items-center gap-2 text-xs">
          <span class="text-amber-300">Build ${r.build_number || (r.completed_builds + 1)}/${r.total_builds}</span>
          <div class="flex gap-0.5 flex-1">
            ${Array(r.total_builds).fill(0).map((_, i) => {
              const currentBuild = r.build_number || (r.completed_builds + 1);
              return `<div class="flex-1 h-1 rounded-full ${(i + 1 === currentBuild) ? 'bg-amber-500' : (i + 1 < currentBuild ? 'bg-emerald-500' : 'bg-zinc-700')}"></div>`;
            }).join('')}
          </div>
        </div>
        ` : ''}
      </div>
    `;}).join('');
    
    // Desktop table - treat IN_PROGRESS same as PRINTING
    desktopEl.querySelector('tbody').innerHTML = activeQueue.map(r => {
      const isPrinting = r.status === 'PRINTING' || r.status === 'IN_PROGRESS';
      return `
      <tr class="border-b border-zinc-800 ${r.is_mine ? 'bg-indigo-900/20' : isPrinting ? 'bg-emerald-900/10' : 'hover:bg-zinc-950/40'} transition">
        <td class="p-3 text-zinc-500 font-semibold">${r.queue_pos}</td>
        <td class="p-3">
          <span class="font-medium text-zinc-200">${r.print_name || r.short_id}</span>
          ${r.print_name ? `<span class="block text-xs text-zinc-500 font-mono">${r.short_id}</span>` : ''}
          ${r.total_builds > 1 ? `<span class="inline-block ml-1 px-1.5 py-0.5 text-[10px] rounded bg-amber-700/50 text-amber-200">Build ${r.build_number || (r.completed_builds + 1)}/${r.total_builds}</span>` : ''}
        </td>
        <td class="p-3 text-zinc-400">${r.requester_first}</td>
        <td class="p-3 text-zinc-400">${r.printer}</td>
        <td class="p-3 text-zinc-400">${r.material}</td>
        <td class="p-3">
          <span class="px-2 py-1 rounded-lg text-xs font-medium ${getStatusClass(r.status)}">
            ${r.status === 'NEEDS_INFO' ? 'WAITING' : (r.status === 'IN_PROGRESS' ? 'PRINTING' : r.status)}
          </span>
        </td>
        <td class="p-3">
          ${isPrinting && r.printer_progress !== null ? `
          <div class="flex items-center gap-2">
            <div class="w-16 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
              <div class="h-full bg-emerald-500" style="width: ${r.printer_progress}%"></div>
            </div>
            <span class="text-xs text-emerald-300">${r.printer_progress}%</span>
          </div>
          ` : '<span class="text-xs text-emerald-300">Up next!</span>'}
        </td>
      </tr>
    `;}).join('');
    
    // Update done items
    const doneEl = document.getElementById('done-items');
    if (doneEl) {
      if (doneItems.length > 0) {
        doneEl.classList.remove('hidden');
        doneEl.querySelector('.done-list').innerHTML = doneItems.map(r => `
          <div class="flex items-center justify-between bg-amber-900/20 border border-amber-700/30 rounded-xl px-4 py-3 ${r.is_mine ? 'ring-1 ring-amber-500/50' : ''}">
            <div class="flex items-center gap-3">
              <span class="text-lg">üì¶</span>
              <div>
                <p class="font-medium text-zinc-200">${r.print_name || r.short_id}</p>
                <p class="text-xs text-zinc-500">${r.requester_first} ‚Ä¢ ${r.printer}</p>
              </div>
            </div>
            <span class="text-xs text-amber-300">Ready!</span>
          </div>
        `).join('');
      } else {
        doneEl.classList.add('hidden');
      }
    }
  }
  
  function getStatusClass(status) {
    switch(status) {
      case 'PRINTING': 
      case 'IN_PROGRESS':
        return 'bg-amber-500/20 border border-amber-500/50 text-amber-300';
      case 'APPROVED': return 'bg-emerald-500/20 border border-emerald-500/50 text-emerald-300';
      case 'NEEDS_INFO': return 'bg-orange-500/20 border border-orange-500/50 text-orange-300';
      case 'NEW': return 'bg-blue-500/20 border border-blue-500/50 text-blue-300';
      case 'DONE': return 'bg-cyan-500/20 border border-cyan-500/50 text-cyan-300';
      default: return 'bg-zinc-800 text-zinc-400';
    }
  }
  
  // Start auto-refresh
  startAutoRefresh();
</script>
{% endblock %}
