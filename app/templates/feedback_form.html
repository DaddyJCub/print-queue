{% extends "pwa_base.html" %}
{% from '_components/form_field.html' import text_input, textarea, error_banner, success_banner %}

{% block title %}{{ "Bug Report" if feedback_type == "bug" else "Suggestion" }} | Printellect{% endblock %}

{% block header_title %}{% if feedback_type == "bug" %}Bug Report{% else %}Suggestion{% endif %}{% endblock %}

{% block head_extra %}
{% if turnstile_site_key %}
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
{% endif %}
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
  
  <!-- Back Button -->
  <a href="/" class="inline-flex items-center gap-1.5 text-indigo-400 hover:text-indigo-300 text-sm mb-4 transition">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
    Back to Printellect
  </a>
  
  <!-- Page Header -->
  <div class="text-center mb-8">
    <h1 class="text-3xl font-bold">
      {% if feedback_type == "bug" %}
        üêõ Report a Bug
      {% else %}
        üí° Submit a Suggestion
      {% endif %}
    </h1>
    <p class="text-zinc-400 mt-2">
      {% if feedback_type == "bug" %}
        Found something that's not working right? Let us know!
      {% else %}
        Have an idea to make this better? We'd love to hear it!
      {% endif %}
    </p>
  </div>

  <!-- Type Switcher -->
  <div class="flex justify-center gap-4 mb-6">
    <a href="/feedback?type=bug" 
       class="px-4 py-2 rounded-lg border transition {% if feedback_type == 'bug' %}bg-red-600/20 border-red-500 text-red-300{% else %}bg-zinc-900 border-zinc-700 text-zinc-400 hover:border-zinc-600{% endif %}">
      üêõ Bug Report
    </a>
    <a href="/feedback?type=suggestion" 
       class="px-4 py-2 rounded-lg border transition {% if feedback_type == 'suggestion' %}bg-purple-600/20 border-purple-500 text-purple-300{% else %}bg-zinc-900 border-zinc-700 text-zinc-400 hover:border-zinc-600{% endif %}">
      üí° Suggestion
    </a>
  </div>

  <!-- Success Message -->
  {% if submitted %}
    <div class="bg-emerald-900/30 border border-emerald-600/50 rounded-xl p-6 mb-6 text-center">
      <div class="text-4xl mb-2">‚úÖ</div>
      <h2 class="text-lg font-semibold text-emerald-300">Thank you!</h2>
      <p class="text-sm text-zinc-300 mt-2">
        Your {{ "bug report" if feedback_type == "bug" else "suggestion" }} has been submitted.
        We appreciate your feedback!
      </p>
      <div class="mt-4 flex justify-center gap-4">
        <a href="/" class="text-indigo-400 hover:underline text-sm">Return to Printellect</a>
        <a href="/feedback?type={{ feedback_type }}" class="text-zinc-400 hover:underline text-sm">Submit Another</a>
      </div>
    </div>
  {% else %}
    <!-- Error Message -->
    {{ error_banner(error) }}

    <!-- Form -->
    <form method="POST" action="/feedback" class="bg-zinc-900/50 border border-zinc-800 rounded-2xl p-6" data-loading="Submitting...">
      <input type="hidden" name="feedback_type" value="{{ feedback_type }}" />
      <input type="hidden" name="page_url" value="" id="page_url_input" />
      
      <div class="space-y-5">
        <!-- Name (optional) -->
        {{ text_input(
            name='name',
            label='Your Name',
            value=form_data.name if form_data else '',
            placeholder='John Doe'
        ) }}

        <!-- Email (optional) -->
        {{ text_input(
            name='email',
            type='email',
            label='Email',
            value=form_data.email if form_data else '',
            placeholder='john@example.com',
            help='Optional - only if you want us to follow up'
        ) }}

        <!-- Message -->
        {{ textarea(
            name='message',
            label='What happened?' if feedback_type == 'bug' else 'Your suggestion',
            value=form_data.message if form_data else '',
            required=true,
            rows=6,
            placeholder='Please describe what happened, what you expected to happen, and any steps to reproduce the issue...' if feedback_type == 'bug' else 'Share your idea for improving the print queue system...',
            help='Minimum 10 characters'
        ) }}

        <!-- Tips -->
        {% if feedback_type == "bug" %}
          <div class="bg-amber-900/20 border border-amber-800/40 rounded-xl p-4">
            <div class="text-sm text-amber-200 font-semibold mb-2">üí° Tips for a helpful bug report:</div>
            <ul class="text-xs text-amber-100/70 space-y-1 list-disc list-inside">
              <li>Describe what you were trying to do</li>
              <li>What did you expect to happen?</li>
              <li>What actually happened instead?</li>
              <li>Include any error messages you saw</li>
              <li>Which browser are you using?</li>
            </ul>
          </div>
        {% endif %}

        <!-- Turnstile -->
        {% if turnstile_site_key %}
          <div class="cf-turnstile" data-sitekey="{{ turnstile_site_key }}" data-theme="dark"></div>
        {% endif %}

        <!-- Submit -->
        <button type="submit" 
                class="w-full rounded-xl py-3 font-semibold transition
                  {% if feedback_type == 'bug' %}
                    bg-red-600 hover:bg-red-500
                  {% else %}
                    bg-purple-600 hover:bg-purple-500
                  {% endif %}">
          {% if feedback_type == "bug" %}
            üêõ Submit Bug Report
          {% else %}
            üí° Submit Suggestion
          {% endif %}
        </button>
      </div>
    </form>
  {% endif %}
</div>

<script>
  // Capture referrer URL
  document.getElementById('page_url_input').value = document.referrer || window.location.href;
  
  // Prevent duplicate submissions
  document.querySelector('form')?.addEventListener('submit', function(e) {
    const btn = this.querySelector('button[type="submit"]');
    if (btn.disabled) {
      e.preventDefault();
      return false;
    }
    btn.disabled = true;
    btn.innerHTML = '<span class="animate-pulse">Submitting...</span>';
    btn.classList.add('opacity-70', 'cursor-not-allowed');
  });
</script>
{% endblock %}
