{% extends "pwa_base.html" %}

{% block title %}My Requests | Printellect{% endblock %}

{% block nav_myrequests %}text-white bg-zinc-800{% endblock %}
{% block bnav_myrequests %}active{% endblock %}

{% block header_title %}My Requests{% endblock %}

{% block header_right %}
<div class="flex items-center gap-2">
  <span class="text-xs text-zinc-400 hidden sm:block">{{ email }}</span>
  <a href="/my-requests?logout=1" class="px-2 py-1 text-xs text-zinc-400 hover:text-white hover:bg-zinc-800 rounded-lg transition">Logout</a>
</div>
{% endblock %}

{% block content %}
<!-- Sync to App Banner (for browser users) -->
<div id="sync-banner" class="hidden mb-4 bg-gradient-to-r from-indigo-600/20 to-purple-600/10 border border-indigo-500/30 rounded-xl p-3">
  <div class="flex items-center justify-between">
    <div class="flex items-center gap-2">
      <span>üì±</span>
      <span class="text-sm">Sync to Printellect app</span>
    </div>
    <button onclick="showSyncCode()" class="px-3 py-1.5 bg-white text-indigo-700 rounded-lg text-xs font-semibold tap-highlight">
      Sync to App
    </button>
  </div>
</div>

<!-- Sync Code Modal -->
<div id="sync-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
  <div class="bg-zinc-900 border border-zinc-700 rounded-2xl p-6 max-w-sm w-full text-center" onclick="event.stopPropagation()">
    <div class="text-4xl mb-3">üì≤</div>
    <h3 class="font-bold text-lg mb-2">Sync to Printellect App</h3>
    <p class="text-zinc-400 text-sm mb-4">Enter this code in the app to sync your session:</p>
    
    <!-- Code Display -->
    <div id="sync-code-display" class="bg-zinc-950 border border-zinc-700 rounded-xl py-4 px-6 mb-3">
      <span id="sync-code" class="text-3xl font-mono font-bold tracking-widest text-indigo-400">------</span>
    </div>
    <p id="sync-expires" class="text-xs text-zinc-500 mb-4">Expires in <span id="sync-timer">10:00</span></p>
    
    <div class="flex gap-2">
      <button onclick="refreshSyncCode()" class="flex-1 py-2.5 rounded-xl bg-zinc-800 hover:bg-zinc-700 text-sm font-medium transition">
        üîÑ New Code
      </button>
      <button onclick="closeSyncModal()" class="flex-1 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-sm font-medium transition">
        Done
      </button>
    </div>
    
    <div class="mt-4 pt-4 border-t border-zinc-800 text-left">
      <p class="text-xs text-zinc-500 mb-2">üìã Instructions:</p>
      <ol class="text-xs text-zinc-400 space-y-1 list-decimal list-inside">
        <li>Open the Printellect app</li>
        <li>Go to "My Requests"</li>
        <li>Tap "Sync Code" tab</li>
        <li>Enter the 6-digit code above</li>
      </ol>
    </div>
  </div>
</div>
<script>
(function() {
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  if (!isStandalone) {
    document.getElementById('sync-banner')?.classList.remove('hidden');
  }
  // Mark PWA as used if standalone
  if (isStandalone) localStorage.setItem('pwa_used', 'true');
})();

let syncTimerInterval = null;
let syncExpiry = null;

async function showSyncCode() {
  document.getElementById('sync-modal').classList.remove('hidden');
  await refreshSyncCode();
}

function closeSyncModal() {
  document.getElementById('sync-modal').classList.add('hidden');
  if (syncTimerInterval) clearInterval(syncTimerInterval);
}

async function refreshSyncCode() {
  const codeEl = document.getElementById('sync-code');
  const timerEl = document.getElementById('sync-timer');
  codeEl.textContent = '......';
  
  try {
    const formData = new FormData();
    formData.append('token', '{{ token }}');
    
    const response = await fetch('/api/generate-sync-code', {
      method: 'POST',
      body: formData
    });
    const data = await response.json();
    
    if (data.success) {
      // Format code as XXX-XXX
      const code = data.code;
      codeEl.textContent = code.slice(0,3) + '-' + code.slice(3);
      
      // Start countdown timer
      syncExpiry = Date.now() + (data.expires_in * 1000);
      if (syncTimerInterval) clearInterval(syncTimerInterval);
      syncTimerInterval = setInterval(updateTimer, 1000);
      updateTimer();
    } else {
      codeEl.textContent = 'Error';
    }
  } catch (e) {
    codeEl.textContent = 'Error';
  }
}

function updateTimer() {
  const timerEl = document.getElementById('sync-timer');
  const remaining = Math.max(0, syncExpiry - Date.now());
  const mins = Math.floor(remaining / 60000);
  const secs = Math.floor((remaining % 60000) / 1000);
  timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
  
  if (remaining <= 0) {
    timerEl.textContent = 'Expired';
    document.getElementById('sync-code').textContent = '------';
    clearInterval(syncTimerInterval);
  }
}
</script>

{% set status_colors = {
  'NEW': 'bg-blue-600/20 border-blue-500/50 text-blue-300',
  'NEEDS_INFO': 'bg-orange-600/20 border-orange-500/50 text-orange-300',
  'APPROVED': 'bg-emerald-600/20 border-emerald-500/50 text-emerald-300',
  'PRINTING': 'bg-indigo-600/20 border-indigo-500/50 text-indigo-300',
  'DONE': 'bg-green-600/20 border-green-500/50 text-green-300',
  'PICKED_UP': 'bg-zinc-600/20 border-zinc-500/50 text-zinc-400',
  'REJECTED': 'bg-red-600/20 border-red-500/50 text-red-300',
  'CANCELLED': 'bg-zinc-600/20 border-zinc-500/50 text-zinc-400'
} %}

{% if requests_list %}
  <!-- Done prints (with snapshots) -->
  {% set done_requests = requests_list | selectattr('status', 'equalto', 'DONE') | list %}
  {% if done_requests %}
  <div class="mb-6">
    <h2 class="font-semibold text-green-400 mb-3 flex items-center gap-2">
      <span>‚úÖ</span> Ready for Pickup
    </h2>
    <div class="space-y-3">
      {% for req in done_requests %}
      <div class="bg-zinc-900/60 border border-green-500/50 rounded-xl overflow-hidden card-interactive">
        {% if req.completion_snapshot %}
        <div class="relative cursor-pointer" onclick="showSnapshot('{{ req.completion_snapshot }}')">
          <img src="data:image/jpeg;base64,{{ req.completion_snapshot }}" 
               alt="Completed print" 
               class="w-full h-32 object-cover" loading="lazy" />
          <span class="absolute bottom-2 right-2 bg-black/60 px-2 py-1 rounded text-xs">üì∑ Tap to enlarge</span>
        </div>
        {% endif %}
        <a href="/my/{{ req.id }}?token={{ req.access_token }}" class="block p-4">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-semibold">{{ req.print_name or 'Untitled' }}</h3>
              <p class="text-xs text-zinc-500">#{{ req.id[:8] }}</p>
            </div>
            <span class="px-2 py-1 rounded-lg text-xs font-medium bg-green-600/25 border border-green-500/50 text-green-300">DONE</span>
          </div>
          <p class="text-sm text-green-300 mt-2">üéâ Your print is ready!</p>
        </a>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Currently printing -->
  {% set printing_requests = requests_list | selectattr('status', 'equalto', 'PRINTING') | list %}
  {% if printing_requests %}
  <div class="mb-6">
    <h2 class="font-semibold text-indigo-400 mb-3 flex items-center gap-2">
      <span>üñ®Ô∏è</span> Printing Now
    </h2>
    <div class="space-y-3">
      {% for req in printing_requests %}
      <a href="/my/{{ req.id }}?token={{ req.access_token }}" 
         class="block bg-zinc-900/60 border border-indigo-500/50 rounded-xl overflow-hidden card-interactive">
        {% if req.printer_status %}
        <div class="bg-indigo-950/40 border-b border-indigo-500/30 p-3">
          <div class="flex items-center justify-between text-sm mb-2">
            <span class="font-medium">{{ req.printer }}</span>
            <span class="text-emerald-300">{{ req.printer_status.progress or 0 }}%</span>
          </div>
          {% if req.printer_status.progress is not none %}
          <div class="h-1.5 bg-zinc-800 rounded-full overflow-hidden">
            <div class="h-full bg-emerald-500 transition-all" style="width: {{ req.printer_status.progress }}%"></div>
          </div>
          {% endif %}
          {% if req.smart_eta_display %}
          <p class="text-xs text-zinc-400 mt-2">ETA: {{ req.smart_eta_display }}</p>
          {% endif %}
        </div>
        {% endif %}
        <div class="p-4">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-semibold">{{ req.print_name or 'Untitled' }}</h3>
              <p class="text-xs text-zinc-500">#{{ req.id[:8] }}</p>
            </div>
            <span class="px-2 py-1 rounded-lg text-xs font-medium bg-indigo-600/25 border border-indigo-500/50 text-indigo-300">PRINTING</span>
          </div>
        </div>
      </a>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Other requests -->
  {% set other_requests = requests_list | rejectattr('status', 'in', ['DONE', 'PRINTING']) | list %}
  {% if other_requests %}
  <div class="mb-6">
    {% if done_requests or printing_requests %}
    <h2 class="font-semibold text-zinc-400 mb-3">üìã Other Requests</h2>
    {% endif %}
    <div class="space-y-3">
      {% for req in other_requests %}
      <a href="/my/{{ req.id }}?token={{ req.access_token }}" 
         class="block bg-zinc-900/60 border {% if req.status == 'NEEDS_INFO' %}border-orange-500/50{% else %}border-zinc-800{% endif %} rounded-xl p-4 card-interactive">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="font-semibold">{{ req.print_name or 'Untitled' }}</h3>
            <p class="text-xs text-zinc-500">#{{ req.id[:8] }} ‚Ä¢ {{ req.created_at[:10] }}</p>
          </div>
          <span class="px-2 py-1 rounded-lg text-xs font-medium border {{ status_colors.get(req.status, 'bg-zinc-800 border-zinc-700') }}">
            {{ req.status.replace('_', ' ') }}
          </span>
        </div>
        <div class="flex gap-2 mt-2 text-xs text-zinc-500">
          <span>{{ req.printer or 'ANY' }}</span>
          <span>‚Ä¢</span>
          <span>{{ req.material }}</span>
        </div>
        {% if req.status == 'NEEDS_INFO' %}
        <p class="text-sm text-orange-300 mt-2">‚ö†Ô∏è Response needed - tap to view</p>
        {% endif %}
      </a>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Summary -->
  <div class="text-center text-sm text-zinc-500 py-4">
    {{ requests_list|length }} request{% if requests_list|length != 1 %}s{% endif %}
  </div>

{% else %}
  <!-- No Requests -->
  <div class="text-center py-16 bg-zinc-900/40 border border-zinc-800 rounded-2xl">
    <div class="text-5xl mb-4">üì≠</div>
    <h3 class="font-semibold mb-2">No requests yet</h3>
    <p class="text-zinc-500 text-sm mb-4">Submit your first print request!</p>
    <a href="/" class="inline-block rounded-xl bg-indigo-600 hover:bg-indigo-500 px-6 py-3 font-semibold tap-highlight">
      New Request
    </a>
  </div>
{% endif %}

<!-- Snapshot Modal -->
<div id="snapshot-modal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4" onclick="hideSnapshot()">
  <img id="snapshot-img" src="" alt="Print" class="max-w-full max-h-full rounded-lg" />
</div>

<!-- Footer -->
<div class="mt-6 pt-4 border-t border-zinc-800 flex items-center justify-between text-xs text-zinc-500">
  <span>{{ email }}</span>
  <div class="flex items-center gap-4">
    <a href="/feedback?type=bug" class="hover:text-red-400 transition">üêõ</a>
    <a href="/feedback?type=suggestion" class="hover:text-yellow-400 transition">üí°</a>
    <a href="/changelog" class="hover:text-indigo-400 transition">v{{ version }}</a>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showSnapshot(b64) {
  document.getElementById('snapshot-img').src = 'data:image/jpeg;base64,' + b64;
  document.getElementById('snapshot-modal').classList.remove('hidden');
}
function hideSnapshot() {
  document.getElementById('snapshot-modal').classList.add('hidden');
}

// Save token for persistent login
const token = '{{ token }}';
const email = '{{ email }}';
if (token) {
  localStorage.setItem('my_requests_token', token);
  localStorage.setItem('my_requests_email', email);
}
</script>
{% endblock %}
