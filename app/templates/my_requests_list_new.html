{% extends "pwa_base.html" %}

{% block title %}My Prints | Printellect{% endblock %}

{% block nav_myrequests %}text-white bg-zinc-800{% endblock %}
{% block bnav_myrequests %}active{% endblock %}

{% block header_title %}My Prints{% endblock %}

{% block header_right %}
<!-- Desktop nav links + Account menu -->
<nav class="hidden sm:flex items-center gap-1">
  <a href="/" class="px-3 py-2 rounded-lg text-sm font-medium text-zinc-400 hover:text-white hover:bg-zinc-800 transition">Submit</a>
  <a href="/queue" class="px-3 py-2 rounded-lg text-sm font-medium text-zinc-400 hover:text-white hover:bg-zinc-800 transition">Queue</a>
  <a href="/store" class="px-3 py-2 rounded-lg text-sm font-medium text-zinc-400 hover:text-white hover:bg-zinc-800 transition">Store</a>
  <a href="/my-requests" class="px-3 py-2 rounded-lg text-sm font-medium text-white bg-zinc-800 transition flex items-center gap-1.5">
    <span class="w-2 h-2 rounded-full bg-indigo-500"></span>
    My Prints
  </a>
  <!-- Admin link - shown via JS if user is admin -->
  <a href="/admin" id="desktop-admin-link" class="hidden px-3 py-2 rounded-lg text-sm font-medium text-amber-400 hover:text-amber-300 hover:bg-amber-900/20 transition flex items-center gap-1.5">
    <span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span>
    Admin
  </a>
  <div class="w-px h-5 bg-zinc-700 mx-1"></div>
</nav>

<div class="relative">
  <button id="account-menu-btn" onclick="toggleAccountMenu()" class="flex items-center gap-2 px-2 py-1.5 hover:bg-zinc-800 rounded-lg transition tap-highlight">
    <div class="w-7 h-7 rounded-full bg-indigo-600 flex items-center justify-center text-xs font-bold">
      {{ email[0]|upper }}
    </div>
    <svg class="w-4 h-4 text-zinc-400 hidden sm:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
    </svg>
  </button>
  
  <!-- Account Dropdown Menu - positioned to right edge of viewport on desktop -->
  <div id="account-menu" class="hidden absolute top-full mt-2 w-72 bg-zinc-900 border border-zinc-700 rounded-2xl shadow-2xl z-50 overflow-hidden right-0 sm:right-0">
    <!-- Account Header -->
    <div class="p-4 border-b border-zinc-800 bg-zinc-950/50">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-lg font-bold">
          {{ email[0]|upper }}
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium text-white truncate">{{ email }}</p>
          <p class="text-xs text-zinc-500">Printellect Account</p>
        </div>
      </div>
    </div>
    
    <!-- Menu Items -->
    <div class="p-2">
      <a href="/user/profile?token={{ token }}" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-zinc-800 transition">
        <span class="text-lg">üë§</span>
        <div>
          <p class="text-sm font-medium">My Account</p>
          <p class="text-xs text-zinc-500">Profile & preferences</p>
        </div>
      </a>
      <button onclick="showNotificationSettings()" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-zinc-800 transition text-left">
        <span class="text-lg">üîî</span>
        <div>
          <p class="text-sm font-medium">Notification Settings</p>
          <p class="text-xs text-zinc-500">Email & push preferences</p>
        </div>
      </button>
      <button onclick="showSyncCode()" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-zinc-800 transition text-left">
        <span class="text-lg">üì±</span>
        <div>
          <p class="text-sm font-medium">Sync to App</p>
          <p class="text-xs text-zinc-500">Transfer session to PWA</p>
        </div>
      </button>
      <a href="/feedback?type=suggestion" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-zinc-800 transition">
        <span class="text-lg">üí°</span>
        <div>
          <p class="text-sm font-medium">Send Feedback</p>
          <p class="text-xs text-zinc-500">Suggestions & bug reports</p>
        </div>
      </a>
    </div>
    
    <!-- Admin Section (shown via JS if user is admin) -->
    <div id="account-admin-section" class="hidden p-2 border-t border-zinc-800">
      <a href="/admin" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-amber-900/30 text-amber-400 transition">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
        <div>
          <p class="text-sm font-medium">Admin Dashboard</p>
          <p class="text-xs text-amber-500/70">Manage print queue</p>
        </div>
      </a>
    </div>
    
    <!-- Logout -->
    <div class="p-2 border-t border-zinc-800">
      <a href="/my-requests?logout=1" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-red-900/30 text-red-400 transition">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
        </svg>
        <span class="text-sm font-medium">Sign Out</span>
      </a>
    </div>
  </div>
</div>
{% endblock %}

{% block head_extra %}
<style>
  /* Tap feedback for mobile */
  .tap-highlight { -webkit-tap-highlight-color: transparent; }
</style>
{% endblock %}

{% block content %}
<!-- Notification Settings Modal -->
<div id="notification-modal" class="hidden fixed inset-0 bg-black/80 flex items-end sm:items-center justify-center z-50 pb-20 sm:pb-0" onclick="hideNotificationSettings()">
  <div class="bg-zinc-900 border border-zinc-700 rounded-t-2xl sm:rounded-2xl w-full sm:max-w-md max-h-[80vh] sm:max-h-[90vh] overflow-y-auto" 
       onclick="event.stopPropagation()" 
       style="padding-bottom: env(safe-area-inset-bottom, 0px);">
    <!-- Modal Header -->
    <div class="sticky top-0 bg-zinc-900 border-b border-zinc-800 px-4 py-3 flex items-center justify-between z-10">
      <h2 class="text-lg font-bold flex items-center gap-2">
        <span>üîî</span> Notifications
      </h2>
      <button onclick="hideNotificationSettings()" class="p-2 hover:bg-zinc-800 rounded-lg transition">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    
    <div class="p-4 space-y-5">
      <!-- Push Status Banner (only shown when there's an issue) -->
      <div id="push-status-banner" class="hidden p-3 rounded-xl border border-yellow-500/40 bg-yellow-900/20">
        <div class="flex items-start gap-2">
          <span class="text-lg">‚ö†Ô∏è</span>
          <p id="push-status-message" class="text-sm text-yellow-200"></p>
        </div>
      </div>
      
      <!-- iOS Install Hint -->
      <div id="ios-install-hint" class="hidden p-3 bg-blue-900/30 border border-blue-500/30 rounded-xl">
        <p class="text-xs text-blue-300">
          <strong>üì± iPhone/iPad:</strong> To get push notifications, first install this app: 
          tap <span class="inline-block px-1.5 py-0.5 bg-zinc-700 rounded">Share</span> ‚Üí 
          <span class="inline-block px-1.5 py-0.5 bg-zinc-700 rounded">Add to Home Screen</span>
        </p>
      </div>
      
      <!-- ========== MAIN PUSH TOGGLE ========== -->
      <div class="bg-gradient-to-br from-indigo-900/40 to-purple-900/30 rounded-2xl p-4 border border-indigo-500/30">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-indigo-600/30 flex items-center justify-center">
              <span class="text-xl">üì≤</span>
            </div>
            <div>
              <span class="font-semibold text-white">Push Notifications</span>
              <div class="mt-0.5">
                <span id="push-status-indicator" class="text-xs font-medium text-zinc-400">Checking...</span>
              </div>
            </div>
          </div>
          <button id="push-toggle" onclick="togglePushNotifications()" 
                  class="relative inline-flex h-7 w-12 items-center rounded-full transition-colors focus:outline-none bg-zinc-700">
            <span id="push-toggle-dot" class="inline-block h-5 w-5 transform rounded-full bg-zinc-400 shadow transition-transform translate-x-1"></span>
          </button>
        </div>
        
        <!-- Test Button -->
        <div class="mt-3 pt-3 border-t border-white/10">
          <button id="test-push-btn" onclick="testPushNotification()" 
                  class="w-full px-4 py-2 bg-white/10 hover:bg-white/15 rounded-xl text-sm font-medium text-white transition flex items-center justify-center gap-2 disabled:opacity-40 disabled:cursor-not-allowed">
            <span>üß™</span> Send Test Notification
          </button>
        </div>
      </div>
      
      <!-- ========== NOTIFICATION TYPES ========== -->
      <div class="space-y-3">
        <h3 class="text-xs font-semibold text-zinc-500 uppercase tracking-wider px-1">What to notify me about</h3>
        
        <!-- Progress Updates Card -->
        <div class="bg-zinc-800/60 rounded-xl overflow-hidden border border-zinc-700/50">
          <div class="p-4">
            <div class="flex items-start justify-between">
              <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-lg bg-emerald-600/20 flex items-center justify-center flex-shrink-0">
                  <span class="text-lg">üìä</span>
                </div>
                <div>
                  <span class="font-medium text-white">Build Progress</span>
                  <p class="text-xs text-zinc-400 mt-0.5">Get notified at key milestones</p>
                </div>
              </div>
            </div>
            
            <!-- Progress Milestone Chips -->
            <div class="mt-4">
              <p class="text-xs text-zinc-500 mb-2">Notify me at:</p>
              <div class="flex flex-wrap gap-2" id="milestone-chips">
                <button type="button" data-milestone="25" onclick="toggleMilestone(25)" 
                        class="milestone-chip px-3 py-1.5 rounded-full text-sm font-medium transition border">
                  25%
                </button>
                <button type="button" data-milestone="50" onclick="toggleMilestone(50)" 
                        class="milestone-chip px-3 py-1.5 rounded-full text-sm font-medium transition border">
                  50%
                </button>
                <button type="button" data-milestone="75" onclick="toggleMilestone(75)" 
                        class="milestone-chip px-3 py-1.5 rounded-full text-sm font-medium transition border">
                  75%
                </button>
                <button type="button" data-milestone="90" onclick="toggleMilestone(90)" 
                        class="milestone-chip px-3 py-1.5 rounded-full text-sm font-medium transition border">
                  90%
                </button>
              </div>
            </div>
            
            <!-- Push/Email toggles -->
            <div class="mt-4 pt-3 border-t border-zinc-700/50 flex items-center gap-4">
              <label class="flex items-center gap-2 cursor-pointer group">
                <div class="relative">
                  <input type="checkbox" id="pref-progress-push" onchange="updateUserPrefs()" class="sr-only peer">
                  <div class="w-8 h-5 bg-zinc-700 rounded-full peer-checked:bg-indigo-600 transition"></div>
                  <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-zinc-400 rounded-full peer-checked:translate-x-3 peer-checked:bg-white transition"></div>
                </div>
                <span class="text-sm text-zinc-400 group-hover:text-zinc-300">Push</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer group">
                <div class="relative">
                  <input type="checkbox" id="pref-progress-email" onchange="updateUserPrefs()" class="sr-only peer">
                  <div class="w-8 h-5 bg-zinc-700 rounded-full peer-checked:bg-indigo-600 transition"></div>
                  <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-zinc-400 rounded-full peer-checked:translate-x-3 peer-checked:bg-white transition"></div>
                </div>
                <span class="text-sm text-zinc-400 group-hover:text-zinc-300">Email</span>
              </label>
            </div>
          </div>
        </div>
        
        <!-- Status Updates Card -->
        <div class="bg-zinc-800/60 rounded-xl overflow-hidden border border-zinc-700/50">
          <div class="p-4">
            <div class="flex items-start justify-between">
              <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-lg bg-blue-600/20 flex items-center justify-center flex-shrink-0">
                  <span class="text-lg">üîÑ</span>
                </div>
                <div>
                  <span class="font-medium text-white">Status Changes</span>
                  <p class="text-xs text-zinc-400 mt-0.5">Approved, printing, ready for pickup</p>
                </div>
              </div>
            </div>
            
            <!-- Push/Email toggles -->
            <div class="mt-4 pt-3 border-t border-zinc-700/50 flex items-center gap-4">
              <label class="flex items-center gap-2 cursor-pointer group">
                <div class="relative">
                  <input type="checkbox" id="pref-status-push" onchange="updateUserPrefs()" class="sr-only peer">
                  <div class="w-8 h-5 bg-zinc-700 rounded-full peer-checked:bg-indigo-600 transition"></div>
                  <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-zinc-400 rounded-full peer-checked:translate-x-3 peer-checked:bg-white transition"></div>
                </div>
                <span class="text-sm text-zinc-400 group-hover:text-zinc-300">Push</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer group">
                <div class="relative">
                  <input type="checkbox" id="pref-status-email" onchange="updateUserPrefs()" class="sr-only peer">
                  <div class="w-8 h-5 bg-zinc-700 rounded-full peer-checked:bg-indigo-600 transition"></div>
                  <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-zinc-400 rounded-full peer-checked:translate-x-3 peer-checked:bg-white transition"></div>
                </div>
                <span class="text-sm text-zinc-400 group-hover:text-zinc-300">Email</span>
              </label>
            </div>
          </div>
        </div>
        
        <!-- Announcements Card -->
        <div class="bg-zinc-800/60 rounded-xl overflow-hidden border border-zinc-700/50">
          <div class="p-4">
            <div class="flex items-start justify-between">
              <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-lg bg-amber-600/20 flex items-center justify-center flex-shrink-0">
                  <span class="text-lg">üì¢</span>
                </div>
                <div>
                  <span class="font-medium text-white">Announcements</span>
                  <p class="text-xs text-zinc-400 mt-0.5">App updates & important news</p>
                </div>
              </div>
            </div>
            
            <!-- Push toggle only -->
            <div class="mt-4 pt-3 border-t border-zinc-700/50 flex items-center gap-4">
              <label class="flex items-center gap-2 cursor-pointer group">
                <div class="relative">
                  <input type="checkbox" id="pref-broadcast-push" onchange="updateUserPrefs()" class="sr-only peer">
                  <div class="w-8 h-5 bg-zinc-700 rounded-full peer-checked:bg-indigo-600 transition"></div>
                  <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-zinc-400 rounded-full peer-checked:translate-x-3 peer-checked:bg-white transition"></div>
                </div>
                <span class="text-sm text-zinc-400 group-hover:text-zinc-300">Push</span>
              </label>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Saving indicator -->
      <div id="prefs-saving" class="hidden">
        <div class="flex items-center justify-center gap-2 py-2">
          <div class="w-4 h-4 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
          <span class="text-xs text-zinc-400">Saving...</span>
        </div>
      </div>
      
      <!-- Footer tip -->
      <p class="text-xs text-zinc-500 text-center pt-2">
        Changes are saved automatically
      </p>
    </div>
  </div>
</div>

<!-- Sync Code Modal -->
<div id="sync-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" onclick="closeSyncModal()">
  <div class="bg-zinc-900 border border-zinc-700 rounded-2xl p-6 max-w-sm w-full text-center" onclick="event.stopPropagation()">
    <div class="text-4xl mb-3">üì≤</div>
    <h3 class="font-bold text-lg mb-2">Sync to Printellect App</h3>
    <p class="text-zinc-400 text-sm mb-4">Enter this code in the app to sync your session:</p>
    
    <!-- Code Display -->
    <div id="sync-code-display" class="bg-zinc-950 border border-zinc-700 rounded-xl py-4 px-6 mb-3">
      <span id="sync-code" class="text-3xl font-mono font-bold tracking-widest text-indigo-400">------</span>
    </div>
    <p id="sync-expires" class="text-xs text-zinc-500 mb-4">Expires in <span id="sync-timer">10:00</span></p>
    
    <div class="flex gap-2">
      <button onclick="refreshSyncCode()" class="flex-1 py-2.5 rounded-xl bg-zinc-800 hover:bg-zinc-700 text-sm font-medium transition tap-highlight">
        üîÑ New Code
      </button>
      <button onclick="closeSyncModal()" class="flex-1 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-sm font-medium transition tap-highlight">
        Done
      </button>
    </div>
    
    <div class="mt-4 pt-4 border-t border-zinc-800 text-left">
      <p class="text-xs text-zinc-500 mb-2">üìã Instructions:</p>
      <ol class="text-xs text-zinc-400 space-y-1 list-decimal list-inside">
        <li>Open the Printellect app</li>
        <li>Go to "My Prints"</li>
        <li>Tap "Sync Code" tab</li>
        <li>Enter the 6-digit code above</li>
      </ol>
    </div>
  </div>
</div>

{% if needs_password_prompt %}
<!-- Account Upgrade Modal -->
<div id="upgrade-modal" class="hidden fixed inset-0 bg-black/80 z-50 items-center justify-center p-4">
  <div class="bg-zinc-900 border border-zinc-700 rounded-2xl w-full max-w-md overflow-hidden">
    <div class="flex items-center justify-between p-4 border-b border-zinc-800">
      <h3 class="text-lg font-semibold">Create Your Account</h3>
      <button onclick="hideUpgradeModal()" class="text-zinc-400 hover:text-white p-1">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    
    <form id="upgrade-form" class="p-4">
      <p class="text-sm text-zinc-400 mb-4">
        Set a password to log in faster and securely manage your prints.
      </p>
      
      <div class="mb-3 p-3 bg-zinc-800/50 rounded-lg">
        <p class="text-xs text-zinc-500">Email</p>
        <p class="font-medium text-white">{{ email }}</p>
      </div>
      
      <div class="mb-4">
        <label class="block text-sm text-zinc-400 mb-1">Display Name</label>
        <input type="text" id="upgrade-name" required
               placeholder="Your name"
               class="w-full rounded-lg border border-zinc-700 bg-zinc-950 px-3 py-2.5 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 transition" />
      </div>
      
      <div class="mb-4">
        <label class="block text-sm text-zinc-400 mb-1">Password</label>
        <input type="password" id="upgrade-password" required minlength="8"
               placeholder="At least 8 characters"
               class="w-full rounded-lg border border-zinc-700 bg-zinc-950 px-3 py-2.5 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 transition" />
      </div>
      
      <p id="upgrade-error" class="hidden text-red-400 text-sm mb-3"></p>
      
      <button type="submit" id="upgrade-btn"
              class="w-full py-3 rounded-xl bg-indigo-600 hover:bg-indigo-500 font-semibold transition tap-highlight">
        Create Account
      </button>
    </form>
  </div>
</div>
{% endif %}

<!-- Page Title -->
<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="text-3xl font-bold">My Prints</h1>
    <p class="text-zinc-400 text-sm mt-1">Track your print requests</p>
  </div>
  <a href="/" class="flex items-center gap-1.5 px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-xl text-sm font-medium transition tap-highlight">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
    </svg>
    <span class="hidden sm:inline">New Request</span>
  </a>
</div>

{% if needs_password_prompt %}
<!-- Account Upgrade Banner -->
<div id="upgrade-banner" class="mb-4 p-4 bg-gradient-to-r from-indigo-600/20 to-purple-600/20 border border-indigo-500/30 rounded-2xl">
  <div class="flex items-start gap-3">
    <div class="w-10 h-10 rounded-xl bg-indigo-600/30 flex items-center justify-center flex-shrink-0">
      <span class="text-xl">üîê</span>
    </div>
    <div class="flex-1 min-w-0">
      <h3 class="font-semibold text-white">Secure Your Account</h3>
      <p class="text-sm text-zinc-300 mt-1">Create a password to log in faster and access all features.</p>
      <button onclick="showUpgradeModal()" class="mt-3 px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-sm font-medium transition tap-highlight">
        Set Password ‚Üí
      </button>
    </div>
    <button onclick="dismissUpgradeBanner()" class="text-zinc-400 hover:text-white p-1">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
  </div>
</div>
{% endif %}

{% if is_admin_user %}
<!-- Admin Quick Access Banner -->
<div class="mb-4 p-3 bg-gradient-to-r from-amber-600/20 to-orange-600/20 border border-amber-500/30 rounded-xl">
  <div class="flex items-center justify-between">
    <div class="flex items-center gap-2">
      <span class="text-lg">‚ö°</span>
      <span class="text-sm font-medium text-amber-200">Admin Mode</span>
    </div>
    <a href="/admin" class="px-3 py-1.5 bg-amber-600 hover:bg-amber-500 rounded-lg text-xs font-medium transition">
      Open Dashboard ‚Üí
    </a>
  </div>
</div>
{% endif %}

{% set status_colors = {
  'NEW': 'bg-blue-500/20 border-blue-500/50 text-blue-300',
  'NEEDS_INFO': 'bg-orange-500/20 border-orange-500/50 text-orange-300',
  'APPROVED': 'bg-emerald-500/20 border-emerald-500/50 text-emerald-300',
  'PRINTING': 'bg-amber-500/20 border-amber-500/50 text-amber-300',
  'IN_PROGRESS': 'bg-amber-500/20 border-amber-500/50 text-amber-300',
  'DONE': 'bg-cyan-500/20 border-cyan-500/50 text-cyan-300',
  'PICKED_UP': 'bg-purple-500/20 border-purple-500/50 text-purple-300',
  'REJECTED': 'bg-red-500/20 border-red-500/50 text-red-300',
  'CANCELLED': 'bg-zinc-500/20 border-zinc-500/50 text-zinc-400'
} %}

{% set status_icons = {
  'NEW': 'üÜï',
  'NEEDS_INFO': '‚ùì',
  'APPROVED': '‚úì',
  'PRINTING': 'üñ®Ô∏è',
  'IN_PROGRESS': 'üñ®Ô∏è',
  'DONE': '‚úÖ',
  'PICKED_UP': 'üì¶',
  'REJECTED': '‚ùå',
  'CANCELLED': 'üö´'
} %}

{% if requests_list %}
  <!-- Done prints (with snapshots) - Ready for Pickup -->
  {% set done_requests = requests_list | selectattr('status', 'equalto', 'DONE') | list %}
  {% if done_requests %}
  <div class="mb-6">
    <h2 class="text-xl font-semibold text-green-400 mb-3 flex items-center gap-2">
      <span>‚úÖ</span> Ready for Pickup
      <span class="text-xs px-2 py-0.5 rounded-full bg-green-600/20 text-green-300">{{ done_requests|length }}</span>
    </h2>
    <div class="space-y-3" id="done-list">
      {% for req in done_requests[:3] %}
      <div class="request-item bg-zinc-900/60 border border-green-500/50 rounded-xl overflow-hidden card-interactive">
        {% if req.completion_snapshot %}
        <div class="relative cursor-pointer" onclick="showSnapshot('{{ req.completion_snapshot }}')">
          <img src="data:image/jpeg;base64,{{ req.completion_snapshot }}" 
               alt="Completed print" 
               class="w-full h-32 object-cover" loading="lazy" />
          <span class="absolute bottom-2 right-2 bg-black/60 px-2 py-1 rounded text-xs">üì∑ Tap to enlarge</span>
        </div>
        {% endif %}
        <a href="/my/{{ req.id }}?token={{ req.access_token }}" class="block p-4">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-semibold">{{ req.print_name or 'Untitled' }}</h3>
              <p class="text-xs text-zinc-500">#{{ req.id[:8] }}</p>
            </div>
            <span class="px-2 py-1 rounded-lg text-xs font-medium bg-green-600/25 border border-green-500/50 text-green-300">DONE</span>
          </div>
          <p class="text-sm text-green-300 mt-2">üéâ Your print is ready!</p>
        </a>
      </div>
      {% endfor %}
      {% for req in done_requests[3:] %}
      <div class="request-item hidden bg-zinc-900/60 border border-green-500/50 rounded-xl overflow-hidden card-interactive">
        {% if req.completion_snapshot %}
        <div class="relative cursor-pointer" onclick="showSnapshot('{{ req.completion_snapshot }}')">
          <img src="data:image/jpeg;base64,{{ req.completion_snapshot }}" alt="Completed print" class="w-full h-32 object-cover" loading="lazy" />
          <span class="absolute bottom-2 right-2 bg-black/60 px-2 py-1 rounded text-xs">üì∑</span>
        </div>
        {% endif %}
        <a href="/my/{{ req.id }}?token={{ req.access_token }}" class="block p-4">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-semibold">{{ req.print_name or 'Untitled' }}</h3>
              <p class="text-xs text-zinc-500">#{{ req.id[:8] }}</p>
            </div>
            <span class="px-2 py-1 rounded-lg text-xs font-medium bg-green-600/25 border border-green-500/50 text-green-300">DONE</span>
          </div>
        </a>
      </div>
      {% endfor %}
    </div>
    {% if done_requests|length > 3 %}
    <button onclick="toggleShowMore('done-list', this)" class="mt-3 w-full text-center text-xs text-indigo-400 hover:text-indigo-300 py-2 rounded-lg hover:bg-zinc-800/50 transition">
      Show {{ done_requests|length - 3 }} more ‚ñº
    </button>
    {% endif %}
  </div>
  {% endif %}

  <!-- Currently printing (includes both PRINTING and IN_PROGRESS with active builds) -->
  {% set printing_requests = requests_list | selectattr('status', 'in', ['PRINTING', 'IN_PROGRESS']) | list %}
  {% if printing_requests %}
  <div class="mb-6">
    <h2 class="text-xl font-semibold text-indigo-400 mb-3 flex items-center gap-2">
      <span>üñ®Ô∏è</span> Printing Now
      <span class="text-xs px-2 py-0.5 rounded-full bg-indigo-600/20 text-indigo-300">{{ printing_requests|length }}</span>
    </h2>
    <div class="space-y-3" id="printing-list">
      {% for req in printing_requests[:3] %}
      <a href="/my/{{ req.id }}?token={{ req.access_token }}" 
         class="request-item block bg-zinc-900/60 border {% if req.printer_status and req.printer_status.is_offline %}border-amber-500/50{% else %}border-indigo-500/50{% endif %} rounded-xl overflow-hidden card-interactive">
        {% if req.printer_status %}
        <div class="{% if req.printer_status.is_offline %}bg-amber-950/40 border-b border-amber-500/30{% else %}bg-indigo-950/40 border-b border-indigo-500/30{% endif %} p-3">
          <div class="flex items-center justify-between text-sm mb-2">
            <div class="flex items-center gap-2">
              <span class="font-medium">{{ req.active_printer or req.printer }}</span>
              {% if req.printer_status.is_offline %}
              <span class="text-xs px-1.5 py-0.5 bg-amber-500/20 border border-amber-500/50 text-amber-300 rounded">Offline</span>
              {% elif req.total_builds and req.total_builds > 1 %}
              <span class="text-xs px-1.5 py-0.5 bg-amber-500/20 border border-amber-500/50 text-amber-300 rounded">Build {{ (req.completed_builds or 0) + 1 }}/{{ req.total_builds }}</span>
              {% endif %}
            </div>
            <span class="{% if req.printer_status.is_offline %}text-amber-300{% else %}text-emerald-300{% endif %}">{{ req.printer_status.progress or 0 }}%</span>
          </div>
          {% if req.printer_status.progress is not none %}
          <div class="h-1.5 bg-zinc-800 rounded-full overflow-hidden">
            <div class="h-full {% if req.printer_status.is_offline %}bg-amber-500{% else %}bg-emerald-500{% endif %} transition-all" style="width: {{ req.printer_status.progress }}%"></div>
          </div>
          {% endif %}
          {% if req.printer_status.is_offline and req.printer_status.last_seen %}
          <p class="text-xs text-amber-400/80 mt-2">‚ö†Ô∏è Connection lost</p>
          {% elif req.smart_eta_display %}
          <p class="text-xs text-zinc-400 mt-2">ETA: {{ req.smart_eta_display }}</p>
          {% endif %}
        </div>
        {% endif %}
        <div class="p-4">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-semibold">{{ req.print_name or 'Untitled' }}</h3>
              <p class="text-xs text-zinc-500">#{{ req.id[:8] }}</p>
            </div>
            <span class="px-2 py-1 rounded-lg text-xs font-medium bg-indigo-600/25 border border-indigo-500/50 text-indigo-300">
              {% if req.status == 'IN_PROGRESS' %}PRINTING{% else %}{{ req.status }}{% endif %}
            </span>
          </div>
        </div>
      </a>
      {% endfor %}
      {% for req in printing_requests[3:] %}
      <a href="/my/{{ req.id }}?token={{ req.access_token }}" 
         class="request-item hidden block bg-zinc-900/60 border border-indigo-500/50 rounded-xl overflow-hidden card-interactive">
        <div class="p-4">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-semibold">{{ req.print_name or 'Untitled' }}</h3>
              <p class="text-xs text-zinc-500">#{{ req.id[:8] }}</p>
            </div>
            <span class="px-2 py-1 rounded-lg text-xs font-medium bg-indigo-600/25 border border-indigo-500/50 text-indigo-300">PRINTING</span>
          </div>
        </div>
      </a>
      {% endfor %}
    </div>
    {% if printing_requests|length > 3 %}
    <button onclick="toggleShowMore('printing-list', this)" class="mt-3 w-full text-center text-xs text-indigo-400 hover:text-indigo-300 py-2 rounded-lg hover:bg-zinc-800/50 transition">
      Show {{ printing_requests|length - 3 }} more ‚ñº
    </button>
    {% endif %}
  </div>
  {% endif %}

  <!-- Other requests (collapsible sections) -->
  {% set other_requests = requests_list | rejectattr('status', 'in', ['DONE', 'PRINTING', 'IN_PROGRESS']) | list %}
  {% set active_requests = other_requests | selectattr('status', 'in', ['NEW', 'NEEDS_INFO', 'APPROVED']) | list %}
  {% set closed_requests = other_requests | selectattr('status', 'in', ['PICKED_UP', 'REJECTED', 'CANCELLED']) | list %}
  
  <!-- Active Requests (NEW, NEEDS_INFO, APPROVED) -->
  {% if active_requests %}
  <div class="mb-6">
    <h2 class="text-xl font-semibold text-zinc-400 mb-3 flex items-center gap-2">
      üìã In Queue
      <span class="text-xs px-2 py-0.5 rounded-full bg-zinc-700/50 text-zinc-300">{{ active_requests|length }}</span>
    </h2>
    <div class="space-y-3" id="active-list">
      {% for req in active_requests[:3] %}
      <a href="/my/{{ req.id }}?token={{ req.access_token }}" 
         class="request-item block bg-zinc-900/60 border {% if req.status == 'NEEDS_INFO' %}border-orange-500/50{% else %}border-zinc-800{% endif %} rounded-xl p-4 card-interactive">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="font-semibold">{{ req.print_name or 'Untitled' }}</h3>
            <p class="text-xs text-zinc-500">#{{ req.id[:8] }} ‚Ä¢ {{ req.created_at[:10] }}</p>
          </div>
          <span class="px-2 py-1 rounded-lg text-xs font-medium border {{ status_colors.get(req.status, 'bg-zinc-800 border-zinc-700') }}">
            {{ req.status.replace('_', ' ') }}
          </span>
        </div>
        <div class="flex gap-2 mt-2 text-xs text-zinc-500">
          <span>{{ req.printer or 'ANY' }}</span>
          <span>‚Ä¢</span>
          <span>{{ req.material }}</span>
        </div>
        {% if req.status == 'NEEDS_INFO' %}
        <p class="text-sm text-orange-300 mt-2">‚ö†Ô∏è Response needed - tap to view</p>
        {% endif %}
      </a>
      {% endfor %}
      {% for req in active_requests[3:] %}
      <a href="/my/{{ req.id }}?token={{ req.access_token }}" 
         class="request-item hidden block bg-zinc-900/60 border {% if req.status == 'NEEDS_INFO' %}border-orange-500/50{% else %}border-zinc-800{% endif %} rounded-xl p-4 card-interactive">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="font-semibold">{{ req.print_name or 'Untitled' }}</h3>
            <p class="text-xs text-zinc-500">#{{ req.id[:8] }}</p>
          </div>
          <span class="px-2 py-1 rounded-lg text-xs font-medium border {{ status_colors.get(req.status, 'bg-zinc-800 border-zinc-700') }}">
            {{ req.status.replace('_', ' ') }}
          </span>
        </div>
      </a>
      {% endfor %}
    </div>
    {% if active_requests|length > 3 %}
    <button onclick="toggleShowMore('active-list', this)" class="mt-3 w-full text-center text-xs text-indigo-400 hover:text-indigo-300 py-2 rounded-lg hover:bg-zinc-800/50 transition">
      Show {{ active_requests|length - 3 }} more ‚ñº
    </button>
    {% endif %}
  </div>
  {% endif %}
  
  <!-- Closed Requests (PICKED_UP, REJECTED, CANCELLED) - Collapsible -->
  {% if closed_requests %}
  <details class="mb-6 bg-zinc-900/40 border border-zinc-800 rounded-xl group">
    <summary class="p-4 cursor-pointer hover:bg-zinc-900/60 rounded-xl transition list-none">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span>üì¶</span>
          <span class="font-semibold text-zinc-400">Past Prints</span>
          <span class="text-xs px-2 py-0.5 rounded-full bg-zinc-700/50 text-zinc-400">{{ closed_requests|length }}</span>
        </div>
        <svg class="w-4 h-4 text-zinc-400 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
      </div>
    </summary>
    <div class="px-4 pb-4">
      <div class="space-y-2" id="closed-list">
        {% for req in closed_requests[:4] %}
        <a href="/my/{{ req.id }}?token={{ req.access_token }}" 
           class="request-item block bg-zinc-950/60 border border-zinc-800 rounded-lg p-3 hover:bg-zinc-900/60 transition">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-medium text-sm">{{ req.print_name or 'Untitled' }}</h3>
              <p class="text-xs text-zinc-500">#{{ req.id[:8] }}</p>
            </div>
            <span class="px-2 py-1 rounded-lg text-xs font-medium border {{ status_colors.get(req.status, 'bg-zinc-800 border-zinc-700') }}">
              {{ req.status.replace('_', ' ') }}
            </span>
          </div>
        </a>
        {% endfor %}
        {% for req in closed_requests[4:] %}
        <a href="/my/{{ req.id }}?token={{ req.access_token }}" 
           class="request-item hidden block bg-zinc-950/60 border border-zinc-800 rounded-lg p-3 hover:bg-zinc-900/60 transition">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-medium text-sm">{{ req.print_name or 'Untitled' }}</h3>
              <p class="text-xs text-zinc-500">#{{ req.id[:8] }}</p>
            </div>
            <span class="px-2 py-1 rounded-lg text-xs font-medium border {{ status_colors.get(req.status, 'bg-zinc-800 border-zinc-700') }}">
              {{ req.status.replace('_', ' ') }}
            </span>
          </div>
        </a>
        {% endfor %}
      </div>
      {% if closed_requests|length > 4 %}
      <button onclick="toggleShowMore('closed-list', this)" class="mt-3 w-full text-center text-xs text-indigo-400 hover:text-indigo-300 py-2 rounded-lg hover:bg-zinc-800/50 transition">
        Show {{ closed_requests|length - 4 }} more ‚ñº
      </button>
      {% endif %}
    </div>
  </details>
  {% endif %}

  <!-- Summary -->
  <div class="text-center text-sm text-zinc-500 py-4">
    {{ requests_list|length }} request{% if requests_list|length != 1 %}s{% endif %}
  </div>

{% else %}
  <!-- No Requests - Improved Empty State -->
  <div class="text-center py-16 bg-zinc-900/40 border border-zinc-800 rounded-2xl">
    <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-zinc-800/50 flex items-center justify-center">
      <svg class="w-8 h-8 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
      </svg>
    </div>
    <h3 class="text-lg font-semibold text-zinc-300 mb-2">No requests yet</h3>
    <p class="text-sm text-zinc-500 mb-6 max-w-xs mx-auto">Submit your first print request and track it here!</p>
    <a href="/" class="inline-flex items-center gap-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 px-6 py-3 font-semibold tap-highlight transition">
      New Request
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
      </svg>
    </a>
  </div>
{% endif %}

<!-- Snapshot Modal -->
<div id="snapshot-modal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4" onclick="hideSnapshot()">
  <img id="snapshot-img" src="" alt="Print" class="max-w-full max-h-full rounded-lg" />
</div>

<!-- Footer -->
<div class="mt-6 pt-4 border-t border-zinc-800 flex items-center justify-between text-xs text-zinc-500">
  <span>{{ email }}</span>
  <div class="flex items-center gap-4">
    <a href="/feedback?type=bug" class="hover:text-red-400 transition">üêõ</a>
    <a href="/feedback?type=suggestion" class="hover:text-yellow-400 transition">üí°</a>
    <a href="/changelog" class="hover:text-indigo-400 transition">v{{ version }}</a>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ========== Constants ==========
const token = '{{ token }}';
const email = '{{ email }}';
let VAPID_PUBLIC_KEY = '';

// Save token for persistent login
if (token) {
  localStorage.setItem('my_requests_token', token);
  localStorage.setItem('my_requests_email', email);
}

// ========== Show More Toggle ==========
function toggleShowMore(listId, btn) {
  const list = document.getElementById(listId);
  const hiddenItems = list.querySelectorAll('.request-item.hidden');
  
  if (hiddenItems.length > 0) {
    // Show all
    hiddenItems.forEach(item => item.classList.remove('hidden'));
    btn.textContent = 'Show less ‚ñ≤';
  } else {
    // Hide extras - 3 for most lists, 4 for closed
    const keepCount = listId === 'closed-list' ? 4 : 3;
    const items = list.querySelectorAll('.request-item');
    items.forEach((item, i) => {
      if (i >= keepCount) item.classList.add('hidden');
    });
    btn.textContent = btn.textContent.replace('Show less ‚ñ≤', `Show ${items.length - keepCount} more ‚ñº`);
  }
}

// ========== Account Menu ==========
function toggleAccountMenu() {
  const menu = document.getElementById('account-menu');
  menu.classList.toggle('hidden');
}

// Close account menu when clicking outside
document.addEventListener('click', (e) => {
  const menu = document.getElementById('account-menu');
  const btn = e.target.closest('button[onclick*="toggleAccountMenu"]');
  if (!btn && !menu.contains(e.target)) {
    menu.classList.add('hidden');
  }
});

// ========== Notification Settings Modal ==========
function showNotificationSettings() {
  document.getElementById('account-menu').classList.add('hidden');
  document.getElementById('notification-modal').classList.remove('hidden');
  initNotificationUI();
  loadUserPrefs();
}

function hideNotificationSettings() {
  document.getElementById('notification-modal').classList.add('hidden');
}

// ========== Snapshot Modal ==========
function showSnapshot(b64) {
  document.getElementById('snapshot-img').src = 'data:image/jpeg;base64,' + b64;
  document.getElementById('snapshot-modal').classList.remove('hidden');
}

function hideSnapshot() {
  document.getElementById('snapshot-modal').classList.add('hidden');
}

// ========== Sync Code Functions ==========
let syncTimerInterval = null;
let syncExpiry = null;

function showSyncCode() {
  document.getElementById('account-menu').classList.add('hidden');
  document.getElementById('sync-modal').classList.remove('hidden');
  refreshSyncCode();
}

function closeSyncModal() {
  document.getElementById('sync-modal').classList.add('hidden');
  if (syncTimerInterval) clearInterval(syncTimerInterval);
}

async function refreshSyncCode() {
  const codeEl = document.getElementById('sync-code');
  const timerEl = document.getElementById('sync-timer');
  codeEl.textContent = '......';
  
  try {
    const formData = new FormData();
    formData.append('token', token);
    
    const response = await fetch('/api/generate-sync-code', {
      method: 'POST',
      body: formData
    });
    const data = await response.json();
    
    if (data.success) {
      const code = data.code;
      codeEl.textContent = code.slice(0,3) + '-' + code.slice(3);
      
      syncExpiry = Date.now() + (data.expires_in * 1000);
      if (syncTimerInterval) clearInterval(syncTimerInterval);
      syncTimerInterval = setInterval(updateTimer, 1000);
      updateTimer();
    } else {
      codeEl.textContent = 'Error';
    }
  } catch (e) {
    codeEl.textContent = 'Error';
  }
}

function updateTimer() {
  const timerEl = document.getElementById('sync-timer');
  const remaining = Math.max(0, syncExpiry - Date.now());
  const mins = Math.floor(remaining / 60000);
  const secs = Math.floor((remaining % 60000) / 1000);
  timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
  
  if (remaining <= 0) {
    timerEl.textContent = 'Expired';
    document.getElementById('sync-code').textContent = '------';
    clearInterval(syncTimerInterval);
  }
}

// ========== User Notification Preferences ==========
let userPrefs = {
  progress_push: true,
  progress_email: false,
  progress_milestones: '50,75',
  status_push: true,
  status_email: true,
  broadcast_push: true
};

// Track selected milestones
let selectedMilestones = new Set([50, 75]);

// Debounce timer for saving preferences
let prefsSaveTimeout = null;

async function loadUserPrefs() {
  try {
    const response = await fetch(`/api/user/notification-prefs?token=${encodeURIComponent(token)}`);
    const data = await response.json();
    
    if (data.success && data.prefs) {
      userPrefs = data.prefs;
      // Parse milestones
      if (userPrefs.progress_milestones) {
        selectedMilestones = new Set(
          userPrefs.progress_milestones.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n))
        );
      } else {
        selectedMilestones = new Set([50, 75]); // Default
      }
      applyPrefsToUI();
    }
  } catch (e) {
    console.error('Error loading user prefs:', e);
  }
}

function applyPrefsToUI() {
  document.getElementById('pref-progress-push').checked = userPrefs.progress_push;
  document.getElementById('pref-progress-email').checked = userPrefs.progress_email;
  document.getElementById('pref-status-push').checked = userPrefs.status_push;
  document.getElementById('pref-status-email').checked = userPrefs.status_email;
  document.getElementById('pref-broadcast-push').checked = userPrefs.broadcast_push;
  
  // Update milestone chips
  updateMilestoneChipsUI();
}

function updateMilestoneChipsUI() {
  document.querySelectorAll('.milestone-chip').forEach(chip => {
    const milestone = parseInt(chip.dataset.milestone);
    if (selectedMilestones.has(milestone)) {
      chip.className = 'milestone-chip px-3 py-1.5 rounded-full text-sm font-medium transition border bg-indigo-600 border-indigo-500 text-white';
    } else {
      chip.className = 'milestone-chip px-3 py-1.5 rounded-full text-sm font-medium transition border bg-zinc-800 border-zinc-600 text-zinc-400 hover:border-zinc-500';
    }
  });
}

function toggleMilestone(value) {
  if (selectedMilestones.has(value)) {
    selectedMilestones.delete(value);
  } else {
    selectedMilestones.add(value);
  }
  updateMilestoneChipsUI();
  updateUserPrefs();
}

function updateUserPrefs() {
  // Gather values from UI
  userPrefs.progress_push = document.getElementById('pref-progress-push').checked;
  userPrefs.progress_email = document.getElementById('pref-progress-email').checked;
  userPrefs.status_push = document.getElementById('pref-status-push').checked;
  userPrefs.status_email = document.getElementById('pref-status-email').checked;
  userPrefs.broadcast_push = document.getElementById('pref-broadcast-push').checked;
  
  // Convert milestone set to comma-separated string
  userPrefs.progress_milestones = Array.from(selectedMilestones).sort((a, b) => a - b).join(',');
  
  // Debounce the save
  if (prefsSaveTimeout) clearTimeout(prefsSaveTimeout);
  
  document.getElementById('prefs-saving').classList.remove('hidden');
  
  prefsSaveTimeout = setTimeout(async () => {
    await saveUserPrefs();
  }, 500);
}

async function saveUserPrefs() {
  try {
    const response = await fetch('/api/user/notification-prefs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        token: token,
        prefs: userPrefs
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showToast('Preferences saved', 'success');
    } else {
      showToast('Failed to save preferences', 'error');
    }
  } catch (e) {
    console.error('Error saving prefs:', e);
    showToast('Error saving preferences', 'error');
  } finally {
    document.getElementById('prefs-saving').classList.add('hidden');
  }
}

// ========== Push Notifications ==========
let pushEnabled = false;

async function initNotificationUI() {
  // Check for iOS not in standalone mode
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  
  if (isIOS && !isStandalone) {
    document.getElementById('ios-install-hint')?.classList.remove('hidden');
  }
  
  // Fetch VAPID key
  try {
    const resp = await fetch('/api/push/vapid-public-key');
    const data = await resp.json();
    if (data.publicKey) {
      VAPID_PUBLIC_KEY = data.publicKey;
    }
  } catch (e) {
    console.warn('Could not fetch VAPID key');
  }
  
  // Check push notification status
  await checkPushStatus();
}

async function checkPushStatus() {
  const statusIndicator = document.getElementById('push-status-indicator');
  const banner = document.getElementById('push-status-banner');
  const bannerMsg = document.getElementById('push-status-message');
  
  // Hide banner by default
  banner.classList.add('hidden');
  
  // Check if service worker and push are supported
  if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
    statusIndicator.textContent = '‚ùå Not supported';
    statusIndicator.className = 'inline-flex items-center text-xs font-medium text-red-400';
    banner.classList.remove('hidden');
    bannerMsg.textContent = 'Push notifications are not supported in this browser.';
    updatePushToggle(false, true);
    return;
  }
  
  // Check notification permission
  const permission = Notification.permission;
  
  if (permission === 'denied') {
    statusIndicator.textContent = 'üö´ Blocked';
    statusIndicator.className = 'inline-flex items-center text-xs font-medium text-red-400';
    banner.classList.remove('hidden');
    bannerMsg.textContent = 'Notifications are blocked. Please enable them in your browser settings.';
    updatePushToggle(false, true);
    return;
  }
  
  // Check if we have an active subscription
  try {
    const registration = await navigator.serviceWorker.ready;
    const subscription = await registration.pushManager.getSubscription();
    
    if (subscription) {
      statusIndicator.textContent = '‚úÖ Active';
      statusIndicator.className = 'inline-flex items-center text-xs font-medium text-emerald-400';
      pushEnabled = true;
      updatePushToggle(true, false);
    } else if (permission === 'granted') {
      statusIndicator.textContent = '‚ö™ Inactive';
      statusIndicator.className = 'inline-flex items-center text-xs font-medium text-zinc-400';
      updatePushToggle(false, false);
    } else {
      statusIndicator.textContent = '‚ö™ Not enabled';
      statusIndicator.className = 'inline-flex items-center text-xs font-medium text-zinc-400';
      updatePushToggle(false, false);
    }
  } catch (e) {
    statusIndicator.textContent = '‚ö†Ô∏è Error';
    statusIndicator.className = 'inline-flex items-center text-xs font-medium text-yellow-400';
    updatePushToggle(false, false);
  }
}

function updatePushToggle(enabled, disabled) {
  const toggle = document.getElementById('push-toggle');
  const dot = document.getElementById('push-toggle-dot');
  const testBtn = document.getElementById('test-push-btn');
  
  if (disabled) {
    toggle.disabled = true;
    toggle.className = 'relative inline-flex h-7 w-12 items-center rounded-full transition-colors focus:outline-none bg-zinc-800 cursor-not-allowed opacity-50';
    testBtn.disabled = true;
    testBtn.className = 'w-full px-4 py-2 bg-white/10 rounded-xl text-sm font-medium text-white/40 flex items-center justify-center gap-2 cursor-not-allowed';
    return;
  }
  
  toggle.disabled = false;
  testBtn.disabled = !enabled;
  
  if (enabled) {
    toggle.className = 'relative inline-flex h-7 w-12 items-center rounded-full transition-colors focus:outline-none bg-indigo-600';
    dot.className = 'inline-block h-5 w-5 transform rounded-full bg-white shadow transition-transform translate-x-6';
    testBtn.className = 'w-full px-4 py-2 bg-white/10 hover:bg-white/15 rounded-xl text-sm font-medium text-white transition flex items-center justify-center gap-2';
  } else {
    toggle.className = 'relative inline-flex h-7 w-12 items-center rounded-full transition-colors focus:outline-none bg-zinc-700';
    dot.className = 'inline-block h-5 w-5 transform rounded-full bg-zinc-400 shadow transition-transform translate-x-1';
    testBtn.className = 'w-full px-4 py-2 bg-white/10 rounded-xl text-sm font-medium text-white/40 flex items-center justify-center gap-2 cursor-not-allowed';
  }
}

async function togglePushNotifications() {
  if (pushEnabled) {
    await unsubscribePush();
  } else {
    await subscribePush();
  }
}

async function subscribePush() {
  try {
    const permission = await Notification.requestPermission();
    if (permission !== 'granted') {
      showToast('Notification permission denied', 'error');
      await checkPushStatus();
      return;
    }
    
    if (!VAPID_PUBLIC_KEY) {
      showToast('Push notifications not configured on server', 'error');
      return;
    }
    
    const registration = await navigator.serviceWorker.ready;
    
    // Create subscription
    const subscription = await registration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
    });
    
    // Send to server as JSON
    const response = await fetch('/api/push/subscribe', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        token: token,
        subscription: subscription.toJSON()
      })
    });
    
    const data = await response.json();
    if (data.success) {
      pushEnabled = true;
      showToast('Push notifications enabled!', 'success');
    } else {
      showToast(data.error || 'Failed to enable push', 'error');
    }
  } catch (e) {
    console.error('Push subscription error:', e);
    showToast('Failed to enable push notifications', 'error');
  }
  
  await checkPushStatus();
}

async function unsubscribePush() {
  try {
    const registration = await navigator.serviceWorker.ready;
    const subscription = await registration.pushManager.getSubscription();
    
    if (subscription) {
      // Unsubscribe locally
      await subscription.unsubscribe();
      
      // Notify server as JSON
      await fetch('/api/push/unsubscribe', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          token: token,
          endpoint: subscription.endpoint
        })
      });
    }
    
    pushEnabled = false;
    showToast('Push notifications disabled', 'success');
  } catch (e) {
    console.error('Unsubscribe error:', e);
    showToast('Failed to disable push', 'error');
  }
  
  await checkPushStatus();
}

async function testPushNotification() {
  const btn = document.getElementById('test-push-btn');
  const originalHTML = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<div class="w-4 h-4 border-2 border-white/40 border-t-white rounded-full animate-spin"></div> Sending...';
  
  try {
    const response = await fetch('/api/push/test', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token: token })
    });
    
    const data = await response.json();
    if (data.success) {
      showToast('Test notification sent!', 'success');
    } else {
      showToast(data.error || 'Failed to send test', 'error');
    }
  } catch (e) {
    showToast('Network error', 'error');
  }
  
  btn.disabled = false;
  btn.innerHTML = '<span>üß™</span> Send Test Notification';
}

// ========== Utility Functions ==========
function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = window.atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}

// ========== Account Upgrade Functions ==========
function dismissUpgradeBanner() {
  const banner = document.getElementById('upgrade-banner');
  if (banner) {
    banner.style.display = 'none';
    sessionStorage.setItem('upgrade_banner_dismissed', 'true');
  }
}

function showUpgradeModal() {
  document.getElementById('upgrade-modal')?.classList.remove('hidden');
  document.getElementById('upgrade-modal')?.classList.add('flex');
}

function hideUpgradeModal() {
  document.getElementById('upgrade-modal')?.classList.add('hidden');
  document.getElementById('upgrade-modal')?.classList.remove('flex');
}

document.getElementById('upgrade-form')?.addEventListener('submit', async function(e) {
  e.preventDefault();
  const name = document.getElementById('upgrade-name').value;
  const password = document.getElementById('upgrade-password').value;
  const errorEl = document.getElementById('upgrade-error');
  const btn = document.getElementById('upgrade-btn');
  
  btn.disabled = true;
  btn.textContent = 'Creating account...';
  errorEl.classList.add('hidden');
  
  try {
    const response = await fetch('/api/user/upgrade', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        email: '{{ email }}',
        name: name,
        password: password,
        token: '{{ token }}'
      })
    });
    
    const data = await response.json();
    if (data.success) {
      // Store session and reload
      localStorage.setItem('user_session', data.session_token);
      localStorage.setItem('user_email', '{{ email }}');
      showToast('Account created! You can now log in with your password.', 'success');
      hideUpgradeModal();
      dismissUpgradeBanner();
      // Reload to update session
      setTimeout(() => window.location.reload(), 1500);
    } else {
      errorEl.textContent = data.error || 'Failed to create account';
      errorEl.classList.remove('hidden');
    }
  } catch (e) {
    errorEl.textContent = 'Connection error. Please try again.';
    errorEl.classList.remove('hidden');
  }
  
  btn.disabled = false;
  btn.textContent = 'Create Account';
});

// Hide upgrade banner if dismissed in this session
if (sessionStorage.getItem('upgrade_banner_dismissed')) {
  document.getElementById('upgrade-banner')?.style.setProperty('display', 'none');
}

// ========== Check Admin Status ==========
// Show admin links if user is an admin
async function checkAdminStatus() {
  try {
    const resp = await fetch('/api/admin/check', { credentials: 'include' });
    if (resp.ok) {
      const data = await resp.json();
      if (data.is_admin) {
        // Show admin link in desktop nav
        const desktopAdminLink = document.getElementById('desktop-admin-link');
        if (desktopAdminLink) {
          desktopAdminLink.classList.remove('hidden');
        }
        // Show admin section in account dropdown
        const adminSection = document.getElementById('account-admin-section');
        if (adminSection) {
          adminSection.classList.remove('hidden');
        }
        // Show admin tab in mobile bottom nav (handled by pwa_base)
        const adminNav = document.getElementById('admin-nav');
        if (adminNav) {
          adminNav.classList.remove('hidden');
          const grid = document.getElementById('bottom-nav-grid');
          if (grid) grid.classList.replace('grid-cols-4', 'grid-cols-5');
        }
      }
    }
  } catch (e) {
    // Silently fail - user is not admin
  }
}
checkAdminStatus();
</script>
{% endblock %}
