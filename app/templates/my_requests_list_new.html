{% extends "pwa_base.html" %}

{% block title %}My Prints | Printellect{% endblock %}

{% block nav_myrequests %}text-white bg-zinc-800{% endblock %}
{% block bnav_myrequests %}active{% endblock %}

{% block header_title %}My Prints{% endblock %}

{% block header_right %}
<!-- Desktop nav links + Account menu -->
<nav class="hidden sm:flex items-center gap-1">
  <a href="/" class="px-3 py-2 rounded-lg text-sm font-medium text-zinc-400 hover:text-white hover:bg-zinc-800 transition">Submit</a>
  <a href="/queue" class="px-3 py-2 rounded-lg text-sm font-medium text-zinc-400 hover:text-white hover:bg-zinc-800 transition">Queue</a>
  <a href="/store" class="px-3 py-2 rounded-lg text-sm font-medium text-zinc-400 hover:text-white hover:bg-zinc-800 transition">Store</a>
  <div class="w-px h-5 bg-zinc-700 mx-1"></div>
</nav>

<div class="flex items-center gap-2 relative">
  <button id="account-menu-btn" onclick="toggleAccountMenu()" class="flex items-center gap-2 px-2 py-1.5 hover:bg-zinc-800 rounded-lg transition tap-highlight">
    <div class="w-7 h-7 rounded-full bg-indigo-600 flex items-center justify-center text-xs font-bold">
      {{ email[0]|upper }}
    </div>
    <svg class="w-4 h-4 text-zinc-400 hidden sm:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
    </svg>
  </button>
  
  <!-- Account Dropdown Menu - positioned relative to button -->
  <div id="account-menu" class="hidden absolute right-0 top-full mt-2 w-72 bg-zinc-900 border border-zinc-700 rounded-2xl shadow-2xl z-50 overflow-hidden">
    <!-- Account Header -->
    <div class="p-4 border-b border-zinc-800 bg-zinc-950/50">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-lg font-bold">
          {{ email[0]|upper }}
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium text-white truncate">{{ email }}</p>
          <p class="text-xs text-zinc-500">Printellect Account</p>
        </div>
      </div>
    </div>
    
    <!-- Menu Items -->
    <div class="p-2">
      <button onclick="showNotificationSettings()" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-zinc-800 transition text-left">
        <span class="text-lg">üîî</span>
        <div>
          <p class="text-sm font-medium">Notification Settings</p>
          <p class="text-xs text-zinc-500">Email & push preferences</p>
        </div>
      </button>
      <button onclick="showSyncCode()" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-zinc-800 transition text-left">
        <span class="text-lg">üì±</span>
        <div>
          <p class="text-sm font-medium">Sync to App</p>
          <p class="text-xs text-zinc-500">Transfer session to PWA</p>
        </div>
      </button>
      <a href="/feedback?type=suggestion" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-zinc-800 transition">
        <span class="text-lg">üí°</span>
        <div>
          <p class="text-sm font-medium">Send Feedback</p>
          <p class="text-xs text-zinc-500">Suggestions & bug reports</p>
        </div>
      </a>
    </div>
    
    <!-- Logout -->
    <div class="p-2 border-t border-zinc-800">
      <a href="/my-requests?logout=1" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-red-900/30 text-red-400 transition">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
        </svg>
        <span class="text-sm font-medium">Sign Out</span>
      </a>
    </div>
  </div>
</div>
{% endblock %}

{% block head_extra %}
<style>
  /* Tap feedback for mobile */
  .tap-highlight { -webkit-tap-highlight-color: transparent; }
</style>
{% endblock %}

{% block content %}
<!-- Notification Settings Modal -->
<div id="notification-modal" class="hidden fixed inset-0 bg-black/80 flex items-end sm:items-center justify-center z-50 pb-20 sm:pb-0" onclick="hideNotificationSettings()">
  <div class="bg-zinc-900 border border-zinc-700 rounded-t-2xl sm:rounded-2xl w-full sm:max-w-md max-h-[70vh] sm:max-h-[85vh] overflow-y-auto" 
       onclick="event.stopPropagation()" 
       style="padding-bottom: env(safe-area-inset-bottom, 0px);">
    <!-- Modal Header -->
    <div class="sticky top-0 bg-zinc-900 border-b border-zinc-800 px-4 py-3 flex items-center justify-between z-10">
      <h2 class="text-lg font-bold">üîî Notification Settings</h2>
      <button onclick="hideNotificationSettings()" class="p-2 hover:bg-zinc-800 rounded-lg transition">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    
    <div class="p-4 space-y-4">
      <!-- Push Status Banner -->
      <div id="push-status-banner" class="hidden p-3 rounded-xl border border-yellow-500/40 bg-yellow-900/20">
        <div class="flex items-start gap-2">
          <span class="text-lg">‚ö†Ô∏è</span>
          <p id="push-status-message" class="text-sm text-yellow-200"></p>
        </div>
      </div>
      
      <!-- Email Notifications -->
      <div class="bg-zinc-800/50 rounded-xl p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="flex items-center gap-2">
              <span class="text-lg">üìß</span>
              <span class="font-medium">Email Notifications</span>
            </div>
            <p class="text-xs text-zinc-500 mt-1 ml-7">Receive status updates via email</p>
          </div>
          <button id="email-toggle" onclick="toggleEmailNotifications()" 
                  class="relative inline-flex h-7 w-12 items-center rounded-full transition-colors focus:outline-none bg-indigo-600">
            <span id="email-toggle-dot" class="inline-block h-5 w-5 transform rounded-full bg-white shadow transition-transform translate-x-6"></span>
          </button>
        </div>
      </div>
      
      <!-- Push Notifications -->
      <div class="bg-zinc-800/50 rounded-xl p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="flex items-center gap-2">
              <span class="text-lg">üì≤</span>
              <span class="font-medium">Push Notifications</span>
            </div>
            <p class="text-xs text-zinc-500 mt-1 ml-7">Instant alerts on your device</p>
            <div class="mt-2 ml-7">
              <span id="push-status-indicator" class="inline-flex items-center text-xs font-medium"></span>
            </div>
          </div>
          <button id="push-toggle" onclick="togglePushNotifications()" 
                  class="relative inline-flex h-7 w-12 items-center rounded-full transition-colors focus:outline-none bg-zinc-700">
            <span id="push-toggle-dot" class="inline-block h-5 w-5 transform rounded-full bg-zinc-400 shadow transition-transform translate-x-1"></span>
          </button>
        </div>
        
        <!-- Test Button -->
        <div class="mt-3 pt-3 border-t border-zinc-700/50 ml-7">
          <button id="test-push-btn" onclick="testPushNotification()" 
                  class="px-3 py-1.5 bg-indigo-700 hover:bg-indigo-600 rounded-lg text-xs font-medium text-white transition">
            Send Test Notification
          </button>
        </div>
      </div>
      
      <!-- iOS Install Hint -->
      <div id="ios-install-hint" class="hidden p-3 bg-blue-900/30 border border-blue-500/30 rounded-xl">
        <p class="text-xs text-blue-300">
          <strong>üì± iPhone/iPad:</strong> To get push notifications, first install this app: 
          tap <span class="inline-block px-1.5 py-0.5 bg-zinc-700 rounded">Share</span> ‚Üí 
          <span class="inline-block px-1.5 py-0.5 bg-zinc-700 rounded">Add to Home Screen</span>
        </p>
      </div>
      
      <!-- Tip -->
      <p class="text-xs text-zinc-500 text-center">
        üí° Enable push notifications for instant updates without email clutter
      </p>
    </div>
  </div>
</div>

<!-- Sync Code Modal -->
<div id="sync-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" onclick="closeSyncModal()">
  <div class="bg-zinc-900 border border-zinc-700 rounded-2xl p-6 max-w-sm w-full text-center" onclick="event.stopPropagation()">
    <div class="text-4xl mb-3">üì≤</div>
    <h3 class="font-bold text-lg mb-2">Sync to Printellect App</h3>
    <p class="text-zinc-400 text-sm mb-4">Enter this code in the app to sync your session:</p>
    
    <!-- Code Display -->
    <div id="sync-code-display" class="bg-zinc-950 border border-zinc-700 rounded-xl py-4 px-6 mb-3">
      <span id="sync-code" class="text-3xl font-mono font-bold tracking-widest text-indigo-400">------</span>
    </div>
    <p id="sync-expires" class="text-xs text-zinc-500 mb-4">Expires in <span id="sync-timer">10:00</span></p>
    
    <div class="flex gap-2">
      <button onclick="refreshSyncCode()" class="flex-1 py-2.5 rounded-xl bg-zinc-800 hover:bg-zinc-700 text-sm font-medium transition tap-highlight">
        üîÑ New Code
      </button>
      <button onclick="closeSyncModal()" class="flex-1 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-sm font-medium transition tap-highlight">
        Done
      </button>
    </div>
    
    <div class="mt-4 pt-4 border-t border-zinc-800 text-left">
      <p class="text-xs text-zinc-500 mb-2">üìã Instructions:</p>
      <ol class="text-xs text-zinc-400 space-y-1 list-decimal list-inside">
        <li>Open the Printellect app</li>
        <li>Go to "My Prints"</li>
        <li>Tap "Sync Code" tab</li>
        <li>Enter the 6-digit code above</li>
      </ol>
    </div>
  </div>
</div>

<!-- Page Title -->
<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="text-2xl font-bold">My Prints</h1>
    <p class="text-zinc-400 text-sm mt-1">Track your print requests</p>
  </div>
  <a href="/" class="flex items-center gap-1.5 px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-sm font-medium transition tap-highlight">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
    </svg>
    <span class="hidden sm:inline">New Request</span>
  </a>
</div>

{% set status_colors = {
  'NEW': 'bg-blue-500/20 border-blue-500/50 text-blue-300',
  'NEEDS_INFO': 'bg-orange-500/20 border-orange-500/50 text-orange-300',
  'APPROVED': 'bg-emerald-500/20 border-emerald-500/50 text-emerald-300',
  'PRINTING': 'bg-amber-500/20 border-amber-500/50 text-amber-300',
  'IN_PROGRESS': 'bg-amber-500/20 border-amber-500/50 text-amber-300',
  'DONE': 'bg-cyan-500/20 border-cyan-500/50 text-cyan-300',
  'PICKED_UP': 'bg-purple-500/20 border-purple-500/50 text-purple-300',
  'REJECTED': 'bg-red-500/20 border-red-500/50 text-red-300',
  'CANCELLED': 'bg-zinc-500/20 border-zinc-500/50 text-zinc-400'
} %}

{% set status_icons = {
  'NEW': 'üÜï',
  'NEEDS_INFO': '‚ùì',
  'APPROVED': '‚úì',
  'PRINTING': 'üñ®Ô∏è',
  'IN_PROGRESS': 'üñ®Ô∏è',
  'DONE': '‚úÖ',
  'PICKED_UP': 'üì¶',
  'REJECTED': '‚ùå',
  'CANCELLED': 'üö´'
} %}

{% if requests_list %}
  <!-- Done prints (with snapshots) -->
  {% set done_requests = requests_list | selectattr('status', 'equalto', 'DONE') | list %}
  {% if done_requests %}
  <div class="mb-6">
    <h2 class="font-semibold text-green-400 mb-3 flex items-center gap-2">
      <span>‚úÖ</span> Ready for Pickup
    </h2>
    <div class="space-y-3">
      {% for req in done_requests %}
      <div class="bg-zinc-900/60 border border-green-500/50 rounded-xl overflow-hidden card-interactive">
        {% if req.completion_snapshot %}
        <div class="relative cursor-pointer" onclick="showSnapshot('{{ req.completion_snapshot }}')">
          <img src="data:image/jpeg;base64,{{ req.completion_snapshot }}" 
               alt="Completed print" 
               class="w-full h-32 object-cover" loading="lazy" />
          <span class="absolute bottom-2 right-2 bg-black/60 px-2 py-1 rounded text-xs">üì∑ Tap to enlarge</span>
        </div>
        {% endif %}
        <a href="/my/{{ req.id }}?token={{ req.access_token }}" class="block p-4">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-semibold">{{ req.print_name or 'Untitled' }}</h3>
              <p class="text-xs text-zinc-500">#{{ req.id[:8] }}</p>
            </div>
            <span class="px-2 py-1 rounded-lg text-xs font-medium bg-green-600/25 border border-green-500/50 text-green-300">DONE</span>
          </div>
          <p class="text-sm text-green-300 mt-2">üéâ Your print is ready!</p>
        </a>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Currently printing (includes both PRINTING and IN_PROGRESS with active builds) -->
  {% set printing_requests = requests_list | selectattr('status', 'in', ['PRINTING', 'IN_PROGRESS']) | list %}
  {% if printing_requests %}
  <div class="mb-6">
    <h2 class="font-semibold text-indigo-400 mb-3 flex items-center gap-2">
      <span>üñ®Ô∏è</span> Printing Now
    </h2>
    <div class="space-y-3">
      {% for req in printing_requests %}
      <a href="/my/{{ req.id }}?token={{ req.access_token }}" 
         class="block bg-zinc-900/60 border {% if req.printer_status and req.printer_status.is_offline %}border-amber-500/50{% else %}border-indigo-500/50{% endif %} rounded-xl overflow-hidden card-interactive">
        {% if req.printer_status %}
        <div class="{% if req.printer_status.is_offline %}bg-amber-950/40 border-b border-amber-500/30{% else %}bg-indigo-950/40 border-b border-indigo-500/30{% endif %} p-3">
          <div class="flex items-center justify-between text-sm mb-2">
            <div class="flex items-center gap-2">
              <span class="font-medium">{{ req.active_printer or req.printer }}</span>
              {% if req.printer_status.is_offline %}
              <span class="text-xs px-1.5 py-0.5 bg-amber-500/20 border border-amber-500/50 text-amber-300 rounded">
                Offline
              </span>
              {% elif req.total_builds and req.total_builds > 1 %}
              <span class="text-xs px-1.5 py-0.5 bg-amber-500/20 border border-amber-500/50 text-amber-300 rounded">
                Build {{ (req.completed_builds or 0) + 1 }}/{{ req.total_builds }}
              </span>
              {% endif %}
            </div>
            <span class="{% if req.printer_status.is_offline %}text-amber-300{% else %}text-emerald-300{% endif %}">{{ req.printer_status.progress or 0 }}%</span>
          </div>
          {% if req.printer_status.progress is not none %}
          <div class="h-1.5 bg-zinc-800 rounded-full overflow-hidden">
            <div class="h-full {% if req.printer_status.is_offline %}bg-amber-500{% else %}bg-emerald-500{% endif %} transition-all" style="width: {{ req.printer_status.progress }}%"></div>
          </div>
          {% endif %}
          {% if req.printer_status.is_offline and req.printer_status.last_seen %}
          <p class="text-xs text-amber-400/80 mt-2">‚ö†Ô∏è Connection lost ¬∑ Last seen: {{ req.printer_status.last_seen }}</p>
          {% elif req.smart_eta_display %}
          <p class="text-xs text-zinc-400 mt-2">ETA: {{ req.smart_eta_display }}</p>
          {% endif %}
          {% if req.printer_status.current_layer and req.printer_status.total_layers %}
          <p class="text-xs text-zinc-500 mt-1">Layer: {{ req.printer_status.current_layer }}/{{ req.printer_status.total_layers }}</p>
          {% endif %}
        </div>
        {% endif %}
        <div class="p-4">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-semibold">{{ req.print_name or 'Untitled' }}</h3>
              <p class="text-xs text-zinc-500">#{{ req.id[:8] }}</p>
            </div>
            <span class="px-2 py-1 rounded-lg text-xs font-medium bg-indigo-600/25 border border-indigo-500/50 text-indigo-300">
              {% if req.status == 'IN_PROGRESS' %}PRINTING{% else %}{{ req.status }}{% endif %}
            </span>
          </div>
        </div>
      </a>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Other requests -->
  {% set other_requests = requests_list | rejectattr('status', 'in', ['DONE', 'PRINTING', 'IN_PROGRESS']) | list %}
  {% if other_requests %}
  <div class="mb-6">
    {% if done_requests or printing_requests %}
    <h2 class="font-semibold text-zinc-400 mb-3">üìã Other Requests</h2>
    {% endif %}
    <div class="space-y-3">
      {% for req in other_requests %}
      <a href="/my/{{ req.id }}?token={{ req.access_token }}" 
         class="block bg-zinc-900/60 border {% if req.status == 'NEEDS_INFO' %}border-orange-500/50{% else %}border-zinc-800{% endif %} rounded-xl p-4 card-interactive">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="font-semibold">{{ req.print_name or 'Untitled' }}</h3>
            <p class="text-xs text-zinc-500">#{{ req.id[:8] }} ‚Ä¢ {{ req.created_at[:10] }}</p>
          </div>
          <span class="px-2 py-1 rounded-lg text-xs font-medium border {{ status_colors.get(req.status, 'bg-zinc-800 border-zinc-700') }}">
            {{ req.status.replace('_', ' ') }}
          </span>
        </div>
        <div class="flex gap-2 mt-2 text-xs text-zinc-500">
          <span>{{ req.printer or 'ANY' }}</span>
          <span>‚Ä¢</span>
          <span>{{ req.material }}</span>
        </div>
        {% if req.status == 'NEEDS_INFO' %}
        <p class="text-sm text-orange-300 mt-2">‚ö†Ô∏è Response needed - tap to view</p>
        {% endif %}
      </a>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Summary -->
  <div class="text-center text-sm text-zinc-500 py-4">
    {{ requests_list|length }} request{% if requests_list|length != 1 %}s{% endif %}
  </div>

{% else %}
  <!-- No Requests - Improved Empty State -->
  <div class="text-center py-16 bg-zinc-900/40 border border-zinc-800 rounded-2xl">
    <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-zinc-800/50 flex items-center justify-center">
      <svg class="w-8 h-8 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
      </svg>
    </div>
    <h3 class="text-lg font-semibold text-zinc-300 mb-2">No requests yet</h3>
    <p class="text-sm text-zinc-500 mb-6 max-w-xs mx-auto">Submit your first print request and track it here!</p>
    <a href="/" class="inline-flex items-center gap-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 px-6 py-3 font-semibold tap-highlight transition">
      New Request
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
      </svg>
    </a>
  </div>
{% endif %}

<!-- Snapshot Modal -->
<div id="snapshot-modal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4" onclick="hideSnapshot()">
  <img id="snapshot-img" src="" alt="Print" class="max-w-full max-h-full rounded-lg" />
</div>

<!-- Footer -->
<div class="mt-6 pt-4 border-t border-zinc-800 flex items-center justify-between text-xs text-zinc-500">
  <span>{{ email }}</span>
  <div class="flex items-center gap-4">
    <a href="/feedback?type=bug" class="hover:text-red-400 transition">üêõ</a>
    <a href="/feedback?type=suggestion" class="hover:text-yellow-400 transition">üí°</a>
    <a href="/changelog" class="hover:text-indigo-400 transition">v{{ version }}</a>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ========== Constants ==========
const token = '{{ token }}';
const email = '{{ email }}';
let VAPID_PUBLIC_KEY = '';

// Save token for persistent login
if (token) {
  localStorage.setItem('my_requests_token', token);
  localStorage.setItem('my_requests_email', email);
}

// ========== Account Menu ==========
function toggleAccountMenu() {
  const menu = document.getElementById('account-menu');
  menu.classList.toggle('hidden');
}

// Close account menu when clicking outside
document.addEventListener('click', (e) => {
  const menu = document.getElementById('account-menu');
  const btn = e.target.closest('button[onclick*="toggleAccountMenu"]');
  if (!btn && !menu.contains(e.target)) {
    menu.classList.add('hidden');
  }
});

// ========== Notification Settings Modal ==========
function showNotificationSettings() {
  document.getElementById('account-menu').classList.add('hidden');
  document.getElementById('notification-modal').classList.remove('hidden');
  initNotificationUI();
}

function hideNotificationSettings() {
  document.getElementById('notification-modal').classList.add('hidden');
}

// ========== Snapshot Modal ==========
function showSnapshot(b64) {
  document.getElementById('snapshot-img').src = 'data:image/jpeg;base64,' + b64;
  document.getElementById('snapshot-modal').classList.remove('hidden');
}

function hideSnapshot() {
  document.getElementById('snapshot-modal').classList.add('hidden');
}

// ========== Sync Code Functions ==========
let syncTimerInterval = null;
let syncExpiry = null;

function showSyncCode() {
  document.getElementById('account-menu').classList.add('hidden');
  document.getElementById('sync-modal').classList.remove('hidden');
  refreshSyncCode();
}

function closeSyncModal() {
  document.getElementById('sync-modal').classList.add('hidden');
  if (syncTimerInterval) clearInterval(syncTimerInterval);
}

async function refreshSyncCode() {
  const codeEl = document.getElementById('sync-code');
  const timerEl = document.getElementById('sync-timer');
  codeEl.textContent = '......';
  
  try {
    const formData = new FormData();
    formData.append('token', token);
    
    const response = await fetch('/api/generate-sync-code', {
      method: 'POST',
      body: formData
    });
    const data = await response.json();
    
    if (data.success) {
      const code = data.code;
      codeEl.textContent = code.slice(0,3) + '-' + code.slice(3);
      
      syncExpiry = Date.now() + (data.expires_in * 1000);
      if (syncTimerInterval) clearInterval(syncTimerInterval);
      syncTimerInterval = setInterval(updateTimer, 1000);
      updateTimer();
    } else {
      codeEl.textContent = 'Error';
    }
  } catch (e) {
    codeEl.textContent = 'Error';
  }
}

function updateTimer() {
  const timerEl = document.getElementById('sync-timer');
  const remaining = Math.max(0, syncExpiry - Date.now());
  const mins = Math.floor(remaining / 60000);
  const secs = Math.floor((remaining % 60000) / 1000);
  timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
  
  if (remaining <= 0) {
    timerEl.textContent = 'Expired';
    document.getElementById('sync-code').textContent = '------';
    clearInterval(syncTimerInterval);
  }
}

// ========== Email Notifications ==========
// Track email toggle state - default to true (enabled)
let currentEmailState = localStorage.getItem('email_notify_' + email) !== 'false';

function updateEmailToggle(enabled) {
  const toggle = document.getElementById('email-toggle');
  const dot = document.getElementById('email-toggle-dot');
  
  if (enabled) {
    toggle.classList.remove('bg-zinc-700');
    toggle.classList.add('bg-indigo-600');
    dot.classList.remove('translate-x-1', 'bg-zinc-400');
    dot.classList.add('translate-x-6', 'bg-white');
  } else {
    toggle.classList.remove('bg-indigo-600');
    toggle.classList.add('bg-zinc-700');
    dot.classList.remove('translate-x-6', 'bg-white');
    dot.classList.add('translate-x-1', 'bg-zinc-400');
  }
}

async function toggleEmailNotifications() {
  const newState = !currentEmailState;
  
  // Save preference locally
  localStorage.setItem('email_notify_' + email, newState ? 'true' : 'false');
  currentEmailState = newState;
  updateEmailToggle(newState);
  
  // Update all requests for this user
  try {
    const formData = new FormData();
    formData.append('token', token);
    formData.append('email_enabled', newState ? '1' : '0');
    
    const response = await fetch('/api/update-global-email-notify', {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    if (data.success) {
      showToast(newState ? 'Email notifications enabled' : 'Email notifications disabled', 'success');
    } else {
      // API may not exist yet - still save locally
      showToast(newState ? 'Email notifications enabled' : 'Email notifications disabled', 'success');
    }
  } catch (e) {
    // Still save locally even if API fails
    showToast(newState ? 'Email notifications enabled' : 'Email notifications disabled', 'success');
  }
}

// ========== Push Notifications ==========
let pushEnabled = false;

async function initNotificationUI() {
  updateEmailToggle(currentEmailState);
  
  // Check for iOS not in standalone mode
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  
  if (isIOS && !isStandalone) {
    document.getElementById('ios-install-hint')?.classList.remove('hidden');
  }
  
  // Fetch VAPID key
  try {
    const resp = await fetch('/api/push/vapid-public-key');
    const data = await resp.json();
    if (data.publicKey) {
      VAPID_PUBLIC_KEY = data.publicKey;
    }
  } catch (e) {
    console.warn('Could not fetch VAPID key');
  }
  
  // Check push notification status
  await checkPushStatus();
}

async function checkPushStatus() {
  const statusIndicator = document.getElementById('push-status-indicator');
  const banner = document.getElementById('push-status-banner');
  const bannerMsg = document.getElementById('push-status-message');
  
  // Hide banner by default
  banner.classList.add('hidden');
  
  // Check if service worker and push are supported
  if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
    statusIndicator.textContent = '‚ùå Not supported';
    statusIndicator.className = 'inline-flex items-center text-xs font-medium text-red-400';
    banner.classList.remove('hidden');
    bannerMsg.textContent = 'Push notifications are not supported in this browser.';
    updatePushToggle(false, true);
    return;
  }
  
  // Check notification permission
  const permission = Notification.permission;
  
  if (permission === 'denied') {
    statusIndicator.textContent = 'üö´ Blocked';
    statusIndicator.className = 'inline-flex items-center text-xs font-medium text-red-400';
    banner.classList.remove('hidden');
    bannerMsg.textContent = 'Notifications are blocked. Please enable them in your browser settings.';
    updatePushToggle(false, true);
    return;
  }
  
  // Check if we have an active subscription
  try {
    const registration = await navigator.serviceWorker.ready;
    const subscription = await registration.pushManager.getSubscription();
    
    if (subscription) {
      statusIndicator.textContent = '‚úÖ Active';
      statusIndicator.className = 'inline-flex items-center text-xs font-medium text-emerald-400';
      pushEnabled = true;
      updatePushToggle(true, false);
    } else if (permission === 'granted') {
      statusIndicator.textContent = '‚ö™ Inactive';
      statusIndicator.className = 'inline-flex items-center text-xs font-medium text-zinc-400';
      updatePushToggle(false, false);
    } else {
      statusIndicator.textContent = '‚ö™ Not enabled';
      statusIndicator.className = 'inline-flex items-center text-xs font-medium text-zinc-400';
      updatePushToggle(false, false);
    }
  } catch (e) {
    statusIndicator.textContent = '‚ö†Ô∏è Error';
    statusIndicator.className = 'inline-flex items-center text-xs font-medium text-yellow-400';
    updatePushToggle(false, false);
  }
}

function updatePushToggle(enabled, disabled) {
  const toggle = document.getElementById('push-toggle');
  const dot = document.getElementById('push-toggle-dot');
  const testBtn = document.getElementById('test-push-btn');
  
  if (disabled) {
    toggle.disabled = true;
    toggle.className = 'relative inline-flex h-7 w-12 items-center rounded-full transition-colors focus:outline-none bg-zinc-800 cursor-not-allowed opacity-50';
    testBtn.disabled = true;
    testBtn.className = 'px-3 py-1.5 bg-zinc-700 rounded-lg text-xs font-medium text-zinc-500 cursor-not-allowed';
    return;
  }
  
  toggle.disabled = false;
  testBtn.disabled = !enabled;
  
  if (enabled) {
    toggle.className = 'relative inline-flex h-7 w-12 items-center rounded-full transition-colors focus:outline-none bg-indigo-600';
    dot.className = 'inline-block h-5 w-5 transform rounded-full bg-white shadow transition-transform translate-x-6';
    testBtn.className = 'px-3 py-1.5 bg-indigo-700 hover:bg-indigo-600 rounded-lg text-xs font-medium text-white transition';
  } else {
    toggle.className = 'relative inline-flex h-7 w-12 items-center rounded-full transition-colors focus:outline-none bg-zinc-700';
    dot.className = 'inline-block h-5 w-5 transform rounded-full bg-zinc-400 shadow transition-transform translate-x-1';
    testBtn.className = 'px-3 py-1.5 bg-zinc-700 rounded-lg text-xs font-medium text-zinc-500 cursor-not-allowed';
  }
}

async function togglePushNotifications() {
  if (pushEnabled) {
    await unsubscribePush();
  } else {
    await subscribePush();
  }
}

async function subscribePush() {
  try {
    const permission = await Notification.requestPermission();
    if (permission !== 'granted') {
      showToast('Notification permission denied', 'error');
      await checkPushStatus();
      return;
    }
    
    if (!VAPID_PUBLIC_KEY) {
      showToast('Push notifications not configured on server', 'error');
      return;
    }
    
    const registration = await navigator.serviceWorker.ready;
    
    // Create subscription
    const subscription = await registration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
    });
    
    // Send to server
    const formData = new FormData();
    formData.append('token', token);
    formData.append('subscription', JSON.stringify(subscription));
    
    const response = await fetch('/api/push/subscribe', {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    if (data.success) {
      pushEnabled = true;
      showToast('Push notifications enabled!', 'success');
    } else {
      showToast(data.error || 'Failed to enable push', 'error');
    }
  } catch (e) {
    console.error('Push subscription error:', e);
    showToast('Failed to enable push notifications', 'error');
  }
  
  await checkPushStatus();
}

async function unsubscribePush() {
  try {
    const registration = await navigator.serviceWorker.ready;
    const subscription = await registration.pushManager.getSubscription();
    
    if (subscription) {
      // Unsubscribe locally
      await subscription.unsubscribe();
      
      // Notify server
      const formData = new FormData();
      formData.append('token', token);
      formData.append('endpoint', subscription.endpoint);
      
      await fetch('/api/push/unsubscribe', {
        method: 'POST',
        body: formData
      });
    }
    
    pushEnabled = false;
    showToast('Push notifications disabled', 'success');
  } catch (e) {
    console.error('Unsubscribe error:', e);
    showToast('Failed to disable push', 'error');
  }
  
  await checkPushStatus();
}

async function testPushNotification() {
  const btn = document.getElementById('test-push-btn');
  btn.disabled = true;
  btn.textContent = 'Sending...';
  
  try {
    const formData = new FormData();
    formData.append('token', token);
    
    const response = await fetch('/api/push/test', {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    if (data.success) {
      showToast('Test notification sent!', 'success');
    } else {
      showToast(data.error || 'Failed to send test', 'error');
    }
  } catch (e) {
    showToast('Network error', 'error');
  }
  
  btn.disabled = false;
  btn.textContent = 'Send Test Notification';
}

// ========== Utility Functions ==========
function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = window.atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}
</script>
{% endblock %}
