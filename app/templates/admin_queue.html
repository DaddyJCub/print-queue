<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard | Printellect</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .design-dim { opacity: 0.35; pointer-events: none; }
  </style>
</head>
<body class="bg-zinc-950 text-zinc-100">
  <div class="max-w-7xl mx-auto p-6">
    <!-- Navigation -->
    {% set active_page = 'design' if request.query_params.get('design') else 'queue' %}
    {% include 'admin_nav.html' %}
    
    <!-- Page Header - Compact -->
    <div class="mb-4 flex items-center justify-between flex-wrap gap-3">
      <h1 class="text-2xl font-bold">Queue</h1>
      {% if current_admin_can_manage_designs and design_enabled %}
      <div class="flex items-center gap-1 bg-zinc-900/50 rounded-lg p-0.5 border border-zinc-800">
        <button type="button" class="design-filter-btn px-3 py-1.5 rounded-md text-xs font-medium transition"
                data-filter="all">All</button>
        <button type="button" class="design-filter-btn px-3 py-1.5 rounded-md text-xs font-medium transition"
                data-filter="needs">Design Needed</button>
        <button type="button" class="design-filter-btn px-3 py-1.5 rounded-md text-xs font-medium transition"
                data-filter="mine">My Work</button>
      </div>
      {% endif %}
    </div>

    <!-- Batch Edit Form (initially hidden) -->
    <div id="batch-edit-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-6 max-w-sm w-full">
        <h2 class="text-xl font-bold mb-4">Batch Edit Selected</h2>
        <form method="POST" action="/admin/batch-update" class="space-y-4">
          <input type="hidden" id="batch-ids" name="request_ids" />
          
          <div>
            <label class="text-sm text-zinc-400">Change Priority (optional)</label>
            <select name="priority" class="w-full mt-2 rounded-xl bg-zinc-950 border border-zinc-800 p-3">
              <option value="">‚Äî Keep current ‚Äî</option>
              {% for p in [1,2,3,4,5] %}
                <option value="{{ p }}">Priority {{ p }}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label class="text-sm text-zinc-400">Change Status (optional)</label>
            <select name="status" class="w-full mt-2 rounded-xl bg-zinc-950 border border-zinc-800 p-3">
              <option value="">‚Äî Keep current ‚Äî</option>
              {% for s in ["APPROVED", "IN_PROGRESS", "PRINTING", "BLOCKED", "DONE", "REJECTED", "CANCELLED"] %}
                <option value="{{ s }}">{{ s }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="flex gap-3 pt-4">
            <button type="button" onclick="hideBatchEditModal()" class="flex-1 rounded-xl bg-zinc-800 hover:bg-zinc-700 transition px-4 py-2 text-sm">
              Cancel
            </button>
            <button type="submit" class="flex-1 rounded-xl bg-indigo-600 hover:bg-indigo-500 transition px-4 py-2 text-sm font-semibold">
              Update <span id="batch-count">0</span> requests
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Print Start Modal (Printer/Material Selection) -->
    <div id="print-start-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-6 max-w-sm w-full">
        <h2 class="text-xl font-bold mb-2" id="print-modal-title">Start Print</h2>
        <p class="text-sm text-zinc-400 mb-4" id="print-modal-subtitle">Select printer and material for this print</p>
        
        <form id="print-start-form" method="POST" action="" class="space-y-4">
          <input type="hidden" name="to_status" id="print-modal-status" value="PRINTING" />
          <input type="hidden" name="comment" id="print-modal-comment" value="Started print" />
          
          <div>
            <label class="text-sm text-zinc-300">Printer <span class="text-red-400">*</span></label>
            <select name="printer" id="print-modal-printer" required class="w-full mt-2 rounded-xl bg-zinc-950 border border-zinc-800 p-3">
              <option value="">‚Äî Select printer ‚Äî</option>
              {% for code, label in printers %}
                {% if code != 'ANY' %}
                  <option value="{{ code }}">{{ label }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>

          <div>
            <label class="text-sm text-zinc-300">Material <span class="text-red-400">*</span></label>
            <select name="material" id="print-modal-material" required class="w-full mt-2 rounded-xl bg-zinc-950 border border-zinc-800 p-3">
              <option value="">‚Äî Select material ‚Äî</option>
              {% for code, label in materials %}
                {% if code != 'ANY' %}
                  <option value="{{ code }}">{{ label }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
          
          <div>
            <label class="text-sm text-zinc-300">Colors</label>
            <input type="text" name="colors" id="print-modal-colors" placeholder="e.g. Black, White" 
                   class="w-full mt-2 rounded-xl bg-zinc-950 border border-zinc-800 p-3 text-sm" />
          </div>

          <div class="flex gap-3 pt-4">
            <button type="button" onclick="hidePrintStartModal()" class="flex-1 rounded-xl bg-zinc-800 hover:bg-zinc-700 transition px-4 py-2 text-sm">
              Cancel
            </button>
            <button type="submit" id="print-modal-submit" class="flex-1 rounded-xl bg-emerald-600 hover:bg-emerald-500 transition px-4 py-2 text-sm font-semibold">
              üñ® Start Print
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Print Start Modal Functions
      function showPrintStartModal(requestId, currentPrinter, currentMaterial, currentColors, targetStatus) {
        targetStatus = targetStatus || 'PRINTING';
        
        const modal = document.getElementById('print-start-modal');
        const form = document.getElementById('print-start-form');
        const printerSelect = document.getElementById('print-modal-printer');
        const materialSelect = document.getElementById('print-modal-material');
        const colorsInput = document.getElementById('print-modal-colors');
        const statusInput = document.getElementById('print-modal-status');
        const commentInput = document.getElementById('print-modal-comment');
        const titleEl = document.getElementById('print-modal-title');
        const subtitleEl = document.getElementById('print-modal-subtitle');
        const submitBtn = document.getElementById('print-modal-submit');
        
        // Set form action
        form.action = `/admin/request/${requestId}/status`;
        
        // Pre-fill current values if not ANY
        if (currentPrinter && currentPrinter !== 'ANY') {
          printerSelect.value = currentPrinter;
        } else {
          printerSelect.value = '';
        }
        
        if (currentMaterial && currentMaterial !== 'ANY') {
          materialSelect.value = currentMaterial;
        } else {
          materialSelect.value = '';
        }
        
        colorsInput.value = currentColors || '';
        statusInput.value = targetStatus;
        
        // Customize modal based on target status
        if (targetStatus === 'PRINTING') {
          titleEl.textContent = 'üñ® Start Print';
          subtitleEl.textContent = 'Select the printer and material for this print job';
          commentInput.value = 'Started print';
          submitBtn.textContent = 'üñ® Start Print';
          submitBtn.className = 'flex-1 rounded-xl bg-emerald-600 hover:bg-emerald-500 transition px-4 py-2 text-sm font-semibold';
        } else if (targetStatus === 'APPROVED') {
          titleEl.textContent = '‚úì Approve Request';
          subtitleEl.textContent = 'Optionally update printer/material before approving';
          commentInput.value = '';
          submitBtn.textContent = '‚úì Approve';
          submitBtn.className = 'flex-1 rounded-xl bg-indigo-600 hover:bg-indigo-500 transition px-4 py-2 text-sm font-semibold';
          // Make fields not required for approval
          printerSelect.required = false;
          materialSelect.required = false;
        }
        
        modal.classList.remove('hidden');
      }
      
      function hidePrintStartModal() {
        document.getElementById('print-start-modal').classList.add('hidden');
        // Reset required fields
        document.getElementById('print-modal-printer').required = true;
        document.getElementById('print-modal-material').required = true;
      }
      
      // Close modal when clicking outside
      document.getElementById('print-start-modal').addEventListener('click', (e) => {
        if (e.target.id === 'print-start-modal') hidePrintStartModal();
      });
    </script>

    <script>
      let selectedIds = new Set();

      function toggleSelectAll(sectionId) {
        const checkboxes = document.querySelectorAll(`#${sectionId} input[type="checkbox"][data-request-id]`);
        const allChecked = Array.from(checkboxes).every(c => c.checked);
        checkboxes.forEach(c => {
          c.checked = !allChecked;
          toggleRequestId(c.value);
        });
        updateBatchUI(sectionId);
      }

      function toggleRequestId(id) {
        if (selectedIds.has(id)) {
          selectedIds.delete(id);
        } else {
          selectedIds.add(id);
        }
      }

      function updateBatchUI(sectionId) {
        const checkboxes = document.querySelectorAll(`#${sectionId} input[type="checkbox"][data-request-id]`);
        const allChecked = Array.from(checkboxes).every(c => c.checked);
        const selectAll = document.querySelector(`#${sectionId} input[data-select-all]`);
        if (selectAll) selectAll.checked = allChecked;
        
        document.getElementById('batch-count').textContent = selectedIds.size;
      }

      function showBatchEditModal() {
        if (selectedIds.size === 0) {
          alert('Please select at least one request');
          return;
        }
        document.getElementById('batch-ids').value = Array.from(selectedIds).join(',');
        document.getElementById('batch-edit-modal').classList.remove('hidden');
      }

      function hideBatchEditModal() {
        document.getElementById('batch-edit-modal').classList.add('hidden');
      }

      // Quick status change without redirect (for dashboard actions)
      async function quickStatusChange(requestId, toStatus, comment, buttonEl) {
        const originalText = buttonEl.innerHTML;
        buttonEl.disabled = true;
        buttonEl.innerHTML = '<span class="animate-pulse">...</span>';
        
        try {
          const formData = new FormData();
          formData.append('to_status', toStatus);
          formData.append('comment', comment || '');
          formData.append('quick_action', '1');  // Signal to not redirect
          
          const response = await fetch(`/admin/request/${requestId}/status`, {
            method: 'POST',
            body: formData
          });
          
          if (response.ok) {
            // Find and hide the parent request item
            const requestItem = buttonEl.closest('.request-item');
            if (requestItem) {
              requestItem.style.transition = 'opacity 0.3s, transform 0.3s';
              requestItem.style.opacity = '0';
              requestItem.style.transform = 'translateX(20px)';
              setTimeout(() => {
                requestItem.remove();
                // Update section count if present
                updateSectionCounts();
              }, 300);
            }
            
            // Show success toast
            showToast(`‚úì Marked as ${toStatus.replace('_', ' ').toLowerCase()}`);
          } else {
            const errorText = await response.text();
            showToast(`Error: ${errorText}`, 'error');
            buttonEl.disabled = false;
            buttonEl.innerHTML = originalText;
          }
        } catch (e) {
          showToast('Network error', 'error');
          buttonEl.disabled = false;
          buttonEl.innerHTML = originalText;
        }
      }
      
      // Update section header counts after removing items
      function updateSectionCounts() {
        // Count remaining items in each section
        const sections = ['new-section', 'printing-section', 'approved-section', 'done-section'];
        sections.forEach(sectionId => {
          const section = document.getElementById(sectionId);
          if (section) {
            const count = section.querySelectorAll('.request-item:not([data-design-hidden="1"])').length;
            const countBadge = section.querySelector('.section-count');
            if (countBadge) {
              countBadge.textContent = count;
            }
          }
        });
      }
      
      // Simple toast notification
      function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-xl text-sm font-medium z-50 transform transition-all duration-300 ${
          type === 'error' 
            ? 'bg-red-900/90 border border-red-700 text-red-200' 
            : 'bg-emerald-900/90 border border-emerald-700 text-emerald-200'
        }`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transform = 'translateX(100%)';
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      // Close modal when clicking outside
      document.getElementById('batch-edit-modal').addEventListener('click', (e) => {
        if (e.target.id === 'batch-edit-modal') hideBatchEditModal();
      });
    </script>
    
    {% if current_admin_can_manage_designs and design_enabled %}
    <script>
      const currentDesignerId = "{{ current_admin.id if current_admin else '' }}";
      const designButtons = document.querySelectorAll('.design-filter-btn');
      function applyDesignFilter(filter) {
        designButtons.forEach(btn => {
          const isActive = btn.dataset.filter === filter;
          btn.classList.toggle('bg-indigo-600', isActive);
          btn.classList.toggle('text-white', isActive);
          btn.classList.toggle('text-zinc-400', !isActive);
        });
        document.querySelectorAll('.request-item').forEach(el => {
          const needsDesign = el.dataset.requiresDesign === '1' && el.dataset.designComplete !== '1';
          const isMine = needsDesign && currentDesignerId && el.dataset.designer === currentDesignerId;
          let show = true;
          if (filter === 'needs' && !needsDesign) show = false;
          if (filter === 'mine' && !isMine) show = false;
          
          el.dataset.designHidden = show ? "0" : "1";
          el.classList.toggle('design-dim', !show);
        });
      }
      designButtons.forEach(btn => btn.addEventListener('click', () => applyDesignFilter(btn.dataset.filter)));
      const initialFilter = (new URLSearchParams(window.location.search).get('design') === '1') ? 'needs' : 'all';
      applyDesignFilter(initialFilter);
    </script>
    {% endif %}

    <!-- Helper macro-ish (simple patterns) -->
    {% macro badge(text) -%}
      <span class="px-2 py-1 rounded-lg text-xs border
        {% if text == 'NEEDS_INFO' %}bg-orange-900/20 border-orange-800 text-orange-200
        {% elif text == 'APPROVED' %}bg-green-900/20 border-green-800 text-green-200
        {% elif text == 'PRINTING' %}bg-emerald-900/20 border-emerald-800 text-emerald-200
        {% elif text == 'DONE' %}bg-cyan-900/20 border-cyan-800 text-cyan-200
        {% else %}bg-zinc-950 border-zinc-800 text-zinc-300{% endif %}">{{ text }}</span>
    {%- endmacro %}

    {% macro prio_badge(p) -%}
      {% set p = p or 3 %}
      <span class="px-2 py-1 rounded-lg text-xs border
        {% if p == 1 %}bg-red-900/20 border-red-800 text-red-200
        {% elif p == 2 %}bg-amber-900/20 border-amber-800 text-amber-200
        {% elif p == 3 %}bg-zinc-950 border-zinc-800 text-zinc-200
        {% elif p == 4 %}bg-zinc-950 border-zinc-800 text-zinc-300
        {% else %}bg-zinc-950 border-zinc-800 text-zinc-400{% endif %}">
        P{{ p }}
      </span>
    {%- endmacro %}

    <!-- Print Match Suggestions - Compact Alert -->
    {% if print_match_suggestions %}
      {% for printer_code, suggestion in print_match_suggestions.items() %}
        <div class="mb-3 bg-amber-900/20 border border-amber-600/50 rounded-xl p-3 flex items-center justify-between gap-3">
          <div class="flex-1 min-w-0">
            <span class="text-sm text-amber-200">
              üîó <strong>{{ printer_code }}</strong> printing "{{ suggestion.file_display }}" ‚Äî 
              <span class="text-amber-300">{{ suggestion.matches|length }} match{% if suggestion.matches|length != 1 %}es{% endif %}</span>
            </span>
            <div class="flex flex-wrap gap-1.5 mt-2">
              {% for match in suggestion.matches %}
                <form method="POST" action="/admin/match-print/{{ match.id }}" class="inline">
                  <input type="hidden" name="printer" value="{{ printer_code }}" />
                  <button type="submit" class="px-2 py-1 bg-amber-600/30 hover:bg-amber-600/50 border border-amber-500/50 rounded text-xs transition">
                    {{ match.print_name or match.id[:8] }}
                  </button>
                </form>
              {% endfor %}
            </div>
          </div>
          <form method="POST" action="/admin/dismiss-match/{{ printer_code }}">
            <button type="submit" class="text-zinc-400 hover:text-zinc-200 p-1" title="Dismiss">‚úï</button>
          </form>
        </div>
      {% endfor %}
    {% endif %}

    <!-- Printer Status - Collapsible -->
    <details class="mb-4 group" open>
      <summary class="flex items-center justify-between cursor-pointer p-3 bg-zinc-900/40 rounded-xl border border-zinc-800 hover:bg-zinc-900/60 transition">
        <div class="flex items-center gap-3">
          <span class="text-sm font-semibold">üñ® Printers</span>
          <div class="flex items-center gap-2">
            {% for printer_name, printer_data in printer_status.items() %}
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs
                {% if printer_data.is_printing %}bg-emerald-500/20 text-emerald-300
                {% elif printer_data.status == 'READY' %}bg-green-500/20 text-green-300
                {% elif printer_data.is_offline %}bg-zinc-700/50 text-zinc-400
                {% else %}bg-amber-500/20 text-amber-300{% endif %}">
                <span class="w-1.5 h-1.5 rounded-full {% if printer_data.is_printing %}bg-emerald-400 animate-pulse{% elif printer_data.status == 'READY' %}bg-green-400{% elif printer_data.is_offline %}bg-zinc-500{% else %}bg-amber-400{% endif %}"></span>
                {{ printer_name.replace('_', ' ').title() }}
              </span>
            {% endfor %}
          </div>
        </div>
        <svg class="w-4 h-4 text-zinc-400 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
      </summary>
      
      <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3" id="printer-status-cards">
      <!-- Adventurer 4 -->
      <div id="card-adv4" class="bg-zinc-900/40 border {% if printer_status.ADVENTURER_4.is_offline and printer_status.ADVENTURER_4.is_cached %}border-amber-700/50{% else %}border-zinc-800{% endif %} rounded-xl p-4">
        <div class="flex items-center justify-between mb-2">
          <span class="font-medium text-sm">Adventurer 4</span>
          {% if printer_status.ADVENTURER_4.is_offline %}
            <span class="status-badge px-2 py-0.5 rounded text-xs bg-zinc-700/50 text-zinc-400">Offline</span>
          {% elif printer_status.ADVENTURER_4.status %}
            <span class="status-badge px-2 py-0.5 rounded text-xs
              {% if printer_status.ADVENTURER_4.is_printing %}bg-emerald-500/20 text-emerald-300
              {% elif printer_status.ADVENTURER_4.status == 'READY' %}bg-green-500/20 text-green-300
              {% else %}bg-amber-500/20 text-amber-300{% endif %}">
              {{ printer_status.ADVENTURER_4.status }}
            </span>
          {% else %}
            <span class="status-badge px-2 py-0.5 rounded text-xs bg-zinc-700/50 text-zinc-400">Unknown</span>
          {% endif %}
        </div>
        
        <!-- Printing progress -->
        <div class="print-info {% if not printer_status.ADVENTURER_4.is_printing %}hidden{% endif %}">
          <div class="flex items-center justify-between text-xs mb-1.5">
            <span class="file-name text-zinc-300 truncate">{{ printer_status.ADVENTURER_4.current_file or 'Unknown' }}</span>
            <span class="progress-text text-emerald-300 font-medium">{{ printer_status.ADVENTURER_4.progress or 0 }}%</span>
          </div>
          <div class="h-1.5 bg-zinc-800 rounded-full overflow-hidden">
            <div class="progress-bar h-full bg-emerald-500 transition-all duration-500" 
                 style="width: {{ printer_status.ADVENTURER_4.progress or 0 }}%"></div>
          </div>
          {% set active_build = active_builds_by_printer.get('ADVENTURER_4') %}
          {% if active_build %}
          <button type="button" class="mt-2 px-2 py-1 rounded bg-amber-700/60 hover:bg-amber-600 text-white text-xs transition"
                  onclick="pausePrinterBuildConfirm('{{ active_build.id }}', '{{ active_build.build_number }}', 'ADVENTURER_4')">
            ‚è∏ Pause
          </button>
          {% endif %}
        </div>
        
        <div class="flex items-center justify-between text-xs text-zinc-500 mt-2 {% if printer_status.ADVENTURER_4.is_printing %}pt-2 border-t border-zinc-800{% endif %}">
          <span class="temp-text">
            {% if printer_status.ADVENTURER_4.temp %}üå° {{ printer_status.ADVENTURER_4.temp }}¬∞C{% endif %}
          </span>
          {% if printer_status.ADVENTURER_4.camera_url %}
          <button type="button" onclick="toggleAdminCamera('ADVENTURER_4')" id="admin-cam-btn-ADVENTURER_4" 
                  class="text-indigo-400 hover:text-indigo-300 text-xs">
            <span class="btn-text">üì∑ Camera</span>
          </button>
          {% endif %}
        </div>
        {% if printer_status.ADVENTURER_4.camera_url %}
        <div id="admin-cam-ADVENTURER_4" class="hidden mt-2">
          <img id="admin-cam-img-ADVENTURER_4" class="w-full rounded-lg bg-zinc-800" alt="Camera" />
        </div>
        {% endif %}
      </div>
      
      <!-- AD5X -->
      <div id="card-ad5x" class="bg-zinc-900/40 border {% if printer_status.AD5X.is_offline and printer_status.AD5X.is_cached %}border-amber-700/50{% elif printer_status.AD5X.get('is_moonraker') %}border-indigo-800/50{% else %}border-zinc-800{% endif %} rounded-xl p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <span class="font-medium text-sm">AD5X</span>
            {% if printer_status.AD5X.get('is_moonraker') %}
              <span class="px-1.5 py-0.5 rounded text-[10px] bg-indigo-600/20 text-indigo-300 border border-indigo-600/30">üåô Moonraker</span>
            {% endif %}
          </div>
          {% if printer_status.AD5X.is_offline %}
            <span class="status-badge px-2 py-0.5 rounded text-xs bg-zinc-700/50 text-zinc-400">Offline</span>
          {% elif printer_status.AD5X.get('is_paused') %}
            <span class="status-badge px-2 py-0.5 rounded text-xs bg-amber-500/20 text-amber-300">Paused</span>
          {% elif printer_status.AD5X.status %}
            <span class="status-badge px-2 py-0.5 rounded text-xs
              {% if printer_status.AD5X.is_printing %}bg-emerald-500/20 text-emerald-300
              {% elif printer_status.AD5X.status == 'READY' %}bg-green-500/20 text-green-300
              {% else %}bg-amber-500/20 text-amber-300{% endif %}">
              {{ printer_status.AD5X.status }}
            </span>
          {% else %}
            <span class="status-badge px-2 py-0.5 rounded text-xs bg-zinc-700/50 text-zinc-400">Unknown</span>
          {% endif %}
        </div>
        
        <!-- Thumbnail (Moonraker) -->
        {% if printer_status.AD5X.get('thumbnail_url') and printer_status.AD5X.is_printing %}
        <div class="mb-2">
          <img src="{{ printer_status.AD5X.thumbnail_url }}" class="w-16 h-16 rounded-lg bg-zinc-800 object-contain" alt="Print thumbnail" />
        </div>
        {% endif %}
        
        <!-- Printing progress -->
        <div class="print-info {% if not printer_status.AD5X.is_printing and not printer_status.AD5X.get('is_paused') %}hidden{% endif %}">
          <div class="flex items-center justify-between text-xs mb-1.5">
            <span class="file-name text-zinc-300 truncate">{{ printer_status.AD5X.current_file or 'Unknown' }}</span>
            <span class="progress-text text-emerald-300 font-medium">{{ printer_status.AD5X.progress or 0 }}%</span>
          </div>
          <div class="h-1.5 bg-zinc-800 rounded-full overflow-hidden">
            <div class="progress-bar h-full {% if printer_status.AD5X.get('is_paused') %}bg-amber-500{% else %}bg-emerald-500{% endif %} transition-all duration-500" 
                 style="width: {{ printer_status.AD5X.progress or 0 }}%"></div>
          </div>
          
          <!-- Moonraker: enriched info row -->
          {% if printer_status.AD5X.get('is_moonraker') %}
          <div class="moonraker-info flex flex-wrap gap-x-3 gap-y-1 mt-1.5 text-[11px] text-zinc-400">
            {% if printer_status.AD5X.get('moonraker_time_remaining') is not none %}
              {% set rem = printer_status.AD5X.moonraker_time_remaining %}
              {% set h = rem // 3600 %}
              {% set m = (rem % 3600) // 60 %}
              <span class="time-remaining">‚è± {% if h > 0 %}{{ h }}h {% endif %}{{ m }}m left</span>
            {% endif %}
            {% if printer_status.AD5X.current_layer is not none and printer_status.AD5X.total_layers %}
              <span class="layer-text">üß± {{ printer_status.AD5X.current_layer }}/{{ printer_status.AD5X.total_layers }}</span>
            {% endif %}
            {% if printer_status.AD5X.get('filament_used_m') %}
              <span>üßµ {{ printer_status.AD5X.filament_used_m }}m used</span>
            {% endif %}
          </div>
          {% endif %}
          
          <!-- Control buttons -->
          <div class="flex gap-1.5 mt-2">
            {% if printer_status.AD5X.get('is_moonraker') %}
              <!-- Moonraker control buttons -->
              {% if printer_status.AD5X.get('is_paused') %}
                <button type="button" class="px-2 py-1 rounded bg-emerald-700/60 hover:bg-emerald-600 text-white text-xs transition"
                        onclick="moonrakerControl('AD5X', 'resume', 'Resume print on AD5X?')">
                  ‚ñ∂ Resume
                </button>
                <button type="button" class="px-2 py-1 rounded bg-red-800/60 hover:bg-red-700 text-white text-xs transition"
                        onclick="moonrakerCancelConfirm('AD5X')">
                  ‚úï Cancel
                </button>
              {% elif printer_status.AD5X.is_printing %}
                <button type="button" class="px-2 py-1 rounded bg-amber-700/60 hover:bg-amber-600 text-white text-xs transition"
                        onclick="moonrakerControl('AD5X', 'pause', 'Pause print on AD5X?')">
                  ‚è∏ Pause
                </button>
                <button type="button" class="px-2 py-1 rounded bg-red-800/60 hover:bg-red-700 text-white text-xs transition"
                        onclick="moonrakerCancelConfirm('AD5X')">
                  ‚úï Cancel
                </button>
              {% endif %}
            {% else %}
              <!-- FlashForge pause button (existing) -->
              {% set active_build = active_builds_by_printer.get('AD5X') %}
              {% if active_build %}
              <button type="button" class="px-2 py-1 rounded bg-amber-700/60 hover:bg-amber-600 text-white text-xs transition"
                      onclick="pausePrinterBuildConfirm('{{ active_build.id }}', '{{ active_build.build_number }}', 'AD5X')">
                ‚è∏ Pause
              </button>
              {% endif %}
            {% endif %}
          </div>
        </div>
        
        <div class="flex items-center justify-between text-xs text-zinc-500 mt-2 {% if printer_status.AD5X.is_printing or printer_status.AD5X.get('is_paused') %}pt-2 border-t border-zinc-800{% endif %}">
          <span class="temp-text">
            {% if printer_status.AD5X.temp %}üå° {{ printer_status.AD5X.temp }}¬∞C{% endif %}
            {% if printer_status.AD5X.get('bed_temp') %}<span class="bed-temp-text ml-2">üõè {{ printer_status.AD5X.bed_temp }}¬∞C</span>{% endif %}
          </span>
          <div class="flex items-center gap-2">
            {% if printer_status.AD5X.get('is_moonraker') and not printer_status.AD5X.is_printing %}
              <button type="button" onclick="showUploadModal('AD5X')" class="text-indigo-400 hover:text-indigo-300 text-xs">üì§ Upload</button>
            {% endif %}
            {% if printer_status.AD5X.camera_url %}
            <button type="button" onclick="toggleAdminCamera('AD5X')" id="admin-cam-btn-AD5X" 
                    class="text-indigo-400 hover:text-indigo-300 text-xs">
              <span class="btn-text">üì∑ Camera</span>
            </button>
            {% endif %}
          </div>
        </div>
        {% if printer_status.AD5X.camera_url %}
        <div id="admin-cam-AD5X" class="hidden mt-2">
          <img id="admin-cam-img-AD5X" class="w-full rounded-lg bg-zinc-800" alt="Camera" />
        </div>
        {% endif %}
      </div>
      
      <!-- Auto-refresh -->
      <div class="mt-2 flex justify-end gap-3 text-xs text-zinc-500">
        <label class="flex items-center gap-1.5 cursor-pointer">
          <input type="checkbox" id="auto-refresh" checked class="rounded w-3 h-3" />
          Auto-refresh
        </label>
        <button onclick="refreshPrinterStatus()" class="text-indigo-400 hover:text-indigo-300">‚Üª Refresh</button>
      </div>
    </details>

    <script>
      // Camera toggle for admin
      const adminCamIntervals = {};
      
      function toggleAdminCamera(printer) {
        const div = document.getElementById(`admin-cam-${printer}`);
        const btn = document.getElementById(`admin-cam-btn-${printer}`);
        const img = document.getElementById(`admin-cam-img-${printer}`);
        
        console.log('[Admin Camera] toggleAdminCamera called for:', printer, { div: !!div, btn: !!btn, img: !!img });
        
        if (!div || !btn || !img) {
          console.warn('[Admin Camera] Missing elements for', printer);
          return;
        }
        
        const btnText = btn.querySelector('.btn-text');
        
        if (div.classList.contains('hidden')) {
          // Show camera
          div.classList.remove('hidden');
          if (btnText) btnText.textContent = 'Hide Camera';
          
          // Load camera image
          img.alt = 'Loading camera...';
          img.src = `/api/camera/${printer}/snapshot?t=${Date.now()}`;
          console.log('[Admin Camera] Loading:', img.src);
          
          img.onerror = function() {
            console.error('[Admin Camera] Load error for', printer);
            img.alt = 'Camera unavailable';
            if (btnText) btnText.textContent = 'Camera Error';
            clearInterval(adminCamIntervals[printer]);
          };
          img.onload = function() {
            console.log('[Admin Camera] Loaded successfully for', printer);
            img.alt = 'Camera feed';
          };
          
          // Auto-refresh every 10 seconds
          adminCamIntervals[printer] = setInterval(() => {
            const newImg = new Image();
            newImg.onload = function() {
              img.src = this.src;
            };
            newImg.src = `/api/camera/${printer}/snapshot?t=${Date.now()}`;
          }, 10000);
        } else {
          // Hide camera
          div.classList.add('hidden');
          if (btnText) btnText.textContent = 'Show Camera';
          clearInterval(adminCamIntervals[printer]);
          console.log('[Admin Camera] Hidden for', printer);
        }
      }
      
      // AJAX-based printer status refresh
      let refreshInterval = null;
      const autoRefreshCheckbox = document.getElementById('auto-refresh');
      
      async function refreshPrinterStatus() {
        try {
          const resp = await fetch('/api/printers/status');
          if (!resp.ok) return;
          const data = await resp.json();
          
          // Update each printer card
          for (const [code, status] of Object.entries(data)) {
            updatePrinterCard(code, status);
          }
        } catch (e) {
          console.error('Failed to refresh printer status:', e);
        }
      }
      
      function updatePrinterCard(code, status) {
        const cardId = code === 'ADVENTURER_4' ? 'card-adv4' : 'card-ad5x';
        const card = document.getElementById(cardId);
        if (!card) return;
        
        // Update status badge
        const badge = card.querySelector('.status-badge');
        if (badge) {
          const displayStatus = status.is_paused ? 'PAUSED' : (status.status || 'OFFLINE');
          badge.textContent = displayStatus;
          badge.className = 'status-badge inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-medium';
          if (status.is_paused) {
            badge.classList.add('bg-amber-500/20', 'text-amber-300', 'border', 'border-amber-500/50');
          } else if (status.is_printing) {
            badge.classList.add('bg-emerald-500/20', 'text-emerald-300', 'border', 'border-emerald-500/50');
          } else if (status.status === 'READY') {
            badge.classList.add('bg-green-500/20', 'text-green-300', 'border', 'border-green-500/50');
          } else if (status.status === 'OFFLINE' || status.status === 'ERROR') {
            badge.classList.add('bg-zinc-600/20', 'text-zinc-300', 'border', 'border-zinc-600/50');
          } else {
            badge.classList.add('bg-amber-500/20', 'text-amber-300', 'border', 'border-amber-500/50');
          }
        }
        
        // Update print info section
        const printInfo = card.querySelector('.print-info');
        if (printInfo) {
          if (status.is_printing || status.is_paused) {
            printInfo.classList.remove('hidden');
            const fileName = printInfo.querySelector('.file-name');
            const progress = printInfo.querySelector('.progress-text');
            const progressBar = printInfo.querySelector('.progress-bar');
            
            if (fileName) fileName.textContent = status.current_file || 'Unknown file';
            if (progress) progress.textContent = (status.progress ?? '?') + '%';
            if (progressBar && status.progress !== null) {
              progressBar.style.width = status.progress + '%';
              // Paused = amber bar
              if (status.is_paused) {
                progressBar.classList.remove('bg-emerald-500');
                progressBar.classList.add('bg-amber-500');
              } else {
                progressBar.classList.remove('bg-amber-500');
                progressBar.classList.add('bg-emerald-500');
              }
            }
            
            // Moonraker enriched info
            if (status.is_moonraker) {
              const moonInfo = card.querySelector('.moonraker-info');
              if (moonInfo) {
                let infoHtml = '';
                if (status.moonraker_time_remaining != null) {
                  const h = Math.floor(status.moonraker_time_remaining / 3600);
                  const m = Math.floor((status.moonraker_time_remaining % 3600) / 60);
                  infoHtml += `<span class="time-remaining">‚è± ${h > 0 ? h + 'h ' : ''}${m}m left</span>`;
                }
                if (status.current_layer != null && status.total_layers) {
                  infoHtml += `<span class="layer-text">üß± ${status.current_layer}/${status.total_layers}</span>`;
                }
                if (status.filament_used_m) {
                  infoHtml += `<span>üßµ ${status.filament_used_m}m used</span>`;
                }
                moonInfo.innerHTML = infoHtml;
              }
            } else {
              // FlashForge: update layer text
              const layer = printInfo.querySelector('.layer-text');
              if (layer && status.current_layer !== null) {
                layer.textContent = `${status.current_layer}/${status.total_layers}`;
              }
            }
          } else {
            printInfo.classList.add('hidden');
          }
        }
        
        // Update temperature
        const temp = card.querySelector('.temp-text');
        if (temp && status.temp) {
          let tempText = `üå° ${status.temp}¬∞C`;
          if (status.target_temp) tempText += ` / ${status.target_temp}¬∞C`;
          temp.innerHTML = tempText;
        }
        
        // Moonraker: update bed temp
        if (status.is_moonraker) {
          const bedTemp = card.querySelector('.bed-temp-text');
          if (bedTemp && status.bed_temp != null) {
            bedTemp.textContent = `üõè ${status.bed_temp}¬∞C`;
            if (status.bed_target) bedTemp.textContent += ` / ${status.bed_target}¬∞C`;
          }
        }
      }

      // Pause active build from printer card (sends M25)
      function pausePrinterBuildConfirm(buildId, buildNumber, printer) {
        if (!buildId) {
          alert('No active build id found for this printer.');
          return;
        }
        const label = buildNumber ? `build ${buildNumber}` : 'the active build';
        if (!confirm(`Pause ${label} on ${printer}? This will send M25 to the printer.`)) return;
        window.location = `/api/admin/build/${buildId}/pause-open`;
      }
      
      // ‚îÄ‚îÄ Moonraker Controls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      
      async function moonrakerControl(printerCode, action, confirmMsg) {
        if (confirmMsg && !confirm(confirmMsg)) return;
        
        try {
          const formData = new FormData();
          formData.append('confirm', '1');
          
          const resp = await fetch(`/api/admin/printer/${printerCode}/${action}`, {
            method: 'POST',
            body: formData,
          });
          
          const data = await resp.json();
          if (!resp.ok) {
            alert(`Error: ${data.detail || 'Unknown error'}`);
            return;
          }
          
          // Refresh printer status immediately
          refreshPrinterStatus();
        } catch (e) {
          alert(`Failed to ${action}: ${e.message}`);
        }
      }
      
      function moonrakerCancelConfirm(printerCode) {
        // Two-step confirmation for cancel (destructive action)
        const modal = document.getElementById('moonraker-cancel-modal');
        if (modal) {
          document.getElementById('cancel-printer-code').value = printerCode;
          document.getElementById('cancel-printer-name').textContent = printerCode;
          modal.classList.remove('hidden');
        }
      }
      
      function closeCancelModal() {
        const modal = document.getElementById('moonraker-cancel-modal');
        if (modal) modal.classList.add('hidden');
      }
      
      async function executeMoonrakerCancel() {
        const printerCode = document.getElementById('cancel-printer-code').value;
        closeCancelModal();
        
        try {
          const formData = new FormData();
          formData.append('confirm', '1');
          
          const resp = await fetch(`/api/admin/printer/${printerCode}/cancel`, {
            method: 'POST',
            body: formData,
          });
          
          const data = await resp.json();
          if (!resp.ok) {
            alert(`Error: ${data.detail || 'Unknown error'}`);
            return;
          }
          
          refreshPrinterStatus();
        } catch (e) {
          alert(`Failed to cancel: ${e.message}`);
        }
      }
      
      // Upload & Print modal
      function showUploadModal(printerCode) {
        const modal = document.getElementById('moonraker-upload-modal');
        if (modal) {
          document.getElementById('upload-printer-code').value = printerCode;
          document.getElementById('upload-printer-name').textContent = printerCode;
          document.getElementById('upload-file-input').value = '';
          document.getElementById('upload-status').textContent = '';
          document.getElementById('upload-start-btn').classList.add('hidden');
          modal.classList.remove('hidden');
        }
      }
      
      function closeUploadModal() {
        const modal = document.getElementById('moonraker-upload-modal');
        if (modal) modal.classList.add('hidden');
      }
      
      async function uploadToMoonraker() {
        const printerCode = document.getElementById('upload-printer-code').value;
        const fileInput = document.getElementById('upload-file-input');
        const statusEl = document.getElementById('upload-status');
        const startBtn = document.getElementById('upload-start-btn');
        
        if (!fileInput.files.length) {
          statusEl.textContent = 'Please select a file.';
          statusEl.className = 'text-xs text-red-400 mt-2';
          return;
        }
        
        const file = fileInput.files[0];
        statusEl.textContent = `Uploading ${file.name}...`;
        statusEl.className = 'text-xs text-indigo-300 mt-2';
        
        try {
          const formData = new FormData();
          formData.append('file', file);
          
          const resp = await fetch(`/api/admin/printer/${printerCode}/upload`, {
            method: 'POST',
            body: formData,
          });
          
          const data = await resp.json();
          if (!resp.ok) {
            statusEl.textContent = `Upload failed: ${data.detail || 'Unknown error'}`;
            statusEl.className = 'text-xs text-red-400 mt-2';
            return;
          }
          
          statusEl.textContent = `‚úì Uploaded ${file.name}`;
          statusEl.className = 'text-xs text-emerald-400 mt-2';
          
          // Show "Start Print" button
          startBtn.classList.remove('hidden');
          startBtn.onclick = async function() {
            if (!confirm(`Start printing ${file.name} on ${printerCode}?`)) return;
            
            const startForm = new FormData();
            startForm.append('filename', file.name);
            startForm.append('confirm', '1');
            
            const startResp = await fetch(`/api/admin/printer/${printerCode}/start`, {
              method: 'POST',
              body: startForm,
            });
            
            if (startResp.ok) {
              closeUploadModal();
              refreshPrinterStatus();
            } else {
              const err = await startResp.json();
              alert(`Failed to start: ${err.detail || 'Unknown error'}`);
            }
          };
        } catch (e) {
          statusEl.textContent = `Upload failed: ${e.message}`;
          statusEl.className = 'text-xs text-red-400 mt-2';
        }
      }
      
      function startAutoRefresh() {
        if (refreshInterval) clearInterval(refreshInterval);
        refreshInterval = setInterval(refreshPrinterStatus, 15000);
      }
      
      function stopAutoRefresh() {
        if (refreshInterval) {
          clearInterval(refreshInterval);
          refreshInterval = null;
        }
      }
      
      autoRefreshCheckbox.addEventListener('change', (e) => {
        if (e.target.checked) {
          startAutoRefresh();
        } else {
          stopAutoRefresh();
        }
      });
      
      // Start auto-refresh on page load
      startAutoRefresh();
    </script>

    <!-- Moonraker Cancel Confirmation Modal -->
    <div id="moonraker-cancel-modal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
      <div class="bg-zinc-900 border border-red-700/50 rounded-xl p-6 w-full max-w-sm">
        <h3 class="text-lg font-semibold mb-2 text-red-400">‚ö†Ô∏è Cancel Print</h3>
        <p class="text-sm text-zinc-300 mb-1">Are you sure you want to cancel the print on <strong id="cancel-printer-name">AD5X</strong>?</p>
        <p class="text-xs text-red-300/80 mb-4">This will immediately stop the print. The printer will cool down and the part will be incomplete. This action cannot be undone.</p>
        <input type="hidden" id="cancel-printer-code" value="" />
        <div class="flex gap-2">
          <button type="button" onclick="executeMoonrakerCancel()" class="flex-1 rounded-lg bg-red-600 hover:bg-red-500 transition px-4 py-2 text-sm font-semibold">
            Cancel Print
          </button>
          <button type="button" onclick="closeCancelModal()" class="rounded-lg bg-zinc-700 hover:bg-zinc-600 transition px-4 py-2 text-sm">
            Go Back
          </button>
        </div>
      </div>
    </div>

    <!-- Moonraker Upload & Print Modal -->
    <div id="moonraker-upload-modal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
      <div class="bg-zinc-900 border border-indigo-700/50 rounded-xl p-6 w-full max-w-md">
        <h3 class="text-lg font-semibold mb-2 text-indigo-300">üì§ Upload G-code to <span id="upload-printer-name">AD5X</span></h3>
        <p class="text-sm text-zinc-400 mb-4">Upload a .gcode file directly to the printer via Moonraker.</p>
        <input type="hidden" id="upload-printer-code" value="" />
        
        <div class="space-y-3">
          <div>
            <label class="text-xs text-zinc-400 block mb-1">G-code File</label>
            <input type="file" id="upload-file-input" accept=".gcode,.g"
                   class="w-full text-sm text-zinc-300 file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-500 file:cursor-pointer" />
          </div>
          
          <div id="upload-status" class="text-xs mt-2"></div>
          
          <div class="flex gap-2 pt-2">
            <button type="button" onclick="uploadToMoonraker()" class="flex-1 rounded-lg bg-indigo-600 hover:bg-indigo-500 transition px-4 py-2 text-sm font-semibold">
              Upload
            </button>
            <button type="button" id="upload-start-btn" class="hidden flex-1 rounded-lg bg-emerald-600 hover:bg-emerald-500 transition px-4 py-2 text-sm font-semibold">
              ‚ñ∂ Start Print
            </button>
            <button type="button" onclick="closeUploadModal()" class="rounded-lg bg-zinc-700 hover:bg-zinc-600 transition px-4 py-2 text-sm">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- QUEUE VIEW - Card-based with expandable actions -->
    <div class="mt-4 space-y-5">

      <!-- NEW REQUESTS -->
      {% if new_reqs|length > 0 %}
      <section id="new-section" class="bg-gradient-to-b from-indigo-950/40 to-zinc-900/60 border border-indigo-800/40 rounded-2xl overflow-hidden shadow-lg">
        <div class="flex items-center justify-between px-5 py-3 border-b border-indigo-800/30">
          <div class="flex items-center gap-3">
            <div class="w-3 h-3 rounded-full bg-indigo-500 shadow-lg shadow-indigo-500/50"></div>
            <h2 class="text-lg font-semibold">New Requests</h2>
            <span class="text-xs font-medium text-indigo-200 bg-indigo-600/40 px-2 py-0.5 rounded-full">{{ new_reqs|length }}</span>
          </div>
        </div>
        <div class="divide-y divide-indigo-900/30">
          {% for r in new_reqs %}
          <details class="request-item group"
               data-requires-design="{{ 1 if r['requires_design'] else 0 }}"
               data-designer="{{ r['designer_admin_id'] or '' }}"
               data-design-complete="{{ 1 if r['design_completed_at'] else 0 }}">
            <summary class="flex items-center gap-4 px-5 py-3.5 hover:bg-indigo-900/20 cursor-pointer list-none transition">
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 flex-wrap">
                  <a href="/admin/request/{{ r['id'] }}" class="text-base font-bold text-white hover:text-indigo-300 truncate">{{ r["print_name"] or 'Untitled' }}</a>
                  {% if r["unread_replies"] and r["unread_replies"] > 0 %}
                    <span class="w-2.5 h-2.5 bg-red-500 rounded-full animate-pulse shadow-lg shadow-red-500/50"></span>
                  {% endif %}
                  {% if r["requires_design"] %}
                    <span class="text-[10px] px-1.5 py-0.5 rounded bg-teal-800/50 text-teal-300 border border-teal-700/50">
                      {% if r["design_completed_at"] %}‚úì Design{% else %}Design{% endif %}
                    </span>
                  {% endif %}
                  {% if r["status"] == "NEEDS_INFO" %}
                    <span class="text-[10px] px-1.5 py-0.5 rounded bg-orange-800/50 text-orange-300 border border-orange-700/50">Needs Info</span>
                  {% endif %}
                </div>
                <div class="flex items-center gap-2 text-sm text-zinc-400 mt-1">
                  <span class="text-indigo-300 font-medium">{{ r["requester_name"] }}</span>
                  <span class="text-zinc-600">‚Ä¢</span>
                  <span>{{ r["printer"] or "Any" }}</span>
                  <span class="text-zinc-600">‚Ä¢</span>
                  <span>{{ r["material"] or "Any" }}</span>
                  {% if r["colors"] %}<span class="text-zinc-600">‚Ä¢</span><span>{{ r["colors"] }}</span>{% endif %}
                  {% if r["file_count"] and r["file_count"] > 0 %}
                    <span class="text-zinc-600">‚Ä¢</span>
                    <span class="text-indigo-400">{{ r["file_count"] }} file{% if r["file_count"] > 1 %}s{% endif %}</span>
                  {% endif %}
                  {% if r["link_url"] %}
                    <span class="text-zinc-600">‚Ä¢</span>
                    <a href="{{ r['link_url'] }}" target="_blank" class="text-indigo-400 hover:underline">Link</a>
                  {% endif %}
                </div>
              </div>
              <div class="flex items-center gap-2 shrink-0">
                <span class="text-xs px-1.5 py-0.5 rounded {% if r['priority'] == 1 %}bg-red-900/50 text-red-300{% elif r['priority'] == 2 %}bg-orange-900/50 text-orange-300{% else %}bg-zinc-800 text-zinc-400{% endif %}">P{{ r["priority"] or 3 }}</span>
                <svg class="w-4 h-4 text-zinc-500 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </div>
            </summary>
            <div class="px-5 py-3 bg-zinc-950/50 border-t border-indigo-900/30">
              <div class="flex flex-wrap gap-2">
                <form method="POST" action="/admin/request/{{ r['id'] }}/status" class="flex gap-1.5 flex-1 min-w-[200px]">
                  <input type="hidden" name="to_status" value="APPROVED" />
                  <input name="comment" placeholder="Note (optional)" class="flex-1 rounded-lg bg-zinc-900 border border-zinc-700 px-3 py-1.5 text-sm focus:border-indigo-500 focus:outline-none" />
                  <button class="px-4 py-1.5 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-sm font-medium transition shadow-lg shadow-indigo-900/30">‚úì Approve</button>
                </form>
                <form method="POST" action="/admin/request/{{ r['id'] }}/status" class="flex gap-1.5">
                  <input type="hidden" name="to_status" value="NEEDS_INFO" />
                  <input name="comment" placeholder="What's needed?" class="w-28 rounded-lg bg-zinc-900 border border-orange-800/50 px-2 py-1.5 text-sm focus:border-orange-500 focus:outline-none" />
                  <button class="px-3 py-1.5 rounded-lg bg-orange-900/40 border border-orange-700/50 hover:bg-orange-900/60 text-sm text-orange-200 transition">? Info</button>
                </form>
                <form method="POST" action="/admin/request/{{ r['id'] }}/status">
                  <input type="hidden" name="to_status" value="REJECTED" />
                  <input type="hidden" name="comment" value="Rejected" />
                  <button class="px-3 py-1.5 rounded-lg bg-zinc-800 hover:bg-zinc-700 text-sm text-zinc-300 transition">‚úï Reject</button>
                </form>
                <a href="/admin/request/{{ r['id'] }}" class="px-3 py-1.5 rounded-lg bg-zinc-800/50 hover:bg-zinc-700 text-sm text-zinc-400 transition">Details ‚Üí</a>
              </div>
            </div>
          </details>
          {% endfor %}
        </div>
      </section>
      {% endif %}

      <!-- PRINTING NOW -->
      {% if printing|length > 0 %}
      <section id="printing-section" class="bg-gradient-to-b from-emerald-950/40 to-zinc-900/60 border border-emerald-700/40 rounded-2xl overflow-hidden shadow-lg">
        <div class="flex items-center justify-between px-5 py-3 border-b border-emerald-800/30">
          <div class="flex items-center gap-3">
            <div class="w-3 h-3 rounded-full bg-emerald-500 animate-pulse shadow-lg shadow-emerald-500/50"></div>
            <h2 class="text-lg font-semibold">Printing Now</h2>
            <span class="text-xs font-medium text-emerald-200 bg-emerald-600/40 px-2 py-0.5 rounded-full">{{ printing|length }}</span>
          </div>
        </div>
        <div class="divide-y divide-emerald-900/30">
          {% for r in printing %}
          <div class="request-item flex items-center gap-4 px-5 py-4 hover:bg-emerald-900/20 transition"
               data-requires-design="{{ 1 if r['requires_design'] else 0 }}"
               data-designer="{{ r['designer_admin_id'] or '' }}"
               data-design-complete="{{ 1 if r['design_completed_at'] else 0 }}">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 flex-wrap">
                <a href="/admin/request/{{ r['id'] }}" class="text-base font-bold text-white hover:text-emerald-300 truncate">{{ r["print_name"] or 'Untitled' }}</a>
                {% if r.total_builds and r.total_builds > 1 %}
                  <span class="text-xs px-1.5 py-0.5 rounded bg-amber-800/50 text-amber-300 border border-amber-700/50">
                    {{ r.completed_builds or 0 }}/{{ r.total_builds }} builds
                  </span>
                {% endif %}
              </div>
              <div class="flex items-center gap-2 text-sm text-zinc-400 mt-1">
                <span class="text-emerald-300 font-semibold">{{ r.get("active_printer") or r["printer"] }}</span>
                <span class="text-zinc-600">‚Ä¢</span>
                <span>{{ r["material"] }}</span>
                {% if r["colors"] %}<span class="text-zinc-600">‚Ä¢</span><span>{{ r["colors"] }}</span>{% endif %}
              </div>
              {% if r.get("printer_progress") is not none %}
              <div class="flex items-center gap-2 mt-2">
                <div class="flex-1 max-w-[200px] bg-zinc-800 rounded-full h-2 overflow-hidden">
                  <div class="bg-gradient-to-r from-emerald-600 to-emerald-400 h-2 rounded-full transition-all" style="width: {{ r.printer_progress }}%"></div>
                </div>
                <span class="text-xs font-bold text-emerald-400">{{ r.printer_progress }}%</span>
                {% if r.get("smart_eta_display") %}
                  <span class="text-xs text-zinc-500">ETA {{ r.smart_eta_display }}</span>
                {% endif %}
              </div>
              {% endif %}
            </div>
            <div class="flex items-center gap-2 shrink-0">
              <button onclick="quickStatusChange('{{ r['id'] }}', 'DONE', 'Print completed', this)" 
                      class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-sm font-medium transition shadow-lg shadow-emerald-900/30">
                ‚úì Done
              </button>
            </div>
          </div>
          {% endfor %}
        </div>
      </section>
      {% endif %}

      <!-- QUEUED (Waiting to Print) -->
      {% if queued|length > 0 %}
      <section id="approved-section" class="bg-gradient-to-b from-green-950/30 to-zinc-900/60 border border-green-800/30 rounded-2xl overflow-hidden shadow-lg">
        <div class="flex items-center justify-between px-5 py-3 border-b border-green-800/30">
          <div class="flex items-center gap-3">
            <div class="w-3 h-3 rounded-full bg-green-500 shadow-lg shadow-green-500/50"></div>
            <h2 class="text-lg font-semibold">Queued</h2>
            <span class="text-xs font-medium text-green-200 bg-green-600/40 px-2 py-0.5 rounded-full">{{ queued|length }}</span>
          </div>
        </div>
        <div class="divide-y divide-green-900/30">
          {% for r in queued %}
          <details class="request-item group"
               data-requires-design="{{ 1 if r['requires_design'] else 0 }}"
               data-designer="{{ r['designer_admin_id'] or '' }}"
               data-design-complete="{{ 1 if r['design_completed_at'] else 0 }}">
            <summary class="flex items-center gap-4 px-5 py-3.5 hover:bg-green-900/20 cursor-pointer list-none transition">
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 flex-wrap">
                  <a href="/admin/request/{{ r['id'] }}" class="text-base font-bold text-white hover:text-green-300 truncate">{{ r["print_name"] or 'Untitled' }}</a>
                  {% if r.total_builds and r.total_builds > 1 %}
                    <span class="text-xs px-1.5 py-0.5 rounded bg-blue-800/50 text-blue-300 border border-blue-700/50">{{ r.total_builds }} builds</span>
                  {% endif %}
                  {% if r["requires_design"] %}
                    <span class="text-[10px] px-1.5 py-0.5 rounded bg-teal-800/50 text-teal-300 border border-teal-700/50">
                      {% if r["design_completed_at"] %}‚úì Design{% else %}Design{% endif %}
                    </span>
                  {% endif %}
                </div>
                <div class="flex items-center gap-2 text-sm text-zinc-400 mt-1">
                  <span class="text-green-300 font-medium">{{ r["requester_name"] }}</span>
                  <span class="text-zinc-600">‚Ä¢</span>
                  <span>{{ r["printer"] or "Any" }}</span>
                  <span class="text-zinc-600">‚Ä¢</span>
                  <span>{{ r["material"] or "Any" }}</span>
                  {% if r["colors"] %}<span class="text-zinc-600">‚Ä¢</span><span>{{ r["colors"] }}</span>{% endif %}
                  {% if r["file_count"] and r["file_count"] > 0 %}
                    <span class="text-zinc-600">‚Ä¢</span>
                    <span class="text-green-400">{{ r["file_count"] }} file{% if r["file_count"] > 1 %}s{% endif %}</span>
                  {% endif %}
                </div>
              </div>
              <div class="flex items-center gap-2 shrink-0">
                <button type="button" onclick="event.stopPropagation(); showPrintStartModal('{{ r['id'] }}', '{{ r['printer'] }}', '{{ r['material'] }}', '{{ r['colors'] }}', 'PRINTING')"
                        class="px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-sm font-medium transition shadow-lg shadow-emerald-900/30">üñ® Start</button>
                <span class="text-xs px-1.5 py-0.5 rounded {% if r['priority'] == 1 %}bg-red-900/50 text-red-300{% elif r['priority'] == 2 %}bg-orange-900/50 text-orange-300{% else %}bg-zinc-800 text-zinc-400{% endif %}">P{{ r["priority"] or 3 }}</span>
                <svg class="w-4 h-4 text-zinc-500 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </div>
            </summary>
            <div class="px-5 py-3 bg-zinc-950/50 border-t border-green-900/30">
              <div class="flex flex-wrap gap-3 items-center">
                <form method="POST" action="/admin/request/{{ r['id'] }}/priority" class="flex items-center gap-2">
                  <label class="text-xs text-zinc-500">Priority:</label>
                  <select name="priority" class="rounded-lg bg-zinc-900 border border-zinc-700 px-2 py-1 text-sm">
                    {% for p in [1,2,3,4,5] %}
                      <option value="{{ p }}" {% if (r["priority"] or 3) == p %}selected{% endif %}>P{{ p }}{% if p == 1 %} (Urgent){% elif p == 5 %} (Low){% endif %}</option>
                    {% endfor %}
                  </select>
                  <button class="px-2 py-1 rounded-lg bg-zinc-800 hover:bg-zinc-700 text-xs">Set</button>
                </form>
                <a href="/admin/request/{{ r['id'] }}" class="text-sm text-zinc-400 hover:text-white">View details ‚Üí</a>
              </div>
            </div>
          </details>
          {% endfor %}
        </div>
      </section>
      {% endif %}

      <!-- BLOCKED -->
      {% if blocked|length > 0 %}
      <section id="blocked-section" class="bg-gradient-to-b from-red-950/40 to-zinc-900/60 border border-red-700/40 rounded-2xl overflow-hidden shadow-lg">
        <div class="flex items-center justify-between px-5 py-3 border-b border-red-800/30">
          <div class="flex items-center gap-3">
            <div class="w-3 h-3 rounded-full bg-red-500 shadow-lg shadow-red-500/50"></div>
            <h2 class="text-lg font-semibold">‚ö†Ô∏è Blocked</h2>
            <span class="text-xs font-medium text-red-200 bg-red-600/40 px-2 py-0.5 rounded-full">{{ blocked|length }}</span>
          </div>
        </div>
        <div class="divide-y divide-red-900/30">
          {% for r in blocked %}
          <div class="request-item flex items-center gap-4 px-5 py-4 hover:bg-red-900/20 transition"
               data-requires-design="{{ 1 if r['requires_design'] else 0 }}"
               data-designer="{{ r['designer_admin_id'] or '' }}"
               data-design-complete="{{ 1 if r['design_completed_at'] else 0 }}">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 flex-wrap">
                <a href="/admin/request/{{ r['id'] }}" class="text-base font-bold text-white hover:text-red-300 truncate">{{ r["print_name"] or 'Untitled' }}</a>
                {% if r["failed_builds"] %}
                  <span class="text-xs px-1.5 py-0.5 rounded bg-red-800/50 text-red-300 border border-red-700/50">{{ r["failed_builds"] }} failed</span>
                {% endif %}
              </div>
              <div class="flex items-center gap-2 text-sm text-zinc-400 mt-1">
                <span class="text-red-300 font-medium">{{ r["requester_name"] }}</span>
                <span class="text-zinc-600">‚Ä¢</span>
                <span>{{ r["printer"] or "Any" }}</span>
                <span class="text-zinc-600">‚Ä¢</span>
                <span>{{ r["material"] or "Any" }}</span>
              </div>
            </div>
            <div class="flex items-center gap-2 shrink-0">
              <a href="/admin/request/{{ r['id'] }}" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-500 text-sm font-medium transition shadow-lg shadow-red-900/30">
                üîß Review & Fix
              </a>
            </div>
          </div>
          {% endfor %}
        </div>
      </section>
      {% endif %}

      <!-- READY FOR PICKUP -->
      {% if done|length > 0 %}
      <section id="done-section" class="bg-gradient-to-b from-cyan-950/30 to-zinc-900/60 border border-cyan-800/30 rounded-2xl overflow-hidden shadow-lg">
        <div class="flex items-center justify-between px-5 py-3 border-b border-cyan-800/30">
          <div class="flex items-center gap-3">
            <div class="w-3 h-3 rounded-full bg-cyan-500 shadow-lg shadow-cyan-500/50"></div>
            <h2 class="text-lg font-semibold">Ready for Pickup</h2>
            <span class="text-xs font-medium text-cyan-200 bg-cyan-600/40 px-2 py-0.5 rounded-full">{{ done|length }}</span>
          </div>
        </div>
        <div class="divide-y divide-cyan-900/30">
          {% for r in done %}
          <div class="request-item flex items-center gap-4 px-5 py-4 hover:bg-cyan-900/20 transition"
               data-requires-design="{{ 1 if r['requires_design'] else 0 }}"
               data-designer="{{ r['designer_admin_id'] or '' }}"
               data-design-complete="{{ 1 if r['design_completed_at'] else 0 }}">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 flex-wrap">
                <a href="/admin/request/{{ r['id'] }}" class="text-base font-bold text-white hover:text-cyan-300 truncate">{{ r["print_name"] or 'Untitled' }}</a>
              </div>
              <div class="flex items-center gap-2 text-sm text-zinc-400 mt-1">
                <span class="text-cyan-300 font-medium">{{ r["requester_name"] }}</span>
                <span class="text-zinc-600">‚Ä¢</span>
                <span>{{ r["printer"] }}</span>
                <span class="text-zinc-600">‚Ä¢</span>
                <span>{{ r["material"] }}</span>
                {% if r["colors"] %}<span class="text-zinc-600">‚Ä¢</span><span>{{ r["colors"] }}</span>{% endif %}
              </div>
            </div>
            <div class="flex items-center gap-2 shrink-0">
              <button onclick="quickStatusChange('{{ r['id'] }}', 'PICKED_UP', 'Picked up', this)" 
                      class="px-4 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-500 text-sm font-medium transition shadow-lg shadow-cyan-900/30">
                ‚úì Picked Up
              </button>
            </div>
          </div>
          {% endfor %}
        </div>
      </section>
      {% endif %}

      <!-- EMPTY STATE -->
      {% if new_reqs|length == 0 and printing|length == 0 and queued|length == 0 and done|length == 0 %}
      <div class="text-center py-16">
        <div class="text-6xl mb-4">üéâ</div>
        <p class="text-xl font-semibold text-zinc-300">Queue is empty</p>
        <p class="text-zinc-500 mt-1">No active print requests right now</p>
      </div>
      {% endif %}

    </div>

    <!-- Recently Closed - Collapsible -->
    <details class="mt-8 bg-zinc-900/40 border border-zinc-800 rounded-2xl group">
      <summary class="p-6 cursor-pointer hover:bg-zinc-900/60 rounded-2xl transition list-none">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <h2 class="text-lg font-semibold">üì¶ Recently Closed</h2>
            {% if closed|length > 0 %}
              <span class="px-2 py-1 rounded-lg bg-zinc-700/50 text-zinc-300 text-xs">{{ closed|length }}</span>
            {% endif %}
          </div>
          <div class="flex items-center gap-3">
            <span class="text-xs text-zinc-500">Picked up / rejected / cancelled</span>
            <svg class="w-5 h-5 text-zinc-400 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </div>
        </div>
      </summary>

      <div class="px-6 pb-6">
        {% if closed|length == 0 %}
          <div class="text-sm text-zinc-400">No closed items yet.</div>
        {% else %}
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3" id="closed-list">
            {% for r in closed[:4] %}
              <a href="/admin/request/{{ r['id'] }}" 
                 class="request-item bg-zinc-950/60 border border-zinc-800 rounded-xl p-3 hover:bg-zinc-900/60 hover:border-zinc-700 transition group/card"
                 data-requires-design="{{ 1 if r['requires_design'] else 0 }}"
                 data-designer="{{ r['designer_admin_id'] or '' }}"
                 data-design-complete="{{ 1 if r['design_completed_at'] else 0 }}">
                <div class="flex items-start justify-between gap-2">
                  <div class="min-w-0 flex-1">
                    <div class="font-medium text-sm truncate group-hover/card:text-indigo-300">
                      {{ r["print_name"] or ("Request " + r["id"][:8]) }}
                    </div>
                    <div class="text-xs text-zinc-500 mt-1 font-mono">{{ r["id"][:8] }}</div>
                    {% if r.requires_design %}
                      <div class="text-[11px] text-teal-200 mt-1">
                        Design {% if r.design_completed_at %}Ready{% else %}Needed{% endif %}{% if r.designer_admin_id and designer_lookup.get(r.designer_admin_id) %} ‚Ä¢ {{ designer_lookup.get(r.designer_admin_id) }}{% endif %}
                      </div>
                    {% endif %}
                  </div>
                  {{ badge(r["status"]) }}
                </div>
                <div class="mt-2 text-xs text-zinc-500 truncate">
                  {{ r["printer"] or "ANY" }} ‚Ä¢ {{ r["material"] or "ANY" }} {% if r["colors"] %}‚Ä¢ {{ r["colors"] }}{% endif %}
                </div>
              </a>
            {% endfor %}
            {% for r in closed[4:] %}
              <a href="/admin/request/{{ r['id'] }}" 
                 class="request-item hidden bg-zinc-950/60 border border-zinc-800 rounded-xl p-3 hover:bg-zinc-900/60 hover:border-zinc-700 transition group/card"
                 data-requires-design="{{ 1 if r['requires_design'] else 0 }}"
                 data-designer="{{ r['designer_admin_id'] or '' }}"
                 data-design-complete="{{ 1 if r['design_completed_at'] else 0 }}">
                <div class="flex items-start justify-between gap-2">
                  <div class="min-w-0 flex-1">
                    <div class="font-medium text-sm truncate group-hover/card:text-indigo-300">
                      {{ r["print_name"] or ("Request " + r["id"][:8]) }}
                    </div>
                    <div class="text-xs text-zinc-500 mt-1 font-mono">{{ r["id"][:8] }}</div>
                    {% if r.requires_design %}
                      <div class="text-[11px] text-teal-200 mt-1">
                        Design {% if r.design_completed_at %}Ready{% else %}Needed{% endif %}{% if r.designer_admin_id and designer_lookup.get(r.designer_admin_id) %} ‚Ä¢ {{ designer_lookup.get(r.designer_admin_id) }}{% endif %}
                      </div>
                    {% endif %}
                  </div>
                  {{ badge(r["status"]) }}
                </div>
                <div class="mt-2 text-xs text-zinc-500 truncate">
                  {{ r["printer"] or "ANY" }} ‚Ä¢ {{ r["material"] or "ANY" }}
                </div>
              </a>
            {% endfor %}
          </div>
          {% if closed|length > 4 %}
          <button onclick="toggleShowMore('closed-list', this)" class="mt-4 w-full text-center text-xs text-indigo-400 hover:text-indigo-300 py-2 rounded-lg hover:bg-zinc-800/50 transition">
            Show {{ closed|length - 4 }} more ‚ñº
          </button>
          {% endif %}
        {% endif %}
      </div>
    </details>

    <!-- Show More Toggle Script -->
    <script>
      function toggleShowMore(listId, btn) {
        const list = document.getElementById(listId);
        const hiddenItems = list.querySelectorAll('.request-item.hidden');
        const visibleItems = list.querySelectorAll('.request-item:not(.hidden)');
        
        if (hiddenItems.length > 0) {
          // Show all
          hiddenItems.forEach(item => item.classList.remove('hidden'));
          btn.textContent = 'Show less ‚ñ≤';
        } else {
          // Hide extras - 3 for lists, 4 for grid
          const keepCount = listId === 'closed-list' ? 4 : 3;
          const items = list.querySelectorAll('.request-item');
          items.forEach((item, i) => {
            if (i >= keepCount) item.classList.add('hidden');
          });
          btn.textContent = btn.textContent.replace('Show less ‚ñ≤', `Show ${items.length - keepCount} more ‚ñº`);
        }
      }
    </script>

    <!-- Footer with version -->
    <div class="mt-8 pt-4 border-t border-zinc-800 text-center text-xs text-zinc-500">
      <a href="/changelog" class="hover:text-indigo-400 transition">Printellect v{{ version }}</a>
    </div>

  </div>
  
  <!-- Files Preview Modal -->
  <div id="files-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
    <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-6 max-w-md w-full max-h-[80vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold">üìÅ Attached Files</h2>
        <button onclick="hideFilesModal()" class="text-zinc-400 hover:text-white text-xl">&times;</button>
      </div>
      <div id="files-list" class="space-y-2">
        <!-- Files will be populated here -->
      </div>
      <div class="mt-4 pt-4 border-t border-zinc-800">
        <a id="files-request-link" href="#" class="block w-full text-center rounded-xl bg-indigo-600 hover:bg-indigo-500 transition px-4 py-2 text-sm font-semibold">
          Open Request Details
        </a>
      </div>
    </div>
  </div>
  
  <script>
    function showFilesModal(requestId, fileNamesStr) {
      const filesList = document.getElementById('files-list');
      const requestLink = document.getElementById('files-request-link');
      requestLink.href = '/admin/request/' + requestId;
      
      // Parse file names (comma-separated)
      const fileNames = fileNamesStr ? fileNamesStr.split(',').map(f => f.trim()).filter(f => f) : [];
      
      if (fileNames.length === 0) {
        filesList.innerHTML = '<p class="text-zinc-400 text-sm">No files attached</p>';
      } else {
        filesList.innerHTML = fileNames.map((name, i) => `
          <div class="flex items-center gap-3 bg-zinc-950 border border-zinc-800 rounded-lg p-3">
            <span class="text-emerald-400">üìÑ</span>
            <span class="text-sm truncate flex-1">${escapeHtml(name)}</span>
          </div>
        `).join('');
      }
      
      document.getElementById('files-modal').classList.remove('hidden');
    }
    
    function hideFilesModal() {
      document.getElementById('files-modal').classList.add('hidden');
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Close modal when clicking outside
    document.getElementById('files-modal').addEventListener('click', (e) => {
      if (e.target.id === 'files-modal') hideFilesModal();
    });
  </script>
</body>
</html>
