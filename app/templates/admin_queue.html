<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard | Printellect</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-zinc-950 text-zinc-100">
  <div class="max-w-7xl mx-auto p-6">
    <!-- Navigation -->
    {% set active_page = 'queue' %}
    {% include 'admin_nav.html' %}
    
    <!-- Page Header -->
    <div class="mb-6">
      <h1 class="text-3xl font-bold">üìã Queue Dashboard</h1>
      <p class="text-zinc-400 mt-1">Manage your print queue efficiently.</p>
    </div>

    <!-- Batch Edit Form (initially hidden) -->
    <div id="batch-edit-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-6 max-w-sm w-full">
        <h2 class="text-xl font-bold mb-4">Batch Edit Selected</h2>
        <form method="POST" action="/admin/batch-update" class="space-y-4">
          <input type="hidden" id="batch-ids" name="request_ids" />
          
          <div>
            <label class="text-sm text-zinc-400">Change Priority (optional)</label>
            <select name="priority" class="w-full mt-2 rounded-xl bg-zinc-950 border border-zinc-800 p-3">
              <option value="">‚Äî Keep current ‚Äî</option>
              {% for p in [1,2,3,4,5] %}
                <option value="{{ p }}">Priority {{ p }}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label class="text-sm text-zinc-400">Change Status (optional)</label>
            <select name="status" class="w-full mt-2 rounded-xl bg-zinc-950 border border-zinc-800 p-3">
              <option value="">‚Äî Keep current ‚Äî</option>
              {% for s in ["APPROVED", "PRINTING", "DONE", "REJECTED", "CANCELLED"] %}
                <option value="{{ s }}">{{ s }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="flex gap-3 pt-4">
            <button type="button" onclick="hideBatchEditModal()" class="flex-1 rounded-xl bg-zinc-800 hover:bg-zinc-700 transition px-4 py-2 text-sm">
              Cancel
            </button>
            <button type="submit" class="flex-1 rounded-xl bg-indigo-600 hover:bg-indigo-500 transition px-4 py-2 text-sm font-semibold">
              Update <span id="batch-count">0</span> requests
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Print Start Modal (Printer/Material Selection) -->
    <div id="print-start-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-6 max-w-sm w-full">
        <h2 class="text-xl font-bold mb-2" id="print-modal-title">Start Print</h2>
        <p class="text-sm text-zinc-400 mb-4" id="print-modal-subtitle">Select printer and material for this print</p>
        
        <form id="print-start-form" method="POST" action="" class="space-y-4">
          <input type="hidden" name="to_status" id="print-modal-status" value="PRINTING" />
          <input type="hidden" name="comment" id="print-modal-comment" value="Started print" />
          
          <div>
            <label class="text-sm text-zinc-300">Printer <span class="text-red-400">*</span></label>
            <select name="printer" id="print-modal-printer" required class="w-full mt-2 rounded-xl bg-zinc-950 border border-zinc-800 p-3">
              <option value="">‚Äî Select printer ‚Äî</option>
              {% for code, label in printers %}
                {% if code != 'ANY' %}
                  <option value="{{ code }}">{{ label }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>

          <div>
            <label class="text-sm text-zinc-300">Material <span class="text-red-400">*</span></label>
            <select name="material" id="print-modal-material" required class="w-full mt-2 rounded-xl bg-zinc-950 border border-zinc-800 p-3">
              <option value="">‚Äî Select material ‚Äî</option>
              {% for code, label in materials %}
                {% if code != 'ANY' %}
                  <option value="{{ code }}">{{ label }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
          
          <div>
            <label class="text-sm text-zinc-300">Colors</label>
            <input type="text" name="colors" id="print-modal-colors" placeholder="e.g. Black, White" 
                   class="w-full mt-2 rounded-xl bg-zinc-950 border border-zinc-800 p-3 text-sm" />
          </div>

          <div class="flex gap-3 pt-4">
            <button type="button" onclick="hidePrintStartModal()" class="flex-1 rounded-xl bg-zinc-800 hover:bg-zinc-700 transition px-4 py-2 text-sm">
              Cancel
            </button>
            <button type="submit" id="print-modal-submit" class="flex-1 rounded-xl bg-emerald-600 hover:bg-emerald-500 transition px-4 py-2 text-sm font-semibold">
              üñ® Start Print
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Print Start Modal Functions
      function showPrintStartModal(requestId, currentPrinter, currentMaterial, currentColors, targetStatus) {
        targetStatus = targetStatus || 'PRINTING';
        
        const modal = document.getElementById('print-start-modal');
        const form = document.getElementById('print-start-form');
        const printerSelect = document.getElementById('print-modal-printer');
        const materialSelect = document.getElementById('print-modal-material');
        const colorsInput = document.getElementById('print-modal-colors');
        const statusInput = document.getElementById('print-modal-status');
        const commentInput = document.getElementById('print-modal-comment');
        const titleEl = document.getElementById('print-modal-title');
        const subtitleEl = document.getElementById('print-modal-subtitle');
        const submitBtn = document.getElementById('print-modal-submit');
        
        // Set form action
        form.action = `/admin/request/${requestId}/status`;
        
        // Pre-fill current values if not ANY
        if (currentPrinter && currentPrinter !== 'ANY') {
          printerSelect.value = currentPrinter;
        } else {
          printerSelect.value = '';
        }
        
        if (currentMaterial && currentMaterial !== 'ANY') {
          materialSelect.value = currentMaterial;
        } else {
          materialSelect.value = '';
        }
        
        colorsInput.value = currentColors || '';
        statusInput.value = targetStatus;
        
        // Customize modal based on target status
        if (targetStatus === 'PRINTING') {
          titleEl.textContent = 'üñ® Start Print';
          subtitleEl.textContent = 'Select the printer and material for this print job';
          commentInput.value = 'Started print';
          submitBtn.textContent = 'üñ® Start Print';
          submitBtn.className = 'flex-1 rounded-xl bg-emerald-600 hover:bg-emerald-500 transition px-4 py-2 text-sm font-semibold';
        } else if (targetStatus === 'APPROVED') {
          titleEl.textContent = '‚úì Approve Request';
          subtitleEl.textContent = 'Optionally update printer/material before approving';
          commentInput.value = '';
          submitBtn.textContent = '‚úì Approve';
          submitBtn.className = 'flex-1 rounded-xl bg-indigo-600 hover:bg-indigo-500 transition px-4 py-2 text-sm font-semibold';
          // Make fields not required for approval
          printerSelect.required = false;
          materialSelect.required = false;
        }
        
        modal.classList.remove('hidden');
      }
      
      function hidePrintStartModal() {
        document.getElementById('print-start-modal').classList.add('hidden');
        // Reset required fields
        document.getElementById('print-modal-printer').required = true;
        document.getElementById('print-modal-material').required = true;
      }
      
      // Close modal when clicking outside
      document.getElementById('print-start-modal').addEventListener('click', (e) => {
        if (e.target.id === 'print-start-modal') hidePrintStartModal();
      });
    </script>

    <script>
      let selectedIds = new Set();

      function toggleSelectAll(sectionId) {
        const checkboxes = document.querySelectorAll(`#${sectionId} input[type="checkbox"][data-request-id]`);
        const allChecked = Array.from(checkboxes).every(c => c.checked);
        checkboxes.forEach(c => {
          c.checked = !allChecked;
          toggleRequestId(c.value);
        });
        updateBatchUI(sectionId);
      }

      function toggleRequestId(id) {
        if (selectedIds.has(id)) {
          selectedIds.delete(id);
        } else {
          selectedIds.add(id);
        }
      }

      function updateBatchUI(sectionId) {
        const checkboxes = document.querySelectorAll(`#${sectionId} input[type="checkbox"][data-request-id]`);
        const allChecked = Array.from(checkboxes).every(c => c.checked);
        const selectAll = document.querySelector(`#${sectionId} input[data-select-all]`);
        if (selectAll) selectAll.checked = allChecked;
        
        document.getElementById('batch-count').textContent = selectedIds.size;
      }

      function showBatchEditModal() {
        if (selectedIds.size === 0) {
          alert('Please select at least one request');
          return;
        }
        document.getElementById('batch-ids').value = Array.from(selectedIds).join(',');
        document.getElementById('batch-edit-modal').classList.remove('hidden');
      }

      function hideBatchEditModal() {
        document.getElementById('batch-edit-modal').classList.add('hidden');
      }

      // Quick status change without redirect (for dashboard actions)
      async function quickStatusChange(requestId, toStatus, comment, buttonEl) {
        const originalText = buttonEl.innerHTML;
        buttonEl.disabled = true;
        buttonEl.innerHTML = '<span class="animate-pulse">...</span>';
        
        try {
          const formData = new FormData();
          formData.append('to_status', toStatus);
          formData.append('comment', comment || '');
          formData.append('quick_action', '1');  // Signal to not redirect
          
          const response = await fetch(`/admin/request/${requestId}/status`, {
            method: 'POST',
            body: formData
          });
          
          if (response.ok) {
            // Find and hide the parent request item
            const requestItem = buttonEl.closest('.request-item');
            if (requestItem) {
              requestItem.style.transition = 'opacity 0.3s, transform 0.3s';
              requestItem.style.opacity = '0';
              requestItem.style.transform = 'translateX(20px)';
              setTimeout(() => {
                requestItem.remove();
                // Update section count if present
                updateSectionCounts();
              }, 300);
            }
            
            // Show success toast
            showToast(`‚úì Marked as ${toStatus.replace('_', ' ').toLowerCase()}`);
          } else {
            const errorText = await response.text();
            showToast(`Error: ${errorText}`, 'error');
            buttonEl.disabled = false;
            buttonEl.innerHTML = originalText;
          }
        } catch (e) {
          showToast('Network error', 'error');
          buttonEl.disabled = false;
          buttonEl.innerHTML = originalText;
        }
      }
      
      // Update section header counts after removing items
      function updateSectionCounts() {
        // Count remaining items in each section
        const sections = ['new-section', 'printing-section', 'approved-section', 'done-section'];
        sections.forEach(sectionId => {
          const section = document.getElementById(sectionId);
          if (section) {
            const count = section.querySelectorAll('.request-item:not([style*="opacity: 0"])').length;
            const countBadge = section.querySelector('.section-count');
            if (countBadge) {
              countBadge.textContent = count;
            }
          }
        });
      }
      
      // Simple toast notification
      function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-xl text-sm font-medium z-50 transform transition-all duration-300 ${
          type === 'error' 
            ? 'bg-red-900/90 border border-red-700 text-red-200' 
            : 'bg-emerald-900/90 border border-emerald-700 text-emerald-200'
        }`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transform = 'translateX(100%)';
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      // Close modal when clicking outside
      document.getElementById('batch-edit-modal').addEventListener('click', (e) => {
        if (e.target.id === 'batch-edit-modal') hideBatchEditModal();
      });
    </script>

    <!-- Helper macro-ish (simple patterns) -->
    {% macro badge(text) -%}
      <span class="px-2 py-1 rounded-lg text-xs border
        {% if text == 'NEEDS_INFO' %}bg-orange-900/20 border-orange-800 text-orange-200
        {% elif text == 'APPROVED' %}bg-green-900/20 border-green-800 text-green-200
        {% elif text == 'PRINTING' %}bg-emerald-900/20 border-emerald-800 text-emerald-200
        {% elif text == 'DONE' %}bg-cyan-900/20 border-cyan-800 text-cyan-200
        {% else %}bg-zinc-950 border-zinc-800 text-zinc-300{% endif %}">{{ text }}</span>
    {%- endmacro %}

    {% macro prio_badge(p) -%}
      {% set p = p or 3 %}
      <span class="px-2 py-1 rounded-lg text-xs border
        {% if p == 1 %}bg-red-900/20 border-red-800 text-red-200
        {% elif p == 2 %}bg-amber-900/20 border-amber-800 text-amber-200
        {% elif p == 3 %}bg-zinc-950 border-zinc-800 text-zinc-200
        {% elif p == 4 %}bg-zinc-950 border-zinc-800 text-zinc-300
        {% else %}bg-zinc-950 border-zinc-800 text-zinc-400{% endif %}">
        P{{ p }}
      </span>
    {%- endmacro %}

    <!-- ETA Disclaimer -->
    <div class="mt-6 mb-4 text-xs text-zinc-500 bg-zinc-900/30 border border-zinc-800 rounded-lg px-3 py-2">
      ‚è±Ô∏è <strong>Note:</strong> ETAs are estimates only and may vary based on print complexity, material, and other factors.
    </div>

    <!-- Print Match Suggestions -->
    {% if print_match_suggestions %}
      {% for printer_code, suggestion in print_match_suggestions.items() %}
        <div class="mb-4 bg-amber-900/20 border border-amber-600/50 rounded-xl p-4">
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-amber-400">üîó</span>
                <span class="font-semibold text-amber-200">
                  {% if printer_code == 'ADVENTURER_4' %}Adventurer 4{% elif printer_code == 'AD5X' %}AD5X{% else %}{{ printer_code }}{% endif %}
                  is printing "{{ suggestion.file_display }}"
                </span>
              </div>
              <p class="text-sm text-zinc-300 mb-3">
                {% if suggestion.matches|length == 1 %}
                  Found 1 matching request. Would you like to assign it?
                {% else %}
                  Found {{ suggestion.matches|length }} potential matches. Select one to assign:
                {% endif %}
              </p>
              <div class="flex flex-wrap gap-2">
                {% for match in suggestion.matches %}
                  <form method="POST" action="/admin/match-print/{{ match.id }}" class="inline">
                    <input type="hidden" name="printer" value="{{ printer_code }}" />
                    <button type="submit" class="inline-flex items-center gap-2 px-3 py-1.5 bg-amber-600/30 hover:bg-amber-600/50 border border-amber-500/50 rounded-lg text-sm transition">
                      <span class="font-medium">{{ match.print_name or match.id[:8] }}</span>
                      <span class="text-xs text-amber-300/70">{{ match.requester_name }}</span>
                      {% if match.printer == printer_code %}
                        <span class="text-xs bg-green-600/30 text-green-300 px-1 rounded">assigned</span>
                      {% endif %}
                    </button>
                  </form>
                {% endfor %}
              </div>
            </div>
            <form method="POST" action="/admin/dismiss-match/{{ printer_code }}" class="flex-shrink-0">
              <button type="submit" class="text-zinc-400 hover:text-zinc-200 p-1" title="Dismiss">
                ‚úï
              </button>
            </form>
          </div>
        </div>
      {% endfor %}
    {% endif %}

    <!-- Printer Status Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="printer-status-cards">
      <!-- Adventurer 4 -->
      <div id="card-adv4" class="bg-zinc-900/50 border {% if printer_status.ADVENTURER_4.is_offline and printer_status.ADVENTURER_4.is_cached %}border-amber-700/50{% else %}border-zinc-800{% endif %} rounded-xl p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold flex items-center gap-2">
            <span>üñ®</span>
            <span>FlashForge Adventurer 4</span>
          </h3>
          {% if printer_status.ADVENTURER_4.is_offline %}
            <span class="status-badge inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-medium bg-amber-600/20 text-amber-300 border border-amber-500/50">
              <span class="status-dot inline-block w-2 h-2 rounded-full bg-amber-400"></span>
              Offline
            </span>
          {% elif printer_status.ADVENTURER_4.status %}
            <span class="status-badge inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-medium
              {% if printer_status.ADVENTURER_4.is_printing %}
                bg-emerald-500/20 text-emerald-300 border border-emerald-500/50
              {% elif printer_status.ADVENTURER_4.status == 'READY' %}
                bg-green-500/20 text-green-300 border border-green-500/50
              {% else %}
                bg-amber-500/20 text-amber-300 border border-amber-500/50
              {% endif %}">
              <span class="status-dot inline-block w-2 h-2 rounded-full animate-pulse
                {% if printer_status.ADVENTURER_4.is_printing %}bg-emerald-400
                {% elif printer_status.ADVENTURER_4.status == 'READY' %}bg-green-400
                {% else %}bg-amber-400{% endif %}"></span>
              {{ printer_status.ADVENTURER_4.status }}
            </span>
          {% else %}
            <span class="status-badge inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-medium bg-zinc-600/20 text-zinc-300 border border-zinc-600/50">
              <span class="status-dot inline-block w-2 h-2 rounded-full bg-zinc-400"></span>
              Unknown
            </span>
          {% endif %}
        </div>
        
        <!-- Offline indicator with last seen -->
        {% if printer_status.ADVENTURER_4.is_offline and printer_status.ADVENTURER_4.is_cached %}
        <div class="mb-3 px-2 py-1.5 bg-amber-950/30 border border-amber-800/30 rounded-lg flex items-center gap-2 text-xs text-amber-400">
          <span>‚ö†Ô∏è</span>
          <span>Connection lost{% if printer_status.ADVENTURER_4.last_seen %} ¬∑ Last seen {{ printer_status.ADVENTURER_4.last_seen }}{% endif %}</span>
        </div>
        {% endif %}
        
        <!-- Currently printing info -->
        <div class="print-info bg-zinc-950/60 rounded-lg p-3 mb-3 {% if not printer_status.ADVENTURER_4.is_printing %}hidden{% endif %}">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-medium text-zinc-200">üìÑ <span class="file-name">{{ printer_status.ADVENTURER_4.current_file or 'Unknown' }}</span></div>
              <div class="flex items-center gap-4 mt-1 text-xs text-zinc-400">
                {% if printer_status.ADVENTURER_4.progress is not none %}
                  <span>Progress: <span class="progress-text text-emerald-300 font-semibold">{{ printer_status.ADVENTURER_4.progress }}%</span></span>
                {% else %}
                  <span>Progress: <span class="progress-text text-zinc-400 font-semibold">‚Äî</span></span>
                {% endif %}
                {% if printer_status.ADVENTURER_4.current_layer is not none %}
                  <span>Layer: <span class="layer-text text-blue-300">{{ printer_status.ADVENTURER_4.current_layer }}/{{ printer_status.ADVENTURER_4.total_layers }}</span></span>
                {% else %}
                  <span>Layer: <span class="layer-text text-zinc-400">‚Äî</span></span>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="mt-2 h-2 bg-zinc-800 rounded-full overflow-hidden">
            <div class="progress-bar h-full bg-gradient-to-r from-emerald-500 to-emerald-400 transition-all duration-500" 
                 style="width: {{ printer_status.ADVENTURER_4.progress or 0 }}%"></div>
          </div>
        </div>
        
        <div class="flex items-center justify-between text-xs text-zinc-400">
          <span class="temp-text">
            {% if printer_status.ADVENTURER_4.temp %}
              üå° Nozzle: <span class="text-zinc-200">{{ printer_status.ADVENTURER_4.temp }}¬∞C</span>
              {% if printer_status.ADVENTURER_4.target_temp %}
                <span class="text-zinc-500">/ {{ printer_status.ADVENTURER_4.target_temp }}¬∞C</span>
              {% endif %}
            {% endif %}
          </span>
          {% if printer_status.ADVENTURER_4.camera_url %}
          <button type="button" onclick="toggleAdminCamera('ADVENTURER_4')" id="admin-cam-btn-ADVENTURER_4" class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 rounded-lg text-xs font-medium text-zinc-300 transition">
            <span>üì∑</span> <span class="btn-text">Show Camera</span>
          </button>
          {% endif %}
        </div>
        <!-- Camera preview -->
        {% if printer_status.ADVENTURER_4.camera_url %}
        <div id="admin-cam-ADVENTURER_4" class="hidden mt-3">
          <img id="admin-cam-img-ADVENTURER_4" class="w-full rounded-lg bg-zinc-800 border border-zinc-700" alt="Camera" />
          <div class="text-xs text-zinc-500 mt-1">Updates every 10 seconds</div>
        </div>
        {% endif %}
      </div>
      
      <!-- AD5X -->
      <div id="card-ad5x" class="bg-zinc-900/50 border {% if printer_status.AD5X.is_offline and printer_status.AD5X.is_cached %}border-amber-700/50{% else %}border-zinc-800{% endif %} rounded-xl p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold flex items-center gap-2">
            <span>üñ®</span>
            <span>FlashForge AD5X</span>
          </h3>
          {% if printer_status.AD5X.is_offline %}
            <span class="status-badge inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-medium bg-amber-600/20 text-amber-300 border border-amber-500/50">
              <span class="status-dot inline-block w-2 h-2 rounded-full bg-amber-400"></span>
              Offline
            </span>
          {% elif printer_status.AD5X.status %}
            <span class="status-badge inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-medium
              {% if printer_status.AD5X.is_printing %}
                bg-emerald-500/20 text-emerald-300 border border-emerald-500/50
              {% elif printer_status.AD5X.status == 'READY' %}
                bg-green-500/20 text-green-300 border border-green-500/50
              {% else %}
                bg-amber-500/20 text-amber-300 border border-amber-500/50
              {% endif %}">
              <span class="status-dot inline-block w-2 h-2 rounded-full animate-pulse
                {% if printer_status.AD5X.is_printing %}bg-emerald-400
                {% elif printer_status.AD5X.status == 'READY' %}bg-green-400
                {% else %}bg-amber-400{% endif %}"></span>
              {{ printer_status.AD5X.status }}
            </span>
          {% else %}
            <span class="status-badge inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-medium bg-zinc-600/20 text-zinc-300 border border-zinc-600/50">
              <span class="status-dot inline-block w-2 h-2 rounded-full bg-zinc-400"></span>
              Unknown
            </span>
          {% endif %}
        </div>
        
        <!-- Offline indicator with last seen -->
        {% if printer_status.AD5X.is_offline and printer_status.AD5X.is_cached %}
        <div class="mb-3 px-2 py-1.5 bg-amber-950/30 border border-amber-800/30 rounded-lg flex items-center gap-2 text-xs text-amber-400">
          <span>‚ö†Ô∏è</span>
          <span>Connection lost{% if printer_status.AD5X.last_seen %} ¬∑ Last seen {{ printer_status.AD5X.last_seen }}{% endif %}</span>
        </div>
        {% endif %}
        
        <!-- Currently printing info -->
        <div class="print-info bg-zinc-950/60 rounded-lg p-3 mb-3 {% if not printer_status.AD5X.is_printing %}hidden{% endif %}">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-medium text-zinc-200">üìÑ <span class="file-name">{{ printer_status.AD5X.current_file or 'Unknown' }}</span></div>
              <div class="flex items-center gap-4 mt-1 text-xs text-zinc-400">
                {% if printer_status.AD5X.progress is not none %}
                  <span>Progress: <span class="progress-text text-emerald-300 font-semibold">{{ printer_status.AD5X.progress }}%</span></span>
                {% else %}
                  <span>Progress: <span class="progress-text text-zinc-400 font-semibold">‚Äî</span></span>
                {% endif %}
                {% if printer_status.AD5X.current_layer is not none %}
                  <span>Layer: <span class="layer-text text-blue-300">{{ printer_status.AD5X.current_layer }}/{{ printer_status.AD5X.total_layers }}</span></span>
                {% else %}
                  <span>Layer: <span class="layer-text text-zinc-400">‚Äî</span></span>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="mt-2 h-2 bg-zinc-800 rounded-full overflow-hidden">
            <div class="progress-bar h-full bg-gradient-to-r from-emerald-500 to-emerald-400 transition-all duration-500" 
                 style="width: {{ printer_status.AD5X.progress or 0 }}%"></div>
          </div>
        </div>
        
        <div class="flex items-center justify-between text-xs text-zinc-400">
          <span class="temp-text">
            {% if printer_status.AD5X.temp %}
              üå° Nozzle: <span class="text-zinc-200">{{ printer_status.AD5X.temp }}¬∞C</span>
              {% if printer_status.AD5X.target_temp %}
                <span class="text-zinc-500">/ {{ printer_status.AD5X.target_temp }}¬∞C</span>
              {% endif %}
            {% endif %}
          </span>
          {% if printer_status.AD5X.camera_url %}
          <button type="button" onclick="toggleAdminCamera('AD5X')" id="admin-cam-btn-AD5X" class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 rounded-lg text-xs font-medium text-zinc-300 transition">
            <span>üì∑</span> <span class="btn-text">Show Camera</span>
          </button>
          {% endif %}
        </div>
        <!-- Camera preview -->
        {% if printer_status.AD5X.camera_url %}
        <div id="admin-cam-AD5X" class="hidden mt-3">
          <img id="admin-cam-img-AD5X" class="w-full rounded-lg bg-zinc-800 border border-zinc-700" alt="Camera" />
          <div class="text-xs text-zinc-500 mt-1">Updates every 10 seconds</div>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Auto-refresh controls -->
    <div class="mt-2 flex justify-end">
      <label class="flex items-center gap-2 text-xs text-zinc-500 cursor-pointer">
        <input type="checkbox" id="auto-refresh" checked class="rounded" />
        Auto-refresh printer status every 15s
      </label>
      <button onclick="refreshPrinterStatus()" class="ml-4 text-xs text-indigo-400 hover:underline">‚Üª Refresh now</button>
    </div>

    <script>
      // Camera toggle for admin
      const adminCamIntervals = {};
      
      function toggleAdminCamera(printer) {
        const div = document.getElementById(`admin-cam-${printer}`);
        const btn = document.getElementById(`admin-cam-btn-${printer}`);
        const img = document.getElementById(`admin-cam-img-${printer}`);
        
        console.log('[Admin Camera] toggleAdminCamera called for:', printer, { div: !!div, btn: !!btn, img: !!img });
        
        if (!div || !btn || !img) {
          console.warn('[Admin Camera] Missing elements for', printer);
          return;
        }
        
        const btnText = btn.querySelector('.btn-text');
        
        if (div.classList.contains('hidden')) {
          // Show camera
          div.classList.remove('hidden');
          if (btnText) btnText.textContent = 'Hide Camera';
          
          // Load camera image
          img.alt = 'Loading camera...';
          img.src = `/api/camera/${printer}/snapshot?t=${Date.now()}`;
          console.log('[Admin Camera] Loading:', img.src);
          
          img.onerror = function() {
            console.error('[Admin Camera] Load error for', printer);
            img.alt = 'Camera unavailable';
            if (btnText) btnText.textContent = 'Camera Error';
            clearInterval(adminCamIntervals[printer]);
          };
          img.onload = function() {
            console.log('[Admin Camera] Loaded successfully for', printer);
            img.alt = 'Camera feed';
          };
          
          // Auto-refresh every 10 seconds
          adminCamIntervals[printer] = setInterval(() => {
            const newImg = new Image();
            newImg.onload = function() {
              img.src = this.src;
            };
            newImg.src = `/api/camera/${printer}/snapshot?t=${Date.now()}`;
          }, 10000);
        } else {
          // Hide camera
          div.classList.add('hidden');
          if (btnText) btnText.textContent = 'Show Camera';
          clearInterval(adminCamIntervals[printer]);
          console.log('[Admin Camera] Hidden for', printer);
        }
      }
      
      // AJAX-based printer status refresh
      let refreshInterval = null;
      const autoRefreshCheckbox = document.getElementById('auto-refresh');
      
      async function refreshPrinterStatus() {
        try {
          const resp = await fetch('/api/printers/status');
          if (!resp.ok) return;
          const data = await resp.json();
          
          // Update each printer card
          for (const [code, status] of Object.entries(data)) {
            updatePrinterCard(code, status);
          }
        } catch (e) {
          console.error('Failed to refresh printer status:', e);
        }
      }
      
      function updatePrinterCard(code, status) {
        const cardId = code === 'ADVENTURER_4' ? 'card-adv4' : 'card-ad5x';
        const card = document.getElementById(cardId);
        if (!card) return;
        
        // Update status badge
        const badge = card.querySelector('.status-badge');
        if (badge) {
          badge.textContent = status.status || 'OFFLINE';
          badge.className = 'status-badge inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-medium';
          if (status.is_printing) {
            badge.classList.add('bg-emerald-500/20', 'text-emerald-300', 'border', 'border-emerald-500/50');
          } else if (status.status === 'READY') {
            badge.classList.add('bg-green-500/20', 'text-green-300', 'border', 'border-green-500/50');
          } else if (status.status === 'OFFLINE' || status.status === 'ERROR') {
            badge.classList.add('bg-zinc-600/20', 'text-zinc-300', 'border', 'border-zinc-600/50');
          } else {
            badge.classList.add('bg-amber-500/20', 'text-amber-300', 'border', 'border-amber-500/50');
          }
        }
        
        // Update print info section
        const printInfo = card.querySelector('.print-info');
        if (printInfo) {
          if (status.is_printing) {
            printInfo.classList.remove('hidden');
            const fileName = printInfo.querySelector('.file-name');
            const progress = printInfo.querySelector('.progress-text');
            const layer = printInfo.querySelector('.layer-text');
            const progressBar = printInfo.querySelector('.progress-bar');
            
            if (fileName) fileName.textContent = status.current_file || 'Unknown file';
            if (progress) progress.textContent = (status.progress ?? '?') + '%';
            if (layer && status.current_layer !== null) {
              layer.textContent = `${status.current_layer}/${status.total_layers}`;
            }
            if (progressBar && status.progress !== null) {
              progressBar.style.width = status.progress + '%';
            }
          } else {
            printInfo.classList.add('hidden');
          }
        }
        
        // Update temperature
        const temp = card.querySelector('.temp-text');
        if (temp && status.temp) {
          let tempText = `üå° Nozzle: ${status.temp}¬∞C`;
          if (status.target_temp) tempText += ` / ${status.target_temp}¬∞C`;
          temp.innerHTML = tempText;
        }
      }
      
      function startAutoRefresh() {
        if (refreshInterval) clearInterval(refreshInterval);
        refreshInterval = setInterval(refreshPrinterStatus, 15000);
      }
      
      function stopAutoRefresh() {
        if (refreshInterval) {
          clearInterval(refreshInterval);
          refreshInterval = null;
        }
      }
      
      autoRefreshCheckbox.addEventListener('change', (e) => {
        if (e.target.checked) {
          startAutoRefresh();
        } else {
          stopAutoRefresh();
        }
      });
      
      // Start auto-refresh on page load
      startAutoRefresh();
    </script>

    <div class="mt-6 grid grid-cols-1 xl:grid-cols-2 gap-6">

      <!-- NEW REQUESTS - Collapsible cards -->
      <section id="new-section" class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5">
        <div class="flex items-center justify-between">
          <div>
            <div class="flex items-center gap-3">
              <h2 class="text-xl font-semibold">New requests</h2>
              {% if new_reqs|length > 0 %}
                <span class="px-2 py-1 rounded-lg bg-indigo-600/20 border border-indigo-500 text-indigo-200 text-xs">
                  {{ new_reqs|length }} needs attention
                </span>
              {% else %}
                <span class="text-xs text-zinc-500">No new requests</span>
              {% endif %}
            </div>
            <p class="text-xs text-zinc-500 mt-1">Tap a request to expand actions.</p>
          </div>
          {% if new_reqs|length > 0 %}
            <label class="flex items-center gap-2 text-xs cursor-pointer">
              <input type="checkbox" data-select-all onchange="toggleSelectAll('new-section'); updateBatchUI('new-section')" />
              Select all
            </label>
          {% endif %}
        </div>

        {% if new_reqs|length == 0 %}
          <div class="mt-4 text-sm text-zinc-400 bg-zinc-950/40 border border-zinc-800 rounded-xl p-4">
            üéâ Nothing new right now.
          </div>
        {% else %}
          <div class="mt-4 space-y-2" id="new-list">
            {% for r in new_reqs[:3] %}
              <details class="request-item group bg-zinc-950/60 border {% if r['status'] == 'NEEDS_INFO' %}border-orange-500/50{% else %}border-zinc-800{% endif %} rounded-xl overflow-hidden">
                <summary class="p-3 cursor-pointer hover:bg-zinc-900/40 list-none">
                  <div class="flex items-center gap-3">
                    <input type="checkbox" data-request-id value="{{ r['id'] }}" onclick="event.stopPropagation()"
                           onchange="toggleRequestId(this.value); updateBatchUI('new-section')" />
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center gap-2">
                        <span class="font-semibold truncate">{{ r["print_name"] or 'Untitled Print' }}</span>
                        {% if r["unread_replies"] and r["unread_replies"] > 0 %}
                          <span class="px-1.5 py-0.5 bg-red-600 text-white text-xs rounded-full animate-pulse">{{ r["unread_replies"] }}</span>
                        {% endif %}
                      </div>
                      <div class="text-xs text-zinc-500">{{ r["id"][:8] }} ‚Ä¢ {{ r["requester_name"] }}</div>
                    </div>
                    <div class="flex items-center gap-2 shrink-0">
                      {{ prio_badge(r["priority"]) }}
                      {{ badge(r["status"]) }}
                      <svg class="w-4 h-4 text-zinc-400 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                      </svg>
                    </div>
                  </div>
                </summary>
                <div class="px-3 pb-3 border-t border-zinc-800/50">
                  <div class="pt-3 text-xs text-zinc-400">
                    {{ r["printer"] }} ‚Ä¢ {{ r["material"] }} ‚Ä¢ {{ r["colors"] }}
                  </div>
                  <div class="mt-2 flex flex-wrap gap-2 items-center">
                    {% if r["file_count"] and r["file_count"] > 0 %}
                      <button type="button" onclick="showFilesModal('{{ r['id'] }}', '{{ r['file_names']|default('')|e }}')"
                              class="text-xs text-emerald-300 bg-emerald-900/20 border border-emerald-800 px-2 py-1 rounded-lg hover:bg-emerald-900/40">
                        üìÅ {{ r["file_count"] }} file{% if r["file_count"] > 1 %}s{% endif %}
                      </button>
                    {% endif %}
                    {% if r["link_url"] %}
                      <a class="text-xs text-indigo-300 bg-indigo-900/20 border border-indigo-800 px-2 py-1 rounded-lg hover:bg-indigo-900/40" href="{{ r['link_url'] }}" target="_blank">üîó Link</a>
                    {% endif %}
                    {% if r["special_notes"] %}
                      <span class="text-xs text-amber-200 bg-amber-900/20 border border-amber-800 px-2 py-1 rounded-lg">üìù Notes</span>
                    {% endif %}
                    <a href="/admin/request/{{ r['id'] }}" class="text-xs text-zinc-400 hover:text-white">View details ‚Üí</a>
                  </div>
                  <div class="mt-3 flex flex-wrap gap-2">
                    <form method="POST" action="/admin/request/{{ r['id'] }}/status" class="flex-1 flex gap-1">
                      <input type="hidden" name="to_status" value="APPROVED" />
                      <input name="comment" placeholder="Question (optional)" class="flex-1 min-w-0 rounded-lg bg-zinc-950 border border-zinc-800 px-2 py-1.5 text-xs" />
                      <button class="rounded-lg bg-indigo-600 hover:bg-indigo-500 transition px-3 py-1.5 text-xs font-semibold whitespace-nowrap">Approve</button>
                    </form>
                  </div>
                  <div class="mt-2 flex flex-wrap gap-2">
                    <form method="POST" action="/admin/request/{{ r['id'] }}/status" class="flex gap-1">
                      <input type="hidden" name="to_status" value="NEEDS_INFO" />
                      <input name="comment" placeholder="What info?" class="w-24 rounded-lg bg-zinc-950 border border-orange-800/50 px-2 py-1.5 text-xs" />
                      <button class="text-xs px-2 py-1.5 rounded-lg bg-orange-900/20 border border-orange-800 hover:bg-orange-900/40 text-orange-200">Need Info</button>
                    </form>
                    <form method="POST" action="/admin/request/{{ r['id'] }}/status">
                      <input type="hidden" name="to_status" value="REJECTED" />
                      <input type="hidden" name="comment" value="Rejected" />
                      <button class="text-xs px-2 py-1.5 rounded-lg bg-zinc-950 border border-zinc-800 hover:bg-zinc-900">Reject</button>
                    </form>
                  </div>
                </div>
              </details>
            {% endfor %}
            {% for r in new_reqs[3:] %}
              <details class="request-item hidden group bg-zinc-950/60 border {% if r['status'] == 'NEEDS_INFO' %}border-orange-500/50{% else %}border-zinc-800{% endif %} rounded-xl overflow-hidden">
                <summary class="p-3 cursor-pointer hover:bg-zinc-900/40 list-none">
                  <div class="flex items-center gap-3">
                    <input type="checkbox" data-request-id value="{{ r['id'] }}" onclick="event.stopPropagation()"
                           onchange="toggleRequestId(this.value); updateBatchUI('new-section')" />
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center gap-2">
                        <span class="font-semibold truncate">{{ r["print_name"] or 'Untitled Print' }}</span>
                        {% if r["unread_replies"] and r["unread_replies"] > 0 %}
                          <span class="px-1.5 py-0.5 bg-red-600 text-white text-xs rounded-full animate-pulse">{{ r["unread_replies"] }}</span>
                        {% endif %}
                      </div>
                      <div class="text-xs text-zinc-500">{{ r["id"][:8] }} ‚Ä¢ {{ r["requester_name"] }}</div>
                    </div>
                    <div class="flex items-center gap-2 shrink-0">
                      {{ prio_badge(r["priority"]) }}
                      {{ badge(r["status"]) }}
                      <svg class="w-4 h-4 text-zinc-400 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                      </svg>
                    </div>
                  </div>
                </summary>
                <div class="px-3 pb-3 border-t border-zinc-800/50">
                  <div class="pt-3 text-xs text-zinc-400">{{ r["printer"] }} ‚Ä¢ {{ r["material"] }} ‚Ä¢ {{ r["colors"] }}</div>
                  <div class="mt-2 flex flex-wrap gap-2 items-center">
                    {% if r["file_count"] and r["file_count"] > 0 %}
                      <button type="button" onclick="showFilesModal('{{ r['id'] }}', '{{ r['file_names']|default('')|e }}')"
                              class="text-xs text-emerald-300 bg-emerald-900/20 border border-emerald-800 px-2 py-1 rounded-lg hover:bg-emerald-900/40">üìÅ {{ r["file_count"] }}</button>
                    {% endif %}
                    <a href="/admin/request/{{ r['id'] }}" class="text-xs text-zinc-400 hover:text-white">View details ‚Üí</a>
                  </div>
                  <div class="mt-3 flex flex-wrap gap-2">
                    <form method="POST" action="/admin/request/{{ r['id'] }}/status" class="flex-1 flex gap-1">
                      <input type="hidden" name="to_status" value="APPROVED" />
                      <input name="comment" placeholder="Question (optional)" class="flex-1 min-w-0 rounded-lg bg-zinc-950 border border-zinc-800 px-2 py-1.5 text-xs" />
                      <button class="rounded-lg bg-indigo-600 hover:bg-indigo-500 transition px-3 py-1.5 text-xs font-semibold whitespace-nowrap">Approve</button>
                    </form>
                  </div>
                  <div class="mt-2 flex flex-wrap gap-2">
                    <form method="POST" action="/admin/request/{{ r['id'] }}/status">
                      <input type="hidden" name="to_status" value="NEEDS_INFO" />
                      <input type="hidden" name="comment" value="Needs more info" />
                      <button class="text-xs px-2 py-1.5 rounded-lg bg-orange-900/20 border border-orange-800 hover:bg-orange-900/40 text-orange-200">Need Info</button>
                    </form>
                    <form method="POST" action="/admin/request/{{ r['id'] }}/status">
                      <input type="hidden" name="to_status" value="REJECTED" />
                      <input type="hidden" name="comment" value="Rejected" />
                      <button class="text-xs px-2 py-1.5 rounded-lg bg-zinc-950 border border-zinc-800 hover:bg-zinc-900">Reject</button>
                    </form>
                  </div>
                </div>
              </details>
            {% endfor %}
          </div>
          {% if new_reqs|length > 3 %}
          <button onclick="toggleShowMore('new-list', this)" class="mt-3 w-full text-center text-xs text-indigo-400 hover:text-indigo-300 py-2 rounded-lg hover:bg-zinc-800/50 transition">
            Show {{ new_reqs|length - 3 }} more ‚ñº
          </button>
          {% endif %}
          <div class="mt-3">
            <button onclick="showBatchEditModal()" class="w-full rounded-xl bg-zinc-800 hover:bg-zinc-700 transition px-4 py-2 text-sm">
              ‚úè Batch Edit Selected
            </button>
          </div>
        {% endif %}
      </section>

    </div>

    <!-- Status Sections Grid - 2x2 Card Layout -->
    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">

      <!-- PRINTING NOW -->
      <section id="printing-section" class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <h2 class="text-xl font-semibold">Printing now</h2>
            {% if printing|length > 0 %}
              <span class="px-2 py-1 rounded-lg bg-emerald-600/20 border border-emerald-500 text-emerald-200 text-xs">
                {{ printing|length }} active
              </span>
            {% else %}
              <span class="text-xs text-zinc-500">None printing</span>
            {% endif %}
          </div>
          {% if printing|length > 0 %}
            <label class="flex items-center gap-2 text-xs cursor-pointer">
              <input type="checkbox" data-select-all onchange="toggleSelectAll('printing-section'); updateBatchUI('printing-section')" />
              Select all
            </label>
          {% endif %}
        </div>

        {% if printing|length == 0 %}
          <div class="mt-4 text-sm text-zinc-400 bg-zinc-950/40 border border-zinc-800 rounded-xl p-4">
            No active prints right now.
          </div>
        {% else %}
          <div class="mt-4 space-y-2" id="printing-list">
            {% for r in printing[:3] %}
              <div class="request-item bg-zinc-950/60 border border-zinc-800 rounded-xl p-3">
                <div class="flex items-center gap-3">
                  <input type="checkbox" data-request-id value="{{ r['id'] }}" 
                         onchange="toggleRequestId(this.value); updateBatchUI('printing-section')" />
                  <a class="hover:underline flex-1 min-w-0" href="/admin/request/{{ r['id'] }}">
                    <div class="flex items-center gap-2">
                      <span class="font-semibold truncate">{{ r["print_name"] or 'Untitled Print' }}</span>
                      <span class="text-xs text-zinc-500 shrink-0">{{ r["id"][:8] }}</span>
                      {% if r.total_builds and r.total_builds > 1 %}
                        <span class="text-xs px-1.5 py-0.5 rounded bg-amber-500/20 text-amber-300">
                          {{ r.completed_builds or 0 }}/{{ r.total_builds }} builds
                        </span>
                      {% endif %}
                      {% if r.status == 'IN_PROGRESS' %}
                        <span class="text-xs px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-300">Multi-Build</span>
                      {% endif %}
                    </div>
                    <div class="text-xs text-zinc-400 mt-0.5 truncate">
                      {{ r.get("active_printer") or r["printer"] or "ANY" }} ‚Ä¢ {{ r["material"] or "ANY" }} {% if r["colors"] %}‚Ä¢ {{ r["colors"] }}{% endif %}
                    </div>
                    {% if r.get("printer_progress") is not none %}
                      <div class="flex items-center gap-2 mt-1.5">
                        <div class="w-20 bg-zinc-800 rounded-full h-1.5">
                          <div class="bg-emerald-500 h-1.5 rounded-full" style="width: {{ r.printer_progress }}%"></div>
                        </div>
                        <span class="text-xs font-semibold text-emerald-300">{{ r.printer_progress }}%</span>
                        {% if r.get("smart_eta_display") %}
                          <span class="text-xs text-zinc-500">‚Ä¢ ETA {{ r.smart_eta_display }}</span>
                        {% endif %}
                      </div>
                    {% endif %}
                  </a>
                  <div class="flex items-center gap-2 shrink-0">
                    {{ prio_badge(r["priority"]) }}
                    {{ badge(r["status"]) }}
                  </div>
                </div>

                <div class="mt-2">
                  <button onclick="quickStatusChange('{{ r['id'] }}', 'DONE', 'Print completed', this)" 
                          class="w-full rounded-lg bg-indigo-600 hover:bg-indigo-500 transition px-3 py-1.5 text-xs font-semibold">
                    ‚úì Mark Done + notify
                  </button>
                </div>
              </div>
            {% endfor %}
            {% for r in printing[3:] %}
              <div class="request-item hidden bg-zinc-950/60 border border-zinc-800 rounded-xl p-3">
                <div class="flex items-center gap-3">
                  <input type="checkbox" data-request-id value="{{ r['id'] }}" 
                         onchange="toggleRequestId(this.value); updateBatchUI('printing-section')" />
                  <a class="hover:underline flex-1 min-w-0" href="/admin/request/{{ r['id'] }}">
                    <div class="flex items-center gap-2">
                      <span class="font-semibold truncate">{{ r["print_name"] or 'Untitled Print' }}</span>
                      <span class="text-xs text-zinc-500 shrink-0">{{ r["id"][:8] }}</span>
                      {% if r.total_builds and r.total_builds > 1 %}
                        <span class="text-xs px-1.5 py-0.5 rounded bg-amber-500/20 text-amber-300">
                          {{ r.completed_builds or 0 }}/{{ r.total_builds }} builds
                        </span>
                      {% endif %}
                    </div>
                    <div class="text-xs text-zinc-400 mt-0.5 truncate">
                      {{ r.get("active_printer") or r["printer"] or "ANY" }} ‚Ä¢ {{ r["material"] or "ANY" }}
                    </div>
                    {% if r.get("printer_progress") is not none %}
                      <div class="flex items-center gap-2 mt-1.5">
                        <div class="w-20 bg-zinc-800 rounded-full h-1.5">
                          <div class="bg-emerald-500 h-1.5 rounded-full" style="width: {{ r.printer_progress }}%"></div>
                        </div>
                        <span class="text-xs font-semibold text-emerald-300">{{ r.printer_progress }}%</span>
                      </div>
                    {% endif %}
                  </a>
                  <div class="flex items-center gap-2 shrink-0">
                    {{ prio_badge(r["priority"]) }}
                    {{ badge(r["status"]) }}
                  </div>
                </div>
                <div class="mt-2">
                  <button onclick="quickStatusChange('{{ r['id'] }}', 'DONE', 'Print completed', this)" 
                          class="w-full rounded-lg bg-indigo-600 hover:bg-indigo-500 transition px-3 py-1.5 text-xs font-semibold">
                    ‚úì Mark Done + notify
                  </button>
                </div>
              </div>
            {% endfor %}
          </div>
          {% if printing|length > 3 %}
          <button onclick="toggleShowMore('printing-list', this)" class="mt-3 w-full text-center text-xs text-indigo-400 hover:text-indigo-300 py-2 rounded-lg hover:bg-zinc-800/50 transition">
            Show {{ printing|length - 3 }} more ‚ñº
          </button>
          {% endif %}
          <div class="mt-3">
            <button onclick="showBatchEditModal()" class="w-full rounded-xl bg-zinc-800 hover:bg-zinc-700 transition px-4 py-2 text-sm">
              ‚úè Batch Edit Selected
            </button>
          </div>
        {% endif %}
      </section>

      <!-- WAITING TO PRINT (APPROVED) -->
      <section id="approved-section" class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <h2 class="text-xl font-semibold">Waiting to print</h2>
            {% if queued|length > 0 %}
              <span class="px-2 py-1 rounded-lg bg-green-600/20 border border-green-500 text-green-200 text-xs">
                {{ queued|length }} queued
              </span>
            {% else %}
              <span class="text-xs text-zinc-500">Empty</span>
            {% endif %}
          </div>
          {% if queued|length > 0 %}
            <label class="flex items-center gap-2 text-xs cursor-pointer">
              <input type="checkbox" data-select-all onchange="toggleSelectAll('approved-section'); updateBatchUI('approved-section')" />
              Select all
            </label>
          {% endif %}
        </div>

        {% if queued|length == 0 %}
          <div class="mt-4 text-sm text-zinc-400 bg-zinc-950/40 border border-zinc-800 rounded-xl p-4">
            Nothing approved yet.
          </div>
        {% else %}
          <div class="mt-4 space-y-2" id="approved-list">
            {% for r in queued[:3] %}
              <div class="request-item bg-zinc-950/60 border border-zinc-800 rounded-xl p-3">
                <div class="flex items-center gap-3">
                  <input type="checkbox" data-request-id value="{{ r['id'] }}" 
                         onchange="toggleRequestId(this.value); updateBatchUI('approved-section')" />
                  <a class="hover:underline flex-1 min-w-0" href="/admin/request/{{ r['id'] }}">
                    <div class="flex items-center gap-2">
                      <span class="font-semibold truncate">{{ r["print_name"] or 'Untitled Print' }}</span>
                      <span class="text-xs text-zinc-500 shrink-0">{{ r["id"][:8] }}</span>
                      {% if r.total_builds and r.total_builds > 1 %}
                        <span class="text-xs px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-300">
                          {{ r.total_builds }} builds
                        </span>
                      {% endif %}
                    </div>
                    <div class="text-xs text-zinc-400 mt-0.5 truncate">
                      {{ r["printer"] or "ANY" }} ‚Ä¢ {{ r["material"] or "ANY" }} {% if r["colors"] %}‚Ä¢ {{ r["colors"] }}{% endif %}
                    </div>
                  </a>
                  <div class="flex items-center gap-2 shrink-0">
                    {{ prio_badge(r["priority"]) }}
                    {{ badge(r["status"]) }}
                  </div>
                </div>

                <div class="mt-2 flex items-center gap-2">
                  <!-- Start print -->
                  <button type="button" 
                          onclick="showPrintStartModal('{{ r['id'] }}', '{{ r['printer'] }}', '{{ r['material'] }}', '{{ r['colors'] }}', 'PRINTING')"
                          class="flex-1 rounded-lg bg-emerald-600 hover:bg-emerald-500 transition px-3 py-1.5 text-xs font-semibold">
                    üñ® Start Print
                  </button>

                  <!-- Priority -->
                  <form method="POST" action="/admin/request/{{ r['id'] }}/priority" class="flex gap-1">
                    <select name="priority" class="rounded-lg bg-zinc-950 border border-zinc-800 px-2 py-1.5 text-xs">
                      {% for p in [1,2,3,4,5] %}
                        <option value="{{ p }}" {% if (r["priority"] or 3) == p %}selected{% endif %}>P{{ p }}</option>
                      {% endfor %}
                    </select>
                    <button class="rounded-lg bg-zinc-800 hover:bg-zinc-700 transition px-2 py-1.5 text-xs">
                      Set
                    </button>
                  </form>
                </div>
              </div>
            {% endfor %}
            {% for r in queued[3:] %}
              <div class="request-item hidden bg-zinc-950/60 border border-zinc-800 rounded-xl p-3">
                <div class="flex items-center gap-3">
                  <input type="checkbox" data-request-id value="{{ r['id'] }}" 
                         onchange="toggleRequestId(this.value); updateBatchUI('approved-section')" />
                  <a class="hover:underline flex-1 min-w-0" href="/admin/request/{{ r['id'] }}">
                    <div class="flex items-center gap-2">
                      <span class="font-semibold truncate">{{ r["print_name"] or 'Untitled Print' }}</span>
                      <span class="text-xs text-zinc-500 shrink-0">{{ r["id"][:8] }}</span>
                    </div>
                    <div class="text-xs text-zinc-400 mt-0.5 truncate">
                      {{ r["printer"] or "ANY" }} ‚Ä¢ {{ r["material"] or "ANY" }}
                    </div>
                  </a>
                  <div class="flex items-center gap-2 shrink-0">
                    {{ prio_badge(r["priority"]) }}
                    {{ badge(r["status"]) }}
                  </div>
                </div>
                <div class="mt-2 flex items-center gap-2">
                  <button type="button" onclick="showPrintStartModal('{{ r['id'] }}', '{{ r['printer'] }}', '{{ r['material'] }}', '{{ r['colors'] }}', 'PRINTING')"
                          class="flex-1 rounded-lg bg-emerald-600 hover:bg-emerald-500 transition px-3 py-1.5 text-xs font-semibold">
                    üñ® Start Print
                  </button>
                  <form method="POST" action="/admin/request/{{ r['id'] }}/priority" class="flex gap-1">
                    <select name="priority" class="rounded-lg bg-zinc-950 border border-zinc-800 px-2 py-1.5 text-xs">
                      {% for p in [1,2,3,4,5] %}
                        <option value="{{ p }}" {% if (r["priority"] or 3) == p %}selected{% endif %}>P{{ p }}</option>
                      {% endfor %}
                    </select>
                    <button class="rounded-lg bg-zinc-800 hover:bg-zinc-700 transition px-2 py-1.5 text-xs">Set</button>
                  </form>
                </div>
              </div>
            {% endfor %}
          </div>
          {% if queued|length > 3 %}
          <button onclick="toggleShowMore('approved-list', this)" class="mt-3 w-full text-center text-xs text-indigo-400 hover:text-indigo-300 py-2 rounded-lg hover:bg-zinc-800/50 transition">
            Show {{ queued|length - 3 }} more ‚ñº
          </button>
          {% endif %}
          <div class="mt-3">
            <button onclick="showBatchEditModal()" class="w-full rounded-xl bg-zinc-800 hover:bg-zinc-700 transition px-4 py-2 text-sm">
              ‚úè Batch Edit Selected
            </button>
          </div>
        {% endif %}
      </section>

      <!-- READY FOR PICKUP -->
      <section id="done-section" class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <h2 class="text-xl font-semibold">Ready for pickup</h2>
            {% if done|length > 0 %}
              <span class="px-2 py-1 rounded-lg bg-amber-600/20 border border-amber-500 text-amber-200 text-xs">
                {{ done|length }} waiting
              </span>
            {% else %}
              <span class="text-xs text-zinc-500">None</span>
            {% endif %}
          </div>
          {% if done|length > 0 %}
            <label class="flex items-center gap-2 text-xs cursor-pointer">
              <input type="checkbox" data-select-all onchange="toggleSelectAll('done-section'); updateBatchUI('done-section')" />
              Select all
            </label>
          {% endif %}
        </div>

        {% if done|length == 0 %}
          <div class="mt-4 text-sm text-zinc-400 bg-zinc-950/40 border border-zinc-800 rounded-xl p-4">
            Nothing waiting for pickup.
          </div>
        {% else %}
          <div class="mt-4 space-y-2" id="done-list">
            {% for r in done[:3] %}
              <div class="request-item bg-zinc-950/60 border border-zinc-800 rounded-xl p-3">
                <div class="flex items-center gap-3">
                  <input type="checkbox" data-request-id value="{{ r['id'] }}" 
                         onchange="toggleRequestId(this.value); updateBatchUI('done-section')" />
                  <a class="hover:underline flex-1 min-w-0" href="/admin/request/{{ r['id'] }}">
                    <div class="flex items-center gap-2">
                      <span class="font-semibold truncate">{{ r["print_name"] or 'Untitled Print' }}</span>
                      <span class="text-xs text-zinc-500 shrink-0">{{ r["id"][:8] }}</span>
                    </div>
                    <div class="text-xs text-zinc-400 mt-0.5 truncate">
                      {{ r["printer"] or "ANY" }} ‚Ä¢ {{ r["material"] or "ANY" }} {% if r["colors"] %}‚Ä¢ {{ r["colors"] }}{% endif %}
                    </div>
                  </a>
                  <div class="flex items-center gap-2 shrink-0">
                    {{ prio_badge(r["priority"]) }}
                    {{ badge(r["status"]) }}
                  </div>
                </div>

                <div class="mt-2">
                  <button onclick="quickStatusChange('{{ r['id'] }}', 'PICKED_UP', 'Picked up', this)" 
                          class="w-full rounded-lg bg-zinc-800 hover:bg-zinc-700 transition px-3 py-1.5 text-xs">
                    ‚úì Mark Picked Up
                  </button>
                </div>
              </div>
            {% endfor %}
            {% for r in done[3:] %}
              <div class="request-item hidden bg-zinc-950/60 border border-zinc-800 rounded-xl p-3">
                <div class="flex items-center gap-3">
                  <input type="checkbox" data-request-id value="{{ r['id'] }}" 
                         onchange="toggleRequestId(this.value); updateBatchUI('done-section')" />
                  <a class="hover:underline flex-1 min-w-0" href="/admin/request/{{ r['id'] }}">
                    <div class="flex items-center gap-2">
                      <span class="font-semibold truncate">{{ r["print_name"] or 'Untitled Print' }}</span>
                      <span class="text-xs text-zinc-500 shrink-0">{{ r["id"][:8] }}</span>
                    </div>
                    <div class="text-xs text-zinc-400 mt-0.5 truncate">
                      {{ r["printer"] or "ANY" }} ‚Ä¢ {{ r["material"] or "ANY" }}
                    </div>
                  </a>
                  <div class="flex items-center gap-2 shrink-0">
                    {{ prio_badge(r["priority"]) }}
                    {{ badge(r["status"]) }}
                  </div>
                </div>
                <div class="mt-2">
                  <button onclick="quickStatusChange('{{ r['id'] }}', 'PICKED_UP', 'Picked up', this)" 
                          class="w-full rounded-lg bg-zinc-800 hover:bg-zinc-700 transition px-3 py-1.5 text-xs">
                    ‚úì Mark Picked Up
                  </button>
                </div>
              </div>
            {% endfor %}
          </div>
          {% if done|length > 3 %}
          <button onclick="toggleShowMore('done-list', this)" class="mt-3 w-full text-center text-xs text-indigo-400 hover:text-indigo-300 py-2 rounded-lg hover:bg-zinc-800/50 transition">
            Show {{ done|length - 3 }} more ‚ñº
          </button>
          {% endif %}
          <div class="mt-3">
            <button onclick="showBatchEditModal()" class="w-full rounded-xl bg-zinc-800 hover:bg-zinc-700 transition px-4 py-2 text-sm">
              ‚úè Batch Edit Selected
            </button>
          </div>
        {% endif %}
      </section>

    </div>

    <!-- Recently Closed - Collapsible -->
    <details class="mt-8 bg-zinc-900/40 border border-zinc-800 rounded-2xl group">
      <summary class="p-5 cursor-pointer hover:bg-zinc-900/60 rounded-2xl transition list-none">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <h2 class="text-lg font-semibold">üì¶ Recently Closed</h2>
            {% if closed|length > 0 %}
              <span class="px-2 py-1 rounded-lg bg-zinc-700/50 text-zinc-300 text-xs">{{ closed|length }}</span>
            {% endif %}
          </div>
          <div class="flex items-center gap-3">
            <span class="text-xs text-zinc-500">Picked up / rejected / cancelled</span>
            <svg class="w-5 h-5 text-zinc-400 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </div>
        </div>
      </summary>

      <div class="px-5 pb-5">
        {% if closed|length == 0 %}
          <div class="text-sm text-zinc-400">No closed items yet.</div>
        {% else %}
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3" id="closed-list">
            {% for r in closed[:4] %}
              <a href="/admin/request/{{ r['id'] }}" 
                 class="request-item bg-zinc-950/60 border border-zinc-800 rounded-xl p-3 hover:bg-zinc-900/60 hover:border-zinc-700 transition group/card">
                <div class="flex items-start justify-between gap-2">
                  <div class="min-w-0 flex-1">
                    <div class="font-medium text-sm truncate group-hover/card:text-indigo-300">
                      {{ r["print_name"] or ("Request " + r["id"][:8]) }}
                    </div>
                    <div class="text-xs text-zinc-500 mt-1 font-mono">{{ r["id"][:8] }}</div>
                  </div>
                  {{ badge(r["status"]) }}
                </div>
                <div class="mt-2 text-xs text-zinc-500 truncate">
                  {{ r["printer"] or "ANY" }} ‚Ä¢ {{ r["material"] or "ANY" }} {% if r["colors"] %}‚Ä¢ {{ r["colors"] }}{% endif %}
                </div>
              </a>
            {% endfor %}
            {% for r in closed[4:] %}
              <a href="/admin/request/{{ r['id'] }}" 
                 class="request-item hidden bg-zinc-950/60 border border-zinc-800 rounded-xl p-3 hover:bg-zinc-900/60 hover:border-zinc-700 transition group/card">
                <div class="flex items-start justify-between gap-2">
                  <div class="min-w-0 flex-1">
                    <div class="font-medium text-sm truncate group-hover/card:text-indigo-300">
                      {{ r["print_name"] or ("Request " + r["id"][:8]) }}
                    </div>
                    <div class="text-xs text-zinc-500 mt-1 font-mono">{{ r["id"][:8] }}</div>
                  </div>
                  {{ badge(r["status"]) }}
                </div>
                <div class="mt-2 text-xs text-zinc-500 truncate">
                  {{ r["printer"] or "ANY" }} ‚Ä¢ {{ r["material"] or "ANY" }}
                </div>
              </a>
            {% endfor %}
          </div>
          {% if closed|length > 4 %}
          <button onclick="toggleShowMore('closed-list', this)" class="mt-4 w-full text-center text-xs text-indigo-400 hover:text-indigo-300 py-2 rounded-lg hover:bg-zinc-800/50 transition">
            Show {{ closed|length - 4 }} more ‚ñº
          </button>
          {% endif %}
        {% endif %}
      </div>
    </details>

    <!-- Show More Toggle Script -->
    <script>
      function toggleShowMore(listId, btn) {
        const list = document.getElementById(listId);
        const hiddenItems = list.querySelectorAll('.request-item.hidden');
        const visibleItems = list.querySelectorAll('.request-item:not(.hidden)');
        
        if (hiddenItems.length > 0) {
          // Show all
          hiddenItems.forEach(item => item.classList.remove('hidden'));
          btn.textContent = 'Show less ‚ñ≤';
        } else {
          // Hide extras - 3 for lists, 4 for grid
          const keepCount = listId === 'closed-list' ? 4 : 3;
          const items = list.querySelectorAll('.request-item');
          items.forEach((item, i) => {
            if (i >= keepCount) item.classList.add('hidden');
          });
          btn.textContent = btn.textContent.replace('Show less ‚ñ≤', `Show ${items.length - keepCount} more ‚ñº`);
        }
      }
    </script>

    <!-- Footer with version -->
    <div class="mt-8 pt-4 border-t border-zinc-800 text-center text-xs text-zinc-500">
      <a href="/changelog" class="hover:text-indigo-400 transition">Printellect v{{ version }}</a>
    </div>

  </div>
  
  <!-- Files Preview Modal -->
  <div id="files-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
    <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-6 max-w-md w-full max-h-[80vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold">üìÅ Attached Files</h2>
        <button onclick="hideFilesModal()" class="text-zinc-400 hover:text-white text-xl">&times;</button>
      </div>
      <div id="files-list" class="space-y-2">
        <!-- Files will be populated here -->
      </div>
      <div class="mt-4 pt-4 border-t border-zinc-800">
        <a id="files-request-link" href="#" class="block w-full text-center rounded-xl bg-indigo-600 hover:bg-indigo-500 transition px-4 py-2 text-sm font-semibold">
          Open Request Details
        </a>
      </div>
    </div>
  </div>
  
  <script>
    function showFilesModal(requestId, fileNamesStr) {
      const filesList = document.getElementById('files-list');
      const requestLink = document.getElementById('files-request-link');
      requestLink.href = '/admin/request/' + requestId;
      
      // Parse file names (comma-separated)
      const fileNames = fileNamesStr ? fileNamesStr.split(',').map(f => f.trim()).filter(f => f) : [];
      
      if (fileNames.length === 0) {
        filesList.innerHTML = '<p class="text-zinc-400 text-sm">No files attached</p>';
      } else {
        filesList.innerHTML = fileNames.map((name, i) => `
          <div class="flex items-center gap-3 bg-zinc-950 border border-zinc-800 rounded-lg p-3">
            <span class="text-emerald-400">üìÑ</span>
            <span class="text-sm truncate flex-1">${escapeHtml(name)}</span>
          </div>
        `).join('');
      }
      
      document.getElementById('files-modal').classList.remove('hidden');
    }
    
    function hideFilesModal() {
      document.getElementById('files-modal').classList.add('hidden');
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Close modal when clicking outside
    document.getElementById('files-modal').addEventListener('click', (e) => {
      if (e.target.id === 'files-modal') hideFilesModal();
    });
  </script>
</body>
</html>
