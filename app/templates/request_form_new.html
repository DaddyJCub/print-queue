{% extends "pwa_base.html" %}

{% block title %}Submit Request | Printellect{% endblock %}

{% block nav_home %}text-white bg-zinc-800{% endblock %}
{% block bnav_home %}active{% endblock %}

{% block header_title %}New Request{% endblock %}

{% block head_extra %}
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
<style>
  /* Animated printer icon - subtle bounce */
  .printer-icon {
    animation: printerBounce 3s ease-in-out infinite;
  }
  @keyframes printerBounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-3px); }
  }
  
  /* Confetti for form submission */
  .confetti-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 9999;
    overflow: hidden;
  }
  .confetti {
    position: absolute;
    width: 10px;
    height: 10px;
    opacity: 0;
  }
  .confetti.active {
    animation: confettiFall 3s ease-out forwards;
  }
  @keyframes confettiFall {
    0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
    100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
  }
  
  /* Color swatch styles */
  .color-swatch {
    transition: transform 0.15s ease;
  }
  .color-swatch:hover {
    transform: scale(1.2);
  }
  
  @media (prefers-reduced-motion: reduce) {
    .printer-icon, .confetti { animation: none !important; }
  }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="relative mb-8 -mx-4 -mt-4 px-4 pt-8 pb-6 bg-gradient-to-br from-indigo-950/80 via-zinc-900 to-purple-950/50 border-b border-indigo-500/20 overflow-hidden">
  <!-- Background decoration -->
  <div class="absolute inset-0 overflow-hidden pointer-events-none">
    <div class="absolute -top-24 -right-24 w-72 h-72 bg-indigo-500/10 rounded-full blur-3xl"></div>
    <div class="absolute -bottom-24 -left-24 w-72 h-72 bg-purple-500/10 rounded-full blur-3xl"></div>
  </div>
  
  <div class="relative">
    <div class="flex items-center gap-3 mb-3">
      <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-indigo-500/30 printer-icon">
        <span class="text-2xl">üñ®Ô∏è</span>
      </div>
      <div>
        <h1 class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-white to-zinc-300 bg-clip-text text-transparent">New Print Request</h1>
        <p class="text-zinc-400 text-sm">Submit your design ‚Äî we'll bring it to life</p>
      </div>
    </div>
    
    <!-- Quick Stats -->
    {% if queue_stats %}
    <div class="flex flex-wrap gap-3 mt-4">
      <div class="flex items-center gap-2 px-3 py-1.5 bg-zinc-900/80 border border-zinc-700/50 rounded-full text-sm">
        <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
        <span class="text-zinc-400">{{ queue_stats.printing or 0 }} printing</span>
      </div>
      <div class="flex items-center gap-2 px-3 py-1.5 bg-zinc-900/80 border border-zinc-700/50 rounded-full text-sm">
        <span class="text-zinc-500">üìã</span>
        <span class="text-zinc-400">{{ queue_stats.queued or 0 }} in queue</span>
      </div>
      {% if queue_stats.avg_wait %}
      <div class="flex items-center gap-2 px-3 py-1.5 bg-zinc-900/80 border border-zinc-700/50 rounded-full text-sm">
        <span class="text-zinc-500">‚è±Ô∏è</span>
        <span class="text-zinc-400">~{{ queue_stats.avg_wait }} avg wait</span>
      </div>
      {% endif %}
    </div>
    {% endif %}
    
    <!-- Live Printer Status (compact) -->
    {% if printer_status %}
    <div class="mt-5 pt-4 border-t border-zinc-700/30">
      <div class="flex items-center gap-2 mb-3">
        <span class="text-sm font-medium text-zinc-400">üñ®Ô∏è Printer Status</span>
        <span class="text-xs text-zinc-600">‚Ä¢ Live</span>
      </div>
      <div class="grid grid-cols-2 gap-3">
        {% for pname, pdata in printer_status.items() %}
        <div class="flex items-center justify-between px-3 py-2 bg-zinc-950/50 border border-zinc-800/50 rounded-xl">
          <span class="text-sm font-medium text-zinc-300">{{ pname|replace('_', ' ') }}</span>
          {% if pdata.is_offline or not pdata.status %}
          <span class="px-2 py-0.5 text-xs rounded bg-zinc-800 text-zinc-500">Offline</span>
          {% elif pdata.is_printing %}
          <div class="flex items-center gap-2">
            <div class="w-8 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
              <div class="h-full bg-emerald-500 transition-all" style="width: {{ pdata.progress or 0 }}%"></div>
            </div>
            <span class="text-xs font-medium text-emerald-400">{{ pdata.progress or 0 }}%</span>
          </div>
          {% elif pdata.status == 'READY' %}
          <span class="px-2 py-0.5 text-xs rounded bg-green-500/20 border border-green-500/30 text-green-400">Ready</span>
          {% else %}
          <span class="px-2 py-0.5 text-xs rounded bg-amber-500/20 border border-amber-500/30 text-amber-400">{{ pdata.status }}</span>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      <a href="/queue" class="mt-2 block text-center text-xs text-indigo-400 hover:text-indigo-300 transition">View full queue ‚Üí</a>
    </div>
    {% endif %}
  </div>
</div>

<!-- Fun Stats Banner -->
{% if fun_stats and fun_stats.total_prints > 0 %}
<div class="mb-6 bg-gradient-to-r from-zinc-900/80 via-indigo-950/30 to-zinc-900/80 border border-zinc-800/50 rounded-2xl p-4 overflow-hidden relative">
  <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PHBhdHRlcm4gaWQ9ImdyaWQiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PHBhdGggZD0iTSAwIDEwIEwgNDAgMTAgTSAxMCAwIEwgMTAgNDAgTSAwIDIwIEwgNDAgMjAgTSAyMCAwIEwgMjAgNDAgTSAwIDMwIEwgNDAgMzAgTSAzMCAwIEwgMzAgNDAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzMzMyIgb3BhY2l0eT0iMC4wNSIgc3Ryb2tlLXdpZHRoPSIxIi8+PC9wYXR0ZXJuPjwvZGVmcz48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI2dyaWQpIi8+PC9zdmc+')] opacity-50"></div>
  <div class="relative flex items-center justify-around text-center">
    <div>
      <div class="text-2xl sm:text-3xl font-bold text-indigo-300">{{ fun_stats.total_prints }}</div>
      <div class="text-xs text-zinc-500">prints completed</div>
    </div>
    <div class="w-px h-10 bg-zinc-800"></div>
    <div>
      <div class="text-2xl sm:text-3xl font-bold text-emerald-300">{{ fun_stats.est_hours }}+</div>
      <div class="text-xs text-zinc-500">print hours</div>
    </div>
    <div class="w-px h-10 bg-zinc-800"></div>
    <div>
      <div class="text-2xl sm:text-3xl font-bold text-purple-300">{{ fun_stats.est_meters|int }}m</div>
      <div class="text-xs text-zinc-500">of filament</div>
    </div>
  </div>
</div>
{% endif %}

<!-- Recently Completed (mini showcase) -->
{% if recent_prints and recent_prints|length > 0 %}
<div class="mb-6">
  <div class="flex items-center justify-between mb-3">
    <h3 class="text-sm font-medium text-zinc-400 flex items-center gap-2">
      <span>‚ú®</span> Recently Completed
    </h3>
    <a href="/queue" class="text-xs text-indigo-400 hover:text-indigo-300">See all ‚Üí</a>
  </div>
  <div class="flex gap-2 overflow-x-auto pb-2 -mx-1 px-1 hide-scrollbar">
    {% for print in recent_prints %}
    <div class="flex-shrink-0 px-3 py-2 bg-zinc-900/60 border border-zinc-800 rounded-xl text-sm">
      <span class="text-zinc-300">{{ print.name[:20] }}{% if print.name|length > 20 %}...{% endif %}</span>
      {% if print.colors %}
      <span class="ml-2 text-xs text-zinc-500">{{ print.colors.split(',')[0] }}</span>
      {% endif %}
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- 3D Printing Tips (rotating) -->
<div class="mb-6 bg-zinc-900/40 border border-zinc-800/50 rounded-xl p-4">
  <div class="flex items-start gap-3">
    <span class="text-xl">üí°</span>
    <div>
      <p class="text-sm font-medium text-zinc-300" id="tip-text">Check the queue page to see your position in line üìã</p>
      <p class="text-xs text-zinc-600 mt-1">Did you know?</p>
    </div>
  </div>
</div>
<script>
  const tips = [
    "PLA is great for everyday prints ‚Äî it's affordable and comes in tons of colors!",
    "PETG is stronger than PLA and great for functional parts üí™",
    "Need something flexible? Ask about TPU filament!",
    "STL is the most common 3D print file format",
    "3MF files can include color and material info üé®",
    "Add a note about how you'll use the print ‚Äî it helps us choose the right settings!",
    "Multiple parts? You can upload several files in one request",
    "Include a reference image if you want a specific color match",
    "Prints typically take 1-3 days depending on the queue",
    "Check the queue page to see your position in line üìã",
    "Larger prints may be split into multiple build jobs",
    "Not sure which material? Just ask ‚Äî we're happy to help!"
  ];
  const tipEl = document.getElementById('tip-text');
  if (tipEl) {
    // Random tip on load
    tipEl.textContent = tips[Math.floor(Math.random() * tips.length)];
    // Rotate every 10 seconds
    setInterval(() => {
      tipEl.style.opacity = 0;
      setTimeout(() => {
        tipEl.textContent = tips[Math.floor(Math.random() * tips.length)];
        tipEl.style.opacity = 1;
      }, 300);
    }, 10000);
  }
</script>
<style>
  #tip-text { transition: opacity 0.3s ease; }
  .hide-scrollbar::-webkit-scrollbar { display: none; }
  .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
</style>

<!-- User Account Card (when logged in) -->
{% if user %}
<div class="mb-6 bg-gradient-to-br from-emerald-600/20 to-teal-600/10 border border-emerald-500/30 rounded-2xl p-5 shadow-lg shadow-emerald-900/20">
  <div class="flex items-start gap-4">
    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-emerald-500 to-teal-500 flex items-center justify-center flex-shrink-0 text-white text-2xl font-bold shadow-lg shadow-emerald-500/30">
      {{ user.display_name[0]|upper if user.display_name else '?' }}
    </div>
    <div class="flex-1 min-w-0">
      <h3 class="font-bold text-lg text-emerald-100">Welcome back, {{ user.display_name }}!</h3>
      <p class="text-sm text-emerald-300/70 mt-0.5">Your details are auto-filled below</p>
      
      <!-- Show which fields are pre-filled -->
      <div class="mt-3 flex flex-wrap gap-2">
        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-emerald-600/30 border border-emerald-500/30 rounded-lg text-xs text-emerald-200">
          <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>
          {{ user.display_name }}
        </span>
        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-emerald-600/30 border border-emerald-500/30 rounded-lg text-xs text-emerald-200">
          <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>
          {{ user.email }}
        </span>
        {% if user.preferred_printer %}
        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-emerald-600/30 border border-emerald-500/30 rounded-lg text-xs text-emerald-200">
          <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>
          üñ®Ô∏è {{ user.preferred_printer }}
        </span>
        {% endif %}
        {% if user.preferred_material %}
        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-emerald-600/30 border border-emerald-500/30 rounded-lg text-xs text-emerald-200">
          <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>
          üßµ {{ user.preferred_material }}
        </span>
        {% endif %}
        {% if user.preferred_colors %}
        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-emerald-600/30 border border-emerald-500/30 rounded-lg text-xs text-emerald-200">
          <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>
          üé® {{ user.preferred_colors }}
        </span>
        {% endif %}
      </div>
    </div>
    <a href="/user/profile?from=submit" class="px-4 py-2 bg-emerald-600/50 hover:bg-emerald-600 border border-emerald-500/50 rounded-xl text-sm font-medium transition tap-highlight whitespace-nowrap shadow-lg shadow-emerald-900/20">
      Edit Profile
    </a>
  </div>
</div>
{% elif user_accounts_enabled %}
<!-- Sign In Prompt (when user accounts enabled but not logged in) -->
<div class="mb-6 bg-gradient-to-br from-zinc-900/80 to-zinc-800/50 border border-zinc-700/50 rounded-2xl p-5 shadow-lg">
  <div class="flex items-center gap-4">
    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-zinc-700 to-zinc-800 flex items-center justify-center flex-shrink-0 shadow-lg">
      <svg class="w-7 h-7 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
      </svg>
    </div>
    <div class="flex-1 min-w-0">
      <h3 class="font-bold text-lg text-zinc-200">Create an account</h3>
      <p class="text-sm text-zinc-400">Save your preferences and track all your prints</p>
    </div>
    <div class="flex gap-2">
      <a href="/auth/login" class="px-4 py-2.5 bg-zinc-800 hover:bg-zinc-700 border border-zinc-600 rounded-xl text-sm font-semibold transition tap-highlight">
        Sign In
      </a>
      <a href="/auth/register" class="px-4 py-2.5 bg-indigo-600 hover:bg-indigo-500 rounded-xl text-sm font-semibold transition tap-highlight shadow-lg shadow-indigo-900/30">
        Register
      </a>
    </div>
  </div>
</div>
{% endif %}

<!-- PWA Install Card (for non-PWA users) -->
<div id="pwa-promo-card" class="hidden mb-6 bg-gradient-to-br from-indigo-600/20 to-purple-600/10 border border-indigo-500/30 rounded-2xl p-4 card-interactive">
  <div class="flex items-center gap-4">
    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center flex-shrink-0">
      <svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
      </svg>
    </div>
    <div class="flex-1 min-w-0">
      <h3 class="font-semibold">Install Printellect</h3>
      <p class="text-xs text-zinc-400">Get push notifications when your print is ready</p>
    </div>
    <button onclick="installPWA()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-xl text-sm font-semibold transition tap-highlight">
      Install
    </button>
  </div>
  <!-- iOS hint -->
  <div id="ios-hint" class="hidden mt-3 pt-3 border-t border-indigo-500/20 text-xs text-zinc-400">
    <strong class="text-indigo-300">iPhone/iPad:</strong> Tap Share ‚Üí Add to Home Screen
  </div>
</div>

<script>
  // Show PWA promo for non-standalone users
  (function() {
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    const dismissed = localStorage.getItem('pwa_promo_dismissed');
    const dismissedAt = parseInt(localStorage.getItem('pwa_promo_dismissed_at') || '0');
    const daysSince = (Date.now() - dismissedAt) / (1000 * 60 * 60 * 24);
    
    if (!isStandalone && (!dismissed || daysSince > 7)) {
      const card = document.getElementById('pwa-promo-card');
      if (card) card.classList.remove('hidden');
      
      // iOS detection
      if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
        document.getElementById('ios-hint')?.classList.remove('hidden');
      }
    }
  })();
</script>

{% if error %}
<div class="mb-4 bg-red-900/30 border border-red-500/50 text-red-200 rounded-xl overflow-hidden">
  <div class="px-4 py-3 flex items-start gap-3">
    <svg class="w-5 h-5 text-red-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
    </svg>
    <div class="flex-1">
      <p class="font-medium text-red-200">Unable to submit request</p>
      <p class="text-sm text-red-300/80 mt-0.5">{{ error }}</p>
    </div>
    <button onclick="this.closest('.bg-red-900\\/30').remove()" class="text-red-400 hover:text-red-200 p-1">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
  </div>
  <div class="px-4 py-2 bg-red-950/50 text-xs text-red-300/70 border-t border-red-800/50">
    üí° Tip: Check your file is under 200MB and try again. If the problem persists, <a href="/feedback?type=bug" class="underline hover:text-red-200">report a bug</a>.
  </div>
</div>
{% endif %}

<!-- Saved Templates -->
{% if saved_templates and saved_templates|length > 0 %}
<div class="mb-4 bg-zinc-900/60 border border-zinc-800 rounded-xl p-4">
  <div class="flex items-center justify-between mb-3">
    <span class="text-sm font-medium text-zinc-300 flex items-center gap-2">
      <span>üìÅ</span> Saved Templates
    </span>
    <button type="button" onclick="toggleTemplatesPanel()" class="text-xs text-zinc-500 hover:text-zinc-300">
      <span id="templates-toggle-text">Hide</span>
    </button>
  </div>
  <div id="templates-panel" class="flex flex-wrap gap-2">
    {% for tpl in saved_templates %}
    <button type="button" onclick="loadTemplate('{{ tpl.id }}')"
            class="group flex items-center gap-2 px-3 py-2 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 rounded-xl text-sm transition tap-highlight">
      <span>{{ tpl.name }}</span>
      <span onclick="event.stopPropagation(); deleteTemplate('{{ tpl.id }}', '{{ tpl.name }}')" 
            class="text-zinc-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition">√ó</span>
    </button>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- Request Form -->
<form id="request-form" action="/submit" method="POST" enctype="multipart/form-data" 
      class="space-y-5 bg-gradient-to-b from-zinc-900/80 to-zinc-900/40 border border-zinc-700/50 rounded-2xl p-5 sm:p-6 shadow-xl"
      data-loading="Submitting...">
  
  <!-- Section: Your Info -->
  <div class="pb-4 border-b border-zinc-800">
    <h2 class="text-sm font-semibold text-zinc-400 uppercase tracking-wider mb-4 flex items-center gap-2">
      <span class="w-6 h-6 rounded-lg bg-indigo-600/30 flex items-center justify-center text-indigo-400 text-xs">1</span>
      Your Info
    </h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
    <div>
      <label class="block text-sm font-medium text-zinc-300 mb-1.5">
        Name
        {% if user %}<span class="text-emerald-400 text-xs ml-1">‚óè from profile</span>{% endif %}
      </label>
      <input name="requester_name" id="requester-name" required
             value="{{ (form.requester_name if form is defined else '') }}"
             onchange="updateRushPricing()"
             onkeyup="debounceUpdatePricing()"
             class="w-full rounded-xl bg-zinc-950 border {% if user %}border-emerald-600/50 ring-1 ring-emerald-600/20{% else %}border-zinc-700{% endif %} focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 px-4 py-3 transition" />
    </div>
    <div>
      <label class="block text-sm font-medium text-zinc-300 mb-1.5">
        Email
        {% if user %}<span class="text-emerald-400 text-xs ml-1">‚óè from profile</span>{% endif %}
      </label>
      <input name="requester_email" type="email" required
             value="{{ (form.requester_email if form is defined else '') }}"
             class="w-full rounded-xl bg-zinc-950 border {% if user %}border-emerald-600/50 ring-1 ring-emerald-600/20{% else %}border-zinc-700{% endif %} focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 px-4 py-3 transition" />
    </div>
  </div>
  </div>

  <!-- Section: Print Details -->
  <div class="pb-4 border-b border-zinc-800">
    <h2 class="text-sm font-semibold text-zinc-400 uppercase tracking-wider mb-4 flex items-center gap-2">
      <span class="w-6 h-6 rounded-lg bg-indigo-600/30 flex items-center justify-center text-indigo-400 text-xs">2</span>
      Print Details
    </h2>

  <!-- Print Name -->
  <div class="mb-4">
    <label class="block text-sm font-medium text-zinc-300 mb-1.5">What are you printing?</label>
    <input name="print_name" required placeholder="e.g., Dragon Statue, Phone Holder..."
           value="{{ (form.print_name if form is defined else '') }}"
           class="w-full rounded-xl bg-zinc-950 border border-zinc-700 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 px-4 py-3 text-lg transition" />
  </div>

  <!-- Printer & Material -->
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
    <div>
      <label class="block text-sm font-medium text-zinc-300 mb-1.5">
        Printer
        {% if user and user.preferred_printer %}<span class="text-emerald-400 text-xs ml-1">‚óè from profile</span>{% endif %}
      </label>
      <select name="printer" id="printer-select" required 
              class="w-full rounded-xl bg-zinc-950 border {% if user and user.preferred_printer %}border-emerald-600/50 ring-1 ring-emerald-600/20{% else %}border-zinc-700{% endif %} focus:border-indigo-500 px-4 py-3 transition">
        {% set selected_printer = (form.printer if form is defined and form.printer else 'ANY') %}
        {% for val, label in printers %}
          <option value="{{val}}" {% if val == selected_printer %}selected{% endif %}>{{label}}</option>
        {% endfor %}
      </select>
      {% if printer_suggestions and printer_suggestions.suggested %}
      <div class="mt-2 text-xs inline-flex items-center gap-2 px-2 py-1 rounded-lg bg-emerald-900/30 border border-emerald-800/50 text-emerald-300">
        üí° {{ printer_suggestions.reason }}
        <button type="button" onclick="document.getElementById('printer-select').value='{{ printer_suggestions.suggested }}'" 
                class="text-emerald-200 hover:text-white underline">Use it</button>
      </div>
      {% endif %}
    </div>
    <div>
      <label class="block text-sm font-medium text-zinc-300 mb-1.5">
        Material
        {% if user and user.preferred_material %}<span class="text-emerald-400 text-xs ml-1">‚óè from profile</span>{% endif %}
      </label>
      <select name="material" required 
              class="w-full rounded-xl bg-zinc-950 border {% if user and user.preferred_material %}border-emerald-600/50 ring-1 ring-emerald-600/20{% else %}border-zinc-700{% endif %} focus:border-indigo-500 px-4 py-3 transition">
        {% set selected_material = (form.material if form is defined and form.material else 'ANY') %}
        {% for val, label in materials %}
          <option value="{{val}}" {% if val == selected_material %}selected{% endif %}>{{label}}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <!-- Colors -->
  <div>
    <label class="block text-sm font-medium text-zinc-300 mb-1.5">
      Colors
      {% if user and user.preferred_colors %}<span class="text-emerald-400 text-xs ml-1">‚óè from profile</span>{% endif %}
    </label>
    <input name="colors" id="colors-input" placeholder="Black / White / Red (comma-separated)" required
           value="{{ (form.colors if form is defined else '') }}"
           class="w-full rounded-xl bg-zinc-950 border {% if user and user.preferred_colors %}border-emerald-600/50 ring-1 ring-emerald-600/20{% else %}border-zinc-700{% endif %} focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 px-4 py-3 transition" />
    <!-- Quick color picker -->
    <div class="mt-2 flex flex-wrap gap-1.5">
      <span class="text-xs text-zinc-500 mr-1">Quick pick:</span>
      <button type="button" onclick="addColor('Black')" class="color-swatch w-6 h-6 rounded-full bg-zinc-900 border-2 border-zinc-600 hover:border-white" title="Black"></button>
      <button type="button" onclick="addColor('White')" class="color-swatch w-6 h-6 rounded-full bg-white border-2 border-zinc-400 hover:border-indigo-400" title="White"></button>
      <button type="button" onclick="addColor('Red')" class="color-swatch w-6 h-6 rounded-full bg-red-500 border-2 border-red-400 hover:border-white" title="Red"></button>
      <button type="button" onclick="addColor('Blue')" class="color-swatch w-6 h-6 rounded-full bg-blue-500 border-2 border-blue-400 hover:border-white" title="Blue"></button>
      <button type="button" onclick="addColor('Green')" class="color-swatch w-6 h-6 rounded-full bg-green-500 border-2 border-green-400 hover:border-white" title="Green"></button>
      <button type="button" onclick="addColor('Yellow')" class="color-swatch w-6 h-6 rounded-full bg-yellow-400 border-2 border-yellow-300 hover:border-white" title="Yellow"></button>
      <button type="button" onclick="addColor('Orange')" class="color-swatch w-6 h-6 rounded-full bg-orange-500 border-2 border-orange-400 hover:border-white" title="Orange"></button>
      <button type="button" onclick="addColor('Purple')" class="color-swatch w-6 h-6 rounded-full bg-purple-500 border-2 border-purple-400 hover:border-white" title="Purple"></button>
      <button type="button" onclick="addColor('Pink')" class="color-swatch w-6 h-6 rounded-full bg-pink-400 border-2 border-pink-300 hover:border-white" title="Pink"></button>
      <button type="button" onclick="addColor('Gray')" class="color-swatch w-6 h-6 rounded-full bg-gray-400 border-2 border-gray-300 hover:border-white" title="Gray"></button>
    </div>
  </div>
  </div>
  <script>
    function addColor(color) {
      const input = document.getElementById('colors-input');
      const current = input.value.trim();
      if (current) {
        // Check if color already exists
        const colors = current.split(/[,\/]/).map(c => c.trim().toLowerCase());
        if (!colors.includes(color.toLowerCase())) {
          input.value = current + ', ' + color;
        }
      } else {
        input.value = color;
      }
      input.focus();
    }
  </script>

  <!-- Section: Files & Notes -->
  <div class="pb-4 border-b border-zinc-800">
    <h2 class="text-sm font-semibold text-zinc-400 uppercase tracking-wider mb-4 flex items-center gap-2">
      <span class="w-6 h-6 rounded-lg bg-indigo-600/30 flex items-center justify-center text-indigo-400 text-xs">3</span>
      Files & Notes
    </h2>

  <!-- Link -->
  <div class="mb-4">
    <label class="block text-sm font-medium text-zinc-300 mb-1.5">Model Link <span class="text-zinc-500 font-normal">(optional)</span></label>
    <input name="link_url" placeholder="https://printables.com/model/..."
           value="{{ (form.link_url if form is defined else '') }}"
           class="w-full rounded-xl bg-zinc-950 border border-zinc-700 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 px-4 py-3 transition" />
  </div>

  <!-- File Upload -->
  <div class="mb-4">
    <label class="block text-sm font-medium text-zinc-300 mb-1.5">Upload Files <span class="text-zinc-500 font-normal">(optional)</span></label>
    <div id="file-drop-zone" 
         class="w-full border-2 border-dashed border-zinc-700 hover:border-indigo-500 hover:bg-indigo-500/5 rounded-xl p-8 text-center cursor-pointer transition-all tap-highlight"
         ondrop="handleDrop(event)" 
         ondragover="handleDragOver(event)" 
         ondragleave="handleDragLeave(event)"
         onclick="document.getElementById('file-input').click()">
      <div id="drop-zone-content">
        <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-zinc-800 flex items-center justify-center">
          <svg class="w-6 h-6 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
          </svg>
        </div>
        <p class="text-zinc-400 text-sm">Drag & drop or <span class="text-indigo-400">browse</span></p>
        <p class="text-xs text-zinc-500 mt-1">STL, 3MF, OBJ, GCODE ‚Ä¢ Max 200MB</p>
      </div>
      <div id="file-preview" class="hidden">
        <div id="file-list" class="space-y-2 text-left"></div>
        <button type="button" onclick="clearFile(event)" class="mt-3 text-red-400 hover:text-red-300 text-sm tap-highlight flex items-center gap-1 mx-auto">
          <span>‚úï</span> Clear all files
        </button>
      </div>
    </div>
    <input id="file-input" name="upload" type="file" accept=".stl,.3mf,.obj,.gcode,.step,.stp,.fpp,.zip" class="hidden" multiple onchange="handleFileSelect(this)" />
    <p class="text-xs text-zinc-500 mt-2">You must provide either a link or file upload. Multiple files supported.</p>
  </div>

  <!-- Notes -->
  <div>
    <label class="block text-sm font-medium text-zinc-300 mb-1.5">Special Instructions <span class="text-zinc-500 font-normal">(optional)</span></label>
    <textarea name="notes" rows="3"
              placeholder="Color placement, scale, infill needs, supports, deadlines..."
              class="w-full rounded-xl bg-zinc-950 border border-zinc-700 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 px-4 py-3 transition resize-none">{{ (form.notes if form is defined else '') }}</textarea>
  </div>
  </div>

  <!-- Priority Rush -->
  {% if rush_settings and rush_settings.enabled %}
  <div class="bg-gradient-to-r from-amber-900/40 to-orange-900/30 border border-amber-600/50 rounded-2xl p-5 shadow-lg shadow-amber-900/20">
    <label class="flex items-start gap-4 cursor-pointer tap-highlight">
      <input type="checkbox" name="rush_request" id="rush-checkbox" value="1" 
             {% if form is defined and form.rush_request %}checked{% endif %}
             onchange="toggleRushPayment()"
             class="mt-1 w-6 h-6 rounded-lg border-amber-600 text-amber-500 focus:ring-amber-500" />
      <div class="flex-1">
        <div class="flex items-center gap-2 flex-wrap">
          <span class="font-bold text-lg text-amber-200">üöÄ Priority Rush</span>
          <span id="rush-price-badge" class="px-2.5 py-1 bg-amber-600/40 border border-amber-500/50 text-amber-200 text-sm font-semibold rounded-lg">${{ rush_settings.fee }}</span>
        </div>
        <p class="text-sm text-zinc-400 mt-1">
          Skip the queue and get your print started first! 
          <span id="rush-queue-reason" class="text-amber-400/70">({{ rush_settings.queue_reason }}{% if rush_settings.queue_addon > 0 %} +${{ rush_settings.queue_addon }}{% endif %})</span>
        </p>
      </div>
    </label>
    
    <!-- Payment Section -->
    <div id="rush-payment-section" class="mt-4 pt-4 border-t border-amber-800/50 hidden">
      <div class="bg-zinc-950/60 rounded-xl p-4">
        <p class="text-sm text-zinc-300 mb-3">
          Send <span id="rush-price-amount" class="font-bold text-amber-300">${{ rush_settings.fee }}</span> via Venmo:
        </p>
        <div class="flex items-center gap-3 bg-zinc-900 rounded-lg px-4 py-3 mb-3">
          <span class="text-2xl">üì±</span>
          <div>
            <div class="font-mono text-lg text-amber-300">{{ rush_settings.venmo_handle }}</div>
            <div class="text-xs text-zinc-500">Include your email in the note</div>
          </div>
        </div>
        <label class="flex items-center gap-2 cursor-pointer tap-highlight">
          <input type="checkbox" name="rush_payment_confirmed" id="rush-payment-confirm" value="1"
                 {% if form is defined and form.rush_payment_confirmed %}checked{% endif %}
                 class="w-4 h-4 rounded border-amber-600 text-amber-500 focus:ring-amber-500" />
          <span class="text-sm text-amber-200">I have sent payment</span>
        </label>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Turnstile -->
  {% if turnstile_site_key %}
  <div class="cf-turnstile" data-sitekey="{{turnstile_site_key}}" data-theme="dark"></div>
  {% else %}
  <div class="text-xs text-amber-300/70 bg-amber-900/20 border border-amber-800/30 rounded-lg px-3 py-2">
    ‚ö†Ô∏è Turnstile not configured ‚Äî submissions allowed for testing.
  </div>
  {% endif %}

  <!-- Submit -->
  <div class="flex gap-3 pt-4">
    <button type="submit" id="submit-btn" class="flex-1 rounded-2xl bg-gradient-to-r from-indigo-600 to-indigo-500 hover:from-indigo-500 hover:to-indigo-400 active:from-indigo-700 active:to-indigo-600 transition py-4 text-lg font-bold tap-highlight flex items-center justify-center gap-2 shadow-xl shadow-indigo-900/30">
      <span id="submit-text">üñ®Ô∏è Submit Request</span>
      <svg id="submit-spinner" class="hidden w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    </button>
    <button type="button" onclick="showSaveTemplateModal()" 
            class="rounded-2xl bg-zinc-800 hover:bg-zinc-700 active:bg-zinc-900 border border-zinc-700 transition px-5 py-4 font-semibold tap-highlight"
            title="Save as template">
      üíæ
    </button>
  </div>
</form>

<!-- Admin & Feedback Links -->
<div class="mt-6 pt-4 border-t border-zinc-800 flex items-center justify-between text-xs text-zinc-500">
  <a class="text-zinc-400 hover:text-indigo-400 transition" href="/admin/login">Admin</a>
  <div class="flex items-center gap-4">
    <a href="/feedback?type=bug" class="hover:text-red-400 transition" title="Report Bug">üêõ Bug</a>
    <a href="/feedback?type=suggestion" class="hover:text-yellow-400 transition" title="Suggestion">üí° Idea</a>
    <a href="/changelog" class="hover:text-indigo-400 transition">v{{ version }}</a>
  </div>
</div>

<!-- Save Template Modal -->
<div id="save-template-modal" class="fixed inset-0 bg-black/80 flex items-end sm:items-center justify-center z-50 hidden" onclick="hideSaveTemplateModal()">
  <div class="bg-zinc-900 border border-zinc-700 rounded-t-2xl sm:rounded-2xl p-6 w-full sm:max-w-md" onclick="event.stopPropagation()" style="padding-bottom: calc(var(--safe-area-bottom, 0px) + 1.5rem);">
    <h3 class="text-lg font-bold mb-4">üíæ Save as Template</h3>
    <input type="text" id="template-name-input" placeholder="Template name..."
           class="w-full rounded-xl bg-zinc-950 border border-zinc-700 focus:border-indigo-500 px-4 py-3 mb-4" />
    <div class="flex gap-3">
      <button onclick="saveTemplate()" class="flex-1 rounded-xl bg-indigo-600 hover:bg-indigo-500 py-3 font-semibold tap-highlight">
        Save
      </button>
      <button onclick="hideSaveTemplateModal()" class="rounded-xl bg-zinc-700 hover:bg-zinc-600 px-6 py-3 tap-highlight">
        Cancel
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // File upload handlers
  const MAX_FILE_SIZE = 200 * 1024 * 1024; // 200MB
  const ALLOWED_EXTENSIONS = ['.stl', '.3mf', '.obj', '.gcode', '.step', '.stp', '.fpp', '.zip'];
  const FILE_ICONS = {
    '.stl': 'üßä', '.3mf': 'üì¶', '.obj': 'üé≤', '.gcode': 'üìú',
    '.step': '‚öôÔ∏è', '.stp': '‚öôÔ∏è', '.fpp': 'üñ®Ô∏è', '.zip': 'üìÅ'
  };
  
  function handleDragOver(e) {
    e.preventDefault();
    document.getElementById('file-drop-zone').classList.add('border-indigo-500', 'bg-indigo-500/10');
  }
  function handleDragLeave(e) {
    e.preventDefault();
    document.getElementById('file-drop-zone').classList.remove('border-indigo-500', 'bg-indigo-500/10');
  }
  function handleDrop(e) {
    e.preventDefault();
    handleDragLeave(e);
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      const validFiles = validateFiles(files);
      if (validFiles) {
        document.getElementById('file-input').files = files;
        showFilePreview(files);
      }
    }
  }
  function handleFileSelect(input) {
    if (input.files.length > 0) {
      const validFiles = validateFiles(input.files);
      if (validFiles) {
        showFilePreview(input.files);
      } else {
        input.value = '';
      }
    }
  }
  
  function validateFiles(files) {
    let totalSize = 0;
    const errors = [];
    
    for (const file of files) {
      totalSize += file.size;
      const ext = '.' + file.name.split('.').pop().toLowerCase();
      if (!ALLOWED_EXTENSIONS.includes(ext)) {
        errors.push(`"${file.name}" has unsupported type. Use: STL, 3MF, OBJ, GCODE, STEP, FPP, or ZIP.`);
      }
    }
    
    if (totalSize > MAX_FILE_SIZE) {
      errors.push(`Total file size (${(totalSize / 1024 / 1024).toFixed(1)} MB) exceeds 200 MB limit.`);
    }
    
    if (errors.length > 0) {
      showToast(errors[0], 'error', 5000);
      return false;
    }
    return true;
  }
  
  function showFilePreview(files) {
    document.getElementById('drop-zone-content').classList.add('hidden');
    document.getElementById('file-preview').classList.remove('hidden');
    const list = document.getElementById('file-list');
    list.innerHTML = '';
    let totalSize = 0;
    for (const file of files) {
      totalSize += file.size;
      const ext = '.' + file.name.split('.').pop().toLowerCase();
      const icon = FILE_ICONS[ext] || 'üìÑ';
      const item = document.createElement('div');
      item.className = 'flex items-center gap-2 bg-zinc-800/50 rounded-lg px-3 py-2';
      item.innerHTML = `<span class="text-lg">${icon}</span><span class="text-zinc-200 text-sm truncate flex-1">${file.name}</span><span class="text-zinc-500 text-xs">${formatFileSize(file.size)}</span>`;
      list.appendChild(item);
    }
    if (files.length > 1) {
      const summary = document.createElement('div');
      summary.className = 'text-xs text-zinc-400 mt-2 pt-2 border-t border-zinc-700 flex items-center justify-between';
      summary.innerHTML = `<span>${files.length} files selected</span><span class="font-medium">${formatFileSize(totalSize)} total</span>`;
      list.appendChild(summary);
    }
  }
  
  function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1024 / 1024).toFixed(2) + ' MB';
  }
  
  function clearFile(e) {
    e.stopPropagation();
    document.getElementById('file-input').value = '';
    document.getElementById('drop-zone-content').classList.remove('hidden');
    document.getElementById('file-preview').classList.add('hidden');
  }

  // Rush pricing
  let pricingDebounceTimer = null;
  function toggleRushPayment() {
    const checkbox = document.getElementById('rush-checkbox');
    const section = document.getElementById('rush-payment-section');
    if (checkbox?.checked) section?.classList.remove('hidden');
    else section?.classList.add('hidden');
  }
  function debounceUpdatePricing() {
    clearTimeout(pricingDebounceTimer);
    pricingDebounceTimer = setTimeout(updateRushPricing, 300);
  }
  async function updateRushPricing() {
    const name = document.getElementById('requester-name')?.value || '';
    try {
      const response = await fetch(`/api/rush-pricing?name=${encodeURIComponent(name)}`);
      const data = await response.json();
      const badge = document.getElementById('rush-price-badge');
      const amount = document.getElementById('rush-price-amount');
      const reason = document.getElementById('rush-queue-reason');
      if (badge) badge.textContent = `$${data.price}`;
      if (amount) amount.textContent = `$${data.price}`;
      if (reason) {
        let txt = `(${data.queue_reason}`;
        if (data.queue_addon > 0) txt += ` +$${data.queue_addon}`;
        reason.textContent = txt + ')';
      }
    } catch (e) { console.error('Pricing fetch failed:', e); }
  }

  // Templates
  function toggleTemplatesPanel() {
    const panel = document.getElementById('templates-panel');
    const text = document.getElementById('templates-toggle-text');
    const hidden = panel.classList.toggle('hidden');
    text.textContent = hidden ? 'Show' : 'Hide';
  }
  async function loadTemplate(id) {
    try {
      const tpl = await fetch(`/api/templates/${id}`).then(r => r.json());
      const form = document.getElementById('request-form');
      if (tpl.requester_name) form.querySelector('[name="requester_name"]').value = tpl.requester_name;
      if (tpl.requester_email) form.querySelector('[name="requester_email"]').value = tpl.requester_email;
      if (tpl.printer) form.querySelector('[name="printer"]').value = tpl.printer;
      if (tpl.material) form.querySelector('[name="material"]').value = tpl.material;
      if (tpl.colors) form.querySelector('[name="colors"]').value = tpl.colors;
      if (tpl.notes) form.querySelector('[name="notes"]').value = tpl.notes;
      updateRushPricing();
      showToastLocal(`Loaded: ${tpl.name}`);
    } catch (e) { showToastLocal('Failed to load template', true); }
  }
  async function deleteTemplate(id, name) {
    if (!confirm(`Delete "${name}"?`)) return;
    try {
      await fetch(`/api/templates/${id}`, { method: 'DELETE' });
      showToastLocal(`Deleted: ${name}`);
      setTimeout(() => location.reload(), 500);
    } catch (e) { showToastLocal('Delete failed', true); }
  }
  function showSaveTemplateModal() {
    document.getElementById('save-template-modal').classList.remove('hidden');
    document.getElementById('template-name-input').focus();
  }
  function hideSaveTemplateModal() {
    document.getElementById('save-template-modal').classList.add('hidden');
  }
  async function saveTemplate() {
    const name = document.getElementById('template-name-input').value.trim();
    if (!name) { showToastLocal('Enter a name', true); return; }
    const form = document.getElementById('request-form');
    const fd = new FormData();
    fd.append('name', name);
    ['requester_name', 'requester_email', 'printer', 'material', 'colors', 'notes'].forEach(f => {
      fd.append(f, form.querySelector(`[name="${f}"]`)?.value || '');
    });
    try {
      const r = await fetch('/api/templates', { method: 'POST', body: fd }).then(r => r.json());
      if (r.success) { hideSaveTemplateModal(); showToastLocal(`Saved: ${name}`); setTimeout(() => location.reload(), 1000); }
    } catch (e) { showToastLocal('Save failed', true); }
  }

  // Toast - use global showToast if available
  function showToastLocal(msg, err = false) {
    if (window.showToast) {
      window.showToast(msg, err ? 'error' : 'success');
    } else {
      const t = document.createElement('div');
      t.className = `fixed bottom-20 sm:bottom-4 left-4 right-4 sm:left-auto sm:right-4 sm:w-auto px-4 py-3 rounded-xl text-sm font-medium z-50 text-center ${err ? 'bg-red-600' : 'bg-emerald-600'}`;
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 2500);
    }
  }
  
  // Fun confetti effect on submit
  function launchConfetti() {
    const container = document.createElement('div');
    container.className = 'confetti-container';
    document.body.appendChild(container);
    
    const colors = ['#6366f1', '#8b5cf6', '#ec4899', '#10b981', '#f59e0b', '#ef4444'];
    for (let i = 0; i < 50; i++) {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = Math.random() * 100 + '%';
      confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
      confetti.style.width = (Math.random() * 10 + 5) + 'px';
      confetti.style.height = confetti.style.width;
      confetti.style.animationDelay = Math.random() * 0.5 + 's';
      container.appendChild(confetti);
      setTimeout(() => confetti.classList.add('active'), 10);
    }
    setTimeout(() => container.remove(), 4000);
  }

  // Form submission with loading state
  document.getElementById('request-form')?.addEventListener('submit', function(e) {
    const btn = document.getElementById('submit-btn');
    const text = document.getElementById('submit-text');
    const spinner = document.getElementById('submit-spinner');
    
    // Validate form before showing loading
    if (!this.checkValidity()) return;
    
    // üéâ Launch confetti!
    launchConfetti();
    
    // Show loading state
    btn.disabled = true;
    btn.classList.add('opacity-75', 'cursor-wait');
    text.textContent = 'Submitting...';
    spinner.classList.remove('hidden');
  });

  // Init
  document.addEventListener('DOMContentLoaded', function() {
    toggleRushPayment();
    if (document.getElementById('requester-name')?.value) updateRushPricing();
    document.getElementById('template-name-input')?.addEventListener('keypress', e => {
      if (e.key === 'Enter') { e.preventDefault(); saveTemplate(); }
    });
  });
</script>
{% endblock %}
