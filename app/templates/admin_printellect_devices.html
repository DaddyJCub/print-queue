<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Printellect Devices</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-zinc-950 text-zinc-100">
  <div class="max-w-7xl mx-auto p-6">
    {% set active_page = 'printellect-devices' %}
    {% include 'admin_nav.html' %}

    <div class="mb-5 rounded-2xl border border-cyan-900/60 bg-gradient-to-r from-cyan-950/30 to-zinc-900/80 p-4">
      <h1 class="text-2xl font-bold">Printellect Device Registry</h1>
      <p class="text-sm text-zinc-300 mt-1">Auto-generate device IDs/claim codes, print QR labels, and track activation.</p>
    </div>

    <form id="createDeviceForm" class="rounded-2xl border border-zinc-800 bg-zinc-900/60 p-4 mb-4 space-y-3">
      <div class="grid md:grid-cols-4 gap-2">
        <input name="device_id" placeholder="device_id (optional)" class="rounded-lg border border-zinc-700 bg-zinc-950 px-3 py-2 text-sm font-mono" />
        <input name="name" placeholder="name (optional)" class="rounded-lg border border-zinc-700 bg-zinc-950 px-3 py-2 text-sm" />
        <input name="claim_code" placeholder="claim_code (optional)" class="rounded-lg border border-zinc-700 bg-zinc-950 px-3 py-2 text-sm font-mono" />
        <button class="rounded-lg bg-indigo-600 hover:bg-indigo-500 px-3 py-2 text-sm font-semibold">Create + Generate Label</button>
      </div>
      <div class="flex items-center justify-between gap-3">
        <p class="text-xs text-zinc-400">Leave fields blank to auto-generate. Save or print claim code now (hash only is stored server-side).</p>
        <label class="text-xs text-zinc-300 inline-flex items-center gap-2">
          <input id="autoDownloadProvisioning" type="checkbox" checked class="accent-indigo-500">
          Auto-download `device.json` + QR
        </label>
      </div>
    </form>

    <section id="labelPanel" class="hidden rounded-2xl border border-zinc-800 bg-zinc-900/60 p-4 mb-4">
      <div class="flex flex-wrap items-center justify-between gap-2 mb-3">
        <h2 class="font-semibold">Ready-to-Print Device Label</h2>
        <div class="flex gap-2">
          <button id="copyPayloadBtn" class="rounded-md border border-zinc-700 bg-zinc-900 hover:bg-zinc-800 px-3 py-1.5 text-xs">Copy Pairing URL</button>
          <button id="downloadDeviceJsonBtn" class="rounded-md border border-zinc-700 bg-zinc-900 hover:bg-zinc-800 px-3 py-1.5 text-xs">Download device.json</button>
          <button id="downloadQrBtn" class="rounded-md border border-zinc-700 bg-zinc-900 hover:bg-zinc-800 px-3 py-1.5 text-xs">Download QR SVG</button>
          <button id="printLabelBtn" class="rounded-md bg-emerald-600 hover:bg-emerald-500 px-3 py-1.5 text-xs font-semibold">Print Label</button>
        </div>
      </div>
      <div class="grid md:grid-cols-[220px,1fr] gap-4">
        <div class="rounded-xl border border-zinc-700 bg-zinc-950 p-3 flex items-center justify-center">
          <img id="labelQr" alt="Pairing QR code" class="w-48 h-48 bg-white p-2 rounded-lg" />
        </div>
        <div class="space-y-2 text-sm">
          <div><span class="text-zinc-400">Device ID:</span> <span id="labelDeviceId" class="font-mono"></span></div>
          <div><span class="text-zinc-400">Name:</span> <span id="labelName"></span></div>
          <div><span class="text-zinc-400">Claim Code:</span> <span id="labelClaim" class="font-mono text-emerald-300"></span></div>
          <div><span class="text-zinc-400">QR Payload:</span> <span id="labelQrPayload" class="font-mono break-all text-xs"></span></div>
          <div><span class="text-zinc-400">Fallback URL:</span> <a id="labelFallback" target="_blank" class="underline break-all text-xs text-cyan-300"></a></div>
          <div class="pt-2">
            <div class="text-zinc-400 text-xs mb-1">device.json preview</div>
            <pre id="labelDeviceJson" class="text-xs rounded-lg border border-zinc-800 bg-zinc-950 p-2 overflow-x-auto"></pre>
          </div>
          <p class="text-xs text-zinc-400 pt-1">Manufacturing note: flash the same <span class="font-mono">device_id</span> and <span class="font-mono">claim_code</span> into <span class="font-mono">/device.json</span>.</p>
        </div>
      </div>
    </section>

    <div class="rounded-2xl border border-zinc-800 bg-zinc-900/60 p-4">
      <h2 class="font-semibold mb-3">Devices</h2>
      <p id="manageStatus" class="text-xs text-zinc-400 mb-2 min-h-4"></p>
      <div id="devices" class="space-y-2"></div>
    </div>
  </div>

  <script>
    let lastLabel = null;
    const devicesById = new Map();

    function qrSvgUrl(payload) {
      return `/api/printellect/admin/qr.svg?payload=${encodeURIComponent(payload)}`;
    }

    function qrLabelPayload(label) {
      return (label?.fallback_url || label?.qr_payload || '').trim();
    }

    function htmlEscape(value) {
      return String(value || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function normalizeLabel(payload) {
      const data = payload.device || payload;
      if (!data || !data.device_id || !data.claim_code || !data.qr_payload) {
        return null;
      }
      return {
        device_id: data.device_id,
        name: data.name || devicesById.get(data.device_id)?.name || data.device_id,
        claim_code: data.claim_code,
        qr_payload: data.qr_payload,
        fallback_url: data.fallback_url || '',
        device_json: data.device_json || {
          device_id: data.device_id,
          claim_code: data.claim_code,
          hw_model: 'pico2w',
        },
      };
    }

    function setManageStatus(message, isError = false) {
      const el = document.getElementById('manageStatus');
      el.className = `text-xs mb-2 min-h-4 ${isError ? 'text-red-300' : 'text-zinc-400'}`;
      el.textContent = message || '';
    }

    function downloadText(filename, content, mimeType = 'text/plain;charset=utf-8') {
      const blob = new Blob([content], {type: mimeType});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 3000);
    }

    async function downloadQrSvg() {
      if (!lastLabel) return;
      const resp = await fetch(qrSvgUrl(qrLabelPayload(lastLabel)));
      if (!resp.ok) return;
      const text = await resp.text();
      downloadText(`${lastLabel.device_id}-pairing-qr.svg`, text, 'image/svg+xml');
    }

    function downloadDeviceJson() {
      if (!lastLabel) return;
      const content = JSON.stringify(lastLabel.device_json, null, 2) + '\n';
      downloadText(`${lastLabel.device_id}-device.json`, content, 'application/json;charset=utf-8');
    }

    function showLabel(rawPayload, options = {}) {
      const label = normalizeLabel(rawPayload);
      if (!label) return;
      lastLabel = label;
      document.getElementById('labelPanel').classList.remove('hidden');
      document.getElementById('labelQr').src = qrSvgUrl(qrLabelPayload(label));
      document.getElementById('labelDeviceId').textContent = label.device_id;
      document.getElementById('labelName').textContent = label.name || label.device_id;
      document.getElementById('labelClaim').textContent = label.claim_code;
      document.getElementById('labelQrPayload').textContent = label.qr_payload;
      const fallback = document.getElementById('labelFallback');
      fallback.textContent = label.fallback_url || '(none)';
      fallback.href = label.fallback_url || '#';
      document.getElementById('labelDeviceJson').textContent = JSON.stringify(label.device_json, null, 2);
      if (options.autoDownload) {
        downloadDeviceJson();
        downloadQrSvg();
      }
    }

    function printLabel() {
      if (!lastLabel) return;
      const qr = qrSvgUrl(qrLabelPayload(lastLabel));
      const safeDeviceId = htmlEscape(lastLabel.device_id);
      const safeName = htmlEscape(lastLabel.name || lastLabel.device_id);
      const safeClaimCode = htmlEscape(lastLabel.claim_code);
      const safePayload = htmlEscape(lastLabel.qr_payload);
      const popup = window.open('', '_blank', 'width=420,height=620');
      if (!popup) return;
      popup.document.write(`
        <html>
          <head><title>Printellect Label</title></head>
          <body style="font-family:system-ui,sans-serif;padding:20px">
            <h2 style="margin:0 0 8px 0">Printellect Device Label</h2>
            <div style="font-size:14px;margin-bottom:6px"><b>Device:</b> ${safeDeviceId}</div>
            <div style="font-size:14px;margin-bottom:6px"><b>Name:</b> ${safeName}</div>
            <div style="font-size:14px;margin-bottom:12px"><b>Claim:</b> ${safeClaimCode}</div>
            <img src="${qr}" style="width:260px;height:260px;border:1px solid #ddd;padding:8px;background:white" />
            <div style="margin-top:12px;font-size:12px;word-break:break-all">${safePayload}</div>
          </body>
        </html>
      `);
      popup.document.close();
      popup.focus();
      setTimeout(() => popup.print(), 250);
    }

    async function loadDevices() {
      const resp = await fetch('/api/printellect/admin/devices');
      const data = await resp.json();
      const root = document.getElementById('devices');
      root.innerHTML = '';
      devicesById.clear();

      for (const d of (data.devices || [])) {
        devicesById.set(d.device_id, d);
        const row = document.createElement('div');
        row.className = 'rounded-xl border border-zinc-800 bg-zinc-950 px-3 py-3 text-sm';
        const safeName = htmlEscape(d.name || d.device_id);
        const safeDeviceId = htmlEscape(d.device_id);
        const safeOwner = htmlEscape(d.owner_user_id || '');
        const safeNotes = htmlEscape(d.notes || '');
        row.innerHTML = `
          <div class="grid md:grid-cols-12 gap-2">
            <div class="md:col-span-3">
              <div class="font-semibold">${safeName}</div>
              <div class="text-xs text-zinc-400 font-mono">${safeDeviceId}</div>
            </div>
            <div class="md:col-span-2 text-xs text-zinc-400">${d.owner_user_id || 'unclaimed'}</div>
            <div class="md:col-span-3 text-xs text-zinc-400 font-mono">fw ${d.fw_version || '-'} / app ${d.app_version || '-'}</div>
            <div class="md:col-span-1 text-xs ${d.online ? 'text-emerald-300' : 'text-zinc-400'}">${d.online ? 'online' : 'offline'}</div>
            <div class="md:col-span-3 text-right flex md:justify-end gap-1">
              <button data-save="${d.device_id}" class="rounded-md border border-zinc-700 bg-zinc-900 hover:bg-zinc-800 px-2 py-1 text-xs">Save</button>
              <button data-unclaim="${d.device_id}" class="rounded-md border border-amber-700 bg-amber-950/40 hover:bg-amber-900/40 px-2 py-1 text-xs">Unclaim</button>
              <button data-delete="${d.device_id}" class="rounded-md border border-red-700 bg-red-950/40 hover:bg-red-900/40 px-2 py-1 text-xs">Delete</button>
              <button data-rotate="${d.device_id}" class="rounded-md border border-zinc-700 bg-zinc-900 hover:bg-zinc-800 px-2 py-1 text-xs">Rotate + Label</button>
            </div>
          </div>
          <div class="grid md:grid-cols-3 gap-2 mt-3">
            <div>
              <label class="block text-[11px] text-zinc-500 mb-1">Name</label>
              <input data-name="${d.device_id}" value="${safeName}" class="w-full rounded-md border border-zinc-700 bg-zinc-900 px-2 py-1.5 text-xs" />
            </div>
            <div>
              <label class="block text-[11px] text-zinc-500 mb-1">Owner account id (blank = unclaimed)</label>
              <input data-owner="${d.device_id}" value="${safeOwner}" class="w-full rounded-md border border-zinc-700 bg-zinc-900 px-2 py-1.5 text-xs font-mono" />
            </div>
            <div>
              <label class="block text-[11px] text-zinc-500 mb-1">Notes</label>
              <input data-notes="${d.device_id}" value="${safeNotes}" class="w-full rounded-md border border-zinc-700 bg-zinc-900 px-2 py-1.5 text-xs" />
            </div>
          </div>
        `;
        root.appendChild(row);
      }

      for (const btn of root.querySelectorAll('button[data-rotate]')) {
        btn.addEventListener('click', async () => {
          const deviceId = btn.getAttribute('data-rotate');
          const resp = await fetch(`/api/printellect/admin/devices/${deviceId}/claim-code/rotate`, {method: 'POST'});
          const data = await resp.json();
          const autoDownload = document.getElementById('autoDownloadProvisioning')?.checked;
          showLabel(data, {autoDownload});
          setManageStatus(`Rotated claim code for ${deviceId}.`);
          await loadDevices();
        });
      }

      for (const btn of root.querySelectorAll('button[data-save]')) {
        btn.addEventListener('click', async () => {
          const deviceId = btn.getAttribute('data-save');
          const name = root.querySelector(`input[data-name="${deviceId}"]`)?.value || '';
          const owner_user_id = root.querySelector(`input[data-owner="${deviceId}"]`)?.value || '';
          const notes = root.querySelector(`input[data-notes="${deviceId}"]`)?.value || '';
          setManageStatus(`Saving ${deviceId}...`);
          const resp = await fetch(`/api/printellect/admin/devices/${deviceId}`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, owner_user_id, notes}),
          });
          const raw = await resp.text();
          let data = {};
          try { data = JSON.parse(raw); } catch (_) {}
          if (!resp.ok) {
            setManageStatus(data.detail || 'Failed to save device', true);
            return;
          }
          setManageStatus(`Saved ${deviceId}.`);
          await loadDevices();
        });
      }

      for (const btn of root.querySelectorAll('button[data-unclaim]')) {
        btn.addEventListener('click', async () => {
          const deviceId = btn.getAttribute('data-unclaim');
          if (!confirm(`Unclaim ${deviceId} and revoke active tokens?`)) return;
          setManageStatus(`Unclaiming ${deviceId}...`);
          const resp = await fetch(`/api/printellect/admin/devices/${deviceId}/unclaim`, {method: 'POST'});
          const raw = await resp.text();
          let data = {};
          try { data = JSON.parse(raw); } catch (_) {}
          if (!resp.ok) {
            setManageStatus(data.detail || 'Failed to unclaim device', true);
            return;
          }
          setManageStatus(`Unclaimed ${deviceId}.`);
          await loadDevices();
        });
      }

      for (const btn of root.querySelectorAll('button[data-delete]')) {
        btn.addEventListener('click', async () => {
          const deviceId = btn.getAttribute('data-delete');
          const force = confirm(`Delete ${deviceId} permanently? Click OK only if you understand this removes command/state/token history.`);
          if (!force) return;
          setManageStatus(`Deleting ${deviceId}...`);
          const resp = await fetch(`/api/printellect/admin/devices/${deviceId}?force=1`, {method: 'DELETE'});
          const raw = await resp.text();
          let data = {};
          try { data = JSON.parse(raw); } catch (_) {}
          if (!resp.ok) {
            setManageStatus(data.detail || 'Failed to delete device', true);
            return;
          }
          setManageStatus(`Deleted ${deviceId}.`);
          await loadDevices();
        });
      }
    }

    document.getElementById('createDeviceForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      const payload = Object.fromEntries(new FormData(event.target).entries());
      const resp = await fetch('/api/printellect/admin/devices', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload),
      });
      const text = await resp.text();
      let data = {};
      try { data = JSON.parse(text); } catch (_) { data = {raw: text}; }
      const autoDownload = document.getElementById('autoDownloadProvisioning')?.checked;
      showLabel(data, {autoDownload});
      await loadDevices();
      event.target.reset();
    });

    document.getElementById('printLabelBtn').addEventListener('click', printLabel);
    document.getElementById('downloadDeviceJsonBtn').addEventListener('click', downloadDeviceJson);
    document.getElementById('downloadQrBtn').addEventListener('click', downloadQrSvg);
    document.getElementById('copyPayloadBtn').addEventListener('click', async () => {
      if (!lastLabel) return;
      try {
        await navigator.clipboard.writeText(lastLabel.fallback_url || lastLabel.qr_payload);
      } catch (_) {}
    });

    loadDevices();
    setInterval(loadDevices, 10000);
  </script>
</body>
</html>
